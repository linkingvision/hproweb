!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.h5jssdk=t():e.h5jssdk=t()}(self,(()=>(()=>{"use strict";var e={512:e=>{e.exports=function(e,t,i,s){var n=self||window;try{try{var r;try{r=new n.Blob([e])}catch(t){(r=new(n.BlobBuilder||n.WebKitBlobBuilder||n.MozBlobBuilder||n.MSBlobBuilder)).append(e),r=r.getBlob()}var a=n.URL||n.webkitURL,o=a.createObjectURL(r),h=new n[t](o,i);return a.revokeObjectURL(o),h}catch(s){return new n[t]("data:application/javascript,".concat(encodeURIComponent(e)),i)}}catch(e){if(!s)throw Error("Inline worker is not supported");return new n[t](s,i)}}}},t={};function i(s){var n=t[s];if(void 0!==n)return n.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,i),r.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s,n,r,a={};i.r(a),i.d(a,{AiDraw:()=>u,H5sPlayerWS2:()=>Zt,PackBitsCompress:()=>ri,PackBitsDecompress:()=>ai,TestVideo:()=>ni,VedDispMgr:()=>ti,VedDispPlayer:()=>si,Video:()=>A});class o{}!function(e){e[e.AB=0]="AB",e[e.BA=1]="BA",e[e.BOTH=2]="BOTH",e[e.NONE=3]="NONE"}(s||(s={}));class h extends o{constructor(e){super(),this.endpointRadius=5,this.isHighlighted=!1,this.arrowDirection=s.AB,this.start=e.point[0],this.end=e.point[1],this.lineWidth=e.lineWidth||3,this.color=e.color||"rgb(18,156,250)",this.countEnable=e.countEnable||!1,this.highlightColor=e.highlightColor||"#FFDC00",this.id=e.uuid||h.lastId++,this.name=e.name||`ID-${this.id}`,this.enter=e.enter||0,this.leave=e.leave||0,this.count=e.count||1,this.channelName=e.channelName||"",this.ruleType=e.ruleType||"",this.label=e.label||{}}updateEnd(e){this.end=e}getEndpointRadius(){return this.endpointRadius}static setStyleConfig(e,t=!1){t?h.highlightStyle={...h.highlightStyle,...e}:h.style={...h.style,...e}}draw(e,t){e.beginPath(),e.moveTo(this.start.x,this.start.y),e.lineTo(this.end.x,this.end.y),e.strokeStyle=this.isHighlighted?h.highlightStyle.color:h.style.color,e.lineWidth=this.isHighlighted?h.highlightStyle.lineWidth:h.style.lineWidth,e.lineWidth=this.lineWidth,e.stroke(),this.drawEndpoint(e,this.start),this.drawEndpoint(e,this.end),this.drawLabels(e),this.drawArrows(e),this.countEnable&&this.setEnterLeave(t)}drawEndpoint(e,t){e.beginPath(),e.arc(t.x,t.y,h.style.endpointRadius,0,2*Math.PI,!1),e.fillStyle=this.isHighlighted?h.highlightStyle.color:h.style.color,e.fill()}drawLabels(e){const t=this.end.x-this.start.x,i=this.end.y-this.start.y,s=Math.sqrt(i*i+t*t),n=i/s,r=-t/s,a=this.start.x+20*n,o=this.start.y+20*r,h=this.start.x-20*n,c=this.start.y-20*r;e.fillStyle="black",e.font="14px Arial",e.fillText("A",a,o),e.fillText("B",h,c)}setEnterLeave(e){e.fillStyle="#3A3A3A";const t=e.canvas.width,i=102*(this.count-1);e.fillRect(0,i,t,100);const s=i+20;e.font="16px Arial",e.fillStyle="#ffffff",[{label:this.label.channelNameLabel,value:this.channelName},{label:this.label.ruleTypeLabel,value:this.ruleType},{label:this.label.EnterLabel,value:this.enter.toString(),color:"#f5ff00"},{label:this.label.LeaveLabel,value:this.leave.toString(),color:"#00FDFF"}].forEach(((i,n)=>{const r=s+20*n;i.color&&(e.fillStyle=i.color),e.textAlign="left",e.fillText(i.label,12,r),e.textAlign="right",e.fillText(i.value,t-12,r),i.color&&(e.fillStyle="#ffffff")}))}setEnterLeaveCount(e,t){this.enter=e,this.leave=t}drawArrows(e){const t=this.end.x-this.start.x,i=this.end.y-this.start.y,n=Math.sqrt(t*t+i*i),r=-i/n,a=t/n,o={x:(this.start.x+this.end.x)/2,y:(this.start.y+this.end.y)/2},c=n/2,l=Math.min(20,c),d=(t,i)=>{const s=o,n={x:o.x+r*l*(t===this.start?1:-1),y:o.y+a*l*(t===this.start?1:-1)};e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(n.x,n.y),e.stroke();const c=Math.atan2(i.y-t.y,i.x-t.x);e.translate(n.x,n.y),e.rotate(c+Math.PI/2),e.beginPath(),e.moveTo(0,0),e.lineTo(-5,5),e.lineTo(-5,-5),e.closePath(),e.fillStyle=this.isHighlighted?h.highlightStyle.color:h.style.color,e.fill(),e.resetTransform(),e.beginPath()};switch(this.arrowDirection){case s.AB:d(this.start,this.end);break;case s.BA:d(this.end,this.start);break;case s.BOTH:d(this.start,this.end),d(this.end,this.start);case s.NONE:}}setHighlight(e){this.isHighlighted=e}toggleHighlight(){this.isHighlighted=!this.isHighlighted}contains(e){const t=Math.sqrt(Math.pow(this.start.x-e.x,2)+Math.pow(this.start.y-e.y,2)),i=Math.sqrt(Math.pow(this.end.x-e.x,2)+Math.pow(this.end.y-e.y,2)),s=this.distanceFromPointToLineSegment(e,this.start,this.end);return t<=this.endpointRadius||i<=this.endpointRadius||s<5}distanceFromPointToLineSegment(e,t,i){const s=e.x-t.x,n=e.y-t.y,r=i.x-t.x,a=i.y-t.y,o=r*r+a*a;let h,c,l=-1;0!==o&&(l=(s*r+n*a)/o),l<0?(h=t.x,c=t.y):l>1?(h=i.x,c=i.y):(h=t.x+l*r,c=t.y+l*a);const d=e.x-h,u=e.y-c;return Math.sqrt(d*d+u*u)}getCenter(){return{x:(this.start.x+this.end.x)/2,y:(this.start.y+this.end.y)/2}}setArrowDirection(e){this.arrowDirection=e}getArrowDirection(){return this.arrowDirection}setStart(e){this.start=e}setEnd(e){this.end=e}getStart(){return this.start}getEnd(){return this.end}getID(){return this.id}getName(){return this.name}setName(e){this.name=e}}h.lastId=0,h.style={lineWidth:3,color:"rgb(18,156,250)",highlightColor:"#FFDC00",endpointRadius:5},h.highlightStyle={lineWidth:3,color:"#FFDC00",highlightColor:"#FFDC00",endpointRadius:5};class c extends o{constructor(e={}){super(),this.vertices=[],this.isHighlighted=!1,this.isClosed=!1,this.polygon=0,this.id=e.id||c.lastId++,this.name=e.name||`ID-${this.id}`,e.vertices&&(this.vertices=e.vertices)}setWarnEnable(e){e?this.polygon+=1:this.polygon-=1,this.polygon>0?this.warnEnable=!0:(this.polygon=0,this.warnEnable=!1)}static setStyleConfig(e,t=!1){t?c.highlightStyle={...c.highlightStyle,...e}:c.style={...c.style,...e}}draw(e){let t=this.isHighlighted?c.highlightStyle:c.style;if(this.warnEnable&&(t=c.warnStyle),0!==this.vertices.length)if(1!==this.vertices.length){e.beginPath(),e.moveTo(this.vertices[0].x,this.vertices[0].y);for(let t=1;t<this.vertices.length;t++)e.lineTo(this.vertices[t].x,this.vertices[t].y);this.vertices.length>2&&(e.closePath(),e.fillStyle=t.fillColor,e.fill()),e.strokeStyle=t.lineColor,e.lineWidth=t.lineWidth,e.stroke();for(const i of this.vertices)this.drawVertex(e,i,t)}else this.drawVertex(e,this.vertices[0],t)}drawVertex(e,t,i){const s=i.vertexRadius;e.beginPath(),e.arc(t.x,t.y,s,0,2*Math.PI),e.fillStyle="white",e.fill(),e.strokeStyle=i.lineColor,e.lineWidth=1,e.stroke()}addVertex(e){return(this.vertices.length<2||this.vertices.length>=2&&!this.doesIntersect(e))&&(this.vertices.push(e),!0)}doesIntersect(e){for(let t=0;t<this.vertices.length;t++){let i=!1;for(let s=0;s<this.vertices.length-1;s++)if(s!==t&&s+1!==t&&this.checkIntersect(this.vertices[t],e,this.vertices[s],this.vertices[s+1])){i=!0;break}if(!i)return!1}return!0}checkIntersect(e,t,i,s){let n=this.getOrientation(e,t,i),r=this.getOrientation(e,t,s),a=this.getOrientation(i,s,e),o=this.getOrientation(i,s,t);return n!==r&&a!==o||!(0!==n||!this.isOnSegment(e,i,t))||!(0!==r||!this.isOnSegment(e,s,t))||!(0!==a||!this.isOnSegment(i,e,s))||!(0!==o||!this.isOnSegment(i,t,s))}isSelfIntersecting(){const e=this.vertices.length;for(let t=0;t<e;t++)for(let i=t+1;i<e;i++)if((0!==t||i!==e-1)&&this.doIntersect(this.vertices[t],this.vertices[(t+1)%e],this.vertices[i],this.vertices[(i+1)%e]))return!0;return!1}getOrientation(e,t,i){let s=(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y);return 0===s?0:s>0?1:2}getName(){return this.name}setName(e){this.name=e}getID(){return this.id}setHighlight(e){this.isHighlighted=e}getVertices(){return this.vertices}edgeClicked(e,t=5){for(let i=0;i<this.vertices.length;i++){const s=(i+1)%this.vertices.length;if(this.distanceToSegment(e,this.vertices[i],this.vertices[s])<t)return i}return-1}distanceToSegment(e,t,i){const s=Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2);if(0===s)return this.distance(e,t);let n=((e.x-t.x)*(i.x-t.x)+(e.y-t.y)*(i.y-t.y))/s;return n=Math.max(0,Math.min(1,n)),this.distance(e,{x:t.x+n*(i.x-t.x),y:t.y+n*(i.y-t.y)})}distance(e,t){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}closePolygon(){this.isClosed=!0}contains(e){let t=0;for(let i=0;i<this.vertices.length;i++){let s=(i+1)%this.vertices.length;this.doIntersect(e,{x:Number.MAX_VALUE,y:e.y},this.vertices[i],this.vertices[s])&&t++}return t%2==1}doIntersect(e,t,i,s){let n=this.getOrientation(e,t,i),r=this.getOrientation(e,t,s),a=this.getOrientation(i,s,e),o=this.getOrientation(i,s,t);return n!==r&&a!==o||!(0!==n||!this.isOnSegment(e,i,t))||!(0!==r||!this.isOnSegment(e,s,t))||!(0!==a||!this.isOnSegment(i,e,s))||!(0!==o||!this.isOnSegment(i,t,s))}isOnSegment(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}move(e,t){for(let i of this.vertices)i.x+=e,i.y+=t}updateVertex(e,t){e>=0&&e<this.vertices.length&&(this.vertices[e]=t)}deleteVertex(e){e>=0&&e<this.vertices.length&&this.vertices.splice(e,1)}isPolygonClosed(){return this.isClosed}distanceToPoint(e){if(this.contains(e))return 0;let t=Number.MAX_VALUE;for(let i=0;i<this.vertices.length;i++){let s=(i+1)%this.vertices.length,n=this.distanceToSegment(e,this.vertices[i],this.vertices[s]);n<t&&(t=n)}return t}squaredDistance(e,t){return(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)}isPointNearVertex(e,t=5){for(const i of this.vertices)if(Math.sqrt(this.squaredDistance(e,i))<t)return!0;return!1}isPointOnEdge(e,t=5){for(let i=0;i<this.vertices.length;i++){let s=(i+1)%this.vertices.length;if(this.distanceToSegment(e,this.vertices[i],this.vertices[s])<t)return!0}return!1}}c.lastId=0,c.style={vertexColor:"white",vertexRadius:5,lineColor:"#00D9FF",fillColor:"rgba(0, 217, 255, 0.2)",lineWidth:1},c.highlightStyle={vertexColor:"white",vertexRadius:5,lineColor:"#FCFF00",fillColor:"rgba(255, 255, 0, 0.2)",lineWidth:1},c.warnStyle={vertexColor:"white",vertexRadius:5,lineColor:"red",fillColor:"rgba(255, 0, 0, 0.2)",lineWidth:1};class l{constructor(e,t){this.canvas=e,this.secondaryCanvas=t,this.shapes=[],this.isDrawing=!1,this.tempShape=null}addShape(e){this.shapes.push(e),this.redraw()}startDrawing(){this.isDrawing=!0}stopDrawing(){this.isDrawing=!1,this.tempShape&&(this.addShape(this.tempShape),this.tempShape=null)}setTempShape(e){this.tempShape=e,this.redraw()}getIsDrawing(){return this.isDrawing}redraw(){const e=this.canvas.getContext("2d"),t=this.secondaryCanvas?.getContext("2d");if(e){e.clearRect(0,0,this.canvas.width,this.canvas.height),t&&t.clearRect(0,0,this.secondaryCanvas.width,this.secondaryCanvas.height);for(const i of this.shapes)i.draw(e,t||null);this.tempShape&&this.tempShape.draw(e,t||null)}}getShapes(){return this.shapes}deleteShape(e){const t=this.shapes.indexOf(e);t>-1&&(this.shapes.splice(t,1),this.redraw())}clear(){this.shapes=[],this.tempShape=null,this.redraw()}}!function(e){e[e.LINE=0]="LINE",e[e.POLYGON=1]="POLYGON"}(n||(n={}));class d{constructor(e,t){this.canvasManager=e,this.isDrawing=!1,this.canDraw=!1,this.startPoint=null,this.highlightedLine=null,this.highlightedPolygon=null,this.draggingEndpoint=null,this.isDraggingLine=!1,this.dragOffset=null,this.defaultArrowDirection=s.AB,this.currentPolygon=null,this.drawMode=n.LINE,this.isPolygonCompleted=!1,this.activePointIndex=null,this.isDraggingPolygon=!1,this.selectedVertexIndex=null,this.onShapeDrawnCallback=t,this.initializeEventHandlers()}setOnShapeDrawnCallback(e){this.onShapeDrawnCallback=e}setDefaultArrowDirection(e){this.defaultArrowDirection=e}enableDrawing(e){if(this.canDraw=e,!e){this.isDrawing=!1,this.draggingEndpoint=null,this.currentPolygon=null;const e=this.canvasManager.getShapes();for(const t of e)t instanceof c&&t.getVertices().length<3&&this.canvasManager.deleteShape(t);this.onShapeDrawnCallback&&this.onShapeDrawnCallback()}}setDrawMode(e){this.drawMode=e}initializeEventHandlers(){this.canvasManager.canvas.addEventListener("mousedown",(e=>this.handleMouseDown(e))),this.canvasManager.canvas.addEventListener("mousemove",(e=>this.handleMouseMove(e))),this.canvasManager.canvas.addEventListener("mouseup",(e=>this.handleMouseUp(e))),this.canvasManager.canvas.addEventListener("click",(e=>this.handleClick(e))),this.canvasManager.canvas.addEventListener("dblclick",(e=>this.handleDoubleClick(e))),this.canvasManager.canvas.addEventListener("contextmenu",(e=>this.handleRightClick(e)))}handleDoubleClick(e){this.drawMode,n.POLYGON}handleRightClick(e){if(e.preventDefault(),this.drawMode===n.POLYGON&&this.currentPolygon){const t=e.clientX-this.canvasManager.canvas.getBoundingClientRect().left,i=e.clientY-this.canvasManager.canvas.getBoundingClientRect().top;if(console.log("this.drawMode",this.drawMode,this.drawMode===n.POLYGON,"this.canDraw",this.canDraw,e.button),2===e.button&&this.drawMode===n.POLYGON){const e=this.canvasManager.getShapes().filter((e=>e instanceof c));for(const s of e)if(s.contains({x:t,y:i})||s.isPointOnEdge({x:t,y:i})){this.currentPolygon=s;const e=this.currentPolygon.getVertices().findIndex((e=>Math.sqrt(Math.pow(e.x-t,2)+Math.pow(e.y-i,2))<10));this.currentPolygon.deleteVertex(e),this.canvasManager.redraw();break}}}}stopDrawingPolygon(){this.drawMode===n.POLYGON&&this.currentPolygon&&(this.currentPolygon.closePolygon(),this.currentPolygon=null,this.canvasManager.redraw())}isPointNearSegment(e,t,i,s=5){const n=Math.pow(i.x-t.x,2)+Math.pow(i.y-t.y,2);if(0===n)return!1;const r=((e.x-t.x)*(i.x-t.x)+(e.y-t.y)*(i.y-t.y))/n;if(r<0||r>1)return!1;const a=t.x+r*(i.x-t.x),o=t.y+r*(i.y-t.y);return Math.sqrt(Math.pow(a-e.x,2)+Math.pow(o-e.y,2))<=s}handleMouseDown(e){if(0!==e.button)return;const t=e.clientX-this.canvasManager.canvas.getBoundingClientRect().left,i=e.clientY-this.canvasManager.canvas.getBoundingClientRect().top;if(this.drawMode===n.LINE)if(this.canDraw)this.isDrawing=!0,this.startPoint={x:t,y:i};else if(this.highlightedLine){const e=Math.sqrt(Math.pow(this.highlightedLine.getStart().x-t,2)+Math.pow(this.highlightedLine.getStart().y-i,2)),s=Math.sqrt(Math.pow(this.highlightedLine.getEnd().x-t,2)+Math.pow(this.highlightedLine.getEnd().y-i,2));e<=this.highlightedLine.getEndpointRadius()?this.draggingEndpoint="start":s<=this.highlightedLine.getEndpointRadius()?this.draggingEndpoint="end":(this.isDraggingLine=!0,this.dragOffset={x:t-this.highlightedLine.getCenter().x,y:i-this.highlightedLine.getCenter().y})}if(this.drawMode===n.POLYGON){if(!this.canDraw){console.log("no draw");const e=this.canvasManager.getShapes().filter((e=>e instanceof c));for(const s of e)if(s.contains({x:t,y:i})||s.isPointOnEdge({x:t,y:i})){this.currentPolygon=s,this.isDraggingPolygon=!0,this.dragOffset={x:t,y:i};break}}if(!this.currentPolygon&&this.canDraw)console.log("current"),this.currentPolygon=new c,this.canvasManager.addShape(this.currentPolygon),this.currentPolygon.addVertex({x:t,y:i}),this.canvasManager.redraw();else if(this.currentPolygon){console.log("has ");const e=this.currentPolygon.getVertices().findIndex((e=>Math.sqrt(Math.pow(e.x-t,2)+Math.pow(e.y-i,2))<10));if(-1!==e&&this.currentPolygon.getVertices().length>=3)this.selectedVertexIndex=e;else{let e=!1;const s=this.currentPolygon.getVertices();for(let n=0;n<s.length;n++){let r=(n+1)%s.length;if(this.isPointNearSegment({x:t,y:i},s[n],s[r])){e=!0,this.canDraw&&(this.currentPolygon.getVertices().splice(r,0,{x:t,y:i}),this.canvasManager.redraw());break}}if(!e)if(this.canDraw)this.canDraw&&(this.currentPolygon.addVertex({x:t,y:i}),console.log("add new point"),this.canvasManager.redraw());else{const e=this.canvasManager.getShapes().filter((e=>e instanceof c));for(const s of e)if(!this.isDrawing&&(s.contains({x:t,y:i})||s.isPointOnEdge({x:t,y:i}))){this.currentPolygon=s,this.isDraggingPolygon=!0,this.dragOffset={x:t,y:i};break}}}}}}setDrawingPolygon(e,t){this.drawMode=n.POLYGON;let i={id:t};this.currentPolygon=new c(i),this.canvasManager.addShape(this.currentPolygon);for(let t=0;t<e.length;t++)this.currentPolygon.addVertex({x:e[t].x,y:e[t].y});this.canvasManager.redraw(),this.enableDrawing(!1)}setDrawingLines(e){this.drawMode=n.LINE;const t=new h(e);t.setArrowDirection(this.defaultArrowDirection),this.canvasManager.addShape(t),this.isDrawing=!1,this.startPoint=null}handleMouseMove(e){const t=e.clientX-this.canvasManager.canvas.getBoundingClientRect().left,i=e.clientY-this.canvasManager.canvas.getBoundingClientRect().top;if(this.drawMode===n.LINE)if(this.canDraw&&this.isDrawing&&this.startPoint){const e={x:t,y:i};let s={point:[this.startPoint,e]};const n=new h(s);n.setArrowDirection(this.defaultArrowDirection),this.canvasManager.redraw(),n.draw(this.canvasManager.canvas.getContext("2d"))}else if(this.draggingEndpoint&&this.highlightedLine)"start"===this.draggingEndpoint?this.highlightedLine.setStart({x:t,y:i}):this.highlightedLine.setEnd({x:t,y:i}),this.canvasManager.redraw();else if(this.isDraggingLine&&this.highlightedLine){const e={x:this.highlightedLine.getStart().x+t-(this.highlightedLine.getCenter().x+(this.dragOffset?.x||0)),y:this.highlightedLine.getStart().y+i-(this.highlightedLine.getCenter().y+(this.dragOffset?.y||0))},s={x:this.highlightedLine.getEnd().x+t-(this.highlightedLine.getCenter().x+(this.dragOffset?.x||0)),y:this.highlightedLine.getEnd().y+i-(this.highlightedLine.getCenter().y+(this.dragOffset?.y||0))};this.highlightedLine.setStart(e),this.highlightedLine.setEnd(s),this.canvasManager.redraw()}else{const e=this.canvasManager.getShapes().find((e=>e instanceof h&&e.contains({x:t,y:i})));e?(this.highlightedLine&&this.highlightedLine.setHighlight(!1),e.setHighlight(!0),this.highlightedLine=e,this.canvasManager.redraw()):this.highlightedLine&&(this.highlightedLine.setHighlight(!1),this.highlightedLine=null,this.canvasManager.redraw())}if(this.drawMode===n.POLYGON){const e=this.canvasManager.getShapes().find((e=>e instanceof c&&(e.contains({x:t,y:i})||e.isPointOnEdge({x:t,y:i}))));if(e?(this.highlightedPolygon&&this.highlightedPolygon.setHighlight(!1),e.setHighlight(!0),this.highlightedPolygon=e,this.canvasManager.redraw()):this.highlightedPolygon&&(this.highlightedPolygon.setHighlight(!1),this.highlightedPolygon=null,this.canvasManager.redraw()),this.highlightedPolygon&&(this.currentPolygon=this.highlightedPolygon),this.isDraggingPolygon&&this.currentPolygon&&this.dragOffset&&null===this.selectedVertexIndex){const e=t-this.dragOffset.x,s=i-this.dragOffset.y;for(let t=0;t<this.currentPolygon.getVertices().length;t++){const i=this.currentPolygon.getVertices()[t],n={x:i.x+e,y:i.y+s};this.currentPolygon.updateVertex(t,n)}this.dragOffset={x:t,y:i},this.canvasManager.redraw()}else null!==this.selectedVertexIndex&&this.currentPolygon&&(this.currentPolygon.updateVertex(this.selectedVertexIndex,{x:t,y:i}),this.canvasManager.redraw())}}handleMouseUp(e){this.isDraggingLine=!1,this.dragOffset=null;const t=e.clientX-this.canvasManager.canvas.getBoundingClientRect().left,i=e.clientY-this.canvasManager.canvas.getBoundingClientRect().top;if(this.drawMode===n.LINE&&this.canDraw&&this.isDrawing&&this.startPoint){const e={x:t,y:i};if(Math.sqrt(Math.pow(e.x-this.startPoint.x,2)+Math.pow(e.y-this.startPoint.y,2))>20){let t={point:[this.startPoint,e]};const i=new h(t);i.setArrowDirection(this.defaultArrowDirection),this.canvasManager.addShape(i),this.onShapeDrawnCallback&&this.onShapeDrawnCallback()}this.isDrawing=!1,this.startPoint=null}else this.drawMode===n.POLYGON?(this.canDraw?(this.selectedVertexIndex=null,this.isDraggingPolygon=!1,this.dragOffset=null):this.currentPolygon&&(null!==this.selectedVertexIndex?(this.selectedVertexIndex=null,this.canvasManager.redraw()):this.isDraggingPolygon?(this.isDraggingPolygon=!1,this.dragOffset=null,this.canvasManager.redraw()):(this.currentPolygon.setHighlight(!1),this.currentPolygon=null)),this.onShapeDrawnCallback&&this.onShapeDrawnCallback()):this.draggingEndpoint=null}handleClick(e){}}!function(e){e[e.LINE=0]="LINE",e[e.POLYGON=1]="POLYGON"}(r||(r={}));class u{constructor(e,t){this.defaultArrowDirection=s.AB,this.drawMode=r.LINE,this.onShapeDrawnCallback=null,this.canvasManager=new l(e,t||void 0),this.eventHandlers=new d(this.canvasManager)}setOnShapeDrawnCallback(e){console.log("call back",e),this.onShapeDrawnCallback=e,this.eventHandlers.setOnShapeDrawnCallback(e)}setDrawMode(e){"line"===e?this.drawMode=r.LINE:"polygon"===e&&(this.drawMode=r.POLYGON),console.log("setDrawMode",this.drawMode),this.eventHandlers.setDrawMode(this.drawMode)}startDrawing(){this.eventHandlers.enableDrawing(!0)}stopDrawing(){this.eventHandlers.enableDrawing(!1)}getLines(){return this.canvasManager.getShapes().filter((e=>e instanceof h))}setLines(e){let t=this.denormalizeVertex(e.point);e.point=t,this.eventHandlers.setDrawingLines(e)}setLinesCount(e,t,i){this.canvasManager.getShapes().filter((e=>e instanceof h)).forEach((s=>{e==s.getID()&&(s.setEnterLeaveCount(t,i),this.canvasManager.redraw())}))}deleteLine(e){this.canvasManager.deleteShape(e)}getDefaultArrowDirection(){return this.defaultArrowDirection}setDefaultArrowDirection(e){switch(e){case"AB":this.defaultArrowDirection=s.AB;break;case"BA":this.defaultArrowDirection=s.BA;break;case"BOTH":this.defaultArrowDirection=s.BOTH;break;case"NONE":this.defaultArrowDirection=s.NONE;break;default:return void console.error("Invalid arrow direction provided:",e)}this.eventHandlers.setDefaultArrowDirection(this.defaultArrowDirection)}getLineDetails(){return this.getLines().map((e=>({id:e.id,start:e.getStart(),end:e.getEnd()})))}deleteLineById(e){const t=this.getLines().find((t=>t.id===e));t&&this.deleteLine(t)}getPolygons(){return this.canvasManager.getShapes().filter((e=>e instanceof c))}setPolygon(e,t){let i=this.denormalizeVertex(e);this.eventHandlers.setDrawingPolygon(i,t)}setPolygonWarnEnable(e,t){this.canvasManager.getShapes().filter((e=>e instanceof c)).forEach((i=>{e==i.getID()&&(i.setWarnEnable(t),this.canvasManager.redraw())}))}deletePolygon(e){this.canvasManager.deleteShape(e)}getPolygonDetails(){return this.getPolygons().map((e=>({id:e.id,vertices:e.getVertices()})))}deletePolygonById(e){const t=this.getPolygons().find((t=>t.id===e));t&&this.deletePolygon(t)}cancelPolygonDraw(){this.eventHandlers.stopDrawingPolygon()}denormalizeVertex(e){const t=this.canvasManager.canvas.width,i=this.canvasManager.canvas.height,s=[];for(const n of e){const e=parseFloat((n.x*t).toFixed(4)),r=parseFloat((n.y*i).toFixed(4));s.push({x:e,y:r})}return s}normalizeVertex(e){const t=this.canvasManager.canvas.width,i=this.canvasManager.canvas.height,s=[];for(const n of e){const e=parseFloat((n.x/t).toFixed(4)),r=parseFloat((n.y/i).toFixed(4));s.push({x:e,y:r})}return s}clearCanvas(){this.canvasManager.clear()}setPolygonStyle(e,t=!1){c.setStyleConfig(e,t)}setLineStyle(e,t=!1){h.setStyleConfig(e,t)}}class g{constructor(e,t){this.canvas=t;const i=this.ctx=t.getContext(e),s=i.createShader(i.VERTEX_SHADER);if(i.shaderSource(s,g.vertexShaderSource),i.compileShader(s),!i.getShaderParameter(s,i.COMPILE_STATUS))throw i.getShaderInfoLog(s);const n=i.createShader(i.FRAGMENT_SHADER);if(i.shaderSource(n,g.fragmentShaderSource),i.compileShader(n),!i.getShaderParameter(n,i.COMPILE_STATUS))throw i.getShaderInfoLog(n);const r=i.createProgram();if(i.attachShader(r,s),i.attachShader(r,n),i.linkProgram(r),!i.getProgramParameter(r,i.LINK_STATUS))throw i.getProgramInfoLog(r);i.useProgram(r);const a=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,a),i.bufferData(i.ARRAY_BUFFER,new Float32Array([-1,-1,-1,1,1,1,1,-1]),i.STATIC_DRAW);const o=i.getAttribLocation(r,"xy");i.vertexAttribPointer(o,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(o);const h=i.createTexture();i.bindTexture(i.TEXTURE_2D,h),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE)}draw(e){this.canvas.width=e.displayWidth,this.canvas.height=e.displayHeight;const t=this.ctx;createImageBitmap(e).then((e=>{t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),e.close(),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),t.clearColor(1,0,0,1),t.clear(t.COLOR_BUFFER_BIT),t.drawArrays(t.TRIANGLE_FAN,0,4)})).catch((e=>{console.error("Error creating ImageBitmap:",e)})),e.close()}}g.vertexShaderSource="\n      attribute vec2 xy;\n      varying highp vec2 uv;\n      void main(void) {\n        gl_Position = vec4(xy, 0.0, 1.0);\n        uv = vec2((1.0 + xy.x) / 2.0, (1.0 - xy.y) / 2.0);\n      }\n    ",g.fragmentShaderSource="\n      varying highp vec2 uv;\n      uniform sampler2D texture;\n      void main(void) {\n        gl_FragColor = texture2D(texture, uv);\n      }\n    ";var f,p,m,E,_,v,D,w,y,C,S,M,O,b=function(e,t,i,s,n){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?n.call(e,i):n?n.value=i:t.set(e,i),i},T=function(e,t,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(e):s?s.value:t.get(e)};class I{constructor(e){f.add(this),m.set(this,void 0),E.set(this,void 0),_.set(this,null),v.set(this,void 0),D.set(this,void 0),w.set(this,void 0),y.set(this,void 0),b(this,m,e,"f"),b(this,_,T(this,f,"m",C).call(this),"f")}async draw(e){await T(this,_,"f"),T(this,m,"f").width=e.displayWidth,T(this,m,"f").height=e.displayHeight;const t=T(this,D,"f").createBindGroup({layout:T(this,w,"f").getBindGroupLayout(0),entries:[{binding:1,resource:T(this,y,"f")},{binding:2,resource:T(this,D,"f").importExternalTexture({source:e})}]}),i=T(this,D,"f").createCommandEncoder(),s={colorAttachments:[{view:T(this,E,"f").getCurrentTexture().createView(),clearValue:[1,0,0,1],loadOp:"clear",storeOp:"store"}]},n=i.beginRenderPass(s);n.setPipeline(T(this,w,"f")),n.setBindGroup(0,t),n.draw(6,1,0,0),n.end(),T(this,D,"f").queue.submit([i.finish()]),e.close()}}p=I,m=new WeakMap,E=new WeakMap,_=new WeakMap,v=new WeakMap,D=new WeakMap,w=new WeakMap,y=new WeakMap,f=new WeakSet,C=async function(){const e=await navigator.gpu.requestAdapter();b(this,D,await e.requestDevice(),"f"),b(this,v,navigator.gpu.getPreferredCanvasFormat(),"f"),b(this,E,T(this,m,"f").getContext("webgpu"),"f"),T(this,E,"f").configure({device:T(this,D,"f"),format:T(this,v,"f"),alphaMode:"opaque"}),b(this,w,T(this,D,"f").createRenderPipeline({layout:"auto",vertex:{module:T(this,D,"f").createShaderModule({code:p.vertexShaderSource}),entryPoint:"vert_main"},fragment:{module:T(this,D,"f").createShaderModule({code:p.fragmentShaderSource}),entryPoint:"frag_main",targets:[{format:T(this,v,"f")}]},primitive:{topology:"triangle-list"}}),"f"),b(this,y,T(this,D,"f").createSampler({}),"f")},I.vertexShaderSource="\n      struct VertexOutput {\n        @builtin(position) Position: vec4<f32>,\n        @location(0) uv: vec2<f32>,\n      }\n  \n      @vertex\n      fn vert_main(@builtin(vertex_index) VertexIndex: u32) -> VertexOutput {\n        var pos = array<vec2<f32>, 6>(\n          vec2<f32>( 1.0,  1.0),\n          vec2<f32>( 1.0, -1.0),\n          vec2<f32>(-1.0, -1.0),\n          vec2<f32>( 1.0,  1.0),\n          vec2<f32>(-1.0, -1.0),\n          vec2<f32>(-1.0,  1.0)\n        );\n  \n        var uv = array<vec2<f32>, 6>(\n          vec2<f32>(1.0, 0.0),\n          vec2<f32>(1.0, 1.0),\n          vec2<f32>(0.0, 1.0),\n          vec2<f32>(1.0, 0.0),\n          vec2<f32>(0.0, 1.0),\n          vec2<f32>(0.0, 0.0)\n        );\n  \n        var output: VertexOutput;\n        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n        output.uv = uv[VertexIndex];\n        return output;\n      }\n    ",I.fragmentShaderSource="\n      @group(0) @binding(1) var mySampler: sampler;\n      @group(0) @binding(2) var myTexture: texture_external;\n      \n      @fragment\n      fn frag_main(@location(0) uv: vec2<f32>) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(myTexture, mySampler, uv);\n      }\n    ",function(e){e[e.CODEC_PCMU=0]="CODEC_PCMU",e[e.CODEC_PCMA=8]="CODEC_PCMA",e[e.CODEC_G711A=19]="CODEC_G711A",e[e.CODEC_G711U=20]="CODEC_G711U",e[e.CODEC_H264=96]="CODEC_H264",e[e.CODEC_H265=98]="CODEC_H265",e[e.CODEC_MPEG4=97]="CODEC_MPEG4",e[e.CODEC_VP9=99]="CODEC_VP9",e[e.CODEC_AV1=101]="CODEC_AV1",e[e.CODEC_MJPEG=26]="CODEC_MJPEG",e[e.CODEC_AAC=100]="CODEC_AAC",e[e.CODEC_PS=200]="CODEC_PS",e[e.CODEC_G722=201]="CODEC_G722",e[e.CODEC_G726=202]="CODEC_G726",e[e.CODEC_OPUS=203]="CODEC_OPUS",e[e.CODEC_ARAW=204]="CODEC_ARAW",e[e.CODEC_NONE=254]="CODEC_NONE",e[e.CODEC_LAST=1e3]="CODEC_LAST"}(S||(S={})),function(e){e[e.VIDEO_STREAM_VIDEO=1]="VIDEO_STREAM_VIDEO",e[e.VIDEO_STREAM_AUDIO=2]="VIDEO_STREAM_AUDIO",e[e.VIDEO_STREAM_INFO=3]="VIDEO_STREAM_INFO",e[e.VIDEO_STREAM_TEXT=4]="VIDEO_STREAM_TEXT",e[e.VIDEO_STREAM_SDP=5]="VIDEO_STREAM_SDP",e[e.VIDEO_STREAM_PBEVENT=6]="VIDEO_STREAM_PBEVENT",e[e.VIDEO_STREAM_MUXED=7]="VIDEO_STREAM_MUXED",e[e.VIDEO_STREAM_META_DATA=8]="VIDEO_STREAM_META_DATA",e[e.VIDEO_STREAM_END=9]="VIDEO_STREAM_END",e[e.VIDEO_STREAM_LAST=10]="VIDEO_STREAM_LAST"}(M||(M={})),function(e){e[e.VIDEO_FRM_NONE=0]="VIDEO_FRM_NONE",e[e.VIDEO_FRM_I=1]="VIDEO_FRM_I",e[e.VIDEO_FRM_P=2]="VIDEO_FRM_P",e[e.VIDEO_FRM_B=3]="VIDEO_FRM_B",e[e.VIDEO_FRM_INFO=4]="VIDEO_FRM_INFO",e[e.VIDEO_FRM_AUDIO=5]="VIDEO_FRM_AUDIO",e[e.VIDEO_FRM_PBTIME=6]="VIDEO_FRM_PBTIME",e[e.VIDEO_FRM_PBPOS=7]="VIDEO_FRM_PBPOS",e[e.VIDEO_FRM_PBEND=8]="VIDEO_FRM_PBEND",e[e.VIDEO_FRM_MUXED=9]="VIDEO_FRM_MUXED",e[e.VIDEO_FRM_TRANS_INFO=10]="VIDEO_FRM_TRANS_INFO",e[e.VIDEO_FRM_PBSPEED=11]="VIDEO_FRM_PBSPEED",e[e.VIDEO_FRM_PBSEEKED=12]="VIDEO_FRM_PBSEEKED",e[e.VIDEO_FRM_PB_PAUSED=13]="VIDEO_FRM_PB_PAUSED",e[e.VIDEO_FRM_LAST=14]="VIDEO_FRM_LAST"}(O||(O={}));class A{static isSupported(){const e=["VideoEncoder","VideoDecoder","AudioEncoder","AudioDecoder","VideoFrame","EncodedVideoChunk","EncodedAudioChunk","MediaStream","MediaStreamTrack","MediaStreamTrackGenerator","MediaStreamTrackProcessor"];let t=!0;for(const i of e)window[i]||(console.error(`${i} is not supported.`),t=!1);t?console.log("[WS2] All required API interfaces are supported!"):console.warn("[WS2] Some required API interfaces are not supported.")}constructor({canvas:e=null,rendererType:t="2d",videoElement:i=null}={}){if(this.context=null,this.writer=null,this.videoElement=null,this.trackGenerator=null,this.renderer=null,this.codec=null,this.audioCodec=null,this.width=null,this.height=null,this.firstTimestamp=null,this.isDecoderConfigured=!1,this.MIN_BUFFER_SIZE=3,this.MAX_BUFFER_SIZE=10,this.FRAME_RATE=25,this.FRAME_INTERVAL=1e3/this.FRAME_RATE,this.frameBuffer=[],this.BUFFER_SIZE=3,this.lastFrame=null,this.renderingStarted=!1,this.audioDecoderConfigured=!1,this.audioDecoder=null,this.audioTrackGenerator=null,this.audioWriter=null,i){console.log("videoElement",i),this.trackGenerator=new MediaStreamTrackGenerator({kind:"video"}),this.audioTrackGenerator=new MediaStreamTrackGenerator({kind:"audio"}),console.log("videoTrackGenerator",this.trackGenerator);const e=new MediaStream;e.addTrack(this.trackGenerator),i.srcObject=e}else{if(!e)throw new Error("You must provide either a canvas or a video element.");{this.canvas=e;const i="gpu"in navigator&&"function"==typeof navigator.gpu.requestAdapter;if("webgl"===t)this.renderer=new g("webgl",e);else if("webgpu"===t)i?this.renderer=new I(e):(console.warn("WebGPU is not supported in your environment. Fallback to WebGL."),this.renderer=new g("webgl",e));else{if("2d"!==t)throw new Error(`Unknown rendererType: ${t}`);this.context=e.getContext("2d")}}}this.initDecoder()}initDecoder(){try{this.decoder=new VideoDecoder({output:this.outputFrame.bind(this),error:e=>{console.error("VideoDecoder error:",e)}})}catch(e){console.error("Error initializing VideoDecoder:",e)}try{this.decoder=new AudioDecoder({output:this.outputAudioFrame.bind(this),error:e=>{console.error("VideoDecoder error:",e)}})}catch(e){console.error("Error initializing VideoDecoder:",e)}}async outputAudioFrame(e){this.audioWriter||(this.audioWriter=this.audioTrackGenerator.writable.getWriter());try{await this.audioWriter.write(e)}catch(e){console.error("Error when trying to render audio frame:",e),this.audioWriter&&(this.audioWriter.releaseLock(),this.audioWriter=null)}finally{e.close()}}async outputFrame(e){this.frameBuffer.push(e),this.renderingStarted||this.startRendering()}startRendering(){this.renderingStarted=!0;let e=0;const t=i=>{if(requestAnimationFrame(t),i-e>=40){e=i;let t=this.frameBuffer.shift();!t&&this.lastFrame&&(t=this.lastFrame),t&&(this.renderFrame(t),this.lastFrame=t)}};requestAnimationFrame(t)}async renderFrame(e){try{if(this.renderer)this.renderer.draw(e);else if(this.context){const t=await createImageBitmap(e);e.close(),this.context.drawImage(t,0,0,this.canvas.width,this.canvas.height),t.close()}else this.trackGenerator?(this.writer||(this.writer=this.trackGenerator.writable.getWriter()),await this.writer.write(e)):console.error("No renderer or context available for drawing")}catch(e){console.error("Error in renderFrame function:",e)}finally{this.writer?.releaseLock(),this.writer=null,e.close()}}start(e){console.log("start"),this.ws=new WebSocket(e),this.ws.binaryType="arraybuffer",this.ws.onmessage=e=>{const t=new Uint8Array(e.data);this.handleVideoData(t)}}toHex(e){return Array.from(e).map((e=>e.toString(16).padStart(2,"0"))).join(" ")}handleVideoData(e){const t=new DataView(e.buffer),i={StreamType:t.getUint32(0,!1),FrameType:t.getUint32(4,!1),Seq:t.getUint32(8,!1),Secs:t.getBigUint64(12,!1),Msecs:t.getUint32(20,!1),DataLen:t.getUint32(24,!1),Ptsdiff:t.getUint32(28,!1)},s=1000n*i.Secs+BigInt(i.Msecs);let n;n=this.firstTimestamp?s-this.firstTimestamp:s;const r=1000n*n;if(i.StreamType===M.VIDEO_STREAM_INFO&&i.FrameType===O.VIDEO_FRM_INFO){const i=4096,s={Video:t.getUint32(32,!1),Width:t.getUint32(36,!1),Height:t.getUint32(40,!1),Fps:t.getUint32(44,!1),vExtra:new Uint8Array(e.slice(48,48+i)),vExtraLen:t.getUint32(48+i,!1),Audio:t.getUint32(52+i,!1),aSampleRate:t.getUint32(56+i,!1),aSampleBit:t.getUint32(60+i,!1),aChannels:t.getUint32(64+i,!1),aExtra:new Uint8Array(e.slice(68+i,68+2*i)),aExtraLen:t.getUint32(68+2*i,!1)};return console.log("info",s),this.aSampleRate=s.aSampleRate,this.aChannels=s.aChannels,this.codec=this.getCodecString(s.Video),this.audioCodec=this.getCodecString(s.Audio),this.width=s.Width,void(this.height=s.Height)}if(i.StreamType===M.VIDEO_STREAM_AUDIO&&i.FrameType===O.VIDEO_FRM_AUDIO){if(!this.audioDecoderConfigured)try{this.audioDecoder.configure({codec:this.audioCodec}),this.audioDecoderConfigured=!0,console.log("Audio Decoder configured successfully")}catch(e){return void console.error("Error configuring audio decoder:",e)}const t=e,i=new AudioData({timestamp:Number(r),data:t});try{this.audioDecoder.decode(i)}catch(e){console.error("Error decoding audio frame:",e)}}if(!this.codec||i.FrameType!==O.VIDEO_FRM_I&&i.FrameType!==O.VIDEO_FRM_P&&i.FrameType!==O.VIDEO_FRM_B)console.log("Codec is missing, or frame type is not I-frame, P-frame, or B-frame.",i.FrameType);else{if(!this.isDecoderConfigured&&i.FrameType===O.VIDEO_FRM_I)try{this.decoder.configure({codec:this.codec}),this.isDecoderConfigured=!0,console.log("Decoder configured successfully")}catch(e){return void console.error("Error configuring decoder:",e)}null==this.firstTimestamp&&(this.firstTimestamp=1000n*i.Secs+BigInt(i.Msecs),console.log("进入",this.firstTimestamp));const t=32,s=e.slice(t),n=new EncodedVideoChunk({type:this.getFrameType(i.FrameType),timestamp:Number(r),data:s});try{this.decoder.decode(n)}catch(e){console.error("Error decoding frame:",e)}}}getCodecString(e){switch(e){case S.CODEC_PCMU:return"audio/PCMU";case S.CODEC_PCMA:return"audio/PCMA";case S.CODEC_H264:return"avc1.42001E";case S.CODEC_H265:return"hev1.1.6.L93.B0";case S.CODEC_MPEG4:return"video/mp4; codecs=mp4v.20.8";case S.CODEC_VP9:return"video/vp9; codecs=vp09.00.10.08";case S.CODEC_AV1:return"video/av1; codecs=av01";case S.CODEC_MJPEG:return"video/jpeg; codecs=mjpa";case S.CODEC_AAC:return"audio/aac; codecs=mp4a.40.2";case S.CODEC_PS:throw new Error("Unknown codec type: CODEC_PS");case S.CODEC_G722:return"audio/G722";case S.CODEC_G726:return"audio/G726";case S.CODEC_OPUS:return"audio/opus";case S.CODEC_ARAW:return"audio/pcm; codecs=1";default:throw new Error("Unknown codec type")}}getFrameType(e){switch(console.log("frameType",e),e){case O.VIDEO_FRM_I:return"key";case O.VIDEO_FRM_P:case O.VIDEO_FRM_B:default:return"delta"}}stop(){this.ws.close(),this.decoder.close()}}class k{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(!this.listeners.has(e))return;const i=this.listeners.get(e).indexOf(t);i>=0&&this.listeners.get(e).splice(i,1)}emit(e,t){(this.listeners.get(e)??[]).forEach((e=>{e.call(this,t)}))}}const R="VIDEO_FRAME",V="VIDEO_AUDIO_FRAME";var P,F,x,U=i(512),W=i.n(U);function L(){return W()('(()=>{let e=null,t=!1,n=!1;function r(n){const r=new DataView(n.buffer).getUint32(0,!0),o=new Uint8Array(n.buffer,4,r),c=new Uint8Array(n.buffer,4+r);let a;try{const e=(new TextDecoder).decode(o);a=JSON.parse(e)}catch(e){return}if(!t&&"key"===a.chunkInfo.type){if(!e)return;e.configure(a.config),t=!0}if(e&&t){const t=new EncodedVideoChunk({type:a.chunkInfo.type,timestamp:a.chunkInfo.timestamp,data:c});e.decode(t)}}self.onmessage=async o=>{const{debug:c,stream:a}=o.data;if(0==function(){try{return e=new VideoDecoder({output:e=>{self.postMessage({type:"decoded",frame:e},[e])},error:e=>{n=!0}}),!0}catch(e){return console.warn("[WS2] vwo can not started, if you use http, try https."),!1}}())return;const f=a.getReader();let s=!1;try{for(;;){const{done:e,value:t}=await f.read();if(e)break;if(1==n)break;r(t)}}catch(e){s=!0}finally{try{0==s&&0==n&&e&&(e.close(),e=null)}catch(e){}}e=null,t=!1,n=!1,self.close()}})();\n',"Worker",void 0,void 0)}class B{constructor(e,t){this.bufferSizeMs=200,void 0!==e&&e>0&&(this.bufferSizeMs=e),this.elementsList=[],this.droppedCallback=t,this.totalLengthMs=0}AddItem(e,t){this.elementsList.push({chunk:e,extraData:t}),this.totalLengthMs+=e.duration/1e3,this.elementsList.length>3e3&&(console.log("max reached"),this.GetItem())}GetFristDuration(){return this.elementsList.length<=0?1e4:this.elementsList[0].chunk.duration}GetItem(){let e;return this.totalLengthMs>0&&(e=this.elementsList.shift(),this.totalLengthMs-=e.chunk.duration/1e3),e}GetStats(){return{totalLengthMs:this.totalLengthMs,size:this.elementsList.length}}GetLengthMs(){return this.totalLengthMs}GetOverLengthMs(){return this.totalLengthMs-this.bufferSizeMs}Clear(){this.elementsList=[],this.totalLengthMs=0}}function N(){return W()('(()=>{let e=null,t=!1,n=!1;function r(n){const r=new DataView(n.buffer),a=r.getUint32(0,!0),o=r.getUint32(4,!0),c=new Uint8Array(n.buffer,8,a),i=new Uint8Array(n.buffer,8+a,o),f=new Uint8Array(n.buffer,8+a+o);let s;try{const n=(new TextDecoder).decode(c);if(s=JSON.parse(n),s.config.description=i,!t){if(!e)return;e.configure(s.config),t=!0}if(e&&t){const t=new EncodedAudioChunk({type:"key",timestamp:s.chunkInfo.timestamp,data:f});e.decode(t)}}catch(e){}}self.onmessage=async a=>{const{debug:o,stream:c}=a.data;if(0==function(){try{return e=new AudioDecoder({output:e=>{self.postMessage({type:"audiodecoded",audioData:e},[e])},error:e=>{n=!0}}),!0}catch(e){return console.warn("[WS2] awo can not started, if you use http, try https."),!1}}())return;const i=c.getReader();let f=!1;try{for(;;){const{done:e,value:t}=await i.read();if(e)break;if(1==n)break;r(t)}}catch(e){f=!0}finally{try{0==f&&0==n&&e&&(e.close(),e=null)}catch(e){}}e=null,t=!1,n=!1,self.close()}})();\n',"Worker",void 0,void 0)}class G{constructor(e,t,i,s){this.worker=new L,this.audioworker=new N,this.firstTimestamp=null,this.audioDecoder=null,this.audioConfiged=!1,this.frameCount=0,this.startTime=performance.now(),this.timeWindow=2e3,this.totalBytesReceived=0,this.lastBitrateCalculationTimestamp=0,this.bitrate=0,this.fps=0,this.freeSpace=0,this.lastVideoTimestamp=null,this.calculateBitrateTimer=null,this.renderingTimer=null,this.decodedFrameTimestamp=null,this.decodedFrameNum=0,this.lastInputVideoTimestamp=null,this.decingTimer=null,this.decJitter=null,this._jbuffersize=300,this._nCurrentSpeed=1,this._bJitterFistFull=!1,this._debug=i,this._nCurrentSpeed=e,this._jbuffersize=t-80,this._jbuffersize<=0&&(this._jbuffersize=0),this.jitter=new B(80,void 0),0!=this._jbuffersize&&(this.decJitter=new B(this._jbuffersize,void 0)),this.eventEmitter=s;const n=new CountQueuingStrategy({highWaterMark:5});this.stream=new ReadableStream({start:e=>{this.streamController=e}},n);const r=new CountQueuingStrategy({highWaterMark:10});this.audioStream=new ReadableStream({start:e=>{this.audioStreamController=e},cancel:e=>{!0===this._debug&&console.log("[WS2] Stream canceled due to:",e)}},r),this.worker.onmessage=this.handleMessage.bind(this),this.audioworker.onmessage=this.audioHandleMessage.bind(this),this.worker.postMessage({debug:this._debug,stream:this.stream},[this.stream]),this.audioworker.postMessage({debug:this._debug,stream:this.audioStream},[this.audioStream]),this.lastBitrateCalculationTimestamp=Date.now(),this.calculateBitrateTimer=setInterval(this.calculateBitrate.bind(this),2e3),this.decJitter&&(this.decingTimer=setTimeout(this.decing.bind(this),this.decJitter.GetFristDuration()/1e3))}handleVideoDataReceived(e){if(e){let t,i;if("audio"===e.type){const s=JSON.stringify({config:e.config,chunkInfo:e.chunkInfo}),n=(new TextEncoder).encode(s),r=e.config.description,a=n.length+r.byteLength+e.data.byteLength+8;t=new ArrayBuffer(a);const o=new DataView(t);o.setUint32(0,n.length,!0),o.setUint32(4,r.byteLength,!0),new Uint8Array(t,8,n.length).set(n),new Uint8Array(t,8+n.length,r.byteLength).set(r),new Uint8Array(t,8+n.length+r.byteLength).set(e.data),i=new Uint8Array(t),this.audioStreamController?.enqueue(i)}else if("video"===e.type){const s=JSON.stringify({config:e.config,chunkInfo:e.chunkInfo}),n=(new TextEncoder).encode(s),r=n.length+e.data.byteLength+4;t=new ArrayBuffer(r),new DataView(t).setUint32(0,n.length,!0),new Uint8Array(t,4,n.length).set(n),new Uint8Array(t,4+n.length).set(e.data),i=new Uint8Array(t);let a=0;null==this.lastInputVideoTimestamp||(a=e.chunkInfo.timestamp-this.lastInputVideoTimestamp),a<0&&(a=0),this.lastInputVideoTimestamp=e.chunkInfo.timestamp,this.decJitter&&this._nCurrentSpeed<=1&&this._nCurrentSpeed>0?this.decJitter.AddItem({duration:Number(a)},i):this.streamController?.enqueue(i)}}}audioHandleMessage(e){if("audiodecoded"===e.data.type){const t=e.data.audioData;this.eventEmitter.emit(V,t)}}getDecodedFrameTimestamp(){return this.decodedFrameTimestamp}getDecodedFrameNum(){return this.decodedFrameNum}getRenderCached(){return this.jitter.GetLengthMs()}getInputCached(){return this.decJitter?this.decJitter.GetLengthMs():0}setSpeed(e){if(this._nCurrentSpeed=e,e<0&&(this._bJitterFistFull=!1,this.decJitter&&this.decJitter.Clear()),e>1&&this.decJitter)for(;;){let e=this.decJitter.GetItem();if(null==e)break;this.streamController?.enqueue(e.extraData)}}handleMessage(e){if("decoded"===e.data.type){const t=e.data.frame;if(t instanceof VideoFrame||t instanceof ArrayBuffer){const e=t;let i=0;null==this.lastVideoTimestamp||(i=e.timestamp-this.lastVideoTimestamp),this.decodedFrameTimestamp=BigInt(e.timestamp),this.decodedFrameNum++,this.lastVideoTimestamp=e.timestamp,this.eventEmitter.emit(R,t),this.frameCount++;const s=performance.now(),n=s-this.startTime;if(n>=this.timeWindow){const e=this.frameCount/(n/1e3);this.fps=e,this.startTime=s,this.frameCount=0}}else!0===this._debug&&console.log("Received object is not a VideoFrame or ArrayBuffer")}}destory(){clearTimeout(this.decingTimer),clearTimeout(this.renderingTimer),clearInterval(this.calculateBitrateTimer),this.worker&&(this.streamController.close(),this.worker=null),this.audioworker&&(this.audioStreamController.close(),this.audioworker=null)}calculateBitrate(){const e=Date.now(),t=(e-this.lastBitrateCalculationTimestamp)/1e3;this.bitrate=8*this.totalBytesReceived/t,this.totalBytesReceived=0,this.lastBitrateCalculationTimestamp=e}rendering(){const e=this.jitter.GetItem();null!=e&&this.eventEmitter.emit(R,e.extraData);let t=this.jitter.GetFristDuration()/1e3;if(0==t){const e=this.jitter.GetItem();null!=e&&this.eventEmitter.emit(R,e.extraData),this.renderingTimer=setTimeout(this.rendering.bind(this),10)}else{let e=this.jitter.GetOverLengthMs(),i=t;i=e<=0?t:t-e/t*1,i/=Math.abs(this._nCurrentSpeed),this.renderingTimer=setTimeout(this.rendering.bind(this),i)}}decing(){let e=Date.now();if(0==this._bJitterFistFull){if(!(this.decJitter.GetLengthMs()>=this._jbuffersize))return void(this.decingTimer=setTimeout(this.decing.bind(this),this.decJitter.GetFristDuration()/1e3));this._bJitterFistFull=!0}let t=this.decJitter.GetItem();null!=t&&this.streamController?.enqueue(t.extraData);let i=this.decJitter.GetFristDuration()/1e3;if(0==i){const e=this.decJitter.GetItem();null!=e&&this.streamController?.enqueue(e.extraData),this.decingTimer=setTimeout(this.decing.bind(this),1)}else{let t=this.decJitter.GetOverLengthMs()-1*i,s=i;s=t<=0?i:i-t/i*1.5,s-=Date.now()-e,this.decingTimer=setTimeout(this.decing.bind(this),s)}}getStatus(){return{Bitrate:Math.trunc(this.bitrate),fps:Math.trunc(this.fps),QueueSize:this.freeSpace,codec:"H264"}}toHex(e){return Array.from(e).map((e=>e.toString(16).padStart(2,"0"))).join(" ")}}!function(e){e[e.CODEC_PCMU=0]="CODEC_PCMU",e[e.CODEC_PCMA=8]="CODEC_PCMA",e[e.CODEC_G711A=19]="CODEC_G711A",e[e.CODEC_G711U=20]="CODEC_G711U",e[e.CODEC_H264=96]="CODEC_H264",e[e.CODEC_H265=98]="CODEC_H265",e[e.CODEC_MPEG4=97]="CODEC_MPEG4",e[e.CODEC_VP9=99]="CODEC_VP9",e[e.CODEC_AV1=101]="CODEC_AV1",e[e.CODEC_MJPEG=26]="CODEC_MJPEG",e[e.CODEC_AAC=100]="CODEC_AAC",e[e.CODEC_PS=200]="CODEC_PS",e[e.CODEC_G722=201]="CODEC_G722",e[e.CODEC_G726=202]="CODEC_G726",e[e.CODEC_OPUS=203]="CODEC_OPUS",e[e.CODEC_ARAW=204]="CODEC_ARAW",e[e.CODEC_NONE=254]="CODEC_NONE",e[e.CODEC_LAST=1e3]="CODEC_LAST"}(P||(P={})),function(e){e[e.VIDEO_STREAM_VIDEO=1]="VIDEO_STREAM_VIDEO",e[e.VIDEO_STREAM_AUDIO=2]="VIDEO_STREAM_AUDIO",e[e.VIDEO_STREAM_INFO=3]="VIDEO_STREAM_INFO",e[e.VIDEO_STREAM_TEXT=4]="VIDEO_STREAM_TEXT",e[e.VIDEO_STREAM_SDP=5]="VIDEO_STREAM_SDP",e[e.VIDEO_STREAM_PBEVENT=6]="VIDEO_STREAM_PBEVENT",e[e.VIDEO_STREAM_MUXED=7]="VIDEO_STREAM_MUXED",e[e.VIDEO_STREAM_META_DATA=8]="VIDEO_STREAM_META_DATA",e[e.VIDEO_STREAM_END=9]="VIDEO_STREAM_END",e[e.VIDEO_STREAM_LAST=10]="VIDEO_STREAM_LAST"}(F||(F={})),function(e){e[e.VIDEO_FRM_NONE=0]="VIDEO_FRM_NONE",e[e.VIDEO_FRM_I=1]="VIDEO_FRM_I",e[e.VIDEO_FRM_P=2]="VIDEO_FRM_P",e[e.VIDEO_FRM_B=3]="VIDEO_FRM_B",e[e.VIDEO_FRM_INFO=4]="VIDEO_FRM_INFO",e[e.VIDEO_FRM_AUDIO=5]="VIDEO_FRM_AUDIO",e[e.VIDEO_FRM_PBTIME=6]="VIDEO_FRM_PBTIME",e[e.VIDEO_FRM_PBPOS=7]="VIDEO_FRM_PBPOS",e[e.VIDEO_FRM_PBEND=8]="VIDEO_FRM_PBEND",e[e.VIDEO_FRM_MUXED=9]="VIDEO_FRM_MUXED",e[e.VIDEO_FRM_TRANS_INFO=10]="VIDEO_FRM_TRANS_INFO",e[e.VIDEO_FRM_PBSPEED=11]="VIDEO_FRM_PBSPEED",e[e.VIDEO_FRM_PBSEEKED=12]="VIDEO_FRM_PBSEEKED",e[e.VIDEO_FRM_PB_PAUSED=13]="VIDEO_FRM_PB_PAUSED",e[e.VIDEO_FRM_META_ANA=14]="VIDEO_FRM_META_ANA",e[e.VIDEO_FRM_META_CELL_MOTION=15]="VIDEO_FRM_META_CELL_MOTION",e[e.VIDEO_FRM_LAST=100]="VIDEO_FRM_LAST"}(x||(x={}));class H{constructor(e,t,i,s,n,r){this.metaconf=null,this.decWorkerMgr=null,this.firstVTimestamp=null,this.lastVTimestamp=null,this.firstATimestamp=null,this.audioDecoder=null,this.audioConfiged=!1,this.totalBytesReceived=0,this.decodedFrameCheckTimer=null,this.currTimestampMicroseconds=null,this.inputVideoFrameNum=0,this.bGotIframe=!1,this._h264cpumode=!1,this._jbuffersize=300,this._nSpeed=1,this._nCurrentSpeed=1,this._nVideoCodec=254,this.metaconf=r,this._debug=s,this._nSpeed=e,this._h264cpumode=t,this._jbuffersize=i,this.eventEmitter=n,this.inputVideoFrameNum=0,this.decWorkerMgr=new G(this._nCurrentSpeed,this._jbuffersize,this._debug,n),this.decodedFrameCheckTimer=setInterval(this.decodedFrameCheck.bind(this),2e3)}handleVideoDataReceived(e){const t=new Uint8Array(e.data);this.totalBytesReceived+=t.byteLength;const i=this.handleVideoData(t);this.decWorkerMgr&&this.decWorkerMgr.handleVideoDataReceived(i)}handleVideoData(e){const t=new DataView(e.buffer),i={StreamType:t.getUint32(0,!1),FrameType:t.getUint32(4,!1),Seq:t.getUint32(8,!1),Secs:t.getBigUint64(12,!1),Msecs:t.getUint32(20,!1),DataLen:t.getUint32(24,!1),Ptsdiff:t.getUint32(28,!1)};let s=1000n*i.Secs+BigInt(i.Msecs);if(i.StreamType===F.VIDEO_STREAM_INFO&&i.FrameType===x.VIDEO_FRM_INFO){const i=4096,s={Video:t.getUint32(32,!1),Width:t.getUint32(36,!1),Height:t.getUint32(40,!1),Fps:t.getUint32(44,!1),vExtra:new Uint8Array(e.slice(48,48+i)),vExtraLen:t.getUint32(48+i,!1),Audio:t.getUint32(52+i,!1),aSampleRate:t.getUint32(56+i,!1),aSampleBit:t.getUint32(60+i,!1),aChannels:t.getUint32(64+i,!1),aExtra:new Uint8Array(e.slice(68+i,68+2*i)),aExtraLen:t.getUint32(68+2*i,!1)},n=this.parseAudioCodec(s.aExtra);return this._nVideoCodec=s.Video,!0===this._debug&&console.log(`[WS2] info data Video:${s.Video},Audio:${s.Audio}, Width:${s.Width}, Height:${s.Height}`),this.audioSpecificConfig=s.aExtra,this.codec=this.getCodecString(s.Video),this.audioCodec=n,this.aSampleRate=s.aSampleRate,void(this.aChannels=s.aChannels)}if(this.audioCodec&&i.StreamType===F.VIDEO_STREAM_AUDIO&&i.FrameType===x.VIDEO_FRM_AUDIO&&this._nCurrentSpeed>0){let t;t=this.firstATimestamp?s-this.firstATimestamp:BigInt(0);const i=1000n*t;null==this.firstATimestamp&&(this.firstATimestamp=s,null==this.firstVTimestamp&&(this.firstVTimestamp=s));const n=32;return{type:"audio",data:e.subarray(n),config:{codec:this.audioCodec,sampleRate:this.aSampleRate,numberOfChannels:this.aChannels,description:this.audioSpecificConfig},chunkInfo:{type:"key",timestamp:Number(i)}}}if(this.codec&&(i.FrameType===x.VIDEO_FRM_I||i.FrameType===x.VIDEO_FRM_P||i.FrameType===x.VIDEO_FRM_B)){let t;this._nCurrentSpeed<0&&null!=this.lastVTimestamp&&(s=this.lastVTimestamp+BigInt(1)),this.lastVTimestamp=s,t=this.firstVTimestamp?s-this.firstVTimestamp:BigInt(0);const n=1000n*t;null==this.firstVTimestamp&&(this.firstVTimestamp=s,null==this.firstATimestamp&&(this.firstATimestamp=s));const r=32,a=e.subarray(r);let o="no-preference";1==this._h264cpumode&&this._nVideoCodec==P.CODEC_H264&&(o="prefer-software");const h={codec:this.codec,hardwareAcceleration:o};if(0==this.bGotIframe){if(i.FrameType!=x.VIDEO_FRM_I)return;this.bGotIframe=!0}i.FrameType===x.VIDEO_FRM_I&&null==this.decWorkerMgr&&(this.inputVideoFrameNum=0,this.decWorkerMgr=new G(this._nCurrentSpeed,this._jbuffersize,this._debug,this.eventEmitter)),this.inputVideoFrameNum++;const c={type:this.getFrameType(i.FrameType),timestamp:Number(n)};return this.currTimestampMicroseconds=n,{type:"video",data:a,config:h,chunkInfo:c}}if(i.StreamType!==F.VIDEO_STREAM_META_DATA||i.FrameType!==x.VIDEO_FRM_META_ANA&&i.FrameType!==x.VIDEO_FRM_META_CELL_MOTION)return i.StreamType===F.VIDEO_STREAM_PBEVENT&&(i.FrameType===x.VIDEO_FRM_PBSEEKED?this.seekedProcess():i.FrameType===x.VIDEO_FRM_PBSPEED&&(this._nCurrentSpeed=this._nSpeed,this.decWorkerMgr&&this.decWorkerMgr.setSpeed(this._nCurrentSpeed))),null;{const t=32,i=e.subarray(t);var n=(new TextDecoder).decode(i);this.metaconf&&this.metaconf.callback(n)}}seekedProcess(){this.firstVTimestamp=null,this.firstATimestamp=null,this.bGotIframe=!1,this.currTimestampMicroseconds=null,this.decWorkerMgr.destory(),this.decWorkerMgr=null}setSpeed(e){this._nSpeed=e}destory(){clearInterval(this.decodedFrameCheckTimer),this.decWorkerMgr&&(this.decWorkerMgr.destory(),this.decWorkerMgr=null)}decodedFrameCheck(){if(this.decWorkerMgr&&null!=this.currTimestampMicroseconds){let e=BigInt(0);if(null!=this.decWorkerMgr.getDecodedFrameTimestamp())e=this.currTimestampMicroseconds-this.decWorkerMgr.getDecodedFrameTimestamp();else if(this.inputVideoFrameNum>50)return!0===this._debug&&console.log("[WS2] restart wo max no output frame:",this.inputVideoFrameNum),this.decWorkerMgr.destory(),void(this.decWorkerMgr=null);let t=this.decWorkerMgr.getDecodedFrameNum(),i=this.inputVideoFrameNum-t;!0===this._debug&&console.log("[WS2] dc:",Number(e/BigInt(1e3)),"rc:",this.decWorkerMgr.getRenderCached(),"input:",this.inputVideoFrameNum,"diff:",i,"ic:",this.decWorkerMgr.getInputCached()),this._nCurrentSpeed>0&&this._nCurrentSpeed<=4&&(e/BigInt(1e3)>3e3*this._nCurrentSpeed||this.decWorkerMgr.getRenderCached()>3e3*this._nCurrentSpeed)&&(!0===this._debug&&console.log("[WS2] restart wo",e/BigInt(1e3)),this.decWorkerMgr.destory(),this.decWorkerMgr=null)}}getCodecString(e){switch(e){case P.CODEC_PCMU:return"audio/PCMU";case P.CODEC_PCMA:case P.CODEC_G711A:case P.CODEC_G711U:return"audio/PCMA";case P.CODEC_H264:return"avc1.42001E";case P.CODEC_H265:return"hev1.1.6.L93.B0";case P.CODEC_MPEG4:return"video/mp4; codecs=mp4v.20.8";case P.CODEC_VP9:return"video/vp9; codecs=vp09.00.10.08";case P.CODEC_AV1:return"video/av1; codecs=av01";case P.CODEC_MJPEG:return"video/jpeg; codecs=mjpa";case P.CODEC_AAC:return"mp4a.40.2";case P.CODEC_G722:return"audio/G722";case P.CODEC_G726:return"audio/G726";case P.CODEC_OPUS:return"audio/opus";case P.CODEC_ARAW:return"audio/pcm; codecs=1";default:throw new Error("Unknown codec type")}}getFrameType(e){switch(e){case x.VIDEO_FRM_I:return"key";case x.VIDEO_FRM_P:case x.VIDEO_FRM_B:default:return"delta"}}parseAudioCodec(e){if(e.length<2)return"unknown";switch((e[0]<<8|e[1])>>11){case 2:return"mp4a.40.2";case 5:return"mp4a.40.5";case 29:return"mp4a.40.29";default:return"unknown"}}analyzeAExtra(e){if(e.length<2)return void console.error("aExtra data is too short.");const t=e[0]<<8|e[1];let i=t>>11;const s=t>>7&15,n=t>>3&15;let r;switch(!0===this._debug&&console.log(`Audio Object Type version: ${i}`),!0===this._debug&&console.log(`Sampling Frequency Index: ${s}`),!0===this._debug&&console.log(`Channel Configuration: ${n}`),i){case 2:r="AAC-LC (Low Complexity)";break;case 5:r="HE-AAC v1 (AAC LC + SBR)";break;case 29:r="HE-AAC v2 (AAC LC + SBR + PS)";break;default:r="Unknown"}console.log(`Determined Codec Type: ${r}`)}getStatus(){return this.decWorkerMgr.getStatus}toHex(e){return Array.from(e).map((e=>e.toString(16).padStart(2,"0"))).join(" ")}}var z,j,J,q,X,K,$,Y=Object.defineProperty,Q=Object.getOwnPropertySymbols,Z=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable,te=Math.pow,ie=(e,t,i)=>t in e?Y(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,se=(e,t,i)=>{if(!t.has(e))throw TypeError("Cannot "+i)},ne=(e,t,i)=>(se(e,t,"read from private field"),i?i.call(e):t.get(e)),re=(e,t,i)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,i)},ae=(e,t,i,s)=>(se(e,t,"write to private field"),s?s.call(e,i):t.set(e,i),i),oe=(e,t,i)=>(se(e,t,"access private method"),i),he=new Uint8Array(8),ce=new DataView(he.buffer),le=e=>[(e%256+256)%256],de=e=>(ce.setUint16(0,e,!1),[he[0],he[1]]),ue=e=>(ce.setUint32(0,e,!1),[he[1],he[2],he[3]]),ge=e=>(ce.setUint32(0,e,!1),[he[0],he[1],he[2],he[3]]),fe=e=>(ce.setInt16(0,te(2,8)*e,!1),[he[0],he[1]]),pe=e=>(ce.setInt32(0,te(2,16)*e,!1),[he[0],he[1],he[2],he[3]]),me=e=>(ce.setInt32(0,te(2,30)*e,!1),[he[0],he[1],he[2],he[3]]),Ee=(e,t=!1)=>{let i=Array(e.length).fill(null).map(((t,i)=>e.charCodeAt(i)));return t&&i.push(0),i},_e=e=>e&&e[e.length-1],ve=(e,t,i=!0)=>{let s=e*t;return i?Math.round(s):s},De=e=>{let t=e*(Math.PI/180),i=Math.cos(t),s=Math.sin(t);return[i,s,0,-s,i,0,0,0,1]},we=De(0),ye=e=>[pe(e[0]),pe(e[1]),me(e[2]),pe(e[3]),pe(e[4]),me(e[5]),pe(e[6]),pe(e[7]),me(e[8])],Ce=(e,t,i)=>({type:e,contents:t&&new Uint8Array(t.flat(10)),children:i}),Se=(e,t,i,s,n)=>Ce(e,[le(t),ue(i),null!=s?s:[]],n),Me=(e,t)=>{let i=ve(Math.max(0,...t.filter((e=>e.samples.length>0)).map((e=>_e(e.samples).timestamp+_e(e.samples).duration))),jt),s=Math.max(...t.map((e=>e.id)))+1;return Se("mvhd",0,0,[ge(e),ge(e),ge(jt),ge(i),pe(1),fe(1),Array(10).fill(0),ye(we),Array(24).fill(0),ge(s)])},Oe=(e,t)=>{let i=_e(e.samples),s=ve(i?i.timestamp+i.duration:0,jt);return Se("tkhd",0,3,[ge(t),ge(t),ge(e.id),ge(0),ge(s),Array(8).fill(0),de(0),de(0),fe("audio"===e.info.type?1:0),de(0),ye(De("video"===e.info.type?e.info.rotation:0)),pe("video"===e.info.type?e.info.width:0),pe("video"===e.info.type?e.info.height:0)])},be=(e,t)=>Ce("mdia",null,[Te(e,t),Ie("video"===e.info.type?"vide":"soun"),Ae(e)]),Te=(e,t)=>{let i=_e(e.samples),s=ve(i?i.timestamp+i.duration:0,e.timescale);return Se("mdhd",0,0,[ge(t),ge(t),ge(e.timescale),ge(s),de(21956),de(0)])},Ie=e=>Se("hdlr",0,0,[Ee("mhlr"),Ee(e),ge(0),ge(0),ge(0),Ee("mp4-muxer-hdlr")]),Ae=e=>Ce("minf",null,["video"===e.info.type?ke():Re(),Ve(),xe(e)]),ke=()=>Se("vmhd",0,1,[de(0),de(0),de(0),de(0)]),Re=()=>Se("smhd",0,0,[de(0),de(0)]),Ve=()=>Ce("dinf",null,[Pe()]),Pe=()=>Se("dref",0,0,[ge(1)],[Fe()]),Fe=()=>Se("url ",0,1),xe=e=>Ce("stbl",null,[Ue(e),Be(e),Ne(e),Ge(e),He(e),ze(e)]),Ue=e=>Se("stsd",0,0,[ge(1)],["video"===e.info.type?We(je[e.info.codec],e):Le(qe[e.info.codec],e)]),We=(e,t)=>Ce(e,[Array(6).fill(0),de(1),de(0),de(0),Array(12).fill(0),de(t.info.width),de(t.info.height),ge(4718592),ge(4718592),ge(0),de(1),Array(32).fill(0),de(24),(ce.setInt16(0,65535,!1),[he[0],he[1]])],[Je[t.info.codec](t)]),Le=(e,t)=>Ce(e,[Array(6).fill(0),de(1),de(0),de(0),ge(0),de(t.info.numberOfChannels),de(16),de(0),de(0),pe(t.info.sampleRate)],[Xe[t.info.codec](t)]),Be=e=>Se("stts",0,0,[ge(e.timeToSampleTable.length),e.timeToSampleTable.map((e=>[ge(e.sampleCount),ge(e.sampleDelta)]))]),Ne=e=>{if(e.samples.every((e=>"key"===e.type)))return null;let t=[...e.samples.entries()].filter((([,e])=>"key"===e.type));return Se("stss",0,0,[ge(t.length),t.map((([e])=>ge(e+1)))])},Ge=e=>Se("stsc",0,0,[ge(e.compactlyCodedChunkTable.length),e.compactlyCodedChunkTable.map((e=>[ge(e.firstChunk),ge(e.samplesPerChunk),ge(1)]))]),He=e=>Se("stsz",0,0,[ge(0),ge(e.samples.length),e.samples.map((e=>ge(e.size)))]),ze=e=>e.writtenChunks.length>0&&_e(e.writtenChunks).offset>=te(2,32)?Se("co64",0,0,[ge(e.writtenChunks.length),e.writtenChunks.map((e=>{return t=e.offset,ce.setUint32(0,Math.floor(t/te(2,32)),!1),ce.setUint32(4,t,!1),[he[0],he[1],he[2],he[3],he[4],he[5],he[6],he[7]];var t}))]):Se("stco",0,0,[ge(e.writtenChunks.length),e.writtenChunks.map((e=>ge(e.offset)))]),je={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},Je={avc:e=>e.codecPrivate&&Ce("avcC",[...e.codecPrivate]),hevc:e=>e.codecPrivate&&Ce("hvcC",[...e.codecPrivate]),vp9:e=>e.codecPrivate&&Ce("vpcC",[...e.codecPrivate]),av1:e=>e.codecPrivate&&Ce("av1C",[...e.codecPrivate])},qe={aac:"mp4a",opus:"opus"},Xe={aac:e=>Se("esds",0,0,[ge(58753152),le(32+e.codecPrivate.byteLength),de(1),le(0),ge(75530368),le(18+e.codecPrivate.byteLength),le(64),le(21),ue(0),ge(130071),ge(130071),ge(92307584),le(e.codecPrivate.byteLength),...e.codecPrivate,ge(109084800),le(1),le(2)]),opus:e=>Ce("dOps",[le(0),le(e.info.numberOfChannels),de(3840),ge(e.info.sampleRate),fe(0),le(0)])},Ke=class{constructor(){this.buffer=null}},$e=class{constructor(e,t,i){this.onData=e,this.onDone=t,this.options=i}},Ye=class{constructor(e,t){this.stream=e,this.options=t}},Qe=class{constructor(){this.pos=0,re(this,z,new Uint8Array(8)),re(this,j,new DataView(ne(this,z).buffer)),this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){ne(this,j).setUint32(0,e,!1),this.write(ne(this,z).subarray(0,4))}writeU64(e){ne(this,j).setUint32(0,Math.floor(e/te(2,32)),!1),ne(this,j).setUint32(4,e,!1),this.write(ne(this,z).subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)ne(this,j).setUint8(t%8,e.charCodeAt(t)),t%8==7&&this.write(ne(this,z));e.length%8!=0&&this.write(ne(this,z).subarray(0,e.length%8))}writeBox(e){var t,i;if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,null!=(t=e.size)?t:e.contents.byteLength+8),this.write(e.contents);else{let t=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let t of e.children)t&&this.writeBox(t);let s=this.pos,n=null!=(i=e.size)?i:s-t;this.seek(t),this.writeBoxHeader(e,n),this.seek(s)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}patchBox(e){let t=this.pos;this.seek(this.offsets.get(e)),this.writeBox(e),this.seek(t)}};z=new WeakMap,j=new WeakMap;var Ze,et,tt=class extends Qe{constructor(e){super(),re(this,K),re(this,J,void 0),re(this,q,new ArrayBuffer(te(2,16))),re(this,X,new Uint8Array(ne(this,q))),ae(this,J,e)}write(e){oe(this,K,$).call(this,this.pos+e.byteLength),ne(this,X).set(e,this.pos),this.pos+=e.byteLength}finalize(){oe(this,K,$).call(this,this.pos),ne(this,J).buffer=ne(this,q).slice(0,this.pos)}};J=new WeakMap,q=new WeakMap,X=new WeakMap,K=new WeakSet,$=function(e){let t=ne(this,q).byteLength;for(;t<e;)t*=2;if(t===ne(this,q).byteLength)return;let i=new ArrayBuffer(t),s=new Uint8Array(i);s.set(ne(this,X),0),ae(this,q,i),ae(this,X,s)};var it=class extends Qe{constructor(e){super(),re(this,Ze,void 0),re(this,et,[]),ae(this,Ze,e)}write(e){ne(this,et).push({data:e.slice(),start:this.pos}),this.pos+=e.byteLength}flush(){if(0===ne(this,et).length)return;let e=[],t=[...ne(this,et)].sort(((e,t)=>e.start-t.start));e.push({start:t[0].start,size:t[0].data.byteLength});for(let i=1;i<t.length;i++){let s=e[e.length-1],n=t[i];n.start<=s.start+s.size?s.size=Math.max(s.size,n.start+n.data.byteLength-s.start):e.push({start:n.start,size:n.data.byteLength})}for(let t of e){t.data=new Uint8Array(t.size);for(let e of ne(this,et))t.start<=e.start&&e.start<t.start+t.size&&t.data.set(e.data,e.start-t.start);ne(this,Ze).onData(t.data,t.start)}ne(this,et).length=0}finalize(){var e,t;null==(t=(e=ne(this,Ze)).onDone)||t.call(e)}};Ze=new WeakMap,et=new WeakMap;var st,nt,rt,at,ot,ht,ct,lt,dt,ut,gt,ft=te(2,24),pt=class extends Qe{constructor(e){var t,i;if(super(),re(this,at),re(this,ht),re(this,lt),re(this,ut),re(this,st,void 0),re(this,nt,void 0),re(this,rt,[]),ae(this,st,e),ae(this,nt,null!=(i=null==(t=e.options)?void 0:t.chunkSize)?i:ft),!Number.isInteger(ne(this,nt))||ne(this,nt)<te(2,10))throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(e){oe(this,at,ot).call(this,e,this.pos),oe(this,ut,gt).call(this),this.pos+=e.byteLength}finalize(){var e,t;oe(this,ut,gt).call(this,!0),null==(t=(e=ne(this,st)).onDone)||t.call(e)}};st=new WeakMap,nt=new WeakMap,rt=new WeakMap,at=new WeakSet,ot=function(e,t){let i=ne(this,rt).findIndex((e=>e.start<=t&&t<e.start+ne(this,nt)));-1===i&&(i=oe(this,lt,dt).call(this,t));let s=ne(this,rt)[i],n=t-s.start,r=e.subarray(0,Math.min(ne(this,nt)-n,e.byteLength));s.data.set(r,n);let a={start:n,end:n+r.byteLength};if(oe(this,ht,ct).call(this,s,a),0===s.written[0].start&&s.written[0].end===ne(this,nt)&&(s.shouldFlush=!0),ne(this,rt).length>2){for(let e=0;e<ne(this,rt).length-1;e++)ne(this,rt)[e].shouldFlush=!0;oe(this,ut,gt).call(this)}r.byteLength<e.byteLength&&oe(this,at,ot).call(this,e.subarray(r.byteLength),t+r.byteLength)},ht=new WeakSet,ct=function(e,t){let i=0,s=e.written.length-1,n=-1;for(;i<=s;){let r=Math.floor(i+(s-i+1)/2);e.written[r].start<=t.start?(i=r+1,n=r):s=r-1}for(e.written.splice(n+1,0,t),(-1===n||e.written[n].end<t.start)&&n++;n<e.written.length-1&&e.written[n].end>=e.written[n+1].start;)e.written[n].end=Math.max(e.written[n].end,e.written[n+1].end),e.written.splice(n+1,1)},lt=new WeakSet,dt=function(e){let t={start:Math.floor(e/ne(this,nt))*ne(this,nt),data:new Uint8Array(ne(this,nt)),written:[],shouldFlush:!1};return ne(this,rt).push(t),ne(this,rt).sort(((e,t)=>e.start-t.start)),ne(this,rt).indexOf(t)},ut=new WeakSet,gt=function(e=!1){for(let t=0;t<ne(this,rt).length;t++){let i=ne(this,rt)[t];if(i.shouldFlush||e){for(let e of i.written)ne(this,st).onData(i.data.subarray(e.start,e.end),i.start+e.start);ne(this,rt).splice(t--,1)}}};var mt,Et,_t,vt,Dt,wt,yt,Ct,St,Mt,Ot,bt,Tt,It,At,kt,Rt,Vt,Pt,Ft,xt,Ut,Wt,Lt,Bt,Nt,Gt,Ht,zt=class extends pt{constructor(e){var t;super(new $e(((t,i)=>e.stream.write({type:"write",data:t,position:i})),void 0,{chunkSize:null==(t=e.options)?void 0:t.chunkSize}))}},jt=1e3,Jt=["avc","hevc","vp9","av1"],qt=["aac","opus"],Xt=["strict","offset"],Kt=class{constructor(e){var t;if(re(this,Ct),re(this,Mt),re(this,bt),re(this,It),re(this,kt),re(this,Vt),re(this,Ft),re(this,Ut),re(this,Lt),re(this,mt,void 0),re(this,Et,void 0),re(this,_t,void 0),re(this,vt,null),re(this,Dt,null),re(this,wt,Math.floor(Date.now()/1e3)+2082844800),re(this,yt,!1),oe(this,Ct,St).call(this,e),this.target=e.target,ae(this,mt,((e,t)=>{for(var i in t||={})Z.call(t,i)&&ie(e,i,t[i]);if(Q)for(var i of Q(t))ee.call(t,i)&&ie(e,i,t[i]);return e})({firstTimestampBehavior:"strict"},e)),e.target instanceof Ke)ae(this,Et,new tt(e.target));else if(e.target instanceof $e)ae(this,Et,(null==(t=e.target.options)?void 0:t.chunked)?new pt(e.target):new it(e.target));else{if(!(e.target instanceof Ye))throw new Error(`Invalid target: ${e.target}`);ae(this,Et,new zt(e.target))}oe(this,Mt,Ot).call(this),oe(this,bt,Tt).call(this)}addVideoChunk(e,t,i){let s=new Uint8Array(e.byteLength);e.copyTo(s),this.addVideoChunkRaw(s,e.type,null!=i?i:e.timestamp,e.duration,t)}addVideoChunkRaw(e,t,i,s,n){if(oe(this,Lt,Bt).call(this),!ne(this,mt).video)throw new Error("No video track declared.");oe(this,kt,Rt).call(this,ne(this,vt),e,t,i,s,n)}addAudioChunk(e,t,i){let s=new Uint8Array(e.byteLength);e.copyTo(s),this.addAudioChunkRaw(s,e.type,null!=i?i:e.timestamp,e.duration,t)}addAudioChunkRaw(e,t,i,s,n){if(oe(this,Lt,Bt).call(this),!ne(this,mt).audio)throw new Error("No audio track declared.");oe(this,kt,Rt).call(this,ne(this,Dt),e,t,i,s,n)}finalize(){ne(this,vt)&&oe(this,Ft,xt).call(this,ne(this,vt)),ne(this,Dt)&&oe(this,Ft,xt).call(this,ne(this,Dt));let e=ne(this,Et).offsets.get(ne(this,_t)),t=ne(this,Et).pos-e;ne(this,_t).size=t,ne(this,Et).patchBox(ne(this,_t));let i=(s=[ne(this,vt),ne(this,Dt)].filter(Boolean),n=ne(this,wt),Ce("moov",null,[Me(n,s),...s.map((e=>((e,t)=>Ce("trak",null,[Oe(e,t),be(e,t)]))(e,n)))]));var s,n;ne(this,Et).writeBox(i),oe(this,Ut,Wt).call(this),ne(this,Et).finalize(),ae(this,yt,!0)}};mt=new WeakMap,Et=new WeakMap,_t=new WeakMap,vt=new WeakMap,Dt=new WeakMap,wt=new WeakMap,yt=new WeakMap,Ct=new WeakSet,St=function(e){if(e.video){if(!Jt.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);if(void 0!==e.video.rotation&&![0,90,180,270].includes(e.video.rotation))throw new Error(`Invalid video rotation: ${e.video.rotation}. Has to be 0, 90, 180 or 270.`)}if(e.audio&&!qt.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!Xt.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`)},Mt=new WeakSet,Ot=function(){var e;let t="hevc"===(null==(e=ne(this,mt).video)?void 0:e.codec);ne(this,Et).writeBox((e=>Ce("ftyp",e?[Ee("isom"),ge(0),Ee("iso4"),Ee("hvc1")]:[Ee("isom"),ge(0),Ee("isom"),Ee("avc1"),Ee("mp41")]))(t)),ae(this,_t,{type:"mdat",largeSize:!0}),ne(this,Et).writeBox(ne(this,_t)),oe(this,Ut,Wt).call(this)},bt=new WeakSet,Tt=function(){var e;if(ne(this,mt).video&&ae(this,vt,{id:1,info:{type:"video",codec:ne(this,mt).video.codec,width:ne(this,mt).video.width,height:ne(this,mt).video.height,rotation:null!=(e=ne(this,mt).video.rotation)?e:0},timescale:720,codecPrivate:new Uint8Array(0),samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]}),ne(this,mt).audio){let e=oe(this,It,At).call(this,2,ne(this,mt).audio.sampleRate,ne(this,mt).audio.numberOfChannels);ae(this,Dt,{id:ne(this,mt).video?2:1,info:{type:"audio",codec:ne(this,mt).audio.codec,numberOfChannels:ne(this,mt).audio.numberOfChannels,sampleRate:ne(this,mt).audio.sampleRate},timescale:ne(this,mt).audio.sampleRate,codecPrivate:e,samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]})}},It=new WeakSet,At=function(e,t,i){let s=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(t),n=i,r="";r+=e.toString(2).padStart(5,"0"),r+=s.toString(2).padStart(4,"0"),15===s&&(r+=t.toString(2).padStart(24,"0")),r+=n.toString(2).padStart(4,"0");let a=8*Math.ceil(r.length/8);r=r.padEnd(a,"0");let o=new Uint8Array(r.length/8);for(let e=0;e<r.length;e+=8)o[e/8]=parseInt(r.slice(e,e+8),2);return o},kt=new WeakSet,Rt=function(e,t,i,s,n,r){var a;let o=s/1e6,h=n/1e6;if(void 0===e.firstTimestamp&&(e.firstTimestamp=o),o=oe(this,Vt,Pt).call(this,o,e),e.lastTimestamp=o,(!e.currentChunk||o-e.currentChunk.startTimestamp>=.5)&&(e.currentChunk&&oe(this,Ft,xt).call(this,e),e.currentChunk={startTimestamp:o,sampleData:[],sampleCount:0}),e.currentChunk.sampleData.push(t),e.currentChunk.sampleCount++,(null==(a=null==r?void 0:r.decoderConfig)?void 0:a.description)&&(e.codecPrivate=new Uint8Array(r.decoderConfig.description)),e.samples.push({timestamp:o,duration:h,size:t.byteLength,type:i}),null!==e.lastTimescaleUnits){let t=ve(o,e.timescale,!1),i=Math.round(t-e.lastTimescaleUnits);e.lastTimescaleUnits+=i;let s=_e(e.timeToSampleTable);1===s.sampleCount?(s.sampleDelta=i,s.sampleCount++):s.sampleDelta===i?s.sampleCount++:(s.sampleCount--,e.timeToSampleTable.push({sampleCount:2,sampleDelta:i}))}else e.lastTimescaleUnits=0,e.timeToSampleTable.push({sampleCount:1,sampleDelta:ve(h,e.timescale)})},Vt=new WeakSet,Pt=function(e,t){if("strict"===ne(this,mt).firstTimestampBehavior&&-1===t.lastTimestamp&&0!==e)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${e}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.\n\nIf you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.\n`);if("offset"===ne(this,mt).firstTimestampBehavior&&(e-=t.firstTimestamp),e<t.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${1e6*t.lastTimestamp} to ${1e6*e}).`);return e},Ft=new WeakSet,xt=function(e){if(e.currentChunk){e.currentChunk.offset=ne(this,Et).pos;for(let t of e.currentChunk.sampleData)ne(this,Et).write(t);e.currentChunk.sampleData=null,0!==e.compactlyCodedChunkTable.length&&_e(e.compactlyCodedChunkTable).samplesPerChunk===e.currentChunk.sampleCount||e.compactlyCodedChunkTable.push({firstChunk:e.writtenChunks.length+1,samplesPerChunk:e.currentChunk.sampleCount}),e.writtenChunks.push(e.currentChunk),oe(this,Ut,Wt).call(this)}},Ut=new WeakSet,Wt=function(){ne(this,Et)instanceof it&&ne(this,Et).flush()},Lt=new WeakSet,Bt=function(){if(ne(this,yt))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};class $t{constructor(e,t){this.firstVTimestamp=null,this.firstATimestamp=null,this.startTime=null,this.endTime=null,this.mp4WriterEnable=!0,this.mp4Name=null,this.mp4WriterConf=null,this.currentTimestamp=null,this.totalBytesReceived=0,e&&console.log("mp4writer",t),this._debug=e,this.mp4WriterConf=t,this.startTime=new Date(t.begintime).getTime(),this.endTime=new Date(t.endtime).getTime(),this.mp4Name=t.mp4name,this.endTime>this.startTime&&t.mp4writer&&(this.mp4WriterEnable=!0)}handleDataReceived(e){const t=new Uint8Array(e.data);this.totalBytesReceived+=t.byteLength,null!=this.mp4DateTimer&&clearTimeout(this.mp4DateTimer),this.handleData(t),this.mp4DateTimer=setTimeout((()=>{this.mp4WriterEnable&&this.finish()}),1e4)}handleData(e){if(!this.mp4WriterEnable)return;const t=new DataView(e.buffer),i={StreamType:t.getUint32(0,!1),FrameType:t.getUint32(4,!1),Seq:t.getUint32(8,!1),Secs:t.getBigUint64(12,!1),Msecs:t.getUint32(20,!1),DataLen:t.getUint32(24,!1),Ptsdiff:t.getUint32(28,!1)},s=1000n*i.Secs+BigInt(i.Msecs);if(i.StreamType===F.VIDEO_STREAM_INFO&&i.FrameType===x.VIDEO_FRM_INFO){const i=4096,s={Video:t.getUint32(32,!1),Width:t.getUint32(36,!1),Height:t.getUint32(40,!1),Fps:t.getUint32(44,!1),vExtra:new Uint8Array(e.slice(48,48+i)),vExtraLen:t.getUint32(48+i,!1),Audio:t.getUint32(52+i,!1),aSampleRate:t.getUint32(56+i,!1),aSampleBit:t.getUint32(60+i,!1),aChannels:t.getUint32(64+i,!1),aExtra:new Uint8Array(e.slice(68+i,68+2*i)),aExtraLen:t.getUint32(68+2*i,!1)};return!0===this._debug&&console.log("[WS2] info data:",s),void(this.muxer||(this.muxer=new Kt({target:new Ke,video:{codec:this.getVideoCodecString(s.Video),width:s.Width,height:s.Height},audio:{codec:this.getAudioCodecString(s.Audio),sampleRate:s.aSampleRate,numberOfChannels:s.aChannels},firstTimestampBehavior:"offset"})))}return i.FrameType!==x.VIDEO_FRM_I&&i.FrameType!==x.VIDEO_FRM_P&&i.FrameType!==x.VIDEO_FRM_B||this.handleVodioData(i,s,e),i.StreamType===F.VIDEO_STREAM_AUDIO&&i.FrameType===x.VIDEO_FRM_AUDIO&&this.handleAudioData(i,s,e),null}handleAudioData(e,t,i){let s=BigInt(0);if(null==this.firstATimestamp?this.firstATimestamp=t:s=t-this.firstATimestamp,t+BigInt(1e3)>=this.endTime)return void this.finish();const n=1000n*s,r=i.subarray(32);try{const e=new EncodedAudioChunk({type:"key",timestamp:Number(n),data:r});this.muxer.addAudioChunk(e)}catch(e){console.error("Error adding audio chunk:",e)}}handleVodioData(e,t,i){let s=BigInt(0);if(null==this.firstVTimestamp?(this.firstVTimestamp=t,this.firstATimestamp=t):s=t-this.firstVTimestamp,t+BigInt(1e3)>=this.endTime)return void this.finish();this.currentTimestamp=t;const n=1000n*s,r=i.subarray(32);try{const t=new EncodedVideoChunk({type:this.getFrameType(e.FrameType),timestamp:Number(n),data:r});this.muxer.addVideoChunk(t)}catch(e){}}getFrameType(e){switch(e){case x.VIDEO_FRM_I:return"key";case x.VIDEO_FRM_P:case x.VIDEO_FRM_B:default:return"delta"}}getVideoCodecString(e){switch(e){case P.CODEC_H264:return"avc";case P.CODEC_H265:return"hevc";case P.CODEC_VP9:return"vp9";case P.CODEC_AV1:return"av1";case P.CODEC_MJPEG:default:return"avc"}}getAudioCodecString(e){return e===P.CODEC_AAC?"aac":"opus"}destory(){let e=this.formatWithTimezoneOffset(new Date(Number(this.currentTimestamp)));console.log(e);let t=`{\n        "type": "H5S_MP4_WRITER_CLOSE",\n        "strTime": "${e}"\n       }`;this.mp4WriterConf.callback(t,this.mp4WriterConf.userdata),this.firstVTimestamp=null,this.firstATimestamp=null,this.startTime=null,this.endTime=null,this.muxer=null,this.mp4WriterConf=null}finish(){if(this.muxer&&this.mp4WriterEnable){this.mp4WriterEnable=!1,this.muxer.finalize();let e=this.muxer.target.buffer;this.downloadBlob(new Blob([e])),this.destory()}}downloadBlob(e){let t=window.URL.createObjectURL(e),i=document.createElement("a");i.style.display="none",i.href=t,i.download=this.mp4Name,document.body.appendChild(i),i.click(),window.URL.revokeObjectURL(t)}formatWithTimezoneOffset(e){e||(e=new Date);const t=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0"),o=e.getTimezoneOffset(),h=Math.abs(o);return`${t}-${i}-${s}T${n}:${r}:${a}${o<=0?"+":"-"}${String(Math.floor(h/60)).padStart(2,"0")}:${String(h%60).padStart(2,"0")}`}}class Yt{constructor({videoElement:e,eventEmitter:t}){this.videoWriter=null,this.audioWriter=null,this.videoBuffer=[],this.audioBuffer=[],this.audioClock=0,this.videoElement=e,this.eventEmitter=t,this.videoTrackGenerator=new MediaStreamTrackGenerator({kind:"video"}),this.audioTrackGenerator=new MediaStreamTrackGenerator({kind:"audio"});const i=new MediaStream([this.videoTrackGenerator,this.audioTrackGenerator]);this.videoElement.srcObject=i;try{this.videoElement.play();var s=this.videoElement.play();void 0!==s&&s.then((e=>{})).catch((e=>{}))}catch(e){}this.eventEmitter.on(R,this.inputVideoFrame.bind(this)),this.eventEmitter.on(V,this.inputAudioFrame.bind(this))}destory(){this.eventEmitter.off(R,this.inputVideoFrame.bind(this)),this.eventEmitter.off(V,this.inputAudioFrame.bind(this))}inputVideoFrame(e){this.videoBuffer.push(e),this.processFrames()}inputAudioFrame(e){this.audioBuffer.push(e),this.processFrames()}async processFrames(){for(;this.videoBuffer.length>0;){const e=this.videoBuffer.shift();for(await this.renderFrame(e);this.audioBuffer.length>0;){const t=this.audioBuffer[0],i=t.timestamp-e.timestamp;if(Math.abs(i)<=8e4)await this.renderFrame(t),this.audioBuffer.shift();else{if(!(i<-8e4))break;this.audioBuffer.shift()}}}}async renderFrame(e){let t;e instanceof VideoFrame?(this.videoWriter||(this.videoWriter=this.videoTrackGenerator.writable.getWriter()),t=this.videoWriter):e instanceof AudioData&&(this.audioWriter||(this.audioWriter=this.audioTrackGenerator.writable.getWriter()),t=this.audioWriter);try{await t.write(e)}catch(i){console.error("[WS2] Error when trying to render frame:",i),t.releaseLock(),e instanceof VideoFrame?this.videoWriter=null:e instanceof AudioData&&(this.audioWriter=null)}finally{e.close()}}async renderVideoFrame(e){console.log("renderVideoFrame frame",e),this.videoWriter||(this.videoWriter=this.videoTrackGenerator.writable.getWriter());try{await this.videoWriter.write(e)}catch(e){console.error("Error when trying to render video frame:",e),this.videoWriter.releaseLock(),this.videoWriter=null}finally{e.close()}}async renderAudioFrame(e){console.log("audio frame",e),this.audioWriter||(this.audioWriter=this.audioTrackGenerator.writable.getWriter());try{await this.audioWriter.write(e)}catch(e){console.error("Error when trying to render audio frame:",e),this.audioWriter.releaseLock(),this.audioWriter=null}}}class Qt{constructor(e,t){this.wsSocket=null,this.keepaliveTimerId=null,this.reconnectTimerId=null,this.lastTimeDataRecvived=null,this.totalDataRecvived=BigInt(0),this._h264cpumode=!1,this._jbuffersize=300,this.decwo=null,this.renwo=null,this.mp4Writer=null,this._nSpeed=1,this.eventEmitter=null,this._debug=!0,this.config=e,this._videodom=t,null!=e.consolelog&&"false"===e.consolelog&&(this._debug=!1),null!=e.buffersize&&(this._jbuffersize=e.buffersize),!0===this._debug&&console.log("[WS2] buffer size:",this._jbuffersize),null!=e.h264cpumode&&"true"===e.h264cpumode&&(this._h264cpumode=!0),!0===this._debug&&console.log("[WS2] h264cpumode:",this._h264cpumode),this.bDisConnected=!1,this.bNeedReconnect=!1}getStatus(){if(this.decwo)return this.decwo.getStatus()}setupDecRenderWo(){if(this.closeDecRenderWo(),this.eventEmitter=new k,this.decwo||null==this._videodom||(this.decwo=new H(this._nSpeed,this._h264cpumode,this._jbuffersize,this._debug,this.eventEmitter,this.config.metaconf)),!this.renwo&&null!=this._videodom){const e=this._videodom;this.renwo=new Yt({videoElement:e,eventEmitter:this.eventEmitter})}}setupMp4writer(){this.mp4Writer||(this.mp4Writer=new $t(this._debug,this.config.mp4writerconf))}closeDecRenderWo(){try{this.eventEmitter&&(this.eventEmitter=null),this.decwo&&(this.decwo.destory(),delete this.decwo),this.renwo&&(this.renwo.destory(),delete this.renwo),this.mp4Writer&&(this.mp4Writer.finish(),delete this.mp4Writer),this.decwo=null,this.renwo=null,this.mp4Writer=null}catch(e){!0===this._debug&&console.log(e)}}setupWebSocket(e){!0===this._debug&&console.log("[WS2] start connect to:",e),this.wsSocket=new WebSocket(e),this.wsSocket.binaryType="arraybuffer",this.wsSocket.onopen=this.handleOpen.bind(this),this.wsSocket.onmessage=this.handleMessage.bind(this),this.wsSocket.onclose=this.handleClose.bind(this),this.wsSocket.onerror=this.handleError.bind(this)}connect(e){this._url=e,this.setupWebSocket(e),this.reconnectTimerId=setInterval(this.ReconnectFunction.bind(this),3e3)}start(){try{this.sendMessage({cmd:"H5_START"})}catch(e){!0===this._debug&&console.log(e)}}pause(){try{this.sendMessage({cmd:"H5_PAUSE"})}catch(e){!0===this._debug&&console.log(e)}}resume(){try{this.sendMessage({cmd:"H5_RESUME"})}catch(e){!0===this._debug&&console.log(e)}}seek(e){try{this.sendMessage({cmd:"H5_SEEK",nSeekTime:e})}catch(e){!0===this._debug&&console.log(e)}}moveto(e){try{this.sendMessage({cmd:"H5_MOVETO",strMovetoTime:e})}catch(e){!0===this._debug&&console.log(e)}}speed(e){try{this._nSpeed=e,this.decwo&&this.decwo.setSpeed(e),this.sendMessage({cmd:"H5_SPEED",nSpeed:e})}catch(e){!0===this._debug&&console.log(e)}}handleMessage(e){if(null!=this.mp4DateTimer&&clearTimeout(this.mp4DateTimer),e.data instanceof ArrayBuffer){new Uint8Array(e.data);const t=e.data;this.totalDataRecvived=this.totalDataRecvived+BigInt(e.data.byteLength),this.decwo&&null!=this._videodom&&this.decwo.handleVideoDataReceived({data:t}),this.mp4Writer&&this.mp4Writer.handleDataReceived({data:t})}else{if("string"==typeof e.data)return null!=this.config.pbconf&&null!=this.config.pbconf.callback&&this.config.pbconf.callback(e.data,this.config.pbconf.userdata),void(null!=this.config.mp4writerconf&&null!=this.config.mp4writerconf.callback&&(this.mp4DateTimer=setTimeout((()=>{this.config.mp4writerconf.callback('{\n                        "type": "H5S_MP4_WRITER_FAIL"\n                    }',this.config.mp4writerconf.userdata)}),1e4),this.config.mp4writerconf.callback(e.data,this.config.mp4writerconf.userdata)));!0===this._debug&&console.log("[WS2] Unexpected data type:",e.data)}}sendMessage(e){this.wsSocket&&this.wsSocket.readyState===WebSocket.OPEN?this.wsSocket.send(JSON.stringify(e)):!0===this._debug&&console.log("[WS2] WebSocket is not open. Cannot send message:",e)}disconnect(){this.bDisConnected=!0,clearInterval(this.reconnectTimerId),null!=this.wsSocket&&(this.wsSocket.close(),this.wsSocket=null),this.cleanupKeepalive(),this.closeDecRenderWo(),this.mp4Writer&&(this.mp4Writer.finish(),this.mp4Writer=null)}handleOpen(e){null!=this.config.pbconf&&"true"===this.config.pbconf.autoplay&&this.start(),this.setupKeepalive(),this.setupDecRenderWo(),null!=this.config.mp4writerconf&&this.config.mp4writerconf.mp4writer&&(this.start(),this.setupMp4writer())}handleClose(e){this.cleanupKeepalive(),!0===this._debug&&console.log("[WS2] wsSocket.onclose"),!0===this.bDisConnected?!0===this._debug&&console.log("[WS2] wsSocket.onclose disconnect"):this.bNeedReconnect=!0,this.closeDecRenderWo()}handleError(e){}setupKeepalive(){this.keepaliveTimerId=setInterval(this.keepaliveTimer.bind(this),5e3)}keepaliveTimer(){if(null!=this.lastTimeDataRecvived&&this.totalDataRecvived<=this.lastTimeDataRecvived&&void 0===this.config.pbconf&&void 0===this.config.mp4writerconf)return!0===this._debug&&console.log("[WS2] no data received reconnect..."),this.bNeedReconnect=!0,this.closeDecRenderWo(),void(this.wsSocket&&(this.wsSocket.close(),this.wsSocket=null));this.lastTimeDataRecvived=this.totalDataRecvived;try{this.sendMessage({cmd:"H5_KEEPALIVE"})}catch(e){!0===this._debug&&console.log(e)}}ReconnectFunction(){!0===this.bNeedReconnect&&(!0===this._debug&&console.log("[WS2] Reconnect..."),this.lastTimeDataRecvived=null,this.totalDataRecvived=BigInt(0),this.setupWebSocket(this._url),this.bNeedReconnect=!1)}cleanupKeepalive(){null!==this.keepaliveTimerId&&(clearInterval(this.keepaliveTimerId),this.keepaliveTimerId=null)}}class Zt{constructor(e){console.log("[WS2] version","r2.3.1027.2024"),this.config=e,this._strPosterUri,this._debug=!0,void 0!==this.config.consolelog&&"false"===this.config.consolelog&&(this._debug=!1),this._videoId=this.config.videoid,void 0===this._videoId&&null!=this._videodom?(this._videodom=this.config.videodom,!0===this._debug&&console.log("[WS2] use dom directly",this.config.token)):null!=this._videoId&&(this._videodom=document.getElementById(this._videoId),!0===this._debug&&console.log("[WS2] use videoid",this.config.token)),null!=this.config.pbconf&&"false"==this.config.showposter&&null!=this._videodom?(this._strPosterUri=this.config.protocol+"//"+this.config.host+this.config.rootpath+"api/v1/GetLoadingImage?session="+this.config.session+"&refresh="+Math.floor(1e6*Math.random()),!0===this._debug&&console.log("[WS2] connect src",e.token),this._videodom.setAttribute("poster",this._strPosterUri)):null!=this._videodom&&(this._strPosterUri=this.config.protocol+"//"+this.config.host+this.config.rootpath+"api/v1/GetImage?token="+this.config.token+"&session="+this.config.session+"&refresh="+Math.floor(1e6*Math.random()),!0===this._debug&&console.log("[WS2] connect src",e.token),this._videodom.setAttribute("poster",this._strPosterUri))}connect(){var e="api/v1/h5slinkweb";!0===this._debug&&console.log("[WS2] API path",e);var t="main";void 0===this.config.streamprofile||(t=this.config.streamprofile);var i="false",s='video/mp4; codecs="hev1.1.6.L93.B0, mp4a.40.2"';if("MediaSource"in window&&MediaSource.isTypeSupported(s)?(!0===this._debug&&console.log("[WS2] MIME type or codec: ",s),i="true"):(!0===this._debug&&console.log("[WS2] Unsupported MIME type or codec: ",s),i="false"),void 0===this.config.pbconf&&void 0===this.config.mp4writerconf)e=this.config.rootpath+e+"?token="+this.config.token+"&hevc="+i+"&meta="+this.config.meta+"&profile="+t+"&session="+this.config.session;else if(void 0!==this.config.pbconf&&void 0===this.config.mp4writerconf){var n="false",r="fake";void 0===this.config.pbconf.serverpb||(n=this.config.pbconf.serverpb),void 0===this.config.pbconf.filename||(r=this.config.pbconf.filename);var a=this.config.pbconf.begintime;void 0===this.config.pbconf.moveto||(a=this.config.pbconf.moveto),e=this.config.rootpath+e+"?token="+this.config.token+"&playback=true&hevc="+i+"&profile="+t+"&serverpb="+n+"&begintime="+encodeURIComponent(this.config.pbconf.begintime)+"&endtime="+encodeURIComponent(this.config.pbconf.endtime)+"&moveto="+encodeURIComponent(a)+"&filename="+r+"&session="+this.config.session}else n="false",r="fake",void 0===this.config.mp4writerconf.serverpb||(n=this.config.mp4writerconf.serverpb),a=this.config.mp4writerconf.begintime,e=this.config.rootpath+e+"?token="+this.config.token+"&playback=true&hevc="+i+"&profile="+t+"&serverpb="+n+"&begintime="+encodeURIComponent(this.config.mp4writerconf.begintime)+"&endtime="+encodeURIComponent(this.config.mp4writerconf.endtime)+"&moveto="+encodeURIComponent(a)+"&filename="+r+"&session="+this.config.session;let o;"http:"==this.config.protocol&&(o="ws://"+this.config.host+e),"https:"==this.config.protocol&&(o="wss://"+this.config.host+e),!0===this._debug&&console.log("[WS2] connect to url ",o),this.webSocketManager=new Qt(this.config,this._videodom),this.webSocketManager.connect(o)}disconnect(){!0===this._debug&&console.log("[WS2] disconnect"),this.webSocketManager.disconnect(),this.webSocketManager=null}start(){this.webSocketManager.start()}pause(){this.webSocketManager.pause()}resume(){this.webSocketManager.resume()}seek(e){this.webSocketManager.seek(e)}moveto(e){this.webSocketManager.moveto(e)}speed(e){this.webSocketManager.speed(e)}getStatus(){if(this.webSocketManager)return this.webSocketManager.getStatus()}}class ei{constructor(e){this.wsSocket=null,this.keepaliveTimerId=null,this.reconnectTimerId=null,this.lastTimeDataRecvived=null,this.totalDataRecvived=BigInt(0),this.eventEmitter=null,this._debug=!0,this.config=e,null!=e.consolelog&&"false"===e.consolelog&&(this._debug=!1),this.bDisConnected=!1,this.bNeedReconnect=!1}setupWebSocket(e){!0===this._debug&&console.log("[VED mgr] start connect to:",e),this.wsSocket=new WebSocket(e),this.wsSocket.binaryType="arraybuffer",this.wsSocket.onopen=this.handleOpen.bind(this),this.wsSocket.onmessage=this.handleMessage.bind(this),this.wsSocket.onclose=this.handleClose.bind(this),this.wsSocket.onerror=this.handleError.bind(this)}connect(e){this._url=e,this.setupWebSocket(e),this.reconnectTimerId=setInterval(this.ReconnectFunction.bind(this),3e3)}createWindows(e,t){try{this.sendMessage({type:"VED_CMD_CREATE_WINDOW_REQ",createWindowReq:{nCount:e,nParentHandle:t}})}catch(e){!0===this._debug&&console.log(e)}}moveWindows(e,t){try{this.sendMessage({type:"VED_CMD_MOVE_WINDOW_REQ",session:this._dispSession,moveWindowReq:{animation:t,move:e}})}catch(e){!0===this._debug&&console.log(e)}}showWindows(e){try{this.sendMessage({type:"VED_CMD_SHOW_WINDOW_REQ",session:this._dispSession,winList:{win:e}})}catch(e){!0===this._debug&&console.log(e)}}hideWindows(e){try{this.sendMessage({type:"VED_CMD_HIDE_WINDOW_REQ",session:this._dispSession,winList:{win:e}})}catch(e){!0===this._debug&&console.log(e)}}start(){try{this.sendMessage({cmd:"H5_START"})}catch(e){!0===this._debug&&console.log(e)}}pause(){try{this.sendMessage({cmd:"H5_PAUSE"})}catch(e){!0===this._debug&&console.log(e)}}resume(){try{this.sendMessage({cmd:"H5_RESUME"})}catch(e){!0===this._debug&&console.log(e)}}seek(e){try{this.sendMessage({cmd:"H5_SEEK",nSeekTime:e})}catch(e){!0===this._debug&&console.log(e)}}moveto(e){try{this.sendMessage({cmd:"H5_MOVETO",strMovetoTime:e})}catch(e){!0===this._debug&&console.log(e)}}handleMessage(e){if("string"!=typeof e.data)!0===this._debug&&console.log("[VED mgr] Unexpected data type:",e.data);else if(null!=this.config.vedconf&&null!=this.config.vedconf.callback){try{let t=JSON.parse(e.data);"VED_CMD_EVENT_DISPLAY_SESSION"==t.type&&(this._dispSession=t.session)}catch(e){!0===this._debug&&console.log(e)}this.config.vedconf.callback(e.data,this.config.vedconf.userdata)}}sendMessage(e){if(this.wsSocket&&this.wsSocket.readyState===WebSocket.OPEN){let t=JSON.stringify(e);!0===this._debug&&console.log("[VED mgr] send:",t),this.wsSocket.send(t)}else!0===this._debug&&console.log("[VED mgr] WebSocket is not open. Cannot send message:",e)}disconnect(){this.bDisConnected=!0,clearInterval(this.reconnectTimerId),null!=this.wsSocket&&(this.wsSocket.close(),this.wsSocket=null),this.cleanupKeepalive()}handleOpen(e){null!=this.config.pbconf&&"true"===this.config.pbconf.autoplay&&this.start(),this.setupKeepalive()}handleClose(e){this.cleanupKeepalive(),!0===this._debug&&console.log("[VED mgr] wsSocket.onclose"),!0===this.bDisConnected?!0===this._debug&&console.log("[VED mgr] wsSocket.onclose disconnect"):this.bNeedReconnect=!0}handleError(e){}setupKeepalive(){this.keepaliveTimerId=setInterval(this.keepaliveTimer.bind(this),5e3)}keepaliveTimer(){if(null!=this.lastTimeDataRecvived&&this.totalDataRecvived<=this.lastTimeDataRecvived&&void 0===this.config.vedconf)return!0===this._debug&&console.log("[VED mgr] no data received reconnect..."),this.bNeedReconnect=!0,void(this.wsSocket&&(this.wsSocket.close(),this.wsSocket=null));this.lastTimeDataRecvived=this.totalDataRecvived;try{this.sendMessage({type:"VED_CMD_KEEPALIVE_REQ",session:this._dispSession})}catch(e){!0===this._debug&&console.log(e)}}ReconnectFunction(){!0===this.bNeedReconnect&&(!0===this._debug&&console.log("[VED mgr] Reconnect..."),this.lastTimeDataRecvived=null,this.totalDataRecvived=BigInt(0),this.setupWebSocket(this._url),this.bNeedReconnect=!1)}cleanupKeepalive(){null!==this.keepaliveTimerId&&(clearInterval(this.keepaliveTimerId),this.keepaliveTimerId=null)}}class ti{constructor(e){this.eventEmitter=null,this._debug=!0,this.config=e,null!=e.consolelog&&"false"===e.consolelog&&(this._debug=!1),console.log("[VED] version","r1.0.1127.2024")}connect(){var e="api/v1/vedmgr";if(null==this.config.vedconf)return void console.log("[VED mgr] vedconf undefined");let t;!0===this._debug&&console.log("[VED mgr] API path",e),e=this.config.rootpath+e+"?bgcolorr="+this.config.vedconf.bgcolorr+"&bgcolorg="+this.config.vedconf.bgcolorg+"&bgcolorb="+this.config.vedconf.bgcolorb+"&session="+this.config.session,"http:"==this.config.protocol&&(t="ws://"+this.config.host+e),"https:"==this.config.protocol&&(t="wss://"+this.config.host+e),!0===this._debug&&console.log("[VED mgr] connect to url ",t),this.ws=new ei(this.config),this.ws.connect(t)}createWindows(e,t){this.ws.createWindows(e,t)}moveWindows(e,t){this.ws.moveWindows(e,t)}showWindows(e){this.ws.showWindows(e)}hideWindows(e){this.ws.hideWindows(e)}disconnect(){!0===this._debug&&console.log("[VED ply] disconnect"),this.ws.disconnect(),this.ws=null}}class ii{constructor(e){this.wsSocket=null,this.keepaliveTimerId=null,this.reconnectTimerId=null,this.lastTimeDataRecvived=null,this.totalDataRecvived=BigInt(0),this._nSpeed=1,this.eventEmitter=null,this._debug=!0,this.config=e,null!=e.consolelog&&"false"===e.consolelog&&(this._debug=!1),this.bDisConnected=!1,this.bNeedReconnect=!1}setupWebSocket(e){!0===this._debug&&console.log("[VED ply] start connect to:",e),this.wsSocket=new WebSocket(e),this.wsSocket.binaryType="arraybuffer",this.wsSocket.onopen=this.handleOpen.bind(this),this.wsSocket.onmessage=this.handleMessage.bind(this),this.wsSocket.onclose=this.handleClose.bind(this),this.wsSocket.onerror=this.handleError.bind(this)}connect(e){this._url=e,this.setupWebSocket(e),this.reconnectTimerId=setInterval(this.ReconnectFunction.bind(this),3e3)}start(){try{this.sendMessage({cmd:"H5_START"})}catch(e){!0===this._debug&&console.log(e)}}pause(){try{this.sendMessage({cmd:"H5_PAUSE"})}catch(e){!0===this._debug&&console.log(e)}}resume(){try{this.sendMessage({cmd:"H5_RESUME"})}catch(e){!0===this._debug&&console.log(e)}}seek(e){try{this.sendMessage({cmd:"H5_SEEK",nSeekTime:e})}catch(e){!0===this._debug&&console.log(e)}}moveto(e){try{this.sendMessage({cmd:"H5_MOVETO",strMovetoTime:e})}catch(e){!0===this._debug&&console.log(e)}}speed(e){try{this._nSpeed=e,this.sendMessage({cmd:"H5_SPEED",nSpeed:e})}catch(e){!0===this._debug&&console.log(e)}}handleMessage(e){if(e.data instanceof ArrayBuffer)new Uint8Array(e.data),e.data,this.totalDataRecvived=this.totalDataRecvived+BigInt(e.data.byteLength);else{if("string"==typeof e.data)return void(null!=this.config.pbconf&&null!=this.config.pbconf.callback&&this.config.pbconf.callback(e.data,this.config.pbconf.userdata));!0===this._debug&&console.log("[VED ply] Unexpected data type:",e.data)}}sendMessage(e){this.wsSocket&&this.wsSocket.readyState===WebSocket.OPEN?this.wsSocket.send(JSON.stringify(e)):!0===this._debug&&console.log("[VED ply] WebSocket is not open. Cannot send message:",e)}disconnect(){this.bDisConnected=!0,clearInterval(this.reconnectTimerId),null!=this.wsSocket&&(this.wsSocket.close(),this.wsSocket=null),this.cleanupKeepalive()}handleOpen(e){null!=this.config.pbconf&&"true"===this.config.pbconf.autoplay&&this.start(),this.setupKeepalive()}handleClose(e){this.cleanupKeepalive(),!0===this._debug&&console.log("[VED ply] wsSocket.onclose"),!0===this.bDisConnected?!0===this._debug&&console.log("[VED ply] wsSocket.onclose disconnect"):this.bNeedReconnect=!0}handleError(e){}setupKeepalive(){this.keepaliveTimerId=setInterval(this.keepaliveTimer.bind(this),5e3)}keepaliveTimer(){null!=this.lastTimeDataRecvived&&(this.totalDataRecvived,this.lastTimeDataRecvived),this.lastTimeDataRecvived=this.totalDataRecvived;try{this.sendMessage({cmd:"H5_KEEPALIVE"})}catch(e){!0===this._debug&&console.log(e)}}ReconnectFunction(){!0===this.bNeedReconnect&&(!0===this._debug&&console.log("[VED ply] Reconnect..."),this.lastTimeDataRecvived=null,this.totalDataRecvived=BigInt(0),this.setupWebSocket(this._url),this.bNeedReconnect=!1)}cleanupKeepalive(){null!==this.keepaliveTimerId&&(clearInterval(this.keepaliveTimerId),this.keepaliveTimerId=null)}}class si{constructor(e){this.config=e,this._debug=!0,void 0!==this.config.consolelog&&"false"===this.config.consolelog&&(this._debug=!1)}connect(){var e="api/v1/vedplayer";!0===this._debug&&console.log("[VED ply] API path",e);var t="main";void 0===this.config.streamprofile||(t=this.config.streamprofile);var i="true";if(void 0===this.config.pbconf)e=this.config.rootpath+e+"?token="+this.config.token+"&dispsesssion="+this.config.dispsesssion+"&dispwindow="+this.config.dispwindow+"&serverip="+this.config.serverip+"&serverport="+this.config.serverport+"&serversession="+this.config.serversession+"&serverhttps="+this.config.serverhttps+"&hevc="+i+"&profile="+t+"&session="+this.config.session;else if(void 0!==this.config.pbconf){var s="false",n="fake";void 0===this.config.pbconf.serverpb||(s=this.config.pbconf.serverpb),void 0===this.config.pbconf.filename||(n=this.config.pbconf.filename);var r=this.config.pbconf.begintime;void 0===this.config.pbconf.moveto||(r=this.config.pbconf.moveto),e=this.config.rootpath+e+"?token="+this.config.token+"&playback=true&dispsesssion="+this.config.dispsesssion+"&dispwindow="+this.config.dispwindow+"&serverip="+this.config.serverip+"&serverport="+this.config.serverport+"&serversession="+this.config.serversession+"&serverhttps="+this.config.serverhttps+"&hevc="+i+"&profile="+t+"&serverpb="+s+"&begintime="+encodeURIComponent(this.config.pbconf.begintime)+"&endtime="+encodeURIComponent(this.config.pbconf.endtime)+"&moveto="+encodeURIComponent(r)+"&filename="+n+"&session="+this.config.session}let a;"http:"==this.config.protocol&&(a="ws://"+this.config.host+e),"https:"==this.config.protocol&&(a="wss://"+this.config.host+e),!0===this._debug&&console.log("[VED ply] connect to url ",a),this.webSocketManager=new ii(this.config),this.webSocketManager.connect(a)}disconnect(){!0===this._debug&&console.log("[VED ply] disconnect"),this.webSocketManager.disconnect(),this.webSocketManager=null}start(){this.webSocketManager.start()}pause(){this.webSocketManager.pause()}resume(){this.webSocketManager.resume()}seek(e){this.webSocketManager.seek(e)}moveto(e){this.webSocketManager.moveto(e)}speed(e){this.webSocketManager.speed(e)}}!function(e){e[e.CODEC_PCMU=0]="CODEC_PCMU",e[e.CODEC_PCMA=8]="CODEC_PCMA",e[e.CODEC_G711A=19]="CODEC_G711A",e[e.CODEC_G711U=20]="CODEC_G711U",e[e.CODEC_H264=96]="CODEC_H264",e[e.CODEC_H265=98]="CODEC_H265",e[e.CODEC_MPEG4=97]="CODEC_MPEG4",e[e.CODEC_VP9=99]="CODEC_VP9",e[e.CODEC_AV1=101]="CODEC_AV1",e[e.CODEC_MJPEG=26]="CODEC_MJPEG",e[e.CODEC_AAC=100]="CODEC_AAC",e[e.CODEC_PS=200]="CODEC_PS",e[e.CODEC_G722=201]="CODEC_G722",e[e.CODEC_G726=202]="CODEC_G726",e[e.CODEC_OPUS=203]="CODEC_OPUS",e[e.CODEC_ARAW=204]="CODEC_ARAW",e[e.CODEC_NONE=254]="CODEC_NONE",e[e.CODEC_LAST=1e3]="CODEC_LAST"}(Nt||(Nt={})),function(e){e[e.VIDEO_STREAM_VIDEO=1]="VIDEO_STREAM_VIDEO",e[e.VIDEO_STREAM_AUDIO=2]="VIDEO_STREAM_AUDIO",e[e.VIDEO_STREAM_INFO=3]="VIDEO_STREAM_INFO",e[e.VIDEO_STREAM_TEXT=4]="VIDEO_STREAM_TEXT",e[e.VIDEO_STREAM_SDP=5]="VIDEO_STREAM_SDP",e[e.VIDEO_STREAM_PBEVENT=6]="VIDEO_STREAM_PBEVENT",e[e.VIDEO_STREAM_MUXED=7]="VIDEO_STREAM_MUXED",e[e.VIDEO_STREAM_META_DATA=8]="VIDEO_STREAM_META_DATA",e[e.VIDEO_STREAM_END=9]="VIDEO_STREAM_END",e[e.VIDEO_STREAM_LAST=10]="VIDEO_STREAM_LAST"}(Gt||(Gt={})),function(e){e[e.VIDEO_FRM_NONE=0]="VIDEO_FRM_NONE",e[e.VIDEO_FRM_I=1]="VIDEO_FRM_I",e[e.VIDEO_FRM_P=2]="VIDEO_FRM_P",e[e.VIDEO_FRM_B=3]="VIDEO_FRM_B",e[e.VIDEO_FRM_INFO=4]="VIDEO_FRM_INFO",e[e.VIDEO_FRM_AUDIO=5]="VIDEO_FRM_AUDIO",e[e.VIDEO_FRM_PBTIME=6]="VIDEO_FRM_PBTIME",e[e.VIDEO_FRM_PBPOS=7]="VIDEO_FRM_PBPOS",e[e.VIDEO_FRM_PBEND=8]="VIDEO_FRM_PBEND",e[e.VIDEO_FRM_MUXED=9]="VIDEO_FRM_MUXED",e[e.VIDEO_FRM_TRANS_INFO=10]="VIDEO_FRM_TRANS_INFO",e[e.VIDEO_FRM_PBSPEED=11]="VIDEO_FRM_PBSPEED",e[e.VIDEO_FRM_PBSEEKED=12]="VIDEO_FRM_PBSEEKED",e[e.VIDEO_FRM_PB_PAUSED=13]="VIDEO_FRM_PB_PAUSED",e[e.VIDEO_FRM_LAST=14]="VIDEO_FRM_LAST"}(Ht||(Ht={}));class ni{constructor(e){if(this.videoElement=null,this.videoCodec=null,this.firstTimestamp=null,this.isDecoderConfigured=!1,this.videoTrackGenerator=null,this.audioDecoderConfigured=!1,this.audioDecoder=null,this.audioTrackGenerator=null,this.audioCodec=null,this.audioWriter=null,this.videoElement=e,e){console.log("videoElement",e),this.videoTrackGenerator=new MediaStreamTrackGenerator({kind:"video"}),this.audioTrackGenerator=new MediaStreamTrackGenerator({kind:"audio"}),console.log("videoTrackGenerator",this.videoTrackGenerator);const t=new MediaStream;t.addTrack(this.videoTrackGenerator),t.addTrack(this.audioTrackGenerator),e.srcObject=t}this.initDecoder()}initDecoder(){"VideoDecoder"in window?this.videoDecoder=new VideoDecoder({output:this.handleVideoFrame.bind(this),error:e=>console.error("Video decoder error:",e)}):console.error("VideoDecoder API is not supported."),this.audioDecoder=new AudioDecoder({output:this.handleAudioFrame.bind(this),error:e=>console.error("Audio decoder error:",e)}),console.log("init decoder!!!!!! ")}handleVideoFrame(e){this.videoTrackGenerator?.write(e),e.close()}handleAudioFrame(e){this.audioTrackGenerator?.write(e),e.close()}start(e){console.log("start"),this.ws=new WebSocket(e),this.ws.binaryType="arraybuffer",this.ws.onmessage=e=>{const t=new Uint8Array(e.data);this.handleVideoData(t)}}handleVideoData(e){const t=new DataView(e.buffer),i={StreamType:t.getUint32(0,!1),FrameType:t.getUint32(4,!1),Seq:t.getUint32(8,!1),Secs:t.getBigUint64(12,!1),Msecs:t.getUint32(20,!1),DataLen:t.getUint32(24,!1),Ptsdiff:t.getUint32(28,!1)};null===this.firstTimestamp&&(this.firstTimestamp=1000n*i.Secs+BigInt(i.Msecs));const s=1000n*i.Secs+BigInt(i.Msecs)-this.firstTimestamp;if(i.StreamType===Gt.VIDEO_STREAM_INFO&&i.FrameType===Ht.VIDEO_FRM_INFO){const i=4096,s={Video:t.getUint32(32,!1),Width:t.getUint32(36,!1),Height:t.getUint32(40,!1),Fps:t.getUint32(44,!1),vExtra:new Uint8Array(e.slice(48,48+i)),vExtraLen:t.getUint32(48+i,!1),Audio:t.getUint32(52+i,!1),aSampleRate:t.getUint32(56+i,!1),aSampleBit:t.getUint32(60+i,!1),aChannels:t.getUint32(64+i,!1),aExtra:new Uint8Array(e.slice(68+i,68+2*i)),aExtraLen:t.getUint32(68+2*i,!1)};return console.log("INFO DATA",s),this.aSampleRate=s.aSampleRate,this.aChannels=s.aChannels,this.audioCodec=this.getCodecString(s.Audio),this.videoCodec=this.getCodecString(s.Video),void this.audioDecoder.configure({codec:this.audioCodec,sampleRate:this.aSampleRate,numberOfChannels:this.aChannels})}if(i.StreamType===Gt.VIDEO_STREAM_AUDIO&&i.FrameType===Ht.VIDEO_FRM_AUDIO){const t=new EncodedAudioChunk({type:this.getFrameType(i.FrameType),timestamp:Number(s),data:e});this.audioDecoder&&this.audioDecoder.decode(t)}if(this.videoCodec&&(i.FrameType===Ht.VIDEO_FRM_I||i.FrameType===Ht.VIDEO_FRM_P||i.FrameType===Ht.VIDEO_FRM_B)&&this.isDecoderConfigured){const t=32,n=e.slice(t),r=new EncodedVideoChunk({type:this.getFrameType(i.FrameType),timestamp:Number(s),data:n});this.videoDecoder.decode(r)}}getCodecString(e){switch(e){case Nt.CODEC_PCMU:return"audio/PCMU";case Nt.CODEC_PCMA:case Nt.CODEC_G711A:case Nt.CODEC_G711U:return"audio/PCMA";case Nt.CODEC_H264:return"avc1.42001E";case Nt.CODEC_H265:return"hev1.1.6.L93.B0";case Nt.CODEC_MPEG4:return"video/mp4; codecs=mp4v.20.8";case Nt.CODEC_VP9:return"video/vp9; codecs=vp09.00.10.08";case Nt.CODEC_AV1:return"video/av1; codecs=av01";case Nt.CODEC_MJPEG:return"video/jpeg; codecs=mjpa";case Nt.CODEC_AAC:return"mp4a.40.2";case Nt.CODEC_G722:return"audio/G722";case Nt.CODEC_G726:return"audio/G726";case Nt.CODEC_OPUS:return"audio/opus";case Nt.CODEC_ARAW:return"audio/pcm; codecs=1";default:throw new Error("Unknown codec type")}}getFrameType(e){switch(console.log("frameType",e),e){case Ht.VIDEO_FRM_I:return"key";case Ht.VIDEO_FRM_P:case Ht.VIDEO_FRM_B:default:return"delta"}}toHex(e){return Array.from(e).map((e=>e.toString(16).padStart(2,"0"))).join(" ")}}const ri=e=>e.match(/([^])\1{1,127}|(?:([^])(?!\2)){1,128}/g).map((e=>e[0]===e[1]?String.fromCharCode(257-e.length)+e[0]:String.fromCharCode(e.length-1)+e)).join("");function ai(e){let t="",i=0;for(;i<e.length;){let s=e.charCodeAt(i++);t+=s>128?e[i++].repeat(257-s):s<128?e.slice(i,i+=s+1):""}return t}return a})()));
//# sourceMappingURL=h5jssdk.js.map