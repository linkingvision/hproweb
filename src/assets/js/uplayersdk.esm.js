class t{constructor(t,e){this.container=t.jquery?t[0]:t,this.videoSegments=[],this.videoSegment={},this.playbackRate=1,this.metadata=null,this.lastRenderedIndex=-1,this.conf={protocol:"",host:"",token:"",session:"",accessToken:"",updateTimeline:function(){},updateMainVideo:function(){},updateMetadata:function(){},...e},this.token=this.conf.token,this.videos=[this.createVideoElement("0"),this.createVideoElement("1"),this.createVideoElement("2")],this.currentVideo=this.videos[0],this.currentTime=0,this.timelineCurrentTime=0,this.playing=!1,this.mainVideo=!1,this.initVideos(),this.setupEventListeners(this.currentVideo),this.isSwitchNextVideo=!1,this._pendingRequests=new Map,this._currentRequestId=null,this._videoSwitchInProgress=!1,this._videoLoadedPromises=new WeakMap}createVideoElement(t){const e=document.createElement("video");return this.setVideoStyle(e),e.setAttribute("poster",this.getImage()),e.setAttribute("pos",t),e.playbackRate=this.playbackRate,e}initVideos(){this.videos.forEach((t,e)=>{this.setVideoStyle(t),this.container.appendChild(t)}),this.currentVideo.style.display="block";const t=document.createElement("canvas");t.id="canvas"+this.conf.videoid,t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.top="0",t.style.left="0",t.style.zIndex=1,this.container.appendChild(t)}setVideoStyle(t){t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.top="0",t.style.left="0",t.style.display="none",t.controls=!1,t.muted=!0}setupEventListeners(t){t._myHandlers=t._myHandlers||{},t._myHandlers.timeupdate||(t._myHandlers.timeupdate=()=>this.onTimeUpdate(),t.addEventListener("timeupdate",t._myHandlers.timeupdate)),t._myHandlers.ended||(t._myHandlers.ended=()=>this.onEnded(),t.addEventListener("ended",t._myHandlers.ended)),t._myHandlers.waiting||(t._myHandlers.waiting=()=>this.onWaiting(),t.addEventListener("waiting",t._myHandlers.waiting)),t._myHandlers.playing||(t._myHandlers.playing=()=>this.onPlaying(),t.addEventListener("playing",t._myHandlers.playing)),t._myHandlers.error||(t._myHandlers.error=t=>this.onError(t),t.addEventListener("error",t._myHandlers.error))}removeEventListeners(t){if(t&&t._myHandlers){for(const[e,i]of Object.entries(t._myHandlers))t.removeEventListener(e,i);t._myHandlers={}}}onTimeUpdate(){this.playing&&(this.currentTime=1e3*this.currentVideo.currentTime+new Date(this.videoSegment.starttime).getTime(),this.renderMatadata(this.currentTime),this.timelineCurrentTime=this.currentTime,this.conf.updateTimeline(this.currentTime),this.preloadNext())}renderMatadata(t){if(null==this.metadata)return;let e=this.metadata.metaGroup;this.lastRenderedIndex=this.findMetadataIndexByTimeBinary(t,e),-1!=this.lastRenderedIndex&&this.conf.updateMetadata(e[this.lastRenderedIndex])}findMetadataIndexByTimeBinary(t,e){let i=0,n=e.length-1;for(;i<=n;){const n=new Date(e[i].time).getTime(),s=Math.abs(n-t);if(s<130)return console.log("diff==========>",e[i].time,new Date(t).toISOString(),s,i),i;if(n>t)return-1;i++}return-1}onEnded(){console.log("Ended...",this.token),this.switchNext()}onWaiting(){console.log("[UPlayerSDK] Video buffer, waiting for data ...")}onPlaying(){console.log("[UPlayerSDK] Video starts playing."),this.playing=!0}onError(t){console.warn("[UPlayerSDK] Video playback error:",t)}getImage(){return`${this.conf.protocol}//${this.conf.host}/api/v1/GetLoadingImage?token=${this.conf.token}&session=${this.conf.session}&refresh=${Math.floor(1e6*Math.random())}`}getMainVideo(){return this.mainVideo}setMainVideo(t){this.mainVideo=t}setSegments(t){this.videoSegments=t}getSegments(t){this.getSearchObjRecordByTime(t).then(t=>{t.objects&&(this.videoSegments=t.objects)}).catch(t=>{console.log(t)})}getCurrentIndex(){return this.videoSegments.findIndex(t=>new Date(t.starttime).getTime()==new Date(this.videoSegment.starttime).getTime())}getCurrentTime(){return this.currentTime}setCurrentTime(t){}async getVideoSegment(t,e){e||(e=Symbol("req"));const i=new AbortController;this._pendingRequests.set(e,i),i.signal;try{let n=this.videoSegments.findIndex(e=>e.starttime&&e.endtime&&new Date(e.starttime).getTime()<=t&&t<new Date(e.endtime).getTime());if(i.signal.aborted)throw new Error("aborted");if(-1!==n){const t=this.videoSegments[n];return this._pendingRequests.delete(e),t}const s=await this.getSearchObjRecordByTime(t,i);if(i.signal.aborted)throw new Error("aborted");if(s.objects&&s.objects.length>0){if(this.videoSegments=s.objects,n=this.videoSegments.findIndex(e=>e.starttime&&e.endtime&&new Date(e.starttime).getTime()<=t&&t<new Date(e.endtime).getTime()),-1!==n){const t=this.videoSegments[n];return this._pendingRequests.delete(e),t}if(n=this.videoSegments.findIndex(e=>e.starttime&&new Date(e.starttime).getTime()>t),-1!==n){const t=this.videoSegments[n];return this._pendingRequests.delete(e),t}}throw this._pendingRequests.delete(e),new Error("No suitable video segment found")}catch(t){if(this._pendingRequests.delete(e),"AbortError"===t.name||"aborted"===t.message)throw new Error("Request aborted");throw t}}async setPosition(t){try{if(isNaN(new Date(t)))return console.warn("[UPlayerSDK] Invalid timestamp"),!1;const e="number"==typeof t?t:new Date(t).getTime();if(this.timelineCurrentTime=e,this.videoSegment.starttime&&e>=new Date(this.videoSegment.starttime).getTime()&&e<new Date(this.videoSegment.endtime).getTime()){let t=(e-new Date(this.videoSegment.starttime).getTime())/1e3;const i=this.currentVideo&&!isNaN(this.currentVideo.duration)?this.currentVideo.duration:NaN;if(!isNaN(i)&&t>=0&&t<=i+.5){try{this.currentVideo.currentTime=t}catch(e){console.warn("[UPlayerSDK] set currentTime failed, will try after loadedmetadata",e),await new Promise(t=>{const e=()=>{t(),this.currentVideo.removeEventListener("loadedmetadata",e)};this.currentVideo.addEventListener("loadedmetadata",e,{once:!0})}),this.currentVideo.currentTime=t}return this.currentTime=e,!0}try{return this.currentVideo.currentTime=t,await Promise.race([new Promise(t=>{if(this.currentVideo.readyState>=2)return t();const e=()=>{t(),this.currentVideo.removeEventListener("loadedmetadata",e)};this.currentVideo.addEventListener("loadedmetadata",e,{once:!0})}),new Promise((t,e)=>setTimeout(()=>e(new Error("timeout waiting metadata")),3e3))]),this.currentTime=e,!0}catch(t){return console.warn("[UPlayerSDK] seek-in-segment metadata wait failed",t),this.currentTime=e,!0}}const i=Symbol("posReq");this._currentRequestId=i;for(const[t,e]of this._pendingRequests.entries()){try{e.abort()}catch(t){}this._pendingRequests.delete(t)}if(this._videoSwitchInProgress&&(await new Promise(t=>setTimeout(t,100)),this._currentRequestId!==i))return!1;this._videoSwitchInProgress=!0;const n=await this.getVideoSegment(e,i);if(this._currentRequestId!==i)return this._videoSwitchInProgress=!1,!1;if(!n||!n.url)return console.warn("[UPlayerSDK] No valid video segment found"),this._videoSwitchInProgress=!1,!1;const s=this.container.querySelector('[pos="0"]'),r=this.container.querySelector('[pos="1"]'),o=this.container.querySelector('[pos="2"]');if(!r)return console.warn("[UPlayerSDK] Next video element not found"),this._videoSwitchInProgress=!1,!1;if(this.removeEventListeners(s),r._loadedCancel)try{r._loadedCancel()}catch(t){}if(r.pause(),r.currentTime=0,r.src!==n.url){"/api"==n.url.slice(0,4)?(r.src=this.conf.protocol+"//"+this.conf.host+n.url+"&session="+this.conf.session,console.log("setPosition url =>",r.src)):r.src=n.url,r.preload="auto"}const a=new Promise((t,e)=>{const i=setTimeout(()=>e(new Error("Timeout loading video")),5e3),n=()=>{clearTimeout(i),t()},s=t=>{clearTimeout(i),e(new Error("Video load error"))};if(r.readyState>=3)return clearTimeout(i),void t();r.addEventListener("loadeddata",n,{once:!0}),r.addEventListener("error",s,{once:!0}),r._loadedCancel=()=>{clearTimeout(i),r.removeEventListener("loadeddata",n),r.removeEventListener("error",s),e(new Error("loaded canceled"))}});if(await a,this._currentRequestId!==i)return this._videoSwitchInProgress=!1,!1;r.playbackRate=this.playbackRate;const l=Math.max(0,(e-new Date(n.starttime).getTime())/1e3);return isNaN(r.duration)?r.currentTime=l:r.currentTime=Math.min(l,r.duration||l),r.style.display="block",s.style.display="none",s.setAttribute("pos","2"),r.setAttribute("pos","0"),o.setAttribute("pos","1"),this.currentVideo=r,this.videoSegment=n,this.setupEventListeners(r),setTimeout(()=>{if("2"===s.getAttribute("pos"))try{s.src="",s.load()}catch(t){}},500),this.currentTime=e,this.isSwitchNextVideo=!0,this._videoSwitchInProgress=!1,!0}catch(t){return this._videoSwitchInProgress=!1,console.warn("[UPlayerSDK] =>  error",t),!1}}play(){if(this.currentVideo)try{const t=this.currentVideo.play();t&&"function"==typeof t.then?t.then(()=>console.log("[UPlayerSDK] Video is playing...")).catch(t=>console.warn("[UPlayerSDK] play rejected:",t)):console.log("[UPlayerSDK] Video is playing...");const e=this.videoSegment.metaurl.slice(0,4);let i="";i="/api"==e?this.conf.protocol+"//"+this.conf.host+this.videoSegment.metaurl+"&session="+this.conf.session:this.videoSegment.metaurl,this.getMetadata(i)}catch(t){console.warn("[UPlayerSDK] play error",t)}}pause(){if(this.currentVideo){try{this.currentVideo.pause()}catch(t){}this.playing=!1}}close(){this.pause(),this.videos.forEach(t=>{this.removeEventListeners(t)}),this.videos.forEach(t=>{try{t.src="",t.load()}catch(t){}}),this.videoSegments=[],this.videoSegment={},this.currentTime=0}destroy(){for(this.close();this.container.firstChild;)this.container.removeChild(this.container.firstChild);this.videos=[],this.currentVideo=null,console.log("[UPlayerSDK] The player has been destroyed")}setPlaybackRate(t){console.log(`[UPlayerSDK] Switch to ${t} speed`),this.playbackRate=t,this.currentVideo&&(this.currentVideo.playbackRate=t)}preloadNext(){try{if(!this.currentVideo)return;if(this.currentVideo.duration-this.currentVideo.currentTime<.3*this.currentVideo.duration){let t=this.getCurrentIndex();if(t+1>=this.videoSegments.length)return void this.getSegments(this.videoSegment.endtime);const e=this.container.querySelector('[pos="1"]'),i=this.videoSegments[t+1].url.slice(0,4);let n="",s="";if("/api"==i?(n=this.conf.protocol+"//"+this.conf.host+this.videoSegments[t+1].url+"&session="+this.conf.session,s=this.conf.protocol+"//"+this.conf.host+this.videoSegments[t+1].metaurl+"&session="+this.conf.session):(n=this.videoSegments[t+1].url,s=this.videoSegments[t+1].metaurl),e.src!=n){if(e._loadedCancel){try{e._loadedCancel()}catch(t){}e._loadedCancel=null}e.src=n,e.preload="auto";const t=new Promise(t=>{if(e.readyState>=2)return t();const i=()=>{t(),e.removeEventListener("loadeddata",i)};e.addEventListener("loadeddata",i,{once:!0})});this._videoLoadedPromises.set(e,t)}}}catch(t){console.warn("[UPlayerSDK] preloadNext exception",t)}}async switchNext(){this.playing=!1;let t=this.getCurrentIndex();if(t+1>=this.videoSegments.length)return;this.videoSegment=this.videoSegments[t+1];const e=this.container.querySelector('[pos="0"]'),i=this.container.querySelector('[pos="1"]'),n=this.container.querySelector('[pos="2"]');try{i&&this._videoLoadedPromises.get(i)&&await this._videoLoadedPromises.get(i)}catch(t){return void console.warn("[UPlayerSDK] preload next failed",t)}this.removeEventListeners(e),i.playbackRate=this.playbackRate,i.style.display="block",e.style.display="none",setTimeout(()=>{try{e.src="",e.load()}catch(t){}},500),this.currentVideo=i,this.setupEventListeners(i),e.setAttribute("pos","2"),i.setAttribute("pos","0"),n.setAttribute("pos","1"),console.log("[UPlayerSDK] not switchNext",new Date(this.videoSegment.starttime).getTime(),this.timelineCurrentTime,new Date(this.videoSegment.starttime).getTime()-this.timelineCurrentTime),new Date(this.videoSegment.starttime).getTime()-this.timelineCurrentTime<1e3?this.play():(this.currentTime=new Date(this.videoSegment.starttime).getTime(),this.mainVideo&&(this.setMainVideo(!1),this.conf.updateMainVideo()))}async setTimelineCurrentTime(t){const e="number"==typeof t?t:new Date(t).getTime();this.timelineCurrentTime=e,!this.playing&&e-this.currentTime>0&&(console.log("[UPlayerSDK] synchronous video 1",this.currentTime,e,e-this.currentTime),this.play()),this.playing&&e-this.currentTime>500&&(console.log("UPlayerSDK] synchronous video 2",this.currentTime,e,this.currentTime-e),await this.setPosition(e),this.play())}getSearchObjRecordByTime(t,e){const i=new Date(t).getTime()-3e6;let n;const s={"Content-Type":"application/json"};this.conf.accessToken?(n=`${this.conf.protocol}//${this.conf.host}/api/v1/SearchObjRecordByTime?token=${this.conf.token}&start=${new Date(i).toISOString()}&maxlen=200`,s.Authorization=`Bearer ${this.conf.accessToken}`):n=`${this.conf.protocol}//${this.conf.host}/api/v1/SearchObjRecordByTime?token=${this.conf.token}&start=${new Date(i).toISOString()}&maxlen=200&session=${this.conf.session}`;const r=e||new AbortController;return fetch(n,{method:"GET",headers:s,signal:r.signal}).then(t=>t.json())}getMetadata(t){const e={"Content-Type":"application/json"};this.conf.accessToken&&(e.Authorization=`Bearer ${this.conf.accessToken}`),fetch(t,{method:"GET",headers:e}).then(t=>t.json()).then(t=>{console.log(t),this.metadata=t})}}var i,n={exports:{}};var s=i?n.exports:(i=1,self,n.exports=(()=>{var t={477:t=>{t.exports=function(t,e,i,n){var s=self||window;try{try{var r;try{r=new s.Blob([t])}catch(e){(r=new(s.BlobBuilder||s.WebKitBlobBuilder||s.MozBlobBuilder||s.MSBlobBuilder)).append(t),r=r.getBlob()}var o=s.URL||s.webkitURL,a=o.createObjectURL(r),l=new s[e](a,i);return o.revokeObjectURL(a),l}catch(n){return new s[e]("data:application/javascript,".concat(encodeURIComponent(t)),i)}}catch(t){if(!n)throw Error("Inline worker is not supported");return new s[e](n,i)}}}},e={};function i(n){var s=e[n];if(void 0!==s)return s.exports;var r=e[n]={exports:{}};return t[n](r,r.exports,i),r.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var n in e)i.o(e,n)&&!i.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n={};return(()=>{i.r(n),i.d(n,{AiDraw:()=>c,H5sPlayerWS2:()=>qe,PackBitsCompress:()=>ni,PackBitsDecompress:()=>si,TestVideo:()=>ii,VedDispMgr:()=>Qe,VedDispPlayer:()=>ei,Video:()=>P});class t{}var e,s,r;!function(t){t[t.AB=0]="AB",t[t.BA=1]="BA",t[t.BOTH=2]="BOTH",t[t.NONE=3]="NONE"}(e||(e={}));class o extends t{constructor(t){super(),this.endpointRadius=5,this.isHighlighted=!1,this.arrowDirection=e.AB,this.start=t.point[0],this.end=t.point[1],this.lineWidth=t.lineWidth||3,this.color=t.color||"rgb(18,156,250)",this.countEnable=t.countEnable||!1,this.highlightColor=t.highlightColor||"#FFDC00",this.id=t.uuid||o.lastId++,this.name=t.name||`ID-${this.id}`,this.enter=t.enter||0,this.leave=t.leave||0,this.count=t.count||1}updateEnd(t){this.end=t}getEndpointRadius(){return this.endpointRadius}static setStyleConfig(t,e=!1){e?o.highlightStyle={...o.highlightStyle,...t}:o.style={...o.style,...t}}draw(t){t.beginPath(),t.moveTo(this.start.x,this.start.y),t.lineTo(this.end.x,this.end.y),t.strokeStyle=this.isHighlighted?o.highlightStyle.color:o.style.color,t.lineWidth=this.isHighlighted?o.highlightStyle.lineWidth:o.style.lineWidth,t.lineWidth=this.lineWidth,t.stroke(),this.drawEndpoint(t,this.start),this.drawEndpoint(t,this.end),this.drawLabels(t),this.drawArrows(t),this.countEnable&&this.setEnterLeave(t)}drawEndpoint(t,e){t.beginPath(),t.arc(e.x,e.y,o.style.endpointRadius,0,2*Math.PI,!1),t.fillStyle=this.isHighlighted?o.highlightStyle.color:o.style.color,t.fill()}drawLabels(t){const e=this.end.x-this.start.x,i=this.end.y-this.start.y,n=Math.sqrt(i*i+e*e),s=i/n,r=-e/n,o=this.start.x+20*s,a=this.start.y+20*r,l=this.start.x-20*s,h=this.start.y-20*r;t.fillStyle="black",t.font="14px Arial",t.fillText("A",o,a),t.fillText("B",l,h)}setEnterLeave(t){t.strokeStyle="rgba(168, 168, 168, 0.8)",t.roundRect(110*(this.count-1)+10,10,110,70,4),t.fillStyle="rgba(168, 168, 168, 0.8)",t.fill(),t.stroke(),t.fillStyle="#29FF00",t.fillText("Name："+this.name,20+110*(this.count-1),30),t.fillStyle="#f5ff00",t.fillText("Enter："+this.enter,20+110*(this.count-1),50),t.fillStyle="#00FDFF",t.fillText("Leave："+this.leave,20+110*(this.count-1),70)}setEnterLeaveCount(t,e){this.enter=t,this.leave=e}drawArrows(t){const i=this.end.x-this.start.x,n=this.end.y-this.start.y,s=Math.sqrt(i*i+n*n),r=-n/s,a=i/s,l={x:(this.start.x+this.end.x)/2,y:(this.start.y+this.end.y)/2},h=s/2,c=Math.min(20,h),d=(e,i)=>{const n=l,s={x:l.x+r*c*(e===this.start?1:-1),y:l.y+a*c*(e===this.start?1:-1)};t.beginPath(),t.moveTo(n.x,n.y),t.lineTo(s.x,s.y),t.stroke();const h=Math.atan2(i.y-e.y,i.x-e.x);t.translate(s.x,s.y),t.rotate(h+Math.PI/2),t.beginPath(),t.moveTo(0,0),t.lineTo(-5,5),t.lineTo(-5,-5),t.closePath(),t.fillStyle=this.isHighlighted?o.highlightStyle.color:o.style.color,t.fill(),t.resetTransform(),t.beginPath()};switch(this.arrowDirection){case e.AB:d(this.start,this.end);break;case e.BA:d(this.end,this.start);break;case e.BOTH:d(this.start,this.end),d(this.end,this.start);case e.NONE:}}setHighlight(t){this.isHighlighted=t}toggleHighlight(){this.isHighlighted=!this.isHighlighted}contains(t){const e=Math.sqrt(Math.pow(this.start.x-t.x,2)+Math.pow(this.start.y-t.y,2)),i=Math.sqrt(Math.pow(this.end.x-t.x,2)+Math.pow(this.end.y-t.y,2)),n=this.distanceFromPointToLineSegment(t,this.start,this.end);return e<=this.endpointRadius||i<=this.endpointRadius||n<5}distanceFromPointToLineSegment(t,e,i){const n=t.x-e.x,s=t.y-e.y,r=i.x-e.x,o=i.y-e.y,a=r*r+o*o;let l,h,c=-1;0!==a&&(c=(n*r+s*o)/a),c<0?(l=e.x,h=e.y):c>1?(l=i.x,h=i.y):(l=e.x+c*r,h=e.y+c*o);const d=t.x-l,u=t.y-h;return Math.sqrt(d*d+u*u)}getCenter(){return{x:(this.start.x+this.end.x)/2,y:(this.start.y+this.end.y)/2}}setArrowDirection(t){this.arrowDirection=t}getArrowDirection(){return this.arrowDirection}setStart(t){this.start=t}setEnd(t){this.end=t}getStart(){return this.start}getEnd(){return this.end}getID(){return this.id}getName(){return this.name}setName(t){this.name=t}}o.lastId=0,o.style={lineWidth:3,color:"rgb(18,156,250)",highlightColor:"#FFDC00",endpointRadius:5},o.highlightStyle={lineWidth:3,color:"#FFDC00",highlightColor:"#FFDC00",endpointRadius:5};class a extends t{constructor(t={}){super(),this.vertices=[],this.isHighlighted=!1,this.isClosed=!1,this.polygon=0,this.id=t.id||a.lastId++,this.name=t.name||`ID-${this.id}`,t.vertices&&(this.vertices=t.vertices)}setWarnEnable(t){t?this.polygon+=1:this.polygon-=1,this.polygon>0?this.warnEnable=!0:(this.polygon=0,this.warnEnable=!1)}static setStyleConfig(t,e=!1){e?a.highlightStyle={...a.highlightStyle,...t}:a.style={...a.style,...t}}draw(t){let e=this.isHighlighted?a.highlightStyle:a.style;if(this.warnEnable&&(e=a.warnStyle),0!==this.vertices.length)if(1!==this.vertices.length){t.beginPath(),t.moveTo(this.vertices[0].x,this.vertices[0].y);for(let e=1;e<this.vertices.length;e++)t.lineTo(this.vertices[e].x,this.vertices[e].y);this.vertices.length>2&&(t.closePath(),t.fillStyle=e.fillColor,t.fill()),t.strokeStyle=e.lineColor,t.lineWidth=e.lineWidth,t.stroke();for(const i of this.vertices)this.drawVertex(t,i,e)}else this.drawVertex(t,this.vertices[0],e)}drawVertex(t,e,i){const n=i.vertexRadius;t.beginPath(),t.arc(e.x,e.y,n,0,2*Math.PI),t.fillStyle="white",t.fill(),t.strokeStyle=i.lineColor,t.lineWidth=1,t.stroke()}addVertex(t){return(this.vertices.length<2||this.vertices.length>=2&&!this.doesIntersect(t))&&(this.vertices.push(t),!0)}doesIntersect(t){for(let e=0;e<this.vertices.length;e++){let i=!1;for(let n=0;n<this.vertices.length-1;n++)if(n!==e&&n+1!==e&&this.checkIntersect(this.vertices[e],t,this.vertices[n],this.vertices[n+1])){i=!0;break}if(!i)return!1}return!0}checkIntersect(t,e,i,n){let s=this.getOrientation(t,e,i),r=this.getOrientation(t,e,n),o=this.getOrientation(i,n,t),a=this.getOrientation(i,n,e);return s!==r&&o!==a||!(0!==s||!this.isOnSegment(t,i,e))||!(0!==r||!this.isOnSegment(t,n,e))||!(0!==o||!this.isOnSegment(i,t,n))||!(0!==a||!this.isOnSegment(i,e,n))}isSelfIntersecting(){const t=this.vertices.length;for(let e=0;e<t;e++)for(let i=e+1;i<t;i++)if((0!==e||i!==t-1)&&this.doIntersect(this.vertices[e],this.vertices[(e+1)%t],this.vertices[i],this.vertices[(i+1)%t]))return!0;return!1}getOrientation(t,e,i){let n=(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y);return 0===n?0:n>0?1:2}getName(){return this.name}setName(t){this.name=t}getID(){return this.id}setHighlight(t){this.isHighlighted=t}getVertices(){return this.vertices}edgeClicked(t,e=5){for(let i=0;i<this.vertices.length;i++){const n=(i+1)%this.vertices.length;if(this.distanceToSegment(t,this.vertices[i],this.vertices[n])<e)return i}return-1}distanceToSegment(t,e,i){const n=Math.pow(e.x-i.x,2)+Math.pow(e.y-i.y,2);if(0===n)return this.distance(t,e);let s=((t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y))/n;return s=Math.max(0,Math.min(1,s)),this.distance(t,{x:e.x+s*(i.x-e.x),y:e.y+s*(i.y-e.y)})}distance(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}closePolygon(){this.isClosed=!0}contains(t){let e=0;for(let i=0;i<this.vertices.length;i++){let n=(i+1)%this.vertices.length;this.doIntersect(t,{x:Number.MAX_VALUE,y:t.y},this.vertices[i],this.vertices[n])&&e++}return e%2==1}doIntersect(t,e,i,n){let s=this.getOrientation(t,e,i),r=this.getOrientation(t,e,n),o=this.getOrientation(i,n,t),a=this.getOrientation(i,n,e);return s!==r&&o!==a||!(0!==s||!this.isOnSegment(t,i,e))||!(0!==r||!this.isOnSegment(t,n,e))||!(0!==o||!this.isOnSegment(i,t,n))||!(0!==a||!this.isOnSegment(i,e,n))}isOnSegment(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}move(t,e){for(let i of this.vertices)i.x+=t,i.y+=e}updateVertex(t,e){t>=0&&t<this.vertices.length&&(this.vertices[t]=e)}deleteVertex(t){t>=0&&t<this.vertices.length&&this.vertices.splice(t,1)}isPolygonClosed(){return this.isClosed}distanceToPoint(t){if(this.contains(t))return 0;let e=Number.MAX_VALUE;for(let i=0;i<this.vertices.length;i++){let n=(i+1)%this.vertices.length,s=this.distanceToSegment(t,this.vertices[i],this.vertices[n]);s<e&&(e=s)}return e}squaredDistance(t,e){return(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)}isPointNearVertex(t,e=5){for(const i of this.vertices)if(Math.sqrt(this.squaredDistance(t,i))<e)return!0;return!1}isPointOnEdge(t,e=5){for(let i=0;i<this.vertices.length;i++){let n=(i+1)%this.vertices.length;if(this.distanceToSegment(t,this.vertices[i],this.vertices[n])<e)return!0}return!1}}a.lastId=0,a.style={vertexColor:"white",vertexRadius:5,lineColor:"#00D9FF",fillColor:"rgba(0, 217, 255, 0.2)",lineWidth:1},a.highlightStyle={vertexColor:"white",vertexRadius:5,lineColor:"#FCFF00",fillColor:"rgba(255, 255, 0, 0.2)",lineWidth:1},a.warnStyle={vertexColor:"white",vertexRadius:5,lineColor:"red",fillColor:"rgba(255, 0, 0, 0.2)",lineWidth:1};class l{constructor(t){this.canvas=t,this.shapes=[],this.isDrawing=!1,this.tempShape=null}addShape(t){this.shapes.push(t),this.redraw()}startDrawing(){this.isDrawing=!0}stopDrawing(){this.isDrawing=!1,this.tempShape&&(this.addShape(this.tempShape),this.tempShape=null)}setTempShape(t){this.tempShape=t,this.redraw()}getIsDrawing(){return this.isDrawing}redraw(){const t=this.canvas.getContext("2d");if(t){t.clearRect(0,0,this.canvas.width,this.canvas.height);for(const e of this.shapes)e.draw(t);this.tempShape&&this.tempShape.draw(t)}}getShapes(){return this.shapes}deleteShape(t){const e=this.shapes.indexOf(t);e>-1&&(this.shapes.splice(e,1),this.redraw())}clear(){this.shapes=[],this.tempShape=null,this.redraw()}}!function(t){t[t.LINE=0]="LINE",t[t.POLYGON=1]="POLYGON"}(s||(s={}));class h{constructor(t,i){this.canvasManager=t,this.isDrawing=!1,this.canDraw=!1,this.startPoint=null,this.highlightedLine=null,this.highlightedPolygon=null,this.draggingEndpoint=null,this.isDraggingLine=!1,this.dragOffset=null,this.defaultArrowDirection=e.AB,this.currentPolygon=null,this.drawMode=s.LINE,this.isPolygonCompleted=!1,this.activePointIndex=null,this.isDraggingPolygon=!1,this.selectedVertexIndex=null,this.onShapeDrawnCallback=i,this.initializeEventHandlers()}setOnShapeDrawnCallback(t){this.onShapeDrawnCallback=t}setDefaultArrowDirection(t){this.defaultArrowDirection=t}enableDrawing(t){if(this.canDraw=t,!t){this.isDrawing=!1,this.draggingEndpoint=null,this.currentPolygon=null;const t=this.canvasManager.getShapes();for(const e of t)e instanceof a&&e.getVertices().length<3&&this.canvasManager.deleteShape(e);this.onShapeDrawnCallback&&this.onShapeDrawnCallback()}}setDrawMode(t){this.drawMode=t}initializeEventHandlers(){this.canvasManager.canvas.addEventListener("mousedown",t=>this.handleMouseDown(t)),this.canvasManager.canvas.addEventListener("mousemove",t=>this.handleMouseMove(t)),this.canvasManager.canvas.addEventListener("mouseup",t=>this.handleMouseUp(t)),this.canvasManager.canvas.addEventListener("click",t=>this.handleClick(t)),this.canvasManager.canvas.addEventListener("dblclick",t=>this.handleDoubleClick(t)),this.canvasManager.canvas.addEventListener("contextmenu",t=>this.handleRightClick(t))}handleDoubleClick(t){this.drawMode,s.POLYGON}handleRightClick(t){if(t.preventDefault(),this.drawMode===s.POLYGON&&this.currentPolygon){const e=t.clientX-this.canvasManager.canvas.getBoundingClientRect().left,i=t.clientY-this.canvasManager.canvas.getBoundingClientRect().top;if(console.log("this.drawMode",this.drawMode,this.drawMode===s.POLYGON,"this.canDraw",this.canDraw,t.button),2===t.button&&this.drawMode===s.POLYGON){const t=this.canvasManager.getShapes().filter(t=>t instanceof a);for(const n of t)if(n.contains({x:e,y:i})||n.isPointOnEdge({x:e,y:i})){this.currentPolygon=n;const t=this.currentPolygon.getVertices().findIndex(t=>Math.sqrt(Math.pow(t.x-e,2)+Math.pow(t.y-i,2))<10);this.currentPolygon.deleteVertex(t),this.canvasManager.redraw();break}}}}stopDrawingPolygon(){this.drawMode===s.POLYGON&&this.currentPolygon&&(this.currentPolygon.closePolygon(),this.currentPolygon=null,this.canvasManager.redraw())}isPointNearSegment(t,e,i,n=5){const s=Math.pow(i.x-e.x,2)+Math.pow(i.y-e.y,2);if(0===s)return!1;const r=((t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y))/s;if(r<0||r>1)return!1;const o=e.x+r*(i.x-e.x),a=e.y+r*(i.y-e.y);return Math.sqrt(Math.pow(o-t.x,2)+Math.pow(a-t.y,2))<=n}handleMouseDown(t){if(0!==t.button)return;const e=t.clientX-this.canvasManager.canvas.getBoundingClientRect().left,i=t.clientY-this.canvasManager.canvas.getBoundingClientRect().top;if(this.drawMode===s.LINE)if(this.canDraw)this.isDrawing=!0,this.startPoint={x:e,y:i};else if(this.highlightedLine){const t=Math.sqrt(Math.pow(this.highlightedLine.getStart().x-e,2)+Math.pow(this.highlightedLine.getStart().y-i,2)),n=Math.sqrt(Math.pow(this.highlightedLine.getEnd().x-e,2)+Math.pow(this.highlightedLine.getEnd().y-i,2));t<=this.highlightedLine.getEndpointRadius()?this.draggingEndpoint="start":n<=this.highlightedLine.getEndpointRadius()?this.draggingEndpoint="end":(this.isDraggingLine=!0,this.dragOffset={x:e-this.highlightedLine.getCenter().x,y:i-this.highlightedLine.getCenter().y})}if(this.drawMode===s.POLYGON){if(!this.canDraw){console.log("no draw");const t=this.canvasManager.getShapes().filter(t=>t instanceof a);for(const n of t)if(n.contains({x:e,y:i})||n.isPointOnEdge({x:e,y:i})){this.currentPolygon=n,this.isDraggingPolygon=!0,this.dragOffset={x:e,y:i};break}}if(!this.currentPolygon&&this.canDraw)console.log("current"),this.currentPolygon=new a,this.canvasManager.addShape(this.currentPolygon),this.currentPolygon.addVertex({x:e,y:i}),this.canvasManager.redraw();else if(this.currentPolygon){console.log("has ");const t=this.currentPolygon.getVertices().findIndex(t=>Math.sqrt(Math.pow(t.x-e,2)+Math.pow(t.y-i,2))<10);if(-1!==t&&this.currentPolygon.getVertices().length>=3)this.selectedVertexIndex=t;else{let t=!1;const n=this.currentPolygon.getVertices();for(let s=0;s<n.length;s++){let r=(s+1)%n.length;if(this.isPointNearSegment({x:e,y:i},n[s],n[r])){t=!0,this.canDraw&&(this.currentPolygon.getVertices().splice(r,0,{x:e,y:i}),this.canvasManager.redraw());break}}if(!t)if(this.canDraw)this.canDraw&&(this.currentPolygon.addVertex({x:e,y:i}),console.log("add new point"),this.canvasManager.redraw());else{const t=this.canvasManager.getShapes().filter(t=>t instanceof a);for(const n of t)if(!this.isDrawing&&(n.contains({x:e,y:i})||n.isPointOnEdge({x:e,y:i}))){this.currentPolygon=n,this.isDraggingPolygon=!0,this.dragOffset={x:e,y:i};break}}}}}}setDrawingPolygon(t,e){this.drawMode=s.POLYGON;let i={id:e};this.currentPolygon=new a(i),this.canvasManager.addShape(this.currentPolygon);for(let e=0;e<t.length;e++)this.currentPolygon.addVertex({x:t[e].x,y:t[e].y});this.canvasManager.redraw(),this.enableDrawing(!1)}setDrawingLines(t){this.drawMode=s.LINE;const e=new o(t);e.setArrowDirection(this.defaultArrowDirection),this.canvasManager.addShape(e),this.isDrawing=!1,this.startPoint=null}handleMouseMove(t){const e=t.clientX-this.canvasManager.canvas.getBoundingClientRect().left,i=t.clientY-this.canvasManager.canvas.getBoundingClientRect().top;if(this.drawMode===s.LINE)if(this.canDraw&&this.isDrawing&&this.startPoint){const t={x:e,y:i};let n={point:[this.startPoint,t]};const s=new o(n);s.setArrowDirection(this.defaultArrowDirection),this.canvasManager.redraw(),s.draw(this.canvasManager.canvas.getContext("2d"))}else if(this.draggingEndpoint&&this.highlightedLine)"start"===this.draggingEndpoint?this.highlightedLine.setStart({x:e,y:i}):this.highlightedLine.setEnd({x:e,y:i}),this.canvasManager.redraw();else if(this.isDraggingLine&&this.highlightedLine){const t={x:this.highlightedLine.getStart().x+e-(this.highlightedLine.getCenter().x+(this.dragOffset?.x||0)),y:this.highlightedLine.getStart().y+i-(this.highlightedLine.getCenter().y+(this.dragOffset?.y||0))},n={x:this.highlightedLine.getEnd().x+e-(this.highlightedLine.getCenter().x+(this.dragOffset?.x||0)),y:this.highlightedLine.getEnd().y+i-(this.highlightedLine.getCenter().y+(this.dragOffset?.y||0))};this.highlightedLine.setStart(t),this.highlightedLine.setEnd(n),this.canvasManager.redraw()}else{const t=this.canvasManager.getShapes().find(t=>t instanceof o&&t.contains({x:e,y:i}));t?(this.highlightedLine&&this.highlightedLine.setHighlight(!1),t.setHighlight(!0),this.highlightedLine=t,this.canvasManager.redraw()):this.highlightedLine&&(this.highlightedLine.setHighlight(!1),this.highlightedLine=null,this.canvasManager.redraw())}if(this.drawMode===s.POLYGON){const t=this.canvasManager.getShapes().find(t=>t instanceof a&&(t.contains({x:e,y:i})||t.isPointOnEdge({x:e,y:i})));if(t?(this.highlightedPolygon&&this.highlightedPolygon.setHighlight(!1),t.setHighlight(!0),this.highlightedPolygon=t,this.canvasManager.redraw()):this.highlightedPolygon&&(this.highlightedPolygon.setHighlight(!1),this.highlightedPolygon=null,this.canvasManager.redraw()),this.highlightedPolygon&&(this.currentPolygon=this.highlightedPolygon),this.isDraggingPolygon&&this.currentPolygon&&this.dragOffset&&null===this.selectedVertexIndex){const t=e-this.dragOffset.x,n=i-this.dragOffset.y;for(let e=0;e<this.currentPolygon.getVertices().length;e++){const i=this.currentPolygon.getVertices()[e],s={x:i.x+t,y:i.y+n};this.currentPolygon.updateVertex(e,s)}this.dragOffset={x:e,y:i},this.canvasManager.redraw()}else null!==this.selectedVertexIndex&&this.currentPolygon&&(this.currentPolygon.updateVertex(this.selectedVertexIndex,{x:e,y:i}),this.canvasManager.redraw())}}handleMouseUp(t){this.isDraggingLine=!1,this.dragOffset=null;const e=t.clientX-this.canvasManager.canvas.getBoundingClientRect().left,i=t.clientY-this.canvasManager.canvas.getBoundingClientRect().top;if(this.drawMode===s.LINE&&this.canDraw&&this.isDrawing&&this.startPoint){const t={x:e,y:i};if(Math.sqrt(Math.pow(t.x-this.startPoint.x,2)+Math.pow(t.y-this.startPoint.y,2))>20){let e={point:[this.startPoint,t]};const i=new o(e);i.setArrowDirection(this.defaultArrowDirection),this.canvasManager.addShape(i),this.onShapeDrawnCallback&&this.onShapeDrawnCallback()}this.isDrawing=!1,this.startPoint=null}else this.drawMode===s.POLYGON?(this.canDraw?(this.selectedVertexIndex=null,this.isDraggingPolygon=!1,this.dragOffset=null):this.currentPolygon&&(null!==this.selectedVertexIndex?(this.selectedVertexIndex=null,this.canvasManager.redraw()):this.isDraggingPolygon?(this.isDraggingPolygon=!1,this.dragOffset=null,this.canvasManager.redraw()):(this.currentPolygon.setHighlight(!1),this.currentPolygon=null)),this.onShapeDrawnCallback&&this.onShapeDrawnCallback()):this.draggingEndpoint=null}handleClick(t){}}!function(t){t[t.LINE=0]="LINE",t[t.POLYGON=1]="POLYGON"}(r||(r={}));class c{constructor(t){this.defaultArrowDirection=e.AB,this.drawMode=r.LINE,this.onShapeDrawnCallback=null,this.canvasManager=new l(t),this.eventHandlers=new h(this.canvasManager)}setOnShapeDrawnCallback(t){console.log("call back",t),this.onShapeDrawnCallback=t,this.eventHandlers.setOnShapeDrawnCallback(t)}setDrawMode(t){"line"===t?this.drawMode=r.LINE:"polygon"===t&&(this.drawMode=r.POLYGON),console.log("setDrawMode",this.drawMode),this.eventHandlers.setDrawMode(this.drawMode)}startDrawing(){this.eventHandlers.enableDrawing(!0)}stopDrawing(){this.eventHandlers.enableDrawing(!1)}getLines(){return this.canvasManager.getShapes().filter(t=>t instanceof o)}setLines(t){let e=this.denormalizeVertex(t.point);t.point=e,this.eventHandlers.setDrawingLines(t)}setLinesCount(t,e,i){this.canvasManager.getShapes().filter(t=>t instanceof o).forEach(n=>{t==n.getID()&&(n.setEnterLeaveCount(e,i),this.canvasManager.redraw())})}deleteLine(t){this.canvasManager.deleteShape(t)}getDefaultArrowDirection(){return this.defaultArrowDirection}setDefaultArrowDirection(t){switch(t){case"AB":this.defaultArrowDirection=e.AB;break;case"BA":this.defaultArrowDirection=e.BA;break;case"BOTH":this.defaultArrowDirection=e.BOTH;break;case"NONE":this.defaultArrowDirection=e.NONE;break;default:return void console.error("Invalid arrow direction provided:",t)}this.eventHandlers.setDefaultArrowDirection(this.defaultArrowDirection)}getLineDetails(){return this.getLines().map(t=>({id:t.id,start:t.getStart(),end:t.getEnd()}))}deleteLineById(t){const e=this.getLines().find(e=>e.id===t);e&&this.deleteLine(e)}getPolygons(){return this.canvasManager.getShapes().filter(t=>t instanceof a)}setPolygon(t,e){let i=this.denormalizeVertex(t);this.eventHandlers.setDrawingPolygon(i,e)}setPolygonWarnEnable(t,e){this.canvasManager.getShapes().filter(t=>t instanceof a).forEach(i=>{t==i.getID()&&(i.setWarnEnable(e),this.canvasManager.redraw())})}deletePolygon(t){this.canvasManager.deleteShape(t)}getPolygonDetails(){return this.getPolygons().map(t=>({id:t.id,vertices:t.getVertices()}))}deletePolygonById(t){const e=this.getPolygons().find(e=>e.id===t);e&&this.deletePolygon(e)}cancelPolygonDraw(){this.eventHandlers.stopDrawingPolygon()}denormalizeVertex(t){const e=this.canvasManager.canvas.width,i=this.canvasManager.canvas.height,n=[];for(const s of t){const t=parseFloat((s.x*e).toFixed(4)),r=parseFloat((s.y*i).toFixed(4));n.push({x:t,y:r})}return n}normalizeVertex(t){const e=this.canvasManager.canvas.width,i=this.canvasManager.canvas.height,n=[];for(const s of t){const t=parseFloat((s.x/e).toFixed(4)),r=parseFloat((s.y/i).toFixed(4));n.push({x:t,y:r})}return n}clearCanvas(){this.canvasManager.clear()}setPolygonStyle(t,e=!1){a.setStyleConfig(t,e)}setLineStyle(t,e=!1){o.setStyleConfig(t,e)}}class d{constructor(t,e){this.canvas=e;const i=this.ctx=e.getContext(t),n=i.createShader(i.VERTEX_SHADER);if(i.shaderSource(n,d.vertexShaderSource),i.compileShader(n),!i.getShaderParameter(n,i.COMPILE_STATUS))throw i.getShaderInfoLog(n);const s=i.createShader(i.FRAGMENT_SHADER);if(i.shaderSource(s,d.fragmentShaderSource),i.compileShader(s),!i.getShaderParameter(s,i.COMPILE_STATUS))throw i.getShaderInfoLog(s);const r=i.createProgram();if(i.attachShader(r,n),i.attachShader(r,s),i.linkProgram(r),!i.getProgramParameter(r,i.LINK_STATUS))throw i.getProgramInfoLog(r);i.useProgram(r);const o=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,o),i.bufferData(i.ARRAY_BUFFER,new Float32Array([-1,-1,-1,1,1,1,1,-1]),i.STATIC_DRAW);const a=i.getAttribLocation(r,"xy");i.vertexAttribPointer(a,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(a);const l=i.createTexture();i.bindTexture(i.TEXTURE_2D,l),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE)}draw(t){this.canvas.width=t.displayWidth,this.canvas.height=t.displayHeight;const e=this.ctx;createImageBitmap(t).then(t=>{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),t.close(),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.clearColor(1,0,0,1),e.clear(e.COLOR_BUFFER_BIT),e.drawArrays(e.TRIANGLE_FAN,0,4)}).catch(t=>{console.error("Error creating ImageBitmap:",t)}),t.close()}}d.vertexShaderSource="\n      attribute vec2 xy;\n      varying highp vec2 uv;\n      void main(void) {\n        gl_Position = vec4(xy, 0.0, 1.0);\n        uv = vec2((1.0 + xy.x) / 2.0, (1.0 - xy.y) / 2.0);\n      }\n    ",d.fragmentShaderSource="\n      varying highp vec2 uv;\n      uniform sampler2D texture;\n      void main(void) {\n        gl_FragColor = texture2D(texture, uv);\n      }\n    ";var u,g,f,p,m,v,y,S,w,E,_,C,D,T=function(t,e,i,n,s){if("function"==typeof e||!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(t,i),i},b=function(t,e,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(t):n?n.value:e.get(t)};class M{constructor(t){u.add(this),f.set(this,void 0),p.set(this,void 0),m.set(this,null),v.set(this,void 0),y.set(this,void 0),S.set(this,void 0),w.set(this,void 0),T(this,f,t),T(this,m,b(this,u,"m",E).call(this))}async draw(t){await b(this,m,"f"),b(this,f,"f").width=t.displayWidth,b(this,f,"f").height=t.displayHeight;const e=b(this,y,"f").createBindGroup({layout:b(this,S,"f").getBindGroupLayout(0),entries:[{binding:1,resource:b(this,w,"f")},{binding:2,resource:b(this,y,"f").importExternalTexture({source:t})}]}),i=b(this,y,"f").createCommandEncoder(),n={colorAttachments:[{view:b(this,p,"f").getCurrentTexture().createView(),clearValue:[1,0,0,1],loadOp:"clear",storeOp:"store"}]},s=i.beginRenderPass(n);s.setPipeline(b(this,S,"f")),s.setBindGroup(0,e),s.draw(6,1,0,0),s.end(),b(this,y,"f").queue.submit([i.finish()]),t.close()}}g=M,f=new WeakMap,p=new WeakMap,m=new WeakMap,v=new WeakMap,y=new WeakMap,S=new WeakMap,w=new WeakMap,u=new WeakSet,E=async function(){const t=await navigator.gpu.requestAdapter();T(this,y,await t.requestDevice()),T(this,v,navigator.gpu.getPreferredCanvasFormat()),T(this,p,b(this,f,"f").getContext("webgpu")),b(this,p,"f").configure({device:b(this,y,"f"),format:b(this,v,"f"),alphaMode:"opaque"}),T(this,S,b(this,y,"f").createRenderPipeline({layout:"auto",vertex:{module:b(this,y,"f").createShaderModule({code:g.vertexShaderSource}),entryPoint:"vert_main"},fragment:{module:b(this,y,"f").createShaderModule({code:g.fragmentShaderSource}),entryPoint:"frag_main",targets:[{format:b(this,v,"f")}]},primitive:{topology:"triangle-list"}})),T(this,w,b(this,y,"f").createSampler({}))},M.vertexShaderSource="\n      struct VertexOutput {\n        @builtin(position) Position: vec4<f32>,\n        @location(0) uv: vec2<f32>,\n      }\n  \n      @vertex\n      fn vert_main(@builtin(vertex_index) VertexIndex: u32) -> VertexOutput {\n        var pos = array<vec2<f32>, 6>(\n          vec2<f32>( 1.0,  1.0),\n          vec2<f32>( 1.0, -1.0),\n          vec2<f32>(-1.0, -1.0),\n          vec2<f32>( 1.0,  1.0),\n          vec2<f32>(-1.0, -1.0),\n          vec2<f32>(-1.0,  1.0)\n        );\n  \n        var uv = array<vec2<f32>, 6>(\n          vec2<f32>(1.0, 0.0),\n          vec2<f32>(1.0, 1.0),\n          vec2<f32>(0.0, 1.0),\n          vec2<f32>(1.0, 0.0),\n          vec2<f32>(0.0, 1.0),\n          vec2<f32>(0.0, 0.0)\n        );\n  \n        var output: VertexOutput;\n        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);\n        output.uv = uv[VertexIndex];\n        return output;\n      }\n    ",M.fragmentShaderSource="\n      @group(0) @binding(1) var mySampler: sampler;\n      @group(0) @binding(2) var myTexture: texture_external;\n      \n      @fragment\n      fn frag_main(@location(0) uv: vec2<f32>) -> @location(0) vec4<f32> {\n        return textureSampleBaseClampToEdge(myTexture, mySampler, uv);\n      }\n    ",function(t){t[t.CODEC_PCMU=0]="CODEC_PCMU",t[t.CODEC_PCMA=8]="CODEC_PCMA",t[t.CODEC_G711A=19]="CODEC_G711A",t[t.CODEC_G711U=20]="CODEC_G711U",t[t.CODEC_H264=96]="CODEC_H264",t[t.CODEC_H265=98]="CODEC_H265",t[t.CODEC_MPEG4=97]="CODEC_MPEG4",t[t.CODEC_VP9=99]="CODEC_VP9",t[t.CODEC_AV1=101]="CODEC_AV1",t[t.CODEC_MJPEG=26]="CODEC_MJPEG",t[t.CODEC_AAC=100]="CODEC_AAC",t[t.CODEC_PS=200]="CODEC_PS",t[t.CODEC_G722=201]="CODEC_G722",t[t.CODEC_G726=202]="CODEC_G726",t[t.CODEC_OPUS=203]="CODEC_OPUS",t[t.CODEC_ARAW=204]="CODEC_ARAW",t[t.CODEC_NONE=254]="CODEC_NONE",t[t.CODEC_LAST=1e3]="CODEC_LAST"}(_||(_={})),function(t){t[t.VIDEO_STREAM_VIDEO=1]="VIDEO_STREAM_VIDEO",t[t.VIDEO_STREAM_AUDIO=2]="VIDEO_STREAM_AUDIO",t[t.VIDEO_STREAM_INFO=3]="VIDEO_STREAM_INFO",t[t.VIDEO_STREAM_TEXT=4]="VIDEO_STREAM_TEXT",t[t.VIDEO_STREAM_SDP=5]="VIDEO_STREAM_SDP",t[t.VIDEO_STREAM_PBEVENT=6]="VIDEO_STREAM_PBEVENT",t[t.VIDEO_STREAM_MUXED=7]="VIDEO_STREAM_MUXED",t[t.VIDEO_STREAM_META_DATA=8]="VIDEO_STREAM_META_DATA",t[t.VIDEO_STREAM_END=9]="VIDEO_STREAM_END",t[t.VIDEO_STREAM_LAST=10]="VIDEO_STREAM_LAST"}(C||(C={})),function(t){t[t.VIDEO_FRM_NONE=0]="VIDEO_FRM_NONE",t[t.VIDEO_FRM_I=1]="VIDEO_FRM_I",t[t.VIDEO_FRM_P=2]="VIDEO_FRM_P",t[t.VIDEO_FRM_B=3]="VIDEO_FRM_B",t[t.VIDEO_FRM_INFO=4]="VIDEO_FRM_INFO",t[t.VIDEO_FRM_AUDIO=5]="VIDEO_FRM_AUDIO",t[t.VIDEO_FRM_PBTIME=6]="VIDEO_FRM_PBTIME",t[t.VIDEO_FRM_PBPOS=7]="VIDEO_FRM_PBPOS",t[t.VIDEO_FRM_PBEND=8]="VIDEO_FRM_PBEND",t[t.VIDEO_FRM_MUXED=9]="VIDEO_FRM_MUXED",t[t.VIDEO_FRM_TRANS_INFO=10]="VIDEO_FRM_TRANS_INFO",t[t.VIDEO_FRM_PBSPEED=11]="VIDEO_FRM_PBSPEED",t[t.VIDEO_FRM_PBSEEKED=12]="VIDEO_FRM_PBSEEKED",t[t.VIDEO_FRM_PB_PAUSED=13]="VIDEO_FRM_PB_PAUSED",t[t.VIDEO_FRM_LAST=14]="VIDEO_FRM_LAST"}(D||(D={}));class P{static isSupported(){const t=["VideoEncoder","VideoDecoder","AudioEncoder","AudioDecoder","VideoFrame","EncodedVideoChunk","EncodedAudioChunk","MediaStream","MediaStreamTrack","MediaStreamTrackGenerator","MediaStreamTrackProcessor"];let e=!0;for(const i of t)window[i]||(console.error(`${i} is not supported.`),e=!1);e?console.log("[WS2] All required API interfaces are supported!"):console.warn("[WS2] Some required API interfaces are not supported.")}constructor({canvas:t=null,rendererType:e="2d",videoElement:i=null}={}){if(this.context=null,this.writer=null,this.videoElement=null,this.trackGenerator=null,this.renderer=null,this.codec=null,this.audioCodec=null,this.width=null,this.height=null,this.firstTimestamp=null,this.isDecoderConfigured=!1,this.MIN_BUFFER_SIZE=3,this.MAX_BUFFER_SIZE=10,this.FRAME_RATE=25,this.FRAME_INTERVAL=1e3/this.FRAME_RATE,this.frameBuffer=[],this.BUFFER_SIZE=3,this.lastFrame=null,this.renderingStarted=!1,this.audioDecoderConfigured=!1,this.audioDecoder=null,this.audioTrackGenerator=null,this.audioWriter=null,i){console.log("videoElement",i),this.trackGenerator=new MediaStreamTrackGenerator({kind:"video"}),this.audioTrackGenerator=new MediaStreamTrackGenerator({kind:"audio"}),console.log("videoTrackGenerator",this.trackGenerator);const t=new MediaStream;t.addTrack(this.trackGenerator),i.srcObject=t}else{if(!t)throw new Error("You must provide either a canvas or a video element.");{this.canvas=t;const i="gpu"in navigator&&"function"==typeof navigator.gpu.requestAdapter;if("webgl"===e)this.renderer=new d("webgl",t);else if("webgpu"===e)i?this.renderer=new M(t):(console.warn("WebGPU is not supported in your environment. Fallback to WebGL."),this.renderer=new d("webgl",t));else{if("2d"!==e)throw new Error(`Unknown rendererType: ${e}`);this.context=t.getContext("2d")}}}this.initDecoder()}initDecoder(){try{this.decoder=new VideoDecoder({output:this.outputFrame.bind(this),error:t=>{console.error("VideoDecoder error:",t)}})}catch(t){console.error("Error initializing VideoDecoder:",t)}try{this.decoder=new AudioDecoder({output:this.outputAudioFrame.bind(this),error:t=>{console.error("VideoDecoder error:",t)}})}catch(t){console.error("Error initializing VideoDecoder:",t)}}async outputAudioFrame(t){this.audioWriter||(this.audioWriter=this.audioTrackGenerator.writable.getWriter());try{await this.audioWriter.write(t)}catch(t){console.error("Error when trying to render audio frame:",t),this.audioWriter&&(this.audioWriter.releaseLock(),this.audioWriter=null)}finally{t.close()}}async outputFrame(t){this.frameBuffer.push(t),this.renderingStarted||this.startRendering()}startRendering(){this.renderingStarted=!0;let t=0;const e=i=>{if(requestAnimationFrame(e),i-t>=40){t=i;let e=this.frameBuffer.shift();!e&&this.lastFrame&&(e=this.lastFrame),e&&(this.renderFrame(e),this.lastFrame=e)}};requestAnimationFrame(e)}async renderFrame(t){try{if(this.renderer)this.renderer.draw(t);else if(this.context){const e=await createImageBitmap(t);t.close(),this.context.drawImage(e,0,0,this.canvas.width,this.canvas.height),e.close()}else this.trackGenerator?(this.writer||(this.writer=this.trackGenerator.writable.getWriter()),await this.writer.write(t)):console.error("No renderer or context available for drawing")}catch(t){console.error("Error in renderFrame function:",t)}finally{this.writer?.releaseLock(),this.writer=null,t.close()}}start(t){console.log("start"),this.ws=new WebSocket(t),this.ws.binaryType="arraybuffer",this.ws.onmessage=t=>{const e=new Uint8Array(t.data);this.handleVideoData(e)}}toHex(t){return Array.from(t).map(t=>t.toString(16).padStart(2,"0")).join(" ")}handleVideoData(t){const e=new DataView(t.buffer),i={StreamType:e.getUint32(0,!1),FrameType:e.getUint32(4,!1),Seq:e.getUint32(8,!1),Secs:e.getBigUint64(12,!1),Msecs:e.getUint32(20,!1),DataLen:e.getUint32(24,!1),Ptsdiff:e.getUint32(28,!1)},n=1000n*i.Secs+BigInt(i.Msecs);let s;s=this.firstTimestamp?n-this.firstTimestamp:n;const r=1000n*s;if(i.StreamType===C.VIDEO_STREAM_INFO&&i.FrameType===D.VIDEO_FRM_INFO){const i=4096,n={Video:e.getUint32(32,!1),Width:e.getUint32(36,!1),Height:e.getUint32(40,!1),Fps:e.getUint32(44,!1),vExtra:new Uint8Array(t.slice(48,48+i)),vExtraLen:e.getUint32(48+i,!1),Audio:e.getUint32(52+i,!1),aSampleRate:e.getUint32(56+i,!1),aSampleBit:e.getUint32(60+i,!1),aChannels:e.getUint32(64+i,!1),aExtra:new Uint8Array(t.slice(68+i,68+2*i)),aExtraLen:e.getUint32(68+2*i,!1)};return console.log("info",n),this.aSampleRate=n.aSampleRate,this.aChannels=n.aChannels,this.codec=this.getCodecString(n.Video),this.audioCodec=this.getCodecString(n.Audio),this.width=n.Width,void(this.height=n.Height)}if(i.StreamType===C.VIDEO_STREAM_AUDIO&&i.FrameType===D.VIDEO_FRM_AUDIO){if(!this.audioDecoderConfigured)try{this.audioDecoder.configure({codec:this.audioCodec}),this.audioDecoderConfigured=!0,console.log("Audio Decoder configured successfully")}catch(t){return void console.error("Error configuring audio decoder:",t)}const e=t,i=new AudioData({timestamp:Number(r),data:e});try{this.audioDecoder.decode(i)}catch(t){console.error("Error decoding audio frame:",t)}}if(!this.codec||i.FrameType!==D.VIDEO_FRM_I&&i.FrameType!==D.VIDEO_FRM_P&&i.FrameType!==D.VIDEO_FRM_B)console.log("Codec is missing, or frame type is not I-frame, P-frame, or B-frame.",i.FrameType);else{if(!this.isDecoderConfigured&&i.FrameType===D.VIDEO_FRM_I)try{this.decoder.configure({codec:this.codec}),this.isDecoderConfigured=!0,console.log("Decoder configured successfully")}catch(t){return void console.error("Error configuring decoder:",t)}null==this.firstTimestamp&&(this.firstTimestamp=1000n*i.Secs+BigInt(i.Msecs),console.log("进入",this.firstTimestamp));const e=32,n=t.slice(e),s=new EncodedVideoChunk({type:this.getFrameType(i.FrameType),timestamp:Number(r),data:n});try{this.decoder.decode(s)}catch(t){console.error("Error decoding frame:",t)}}}getCodecString(t){switch(t){case _.CODEC_PCMU:return"audio/PCMU";case _.CODEC_PCMA:return"audio/PCMA";case _.CODEC_H264:return"avc1.42001E";case _.CODEC_H265:return"hev1.1.6.L93.B0";case _.CODEC_MPEG4:return"video/mp4; codecs=mp4v.20.8";case _.CODEC_VP9:return"video/vp9; codecs=vp09.00.10.08";case _.CODEC_AV1:return"video/av1; codecs=av01";case _.CODEC_MJPEG:return"video/jpeg; codecs=mjpa";case _.CODEC_AAC:return"audio/aac; codecs=mp4a.40.2";case _.CODEC_PS:throw new Error("Unknown codec type: CODEC_PS");case _.CODEC_G722:return"audio/G722";case _.CODEC_G726:return"audio/G726";case _.CODEC_OPUS:return"audio/opus";case _.CODEC_ARAW:return"audio/pcm; codecs=1";default:throw new Error("Unknown codec type")}}getFrameType(t){switch(console.log("frameType",t),t){case D.VIDEO_FRM_I:return"key";case D.VIDEO_FRM_P:case D.VIDEO_FRM_B:default:return"delta"}}stop(){this.ws.close(),this.decoder.close()}}class k{constructor(){this.listeners=new Map}on(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}off(t,e){if(!this.listeners.has(t))return;const i=this.listeners.get(t).indexOf(e);i>=0&&this.listeners.get(t).splice(i,1)}emit(t,e){(this.listeners.get(t)??[]).forEach(t=>{t.call(this,e)})}}const O="VIDEO_FRAME",x="VIDEO_AUDIO_FRAME";var A,I,R,V=i(477),U=i.n(V);function F(){return U()('(()=>{let e=null,t=!1,n=!1;function r(n){const r=new DataView(n.buffer).getUint32(0,!0),o=new Uint8Array(n.buffer,4,r),c=new Uint8Array(n.buffer,4+r);let a;try{const e=(new TextDecoder).decode(o);a=JSON.parse(e)}catch(e){return}if(!t&&"key"===a.chunkInfo.type){if(!e)return;e.configure(a.config),t=!0}if(e&&t){const t=new EncodedVideoChunk({type:a.chunkInfo.type,timestamp:a.chunkInfo.timestamp,data:c});e.decode(t)}}self.onmessage=async o=>{const{debug:c,stream:a}=o.data;if(0==function(){try{return e=new VideoDecoder({output:e=>{self.postMessage({type:"decoded",frame:e},[e])},error:e=>{n=!0}}),!0}catch(e){return console.warn("[WS2] vwo can not started, if you use http, try https."),!1}}())return;const f=a.getReader();let s=!1;try{for(;;){const{done:e,value:t}=await f.read();if(e)break;if(1==n)break;r(t)}}catch(e){s=!0}finally{try{0==s&&0==n&&e&&(e.close(),e=null)}catch(e){}}e=null,t=!1,n=!1,self.close()}})();\n',"Worker",void 0,void 0)}class L{constructor(t,e){this.bufferSizeMs=200,void 0!==t&&t>0&&(this.bufferSizeMs=t),this.elementsList=[],this.droppedCallback=e,this.totalLengthMs=0}AddItem(t,e){this.elementsList.push({chunk:t,extraData:e}),this.totalLengthMs+=t.duration/1e3,this.elementsList.length>3e3&&(console.log("max reached"),this.GetItem())}GetFristDuration(){return this.elementsList.length<=0?1e4:this.elementsList[0].chunk.duration}GetItem(){let t;return this.totalLengthMs>0&&(t=this.elementsList.shift(),this.totalLengthMs-=t.chunk.duration/1e3),t}GetStats(){return{totalLengthMs:this.totalLengthMs,size:this.elementsList.length}}GetLengthMs(){return this.totalLengthMs}GetOverLengthMs(){return this.totalLengthMs-this.bufferSizeMs}Clear(){this.elementsList=[],this.totalLengthMs=0}}function W(){return U()('(()=>{let e=null,t=!1,n=!1;function r(n){const r=new DataView(n.buffer),a=r.getUint32(0,!0),o=r.getUint32(4,!0),c=new Uint8Array(n.buffer,8,a),i=new Uint8Array(n.buffer,8+a,o),f=new Uint8Array(n.buffer,8+a+o);let s;try{const n=(new TextDecoder).decode(c);if(s=JSON.parse(n),s.config.description=i,!t){if(!e)return;e.configure(s.config),t=!0}if(e&&t){const t=new EncodedAudioChunk({type:"key",timestamp:s.chunkInfo.timestamp,data:f});e.decode(t)}}catch(e){}}self.onmessage=async a=>{const{debug:o,stream:c}=a.data;if(0==function(){try{return e=new AudioDecoder({output:e=>{self.postMessage({type:"audiodecoded",audioData:e},[e])},error:e=>{n=!0}}),!0}catch(e){return console.warn("[WS2] awo can not started, if you use http, try https."),!1}}())return;const i=c.getReader();let f=!1;try{for(;;){const{done:e,value:t}=await i.read();if(e)break;if(1==n)break;r(t)}}catch(e){f=!0}finally{try{0==f&&0==n&&e&&(e.close(),e=null)}catch(e){}}e=null,t=!1,n=!1,self.close()}})();\n',"Worker",void 0,void 0)}class N{constructor(t,e,i,n){this.worker=new F,this.audioworker=new W,this.firstTimestamp=null,this.audioDecoder=null,this.audioConfiged=!1,this.frameCount=0,this.startTime=performance.now(),this.timeWindow=2e3,this.totalBytesReceived=0,this.lastBitrateCalculationTimestamp=0,this.bitrate=0,this.fps=0,this.freeSpace=0,this.lastVideoTimestamp=null,this.calculateBitrateTimer=null,this.renderingTimer=null,this.decodedFrameTimestamp=null,this.decodedFrameNum=0,this.lastInputVideoTimestamp=null,this.decingTimer=null,this.decJitter=null,this._jbuffersize=300,this._nCurrentSpeed=1,this._bJitterFistFull=!1,this._debug=i,this._nCurrentSpeed=t,this._jbuffersize=e-80,this._jbuffersize<=0&&(this._jbuffersize=0),this.jitter=new L(80,void 0),0!=this._jbuffersize&&(this.decJitter=new L(this._jbuffersize,void 0)),this.eventEmitter=n;const s=new CountQueuingStrategy({highWaterMark:5});this.stream=new ReadableStream({start:t=>{this.streamController=t}},s);const r=new CountQueuingStrategy({highWaterMark:10});this.audioStream=new ReadableStream({start:t=>{this.audioStreamController=t},cancel:t=>{!0===this._debug&&console.log("[WS2] Stream canceled due to:",t)}},r),this.worker.onmessage=this.handleMessage.bind(this),this.audioworker.onmessage=this.audioHandleMessage.bind(this),this.worker.postMessage({debug:this._debug,stream:this.stream},[this.stream]),this.audioworker.postMessage({debug:this._debug,stream:this.audioStream},[this.audioStream]),this.lastBitrateCalculationTimestamp=Date.now(),this.calculateBitrateTimer=setInterval(this.calculateBitrate.bind(this),2e3),this.decJitter&&(this.decingTimer=setTimeout(this.decing.bind(this),this.decJitter.GetFristDuration()/1e3))}handleVideoDataReceived(t){if(t){let e,i;if("audio"===t.type){const n=JSON.stringify({config:t.config,chunkInfo:t.chunkInfo}),s=(new TextEncoder).encode(n),r=t.config.description,o=s.length+r.byteLength+t.data.byteLength+8;e=new ArrayBuffer(o);const a=new DataView(e);a.setUint32(0,s.length,!0),a.setUint32(4,r.byteLength,!0),new Uint8Array(e,8,s.length).set(s),new Uint8Array(e,8+s.length,r.byteLength).set(r),new Uint8Array(e,8+s.length+r.byteLength).set(t.data),i=new Uint8Array(e),this.audioStreamController?.enqueue(i)}else if("video"===t.type){const n=JSON.stringify({config:t.config,chunkInfo:t.chunkInfo}),s=(new TextEncoder).encode(n),r=s.length+t.data.byteLength+4;e=new ArrayBuffer(r),new DataView(e).setUint32(0,s.length,!0),new Uint8Array(e,4,s.length).set(s),new Uint8Array(e,4+s.length).set(t.data),i=new Uint8Array(e);let o=0;null==this.lastInputVideoTimestamp||(o=t.chunkInfo.timestamp-this.lastInputVideoTimestamp),o<0&&(o=0),this.lastInputVideoTimestamp=t.chunkInfo.timestamp,this.decJitter&&this._nCurrentSpeed<=1&&this._nCurrentSpeed>0?this.decJitter.AddItem({duration:Number(o)},i):this.streamController?.enqueue(i)}}}audioHandleMessage(t){if("audiodecoded"===t.data.type){const e=t.data.audioData;this.eventEmitter.emit(x,e)}}getDecodedFrameTimestamp(){return this.decodedFrameTimestamp}getDecodedFrameNum(){return this.decodedFrameNum}getRenderCached(){return this.jitter.GetLengthMs()}getInputCached(){return this.decJitter?this.decJitter.GetLengthMs():0}setSpeed(t){if(this._nCurrentSpeed=t,t<0&&(this._bJitterFistFull=!1,this.decJitter&&this.decJitter.Clear()),t>1&&this.decJitter)for(;;){let t=this.decJitter.GetItem();if(null==t)break;this.streamController?.enqueue(t.extraData)}}handleMessage(t){if("decoded"===t.data.type){const e=t.data.frame;if(e instanceof VideoFrame||e instanceof ArrayBuffer){const t=e;null==this.lastVideoTimestamp||(t.timestamp,this.lastVideoTimestamp),this.decodedFrameTimestamp=BigInt(t.timestamp),this.decodedFrameNum++,this.lastVideoTimestamp=t.timestamp,this.eventEmitter.emit(O,e),this.frameCount++;const i=performance.now(),n=i-this.startTime;if(n>=this.timeWindow){const t=this.frameCount/(n/1e3);this.fps=t,this.startTime=i,this.frameCount=0}}else!0===this._debug&&console.log("Received object is not a VideoFrame or ArrayBuffer")}}destory(){clearTimeout(this.decingTimer),clearTimeout(this.renderingTimer),clearInterval(this.calculateBitrateTimer),this.worker&&(this.streamController.close(),this.worker=null),this.audioworker&&(this.audioStreamController.close(),this.audioworker=null)}calculateBitrate(){const t=Date.now(),e=(t-this.lastBitrateCalculationTimestamp)/1e3;this.bitrate=8*this.totalBytesReceived/e,this.totalBytesReceived=0,this.lastBitrateCalculationTimestamp=t}rendering(){const t=this.jitter.GetItem();null!=t&&this.eventEmitter.emit(O,t.extraData);let e=this.jitter.GetFristDuration()/1e3;if(0==e){const t=this.jitter.GetItem();null!=t&&this.eventEmitter.emit(O,t.extraData),this.renderingTimer=setTimeout(this.rendering.bind(this),10)}else{let t=this.jitter.GetOverLengthMs(),i=e;i=t<=0?e:e-t/e*1,i/=Math.abs(this._nCurrentSpeed),this.renderingTimer=setTimeout(this.rendering.bind(this),i)}}decing(){let t=Date.now();if(0==this._bJitterFistFull){if(!(this.decJitter.GetLengthMs()>=this._jbuffersize))return void(this.decingTimer=setTimeout(this.decing.bind(this),this.decJitter.GetFristDuration()/1e3));this._bJitterFistFull=!0}let e=this.decJitter.GetItem();null!=e&&this.streamController?.enqueue(e.extraData);let i=this.decJitter.GetFristDuration()/1e3;if(0==i){const t=this.decJitter.GetItem();null!=t&&this.streamController?.enqueue(t.extraData),this.decingTimer=setTimeout(this.decing.bind(this),1)}else{let e=this.decJitter.GetOverLengthMs()-1*i,n=i;n=e<=0?i:i-e/i*1.5,n-=Date.now()-t,this.decingTimer=setTimeout(this.decing.bind(this),n)}}getStatus(){return{Bitrate:Math.trunc(this.bitrate),fps:Math.trunc(this.fps),QueueSize:this.freeSpace,codec:"H264"}}toHex(t){return Array.from(t).map(t=>t.toString(16).padStart(2,"0")).join(" ")}}!function(t){t[t.CODEC_PCMU=0]="CODEC_PCMU",t[t.CODEC_PCMA=8]="CODEC_PCMA",t[t.CODEC_G711A=19]="CODEC_G711A",t[t.CODEC_G711U=20]="CODEC_G711U",t[t.CODEC_H264=96]="CODEC_H264",t[t.CODEC_H265=98]="CODEC_H265",t[t.CODEC_MPEG4=97]="CODEC_MPEG4",t[t.CODEC_VP9=99]="CODEC_VP9",t[t.CODEC_AV1=101]="CODEC_AV1",t[t.CODEC_MJPEG=26]="CODEC_MJPEG",t[t.CODEC_AAC=100]="CODEC_AAC",t[t.CODEC_PS=200]="CODEC_PS",t[t.CODEC_G722=201]="CODEC_G722",t[t.CODEC_G726=202]="CODEC_G726",t[t.CODEC_OPUS=203]="CODEC_OPUS",t[t.CODEC_ARAW=204]="CODEC_ARAW",t[t.CODEC_NONE=254]="CODEC_NONE",t[t.CODEC_LAST=1e3]="CODEC_LAST"}(A||(A={})),function(t){t[t.VIDEO_STREAM_VIDEO=1]="VIDEO_STREAM_VIDEO",t[t.VIDEO_STREAM_AUDIO=2]="VIDEO_STREAM_AUDIO",t[t.VIDEO_STREAM_INFO=3]="VIDEO_STREAM_INFO",t[t.VIDEO_STREAM_TEXT=4]="VIDEO_STREAM_TEXT",t[t.VIDEO_STREAM_SDP=5]="VIDEO_STREAM_SDP",t[t.VIDEO_STREAM_PBEVENT=6]="VIDEO_STREAM_PBEVENT",t[t.VIDEO_STREAM_MUXED=7]="VIDEO_STREAM_MUXED",t[t.VIDEO_STREAM_META_DATA=8]="VIDEO_STREAM_META_DATA",t[t.VIDEO_STREAM_END=9]="VIDEO_STREAM_END",t[t.VIDEO_STREAM_LAST=10]="VIDEO_STREAM_LAST"}(I||(I={})),function(t){t[t.VIDEO_FRM_NONE=0]="VIDEO_FRM_NONE",t[t.VIDEO_FRM_I=1]="VIDEO_FRM_I",t[t.VIDEO_FRM_P=2]="VIDEO_FRM_P",t[t.VIDEO_FRM_B=3]="VIDEO_FRM_B",t[t.VIDEO_FRM_INFO=4]="VIDEO_FRM_INFO",t[t.VIDEO_FRM_AUDIO=5]="VIDEO_FRM_AUDIO",t[t.VIDEO_FRM_PBTIME=6]="VIDEO_FRM_PBTIME",t[t.VIDEO_FRM_PBPOS=7]="VIDEO_FRM_PBPOS",t[t.VIDEO_FRM_PBEND=8]="VIDEO_FRM_PBEND",t[t.VIDEO_FRM_MUXED=9]="VIDEO_FRM_MUXED",t[t.VIDEO_FRM_TRANS_INFO=10]="VIDEO_FRM_TRANS_INFO",t[t.VIDEO_FRM_PBSPEED=11]="VIDEO_FRM_PBSPEED",t[t.VIDEO_FRM_PBSEEKED=12]="VIDEO_FRM_PBSEEKED",t[t.VIDEO_FRM_PB_PAUSED=13]="VIDEO_FRM_PB_PAUSED",t[t.VIDEO_FRM_META_ANA=14]="VIDEO_FRM_META_ANA",t[t.VIDEO_FRM_META_CELL_MOTION=15]="VIDEO_FRM_META_CELL_MOTION",t[t.VIDEO_FRM_LAST=100]="VIDEO_FRM_LAST"}(R||(R={}));class B{constructor(t,e,i,n,s,r){this.metaconf=null,this.decWorkerMgr=null,this.firstVTimestamp=null,this.lastVTimestamp=null,this.firstATimestamp=null,this.audioDecoder=null,this.audioConfiged=!1,this.totalBytesReceived=0,this.decodedFrameCheckTimer=null,this.currTimestampMicroseconds=null,this.inputVideoFrameNum=0,this.bGotIframe=!1,this._h264cpumode=!1,this._jbuffersize=300,this._nSpeed=1,this._nCurrentSpeed=1,this._nVideoCodec=254,this.metaconf=r,this._debug=n,this._nSpeed=t,this._h264cpumode=e,this._jbuffersize=i,this.eventEmitter=s,this.inputVideoFrameNum=0,this.decWorkerMgr=new N(this._nCurrentSpeed,this._jbuffersize,this._debug,s),this.decodedFrameCheckTimer=setInterval(this.decodedFrameCheck.bind(this),2e3)}handleVideoDataReceived(t){const e=new Uint8Array(t.data);this.totalBytesReceived+=e.byteLength;const i=this.handleVideoData(e);this.decWorkerMgr&&this.decWorkerMgr.handleVideoDataReceived(i)}handleVideoData(t){const e=new DataView(t.buffer),i={StreamType:e.getUint32(0,!1),FrameType:e.getUint32(4,!1),Seq:e.getUint32(8,!1),Secs:e.getBigUint64(12,!1),Msecs:e.getUint32(20,!1),DataLen:e.getUint32(24,!1),Ptsdiff:e.getUint32(28,!1)};let n=1000n*i.Secs+BigInt(i.Msecs);if(i.StreamType===I.VIDEO_STREAM_INFO&&i.FrameType===R.VIDEO_FRM_INFO){const i=4096,n={Video:e.getUint32(32,!1),Width:e.getUint32(36,!1),Height:e.getUint32(40,!1),Fps:e.getUint32(44,!1),vExtra:new Uint8Array(t.slice(48,48+i)),vExtraLen:e.getUint32(48+i,!1),Audio:e.getUint32(52+i,!1),aSampleRate:e.getUint32(56+i,!1),aSampleBit:e.getUint32(60+i,!1),aChannels:e.getUint32(64+i,!1),aExtra:new Uint8Array(t.slice(68+i,68+2*i)),aExtraLen:e.getUint32(68+2*i,!1)},s=this.parseAudioCodec(n.aExtra);return this._nVideoCodec=n.Video,!0===this._debug&&console.log(`[WS2] info data Video:${n.Video},Audio:${n.Audio}, Width:${n.Width}, Height:${n.Height}`),this.audioSpecificConfig=n.aExtra,this.codec=this.getCodecString(n.Video),this.audioCodec=s,this.aSampleRate=n.aSampleRate,void(this.aChannels=n.aChannels)}if(this.audioCodec&&i.StreamType===I.VIDEO_STREAM_AUDIO&&i.FrameType===R.VIDEO_FRM_AUDIO&&this._nCurrentSpeed>0){let e;e=this.firstATimestamp?n-this.firstATimestamp:BigInt(0);const i=1000n*e;null==this.firstATimestamp&&(this.firstATimestamp=n,null==this.firstVTimestamp&&(this.firstVTimestamp=n));const s=32;return{type:"audio",data:t.subarray(s),config:{codec:this.audioCodec,sampleRate:this.aSampleRate,numberOfChannels:this.aChannels,description:this.audioSpecificConfig},chunkInfo:{type:"key",timestamp:Number(i)}}}if(this.codec&&(i.FrameType===R.VIDEO_FRM_I||i.FrameType===R.VIDEO_FRM_P||i.FrameType===R.VIDEO_FRM_B)){let e;this._nCurrentSpeed<0&&null!=this.lastVTimestamp&&(n=this.lastVTimestamp+BigInt(1)),this.lastVTimestamp=n,e=this.firstVTimestamp?n-this.firstVTimestamp:BigInt(0);const s=1000n*e;null==this.firstVTimestamp&&(this.firstVTimestamp=n,null==this.firstATimestamp&&(this.firstATimestamp=n));const r=32,o=t.subarray(r);let a="no-preference";1==this._h264cpumode&&this._nVideoCodec==A.CODEC_H264&&(a="prefer-software");const l={codec:this.codec,hardwareAcceleration:a};if(0==this.bGotIframe){if(i.FrameType!=R.VIDEO_FRM_I)return;this.bGotIframe=!0}i.FrameType===R.VIDEO_FRM_I&&null==this.decWorkerMgr&&(this.inputVideoFrameNum=0,this.decWorkerMgr=new N(this._nCurrentSpeed,this._jbuffersize,this._debug,this.eventEmitter)),this.inputVideoFrameNum++;const h={type:this.getFrameType(i.FrameType),timestamp:Number(s)};return this.currTimestampMicroseconds=s,{type:"video",data:o,config:l,chunkInfo:h}}if(i.StreamType!==I.VIDEO_STREAM_META_DATA||i.FrameType!==R.VIDEO_FRM_META_ANA&&i.FrameType!==R.VIDEO_FRM_META_CELL_MOTION)return i.StreamType===I.VIDEO_STREAM_PBEVENT&&(i.FrameType===R.VIDEO_FRM_PBSEEKED?this.seekedProcess():i.FrameType===R.VIDEO_FRM_PBSPEED&&(this._nCurrentSpeed=this._nSpeed,this.decWorkerMgr&&this.decWorkerMgr.setSpeed(this._nCurrentSpeed))),null;{const e=32,i=t.subarray(e);var s=(new TextDecoder).decode(i);this.metaconf&&this.metaconf.callback(s)}}seekedProcess(){this.firstVTimestamp=null,this.firstATimestamp=null,this.bGotIframe=!1,this.currTimestampMicroseconds=null,this.decWorkerMgr.destory(),this.decWorkerMgr=null}setSpeed(t){this._nSpeed=t}destory(){clearInterval(this.decodedFrameCheckTimer),this.decWorkerMgr&&(this.decWorkerMgr.destory(),this.decWorkerMgr=null)}decodedFrameCheck(){if(this.decWorkerMgr&&null!=this.currTimestampMicroseconds){let t=BigInt(0);if(null!=this.decWorkerMgr.getDecodedFrameTimestamp())t=this.currTimestampMicroseconds-this.decWorkerMgr.getDecodedFrameTimestamp();else if(this.inputVideoFrameNum>50)return!0===this._debug&&console.log("[WS2] restart wo max no output frame:",this.inputVideoFrameNum),this.decWorkerMgr.destory(),void(this.decWorkerMgr=null);let e=this.decWorkerMgr.getDecodedFrameNum(),i=this.inputVideoFrameNum-e;!0===this._debug&&console.log("[WS2] dc:",Number(t/BigInt(1e3)),"rc:",this.decWorkerMgr.getRenderCached(),"input:",this.inputVideoFrameNum,"diff:",i,"ic:",this.decWorkerMgr.getInputCached()),this._nCurrentSpeed>0&&this._nCurrentSpeed<=4&&(t/BigInt(1e3)>3e3*this._nCurrentSpeed||this.decWorkerMgr.getRenderCached()>3e3*this._nCurrentSpeed)&&(!0===this._debug&&console.log("[WS2] restart wo",t/BigInt(1e3)),this.decWorkerMgr.destory(),this.decWorkerMgr=null)}}getCodecString(t){switch(t){case A.CODEC_PCMU:return"audio/PCMU";case A.CODEC_PCMA:case A.CODEC_G711A:case A.CODEC_G711U:return"audio/PCMA";case A.CODEC_H264:return"avc1.42001E";case A.CODEC_H265:return"hev1.1.6.L93.B0";case A.CODEC_MPEG4:return"video/mp4; codecs=mp4v.20.8";case A.CODEC_VP9:return"video/vp9; codecs=vp09.00.10.08";case A.CODEC_AV1:return"video/av1; codecs=av01";case A.CODEC_MJPEG:return"video/jpeg; codecs=mjpa";case A.CODEC_AAC:return"mp4a.40.2";case A.CODEC_G722:return"audio/G722";case A.CODEC_G726:return"audio/G726";case A.CODEC_OPUS:return"audio/opus";case A.CODEC_ARAW:return"audio/pcm; codecs=1";default:throw new Error("Unknown codec type")}}getFrameType(t){switch(t){case R.VIDEO_FRM_I:return"key";case R.VIDEO_FRM_P:case R.VIDEO_FRM_B:default:return"delta"}}parseAudioCodec(t){if(t.length<2)return"unknown";switch((t[0]<<8|t[1])>>11){case 2:return"mp4a.40.2";case 5:return"mp4a.40.5";case 29:return"mp4a.40.29";default:return"unknown"}}analyzeAExtra(t){if(t.length<2)return void console.error("aExtra data is too short.");const e=t[0]<<8|t[1];let i=e>>11;const n=e>>7&15,s=e>>3&15;let r;switch(!0===this._debug&&console.log(`Audio Object Type version: ${i}`),!0===this._debug&&console.log(`Sampling Frequency Index: ${n}`),!0===this._debug&&console.log(`Channel Configuration: ${s}`),i){case 2:r="AAC-LC (Low Complexity)";break;case 5:r="HE-AAC v1 (AAC LC + SBR)";break;case 29:r="HE-AAC v2 (AAC LC + SBR + PS)";break;default:r="Unknown"}console.log(`Determined Codec Type: ${r}`)}getStatus(){return this.decWorkerMgr.getStatus}toHex(t){return Array.from(t).map(t=>t.toString(16).padStart(2,"0")).join(" ")}}var H,z,G,K,J,$,Y,j=Object.defineProperty,X=Object.getOwnPropertySymbols,q=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable,Q=Math.pow,tt=(t,e,i)=>e in t?j(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,et=(t,e,i)=>{if(!e.has(t))throw TypeError("Cannot "+i)},it=(t,e,i)=>(et(t,e,"read from private field"),i?i.call(t):e.get(t)),nt=(t,e,i)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,i)},st=(t,e,i,n)=>(et(t,e,"write to private field"),e.set(t,i),i),rt=(t,e,i)=>(et(t,e,"access private method"),i),ot=new Uint8Array(8),at=new DataView(ot.buffer),lt=t=>[(t%256+256)%256],ht=t=>(at.setUint16(0,t,!1),[ot[0],ot[1]]),ct=t=>(at.setUint32(0,t,!1),[ot[1],ot[2],ot[3]]),dt=t=>(at.setUint32(0,t,!1),[ot[0],ot[1],ot[2],ot[3]]),ut=t=>(at.setInt16(0,Q(2,8)*t,!1),[ot[0],ot[1]]),gt=t=>(at.setInt32(0,Q(2,16)*t,!1),[ot[0],ot[1],ot[2],ot[3]]),ft=t=>(at.setInt32(0,Q(2,30)*t,!1),[ot[0],ot[1],ot[2],ot[3]]),pt=(t,e=!1)=>{let i=Array(t.length).fill(null).map((e,i)=>t.charCodeAt(i));return e&&i.push(0),i},mt=t=>t&&t[t.length-1],vt=(t,e,i=!0)=>{let n=t*e;return i?Math.round(n):n},yt=t=>{let e=t*(Math.PI/180),i=Math.cos(e),n=Math.sin(e);return[i,n,0,-n,i,0,0,0,1]},St=yt(0),wt=t=>[gt(t[0]),gt(t[1]),ft(t[2]),gt(t[3]),gt(t[4]),ft(t[5]),gt(t[6]),gt(t[7]),ft(t[8])],Et=(t,e,i)=>({type:t,contents:e&&new Uint8Array(e.flat(10)),children:i}),_t=(t,e,i,n,s)=>Et(t,[lt(e),ct(i),null!=n?n:[]],s),Ct=(t,e)=>{let i=vt(Math.max(0,...e.filter(t=>t.samples.length>0).map(t=>mt(t.samples).timestamp+mt(t.samples).duration)),ze),n=Math.max(...e.map(t=>t.id))+1;return _t("mvhd",0,0,[dt(t),dt(t),dt(ze),dt(i),gt(1),ut(1),Array(10).fill(0),wt(St),Array(24).fill(0),dt(n)])},Dt=(t,e)=>{let i=mt(t.samples),n=vt(i?i.timestamp+i.duration:0,ze);return _t("tkhd",0,3,[dt(e),dt(e),dt(t.id),dt(0),dt(n),Array(8).fill(0),ht(0),ht(0),ut("audio"===t.info.type?1:0),ht(0),wt(yt("video"===t.info.type?t.info.rotation:0)),gt("video"===t.info.type?t.info.width:0),gt("video"===t.info.type?t.info.height:0)])},Tt=(t,e)=>Et("mdia",null,[bt(t,e),Mt("video"===t.info.type?"vide":"soun"),Pt(t)]),bt=(t,e)=>{let i=mt(t.samples),n=vt(i?i.timestamp+i.duration:0,t.timescale);return _t("mdhd",0,0,[dt(e),dt(e),dt(t.timescale),dt(n),ht(21956),ht(0)])},Mt=t=>_t("hdlr",0,0,[pt("mhlr"),pt(t),dt(0),dt(0),dt(0),pt("mp4-muxer-hdlr")]),Pt=t=>Et("minf",null,["video"===t.info.type?kt():Ot(),xt(),Rt(t)]),kt=()=>_t("vmhd",0,1,[ht(0),ht(0),ht(0),ht(0)]),Ot=()=>_t("smhd",0,0,[ht(0),ht(0)]),xt=()=>Et("dinf",null,[At()]),At=()=>_t("dref",0,0,[dt(1)],[It()]),It=()=>_t("url ",0,1),Rt=t=>Et("stbl",null,[Vt(t),Lt(t),Wt(t),Nt(t),Bt(t),Ht(t)]),Vt=t=>_t("stsd",0,0,[dt(1)],["video"===t.info.type?Ut(zt[t.info.codec],t):Ft(Kt[t.info.codec],t)]),Ut=(t,e)=>Et(t,[Array(6).fill(0),ht(1),ht(0),ht(0),Array(12).fill(0),ht(e.info.width),ht(e.info.height),dt(4718592),dt(4718592),dt(0),ht(1),Array(32).fill(0),ht(24),(at.setInt16(0,65535,!1),[ot[0],ot[1]])],[Gt[e.info.codec](e)]),Ft=(t,e)=>Et(t,[Array(6).fill(0),ht(1),ht(0),ht(0),dt(0),ht(e.info.numberOfChannels),ht(16),ht(0),ht(0),gt(e.info.sampleRate)],[Jt[e.info.codec](e)]),Lt=t=>_t("stts",0,0,[dt(t.timeToSampleTable.length),t.timeToSampleTable.map(t=>[dt(t.sampleCount),dt(t.sampleDelta)])]),Wt=t=>{if(t.samples.every(t=>"key"===t.type))return null;let e=[...t.samples.entries()].filter(([,t])=>"key"===t.type);return _t("stss",0,0,[dt(e.length),e.map(([t])=>dt(t+1))])},Nt=t=>_t("stsc",0,0,[dt(t.compactlyCodedChunkTable.length),t.compactlyCodedChunkTable.map(t=>[dt(t.firstChunk),dt(t.samplesPerChunk),dt(1)])]),Bt=t=>_t("stsz",0,0,[dt(0),dt(t.samples.length),t.samples.map(t=>dt(t.size))]),Ht=t=>t.writtenChunks.length>0&&mt(t.writtenChunks).offset>=Q(2,32)?_t("co64",0,0,[dt(t.writtenChunks.length),t.writtenChunks.map(t=>{return e=t.offset,at.setUint32(0,Math.floor(e/Q(2,32)),!1),at.setUint32(4,e,!1),[ot[0],ot[1],ot[2],ot[3],ot[4],ot[5],ot[6],ot[7]];var e})]):_t("stco",0,0,[dt(t.writtenChunks.length),t.writtenChunks.map(t=>dt(t.offset))]),zt={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},Gt={avc:t=>t.codecPrivate&&Et("avcC",[...t.codecPrivate]),hevc:t=>t.codecPrivate&&Et("hvcC",[...t.codecPrivate]),vp9:t=>t.codecPrivate&&Et("vpcC",[...t.codecPrivate]),av1:t=>t.codecPrivate&&Et("av1C",[...t.codecPrivate])},Kt={aac:"mp4a",opus:"opus"},Jt={aac:t=>_t("esds",0,0,[dt(58753152),lt(32+t.codecPrivate.byteLength),ht(1),lt(0),dt(75530368),lt(18+t.codecPrivate.byteLength),lt(64),lt(21),ct(0),dt(130071),dt(130071),dt(92307584),lt(t.codecPrivate.byteLength),...t.codecPrivate,dt(109084800),lt(1),lt(2)]),opus:t=>Et("dOps",[lt(0),lt(t.info.numberOfChannels),ht(3840),dt(t.info.sampleRate),ut(0),lt(0)])},$t=class{constructor(){this.buffer=null}},Yt=class{constructor(t,e,i){this.onData=t,this.onDone=e,this.options=i}},jt=class{constructor(t,e){this.stream=t,this.options=e}},Xt=class{constructor(){this.pos=0,nt(this,H,new Uint8Array(8)),nt(this,z,new DataView(it(this,H).buffer)),this.offsets=new WeakMap}seek(t){this.pos=t}writeU32(t){it(this,z).setUint32(0,t,!1),this.write(it(this,H).subarray(0,4))}writeU64(t){it(this,z).setUint32(0,Math.floor(t/Q(2,32)),!1),it(this,z).setUint32(4,t,!1),this.write(it(this,H).subarray(0,8))}writeAscii(t){for(let e=0;e<t.length;e++)it(this,z).setUint8(e%8,t.charCodeAt(e)),e%8==7&&this.write(it(this,H));t.length%8!=0&&this.write(it(this,H).subarray(0,t.length%8))}writeBox(t){var e,i;if(this.offsets.set(t,this.pos),t.contents&&!t.children)this.writeBoxHeader(t,null!=(e=t.size)?e:t.contents.byteLength+8),this.write(t.contents);else{let e=this.pos;if(this.writeBoxHeader(t,0),t.contents&&this.write(t.contents),t.children)for(let e of t.children)e&&this.writeBox(e);let n=this.pos,s=null!=(i=t.size)?i:n-e;this.seek(e),this.writeBoxHeader(t,s),this.seek(n)}}writeBoxHeader(t,e){this.writeU32(t.largeSize?1:e),this.writeAscii(t.type),t.largeSize&&this.writeU64(e)}patchBox(t){let e=this.pos;this.seek(this.offsets.get(t)),this.writeBox(t),this.seek(e)}};H=new WeakMap,z=new WeakMap;var qt,Zt,Qt=class extends Xt{constructor(t){super(),nt(this,$),nt(this,G,void 0),nt(this,K,new ArrayBuffer(Q(2,16))),nt(this,J,new Uint8Array(it(this,K))),st(this,G,t)}write(t){rt(this,$,Y).call(this,this.pos+t.byteLength),it(this,J).set(t,this.pos),this.pos+=t.byteLength}finalize(){rt(this,$,Y).call(this,this.pos),it(this,G).buffer=it(this,K).slice(0,this.pos)}};G=new WeakMap,K=new WeakMap,J=new WeakMap,$=new WeakSet,Y=function(t){let e=it(this,K).byteLength;for(;e<t;)e*=2;if(e===it(this,K).byteLength)return;let i=new ArrayBuffer(e),n=new Uint8Array(i);n.set(it(this,J),0),st(this,K,i),st(this,J,n)};var te=class extends Xt{constructor(t){super(),nt(this,qt,void 0),nt(this,Zt,[]),st(this,qt,t)}write(t){it(this,Zt).push({data:t.slice(),start:this.pos}),this.pos+=t.byteLength}flush(){if(0===it(this,Zt).length)return;let t=[],e=[...it(this,Zt)].sort((t,e)=>t.start-e.start);t.push({start:e[0].start,size:e[0].data.byteLength});for(let i=1;i<e.length;i++){let n=t[t.length-1],s=e[i];s.start<=n.start+n.size?n.size=Math.max(n.size,s.start+s.data.byteLength-n.start):t.push({start:s.start,size:s.data.byteLength})}for(let e of t){e.data=new Uint8Array(e.size);for(let t of it(this,Zt))e.start<=t.start&&t.start<e.start+e.size&&e.data.set(t.data,t.start-e.start);it(this,qt).onData(e.data,e.start)}it(this,Zt).length=0}finalize(){var t,e;null==(e=(t=it(this,qt)).onDone)||e.call(t)}};qt=new WeakMap,Zt=new WeakMap;var ee,ie,ne,se,re,oe,ae,le,he,ce,de,ue=Q(2,24),ge=class extends Xt{constructor(t){var e,i;if(super(),nt(this,se),nt(this,oe),nt(this,le),nt(this,ce),nt(this,ee,void 0),nt(this,ie,void 0),nt(this,ne,[]),st(this,ee,t),st(this,ie,null!=(i=null==(e=t.options)?void 0:e.chunkSize)?i:ue),!Number.isInteger(it(this,ie))||it(this,ie)<Q(2,10))throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(t){rt(this,se,re).call(this,t,this.pos),rt(this,ce,de).call(this),this.pos+=t.byteLength}finalize(){var t,e;rt(this,ce,de).call(this,!0),null==(e=(t=it(this,ee)).onDone)||e.call(t)}};ee=new WeakMap,ie=new WeakMap,ne=new WeakMap,se=new WeakSet,re=function(t,e){let i=it(this,ne).findIndex(t=>t.start<=e&&e<t.start+it(this,ie));-1===i&&(i=rt(this,le,he).call(this,e));let n=it(this,ne)[i],s=e-n.start,r=t.subarray(0,Math.min(it(this,ie)-s,t.byteLength));n.data.set(r,s);let o={start:s,end:s+r.byteLength};if(rt(this,oe,ae).call(this,n,o),0===n.written[0].start&&n.written[0].end===it(this,ie)&&(n.shouldFlush=!0),it(this,ne).length>2){for(let t=0;t<it(this,ne).length-1;t++)it(this,ne)[t].shouldFlush=!0;rt(this,ce,de).call(this)}r.byteLength<t.byteLength&&rt(this,se,re).call(this,t.subarray(r.byteLength),e+r.byteLength)},oe=new WeakSet,ae=function(t,e){let i=0,n=t.written.length-1,s=-1;for(;i<=n;){let r=Math.floor(i+(n-i+1)/2);t.written[r].start<=e.start?(i=r+1,s=r):n=r-1}for(t.written.splice(s+1,0,e),(-1===s||t.written[s].end<e.start)&&s++;s<t.written.length-1&&t.written[s].end>=t.written[s+1].start;)t.written[s].end=Math.max(t.written[s].end,t.written[s+1].end),t.written.splice(s+1,1)},le=new WeakSet,he=function(t){let e={start:Math.floor(t/it(this,ie))*it(this,ie),data:new Uint8Array(it(this,ie)),written:[],shouldFlush:!1};return it(this,ne).push(e),it(this,ne).sort((t,e)=>t.start-e.start),it(this,ne).indexOf(e)},ce=new WeakSet,de=function(t=!1){for(let e=0;e<it(this,ne).length;e++){let i=it(this,ne)[e];if(i.shouldFlush||t){for(let t of i.written)it(this,ee).onData(i.data.subarray(t.start,t.end),i.start+t.start);it(this,ne).splice(e--,1)}}};var fe,pe,me,ve,ye,Se,we,Ee,_e,Ce,De,Te,be,Me,Pe,ke,Oe,xe,Ae,Ie,Re,Ve,Ue,Fe,Le,We,Ne,Be,He=class extends ge{constructor(t){var e;super(new Yt((e,i)=>t.stream.write({type:"write",data:e,position:i}),void 0,{chunkSize:null==(e=t.options)?void 0:e.chunkSize}))}},ze=1e3,Ge=["avc","hevc","vp9","av1"],Ke=["aac","opus"],Je=["strict","offset"],$e=class{constructor(t){var e;if(nt(this,Ee),nt(this,Ce),nt(this,Te),nt(this,Me),nt(this,ke),nt(this,xe),nt(this,Ie),nt(this,Ve),nt(this,Fe),nt(this,fe,void 0),nt(this,pe,void 0),nt(this,me,void 0),nt(this,ve,null),nt(this,ye,null),nt(this,Se,Math.floor(Date.now()/1e3)+2082844800),nt(this,we,!1),rt(this,Ee,_e).call(this,t),this.target=t.target,st(this,fe,((t,e)=>{for(var i in e||={})q.call(e,i)&&tt(t,i,e[i]);if(X)for(var i of X(e))Z.call(e,i)&&tt(t,i,e[i]);return t})({firstTimestampBehavior:"strict"},t)),t.target instanceof $t)st(this,pe,new Qt(t.target));else if(t.target instanceof Yt)st(this,pe,(null==(e=t.target.options)?void 0:e.chunked)?new ge(t.target):new te(t.target));else{if(!(t.target instanceof jt))throw new Error(`Invalid target: ${t.target}`);st(this,pe,new He(t.target))}rt(this,Ce,De).call(this),rt(this,Te,be).call(this)}addVideoChunk(t,e,i){let n=new Uint8Array(t.byteLength);t.copyTo(n),this.addVideoChunkRaw(n,t.type,null!=i?i:t.timestamp,t.duration,e)}addVideoChunkRaw(t,e,i,n,s){if(rt(this,Fe,Le).call(this),!it(this,fe).video)throw new Error("No video track declared.");rt(this,ke,Oe).call(this,it(this,ve),t,e,i,n,s)}addAudioChunk(t,e,i){let n=new Uint8Array(t.byteLength);t.copyTo(n),this.addAudioChunkRaw(n,t.type,null!=i?i:t.timestamp,t.duration,e)}addAudioChunkRaw(t,e,i,n,s){if(rt(this,Fe,Le).call(this),!it(this,fe).audio)throw new Error("No audio track declared.");rt(this,ke,Oe).call(this,it(this,ye),t,e,i,n,s)}finalize(){it(this,ve)&&rt(this,Ie,Re).call(this,it(this,ve)),it(this,ye)&&rt(this,Ie,Re).call(this,it(this,ye));let t=it(this,pe).offsets.get(it(this,me)),e=it(this,pe).pos-t;it(this,me).size=e,it(this,pe).patchBox(it(this,me));let i=(n=[it(this,ve),it(this,ye)].filter(Boolean),s=it(this,Se),Et("moov",null,[Ct(s,n),...n.map(t=>((t,e)=>Et("trak",null,[Dt(t,e),Tt(t,e)]))(t,s))]));var n,s;it(this,pe).writeBox(i),rt(this,Ve,Ue).call(this),it(this,pe).finalize(),st(this,we,!0)}};fe=new WeakMap,pe=new WeakMap,me=new WeakMap,ve=new WeakMap,ye=new WeakMap,Se=new WeakMap,we=new WeakMap,Ee=new WeakSet,_e=function(t){if(t.video){if(!Ge.includes(t.video.codec))throw new Error(`Unsupported video codec: ${t.video.codec}`);if(void 0!==t.video.rotation&&![0,90,180,270].includes(t.video.rotation))throw new Error(`Invalid video rotation: ${t.video.rotation}. Has to be 0, 90, 180 or 270.`)}if(t.audio&&!Ke.includes(t.audio.codec))throw new Error(`Unsupported audio codec: ${t.audio.codec}`);if(t.firstTimestampBehavior&&!Je.includes(t.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${t.firstTimestampBehavior}`)},Ce=new WeakSet,De=function(){var t;let e="hevc"===(null==(t=it(this,fe).video)?void 0:t.codec);it(this,pe).writeBox((t=>Et("ftyp",t?[pt("isom"),dt(0),pt("iso4"),pt("hvc1")]:[pt("isom"),dt(0),pt("isom"),pt("avc1"),pt("mp41")]))(e)),st(this,me,{type:"mdat",largeSize:!0}),it(this,pe).writeBox(it(this,me)),rt(this,Ve,Ue).call(this)},Te=new WeakSet,be=function(){var t;if(it(this,fe).video&&st(this,ve,{id:1,info:{type:"video",codec:it(this,fe).video.codec,width:it(this,fe).video.width,height:it(this,fe).video.height,rotation:null!=(t=it(this,fe).video.rotation)?t:0},timescale:720,codecPrivate:new Uint8Array(0),samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]}),it(this,fe).audio){let t=rt(this,Me,Pe).call(this,2,it(this,fe).audio.sampleRate,it(this,fe).audio.numberOfChannels);st(this,ye,{id:it(this,fe).video?2:1,info:{type:"audio",codec:it(this,fe).audio.codec,numberOfChannels:it(this,fe).audio.numberOfChannels,sampleRate:it(this,fe).audio.sampleRate},timescale:it(this,fe).audio.sampleRate,codecPrivate:t,samples:[],writtenChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,compactlyCodedChunkTable:[]})}},Me=new WeakSet,Pe=function(t,e,i){let n=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(e),s=i,r="";r+=t.toString(2).padStart(5,"0"),r+=n.toString(2).padStart(4,"0"),15===n&&(r+=e.toString(2).padStart(24,"0")),r+=s.toString(2).padStart(4,"0");let o=8*Math.ceil(r.length/8);r=r.padEnd(o,"0");let a=new Uint8Array(r.length/8);for(let t=0;t<r.length;t+=8)a[t/8]=parseInt(r.slice(t,t+8),2);return a},ke=new WeakSet,Oe=function(t,e,i,n,s,r){var o;let a=n/1e6,l=s/1e6;if(void 0===t.firstTimestamp&&(t.firstTimestamp=a),a=rt(this,xe,Ae).call(this,a,t),t.lastTimestamp=a,(!t.currentChunk||a-t.currentChunk.startTimestamp>=.5)&&(t.currentChunk&&rt(this,Ie,Re).call(this,t),t.currentChunk={startTimestamp:a,sampleData:[],sampleCount:0}),t.currentChunk.sampleData.push(e),t.currentChunk.sampleCount++,(null==(o=null==r?void 0:r.decoderConfig)?void 0:o.description)&&(t.codecPrivate=new Uint8Array(r.decoderConfig.description)),t.samples.push({timestamp:a,duration:l,size:e.byteLength,type:i}),null!==t.lastTimescaleUnits){let e=vt(a,t.timescale,!1),i=Math.round(e-t.lastTimescaleUnits);t.lastTimescaleUnits+=i;let n=mt(t.timeToSampleTable);1===n.sampleCount?(n.sampleDelta=i,n.sampleCount++):n.sampleDelta===i?n.sampleCount++:(n.sampleCount--,t.timeToSampleTable.push({sampleCount:2,sampleDelta:i}))}else t.lastTimescaleUnits=0,t.timeToSampleTable.push({sampleCount:1,sampleDelta:vt(l,t.timescale)})},xe=new WeakSet,Ae=function(t,e){if("strict"===it(this,fe).firstTimestampBehavior&&-1===e.lastTimestamp&&0!==t)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${t}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.\n\nIf you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.\n`);if("offset"===it(this,fe).firstTimestampBehavior&&(t-=e.firstTimestamp),t<e.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${1e6*e.lastTimestamp} to ${1e6*t}).`);return t},Ie=new WeakSet,Re=function(t){if(t.currentChunk){t.currentChunk.offset=it(this,pe).pos;for(let e of t.currentChunk.sampleData)it(this,pe).write(e);t.currentChunk.sampleData=null,0!==t.compactlyCodedChunkTable.length&&mt(t.compactlyCodedChunkTable).samplesPerChunk===t.currentChunk.sampleCount||t.compactlyCodedChunkTable.push({firstChunk:t.writtenChunks.length+1,samplesPerChunk:t.currentChunk.sampleCount}),t.writtenChunks.push(t.currentChunk),rt(this,Ve,Ue).call(this)}},Ve=new WeakSet,Ue=function(){it(this,pe)instanceof te&&it(this,pe).flush()},Fe=new WeakSet,Le=function(){if(it(this,we))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};class Ye{constructor(t,e){this.firstVTimestamp=null,this.firstATimestamp=null,this.startTime=null,this.endTime=null,this.mp4WriterEnable=!0,this.mp4Name=null,this.mp4WriterConf=null,this.currentTimestamp=null,this.totalBytesReceived=0,t&&console.log("mp4writer",e),this._debug=t,this.mp4WriterConf=e,this.startTime=new Date(e.begintime).getTime(),this.endTime=new Date(e.endtime).getTime(),this.mp4Name=e.mp4name,this.endTime>this.startTime&&e.mp4writer&&(this.mp4WriterEnable=!0)}handleDataReceived(t){const e=new Uint8Array(t.data);this.totalBytesReceived+=e.byteLength,null!=this.mp4DateTimer&&clearTimeout(this.mp4DateTimer),this.handleData(e),this.mp4DateTimer=setTimeout(()=>{this.mp4WriterEnable&&this.finish()},1e4)}handleData(t){if(!this.mp4WriterEnable)return;const e=new DataView(t.buffer),i={StreamType:e.getUint32(0,!1),FrameType:e.getUint32(4,!1),Seq:e.getUint32(8,!1),Secs:e.getBigUint64(12,!1),Msecs:e.getUint32(20,!1),DataLen:e.getUint32(24,!1),Ptsdiff:e.getUint32(28,!1)},n=1000n*i.Secs+BigInt(i.Msecs);if(i.StreamType===I.VIDEO_STREAM_INFO&&i.FrameType===R.VIDEO_FRM_INFO){const i=4096,n={Video:e.getUint32(32,!1),Width:e.getUint32(36,!1),Height:e.getUint32(40,!1),Fps:e.getUint32(44,!1),vExtra:new Uint8Array(t.slice(48,48+i)),vExtraLen:e.getUint32(48+i,!1),Audio:e.getUint32(52+i,!1),aSampleRate:e.getUint32(56+i,!1),aSampleBit:e.getUint32(60+i,!1),aChannels:e.getUint32(64+i,!1),aExtra:new Uint8Array(t.slice(68+i,68+2*i)),aExtraLen:e.getUint32(68+2*i,!1)};return!0===this._debug&&console.log("[WS2] info data:",n),void(this.muxer||(this.muxer=new $e({target:new $t,video:{codec:this.getVideoCodecString(n.Video),width:n.Width,height:n.Height},audio:{codec:this.getAudioCodecString(n.Audio),sampleRate:n.aSampleRate,numberOfChannels:n.aChannels},firstTimestampBehavior:"offset"})))}return i.FrameType!==R.VIDEO_FRM_I&&i.FrameType!==R.VIDEO_FRM_P&&i.FrameType!==R.VIDEO_FRM_B||this.handleVodioData(i,n,t),i.StreamType===I.VIDEO_STREAM_AUDIO&&i.FrameType===R.VIDEO_FRM_AUDIO&&this.handleAudioData(i,n,t),null}handleAudioData(t,e,i){let n=BigInt(0);if(null==this.firstATimestamp?this.firstATimestamp=e:n=e-this.firstATimestamp,e+BigInt(1e3)>=this.endTime)return void this.finish();const s=1000n*n,r=i.subarray(32);try{const t=new EncodedAudioChunk({type:"key",timestamp:Number(s),data:r});this.muxer.addAudioChunk(t)}catch(t){console.error("Error adding audio chunk:",t)}}handleVodioData(t,e,i){let n=BigInt(0);if(null==this.firstVTimestamp?(this.firstVTimestamp=e,this.firstATimestamp=e):n=e-this.firstVTimestamp,e+BigInt(1e3)>=this.endTime)return void this.finish();this.currentTimestamp=e;const s=1000n*n,r=i.subarray(32);try{const e=new EncodedVideoChunk({type:this.getFrameType(t.FrameType),timestamp:Number(s),data:r});this.muxer.addVideoChunk(e)}catch(t){}}getFrameType(t){switch(t){case R.VIDEO_FRM_I:return"key";case R.VIDEO_FRM_P:case R.VIDEO_FRM_B:default:return"delta"}}getVideoCodecString(t){switch(t){case A.CODEC_H264:return"avc";case A.CODEC_H265:return"hevc";case A.CODEC_VP9:return"vp9";case A.CODEC_AV1:return"av1";case A.CODEC_MJPEG:default:return"avc"}}getAudioCodecString(t){return t===A.CODEC_AAC?"aac":"opus"}destory(){let t=this.formatWithTimezoneOffset(new Date(Number(this.currentTimestamp)));console.log(t);let e=`{\n        "type": "H5S_MP4_WRITER_CLOSE",\n        "strTime": "${t}"\n       }`;this.mp4WriterConf.callback(e,this.mp4WriterConf.userdata),this.firstVTimestamp=null,this.firstATimestamp=null,this.startTime=null,this.endTime=null,this.muxer=null,this.mp4WriterConf=null}finish(){if(this.muxer&&this.mp4WriterEnable){this.mp4WriterEnable=!1,this.muxer.finalize();let t=this.muxer.target.buffer;this.downloadBlob(new Blob([t])),this.destory()}}downloadBlob(t){let e=window.URL.createObjectURL(t),i=document.createElement("a");i.style.display="none",i.href=e,i.download=this.mp4Name,document.body.appendChild(i),i.click(),window.URL.revokeObjectURL(e)}formatWithTimezoneOffset(t){t||(t=new Date);const e=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),s=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0"),o=String(t.getSeconds()).padStart(2,"0"),a=t.getTimezoneOffset(),l=Math.abs(a);return`${e}-${i}-${n}T${s}:${r}:${o}${a<=0?"+":"-"}${String(Math.floor(l/60)).padStart(2,"0")}:${String(l%60).padStart(2,"0")}`}}class je{constructor({videoElement:t,eventEmitter:e}){this.videoWriter=null,this.audioWriter=null,this.videoBuffer=[],this.audioBuffer=[],this.audioClock=0,this.videoElement=t,this.eventEmitter=e,this.videoTrackGenerator=new MediaStreamTrackGenerator({kind:"video"}),this.audioTrackGenerator=new MediaStreamTrackGenerator({kind:"audio"});const i=new MediaStream([this.videoTrackGenerator,this.audioTrackGenerator]);this.videoElement.srcObject=i;try{this.videoElement.play();var n=this.videoElement.play();void 0!==n&&n.then(t=>{}).catch(t=>{})}catch(t){}this.eventEmitter.on(O,this.inputVideoFrame.bind(this)),this.eventEmitter.on(x,this.inputAudioFrame.bind(this))}destory(){this.eventEmitter.off(O,this.inputVideoFrame.bind(this)),this.eventEmitter.off(x,this.inputAudioFrame.bind(this))}inputVideoFrame(t){this.videoBuffer.push(t),this.processFrames()}inputAudioFrame(t){this.audioBuffer.push(t),this.processFrames()}async processFrames(){for(;this.videoBuffer.length>0;){const t=this.videoBuffer.shift();for(await this.renderFrame(t);this.audioBuffer.length>0;){const e=this.audioBuffer[0],i=e.timestamp-t.timestamp;if(Math.abs(i)<=8e4)await this.renderFrame(e),this.audioBuffer.shift();else{if(!(i<-8e4))break;this.audioBuffer.shift()}}}}async renderFrame(t){let e;t instanceof VideoFrame?(this.videoWriter||(this.videoWriter=this.videoTrackGenerator.writable.getWriter()),e=this.videoWriter):t instanceof AudioData&&(this.audioWriter||(this.audioWriter=this.audioTrackGenerator.writable.getWriter()),e=this.audioWriter);try{await e.write(t)}catch(i){console.error("[WS2] Error when trying to render frame:",i),e.releaseLock(),t instanceof VideoFrame?this.videoWriter=null:t instanceof AudioData&&(this.audioWriter=null)}finally{t.close()}}async renderVideoFrame(t){console.log("renderVideoFrame frame",t),this.videoWriter||(this.videoWriter=this.videoTrackGenerator.writable.getWriter());try{await this.videoWriter.write(t)}catch(t){console.error("Error when trying to render video frame:",t),this.videoWriter.releaseLock(),this.videoWriter=null}finally{t.close()}}async renderAudioFrame(t){console.log("audio frame",t),this.audioWriter||(this.audioWriter=this.audioTrackGenerator.writable.getWriter());try{await this.audioWriter.write(t)}catch(t){console.error("Error when trying to render audio frame:",t),this.audioWriter.releaseLock(),this.audioWriter=null}}}class Xe{constructor(t,e){this.wsSocket=null,this.keepaliveTimerId=null,this.reconnectTimerId=null,this.lastTimeDataRecvived=null,this.totalDataRecvived=BigInt(0),this._h264cpumode=!1,this._jbuffersize=300,this.decwo=null,this.renwo=null,this.mp4Writer=null,this._nSpeed=1,this.eventEmitter=null,this._debug=!0,this.config=t,this._videodom=e,null!=t.consolelog&&"false"===t.consolelog&&(this._debug=!1),null!=t.buffersize&&(this._jbuffersize=t.buffersize),!0===this._debug&&console.log("[WS2] buffer size:",this._jbuffersize),null!=t.h264cpumode&&"true"===t.h264cpumode&&(this._h264cpumode=!0),!0===this._debug&&console.log("[WS2] h264cpumode:",this._h264cpumode),this.bDisConnected=!1,this.bNeedReconnect=!1}getStatus(){if(this.decwo)return this.decwo.getStatus()}setupDecRenderWo(){if(this.closeDecRenderWo(),this.eventEmitter=new k,this.decwo||null==this._videodom||(this.decwo=new B(this._nSpeed,this._h264cpumode,this._jbuffersize,this._debug,this.eventEmitter,this.config.metaconf)),!this.renwo&&null!=this._videodom){const t=this._videodom;this.renwo=new je({videoElement:t,eventEmitter:this.eventEmitter})}}setupMp4writer(){this.mp4Writer||(this.mp4Writer=new Ye(this._debug,this.config.mp4writerconf))}closeDecRenderWo(){try{this.eventEmitter&&(this.eventEmitter=null),this.decwo&&(this.decwo.destory(),delete this.decwo),this.renwo&&(this.renwo.destory(),delete this.renwo),this.mp4Writer&&(this.mp4Writer.finish(),delete this.mp4Writer),this.decwo=null,this.renwo=null,this.mp4Writer=null}catch(t){!0===this._debug&&console.log(t)}}setupWebSocket(t){!0===this._debug&&console.log("[WS2] start connect to:",t),this.wsSocket=new WebSocket(t),this.wsSocket.binaryType="arraybuffer",this.wsSocket.onopen=this.handleOpen.bind(this),this.wsSocket.onmessage=this.handleMessage.bind(this),this.wsSocket.onclose=this.handleClose.bind(this),this.wsSocket.onerror=this.handleError.bind(this)}connect(t){this._url=t,this.setupWebSocket(t),this.reconnectTimerId=setInterval(this.ReconnectFunction.bind(this),3e3)}start(){try{this.sendMessage({cmd:"H5_START"})}catch(t){!0===this._debug&&console.log(t)}}pause(){try{this.sendMessage({cmd:"H5_PAUSE"})}catch(t){!0===this._debug&&console.log(t)}}resume(){try{this.sendMessage({cmd:"H5_RESUME"})}catch(t){!0===this._debug&&console.log(t)}}seek(t){try{this.sendMessage({cmd:"H5_SEEK",nSeekTime:t})}catch(t){!0===this._debug&&console.log(t)}}moveto(t){try{this.sendMessage({cmd:"H5_MOVETO",strMovetoTime:t})}catch(t){!0===this._debug&&console.log(t)}}speed(t){try{this._nSpeed=t,this.decwo&&this.decwo.setSpeed(t),this.sendMessage({cmd:"H5_SPEED",nSpeed:t})}catch(t){!0===this._debug&&console.log(t)}}handleMessage(t){if(null!=this.mp4DateTimer&&clearTimeout(this.mp4DateTimer),t.data instanceof ArrayBuffer){new Uint8Array(t.data);const e=t.data;this.totalDataRecvived=this.totalDataRecvived+BigInt(t.data.byteLength),this.decwo&&null!=this._videodom&&this.decwo.handleVideoDataReceived({data:e}),this.mp4Writer&&this.mp4Writer.handleDataReceived({data:e})}else{if("string"==typeof t.data)return null!=this.config.pbconf&&null!=this.config.pbconf.callback&&this.config.pbconf.callback(t.data,this.config.pbconf.userdata),void(null!=this.config.mp4writerconf&&null!=this.config.mp4writerconf.callback&&(this.mp4DateTimer=setTimeout(()=>{this.config.mp4writerconf.callback('{\n                        "type": "H5S_MP4_WRITER_FAIL"\n                    }',this.config.mp4writerconf.userdata)},1e4),this.config.mp4writerconf.callback(t.data,this.config.mp4writerconf.userdata)));!0===this._debug&&console.log("[WS2] Unexpected data type:",t.data)}}sendMessage(t){this.wsSocket&&this.wsSocket.readyState===WebSocket.OPEN?this.wsSocket.send(JSON.stringify(t)):!0===this._debug&&console.log("[WS2] WebSocket is not open. Cannot send message:",t)}disconnect(){this.bDisConnected=!0,clearInterval(this.reconnectTimerId),null!=this.wsSocket&&(this.wsSocket.close(),this.wsSocket=null),this.cleanupKeepalive(),this.closeDecRenderWo(),this.mp4Writer&&(this.mp4Writer.finish(),this.mp4Writer=null)}handleOpen(t){null!=this.config.pbconf&&"true"===this.config.pbconf.autoplay&&this.start(),this.setupKeepalive(),this.setupDecRenderWo(),null!=this.config.mp4writerconf&&this.config.mp4writerconf.mp4writer&&(this.start(),this.setupMp4writer())}handleClose(t){this.cleanupKeepalive(),!0===this._debug&&console.log("[WS2] wsSocket.onclose"),!0===this.bDisConnected?!0===this._debug&&console.log("[WS2] wsSocket.onclose disconnect"):this.bNeedReconnect=!0,this.closeDecRenderWo()}handleError(t){}setupKeepalive(){this.keepaliveTimerId=setInterval(this.keepaliveTimer.bind(this),5e3)}keepaliveTimer(){if(null!=this.lastTimeDataRecvived&&this.totalDataRecvived<=this.lastTimeDataRecvived&&void 0===this.config.pbconf&&void 0===this.config.mp4writerconf)return!0===this._debug&&console.log("[WS2] no data received reconnect..."),this.bNeedReconnect=!0,this.closeDecRenderWo(),void(this.wsSocket&&(this.wsSocket.close(),this.wsSocket=null));this.lastTimeDataRecvived=this.totalDataRecvived;try{this.sendMessage({cmd:"H5_KEEPALIVE"})}catch(t){!0===this._debug&&console.log(t)}}ReconnectFunction(){!0===this.bNeedReconnect&&(!0===this._debug&&console.log("[WS2] Reconnect..."),this.lastTimeDataRecvived=null,this.totalDataRecvived=BigInt(0),this.setupWebSocket(this._url),this.bNeedReconnect=!1)}cleanupKeepalive(){null!==this.keepaliveTimerId&&(clearInterval(this.keepaliveTimerId),this.keepaliveTimerId=null)}}class qe{constructor(t){console.log("[WS2] version","r2.3.1027.2024"),this.config=t,this._strPosterUri,this._debug=!0,void 0!==this.config.consolelog&&"false"===this.config.consolelog&&(this._debug=!1),this._videoId=this.config.videoid,void 0===this._videoId&&null!=this._videodom?(this._videodom=this.config.videodom,!0===this._debug&&console.log("[WS2] use dom directly",this.config.token)):null!=this._videoId&&(this._videodom=document.getElementById(this._videoId),!0===this._debug&&console.log("[WS2] use videoid",this.config.token)),null!=this.config.pbconf&&"false"==this.config.showposter&&null!=this._videodom?(this._strPosterUri=this.config.protocol+"//"+this.config.host+this.config.rootpath+"api/v1/GetLoadingImage?session="+this.config.session+"&refresh="+Math.floor(1e6*Math.random()),!0===this._debug&&console.log("[WS2] connect src",t.token),this._videodom.setAttribute("poster",this._strPosterUri)):null!=this._videodom&&(this._strPosterUri=this.config.protocol+"//"+this.config.host+this.config.rootpath+"api/v1/GetImage?token="+this.config.token+"&session="+this.config.session+"&refresh="+Math.floor(1e6*Math.random()),!0===this._debug&&console.log("[WS2] connect src",t.token),this._videodom.setAttribute("poster",this._strPosterUri))}connect(){var t="api/v1/h5slinkweb";!0===this._debug&&console.log("[WS2] API path",t);var e="main";void 0===this.config.streamprofile||(e=this.config.streamprofile);var i="false",n='video/mp4; codecs="hev1.1.6.L93.B0, mp4a.40.2"';if("MediaSource"in window&&MediaSource.isTypeSupported(n)?(!0===this._debug&&console.log("[WS2] MIME type or codec: ",n),i="true"):(!0===this._debug&&console.log("[WS2] Unsupported MIME type or codec: ",n),i="false"),void 0===this.config.pbconf&&void 0===this.config.mp4writerconf)t=this.config.rootpath+t+"?token="+this.config.token+"&hevc="+i+"&meta="+this.config.meta+"&profile="+e+"&session="+this.config.session;else if(void 0!==this.config.pbconf&&void 0===this.config.mp4writerconf){var s="false",r="fake";void 0===this.config.pbconf.serverpb||(s=this.config.pbconf.serverpb),void 0===this.config.pbconf.filename||(r=this.config.pbconf.filename);var o=this.config.pbconf.begintime;void 0===this.config.pbconf.moveto||(o=this.config.pbconf.moveto),t=this.config.rootpath+t+"?token="+this.config.token+"&playback=true&hevc="+i+"&profile="+e+"&serverpb="+s+"&begintime="+encodeURIComponent(this.config.pbconf.begintime)+"&endtime="+encodeURIComponent(this.config.pbconf.endtime)+"&moveto="+encodeURIComponent(o)+"&filename="+r+"&session="+this.config.session}else s="false",r="fake",void 0===this.config.mp4writerconf.serverpb||(s=this.config.mp4writerconf.serverpb),o=this.config.mp4writerconf.begintime,t=this.config.rootpath+t+"?token="+this.config.token+"&playback=true&hevc="+i+"&profile="+e+"&serverpb="+s+"&begintime="+encodeURIComponent(this.config.mp4writerconf.begintime)+"&endtime="+encodeURIComponent(this.config.mp4writerconf.endtime)+"&moveto="+encodeURIComponent(o)+"&filename="+r+"&session="+this.config.session;let a;"http:"==this.config.protocol&&(a="ws://"+this.config.host+t),"https:"==this.config.protocol&&(a="wss://"+this.config.host+t),!0===this._debug&&console.log("[WS2] connect to url ",a),this.webSocketManager=new Xe(this.config,this._videodom),this.webSocketManager.connect(a)}disconnect(){!0===this._debug&&console.log("[WS2] disconnect"),this.webSocketManager.disconnect(),this.webSocketManager=null}start(){this.webSocketManager.start()}pause(){this.webSocketManager.pause()}resume(){this.webSocketManager.resume()}seek(t){this.webSocketManager.seek(t)}moveto(t){this.webSocketManager.moveto(t)}speed(t){this.webSocketManager.speed(t)}getStatus(){if(this.webSocketManager)return this.webSocketManager.getStatus()}}class Ze{constructor(t){this.wsSocket=null,this.keepaliveTimerId=null,this.reconnectTimerId=null,this.lastTimeDataRecvived=null,this.totalDataRecvived=BigInt(0),this.eventEmitter=null,this._debug=!0,this.config=t,null!=t.consolelog&&"false"===t.consolelog&&(this._debug=!1),this.bDisConnected=!1,this.bNeedReconnect=!1}setupWebSocket(t){!0===this._debug&&console.log("[VED mgr] start connect to:",t),this.wsSocket=new WebSocket(t),this.wsSocket.binaryType="arraybuffer",this.wsSocket.onopen=this.handleOpen.bind(this),this.wsSocket.onmessage=this.handleMessage.bind(this),this.wsSocket.onclose=this.handleClose.bind(this),this.wsSocket.onerror=this.handleError.bind(this)}connect(t){this._url=t,this.setupWebSocket(t),this.reconnectTimerId=setInterval(this.ReconnectFunction.bind(this),3e3)}createWindows(t,e){try{this.sendMessage({type:"VED_CMD_CREATE_WINDOW_REQ",createWindowReq:{nCount:t,nParentHandle:e}})}catch(t){!0===this._debug&&console.log(t)}}moveWindows(t,e){try{this.sendMessage({type:"VED_CMD_MOVE_WINDOW_REQ",session:this._dispSession,moveWindowReq:{animation:e,move:t}})}catch(t){!0===this._debug&&console.log(t)}}showWindows(t){try{this.sendMessage({type:"VED_CMD_SHOW_WINDOW_REQ",session:this._dispSession,winList:{win:t}})}catch(t){!0===this._debug&&console.log(t)}}hideWindows(t){try{this.sendMessage({type:"VED_CMD_HIDE_WINDOW_REQ",session:this._dispSession,winList:{win:t}})}catch(t){!0===this._debug&&console.log(t)}}start(){try{this.sendMessage({cmd:"H5_START"})}catch(t){!0===this._debug&&console.log(t)}}pause(){try{this.sendMessage({cmd:"H5_PAUSE"})}catch(t){!0===this._debug&&console.log(t)}}resume(){try{this.sendMessage({cmd:"H5_RESUME"})}catch(t){!0===this._debug&&console.log(t)}}seek(t){try{this.sendMessage({cmd:"H5_SEEK",nSeekTime:t})}catch(t){!0===this._debug&&console.log(t)}}moveto(t){try{this.sendMessage({cmd:"H5_MOVETO",strMovetoTime:t})}catch(t){!0===this._debug&&console.log(t)}}handleMessage(t){if("string"!=typeof t.data)!0===this._debug&&console.log("[VED mgr] Unexpected data type:",t.data);else if(null!=this.config.vedconf&&null!=this.config.vedconf.callback){try{let e=JSON.parse(t.data);"VED_CMD_EVENT_DISPLAY_SESSION"==e.type&&(this._dispSession=e.session)}catch(t){!0===this._debug&&console.log(t)}this.config.vedconf.callback(t.data,this.config.vedconf.userdata)}}sendMessage(t){if(this.wsSocket&&this.wsSocket.readyState===WebSocket.OPEN){let e=JSON.stringify(t);!0===this._debug&&console.log("[VED mgr] send:",e),this.wsSocket.send(e)}else!0===this._debug&&console.log("[VED mgr] WebSocket is not open. Cannot send message:",t)}disconnect(){this.bDisConnected=!0,clearInterval(this.reconnectTimerId),null!=this.wsSocket&&(this.wsSocket.close(),this.wsSocket=null),this.cleanupKeepalive()}handleOpen(t){null!=this.config.pbconf&&"true"===this.config.pbconf.autoplay&&this.start(),this.setupKeepalive()}handleClose(t){this.cleanupKeepalive(),!0===this._debug&&console.log("[VED mgr] wsSocket.onclose"),!0===this.bDisConnected?!0===this._debug&&console.log("[VED mgr] wsSocket.onclose disconnect"):this.bNeedReconnect=!0}handleError(t){}setupKeepalive(){this.keepaliveTimerId=setInterval(this.keepaliveTimer.bind(this),5e3)}keepaliveTimer(){if(null!=this.lastTimeDataRecvived&&this.totalDataRecvived<=this.lastTimeDataRecvived&&void 0===this.config.vedconf)return!0===this._debug&&console.log("[VED mgr] no data received reconnect..."),this.bNeedReconnect=!0,void(this.wsSocket&&(this.wsSocket.close(),this.wsSocket=null));this.lastTimeDataRecvived=this.totalDataRecvived;try{this.sendMessage({type:"VED_CMD_KEEPALIVE_REQ",session:this._dispSession})}catch(t){!0===this._debug&&console.log(t)}}ReconnectFunction(){!0===this.bNeedReconnect&&(!0===this._debug&&console.log("[VED mgr] Reconnect..."),this.lastTimeDataRecvived=null,this.totalDataRecvived=BigInt(0),this.setupWebSocket(this._url),this.bNeedReconnect=!1)}cleanupKeepalive(){null!==this.keepaliveTimerId&&(clearInterval(this.keepaliveTimerId),this.keepaliveTimerId=null)}}class Qe{constructor(t){this.eventEmitter=null,this._debug=!0,this.config=t,null!=t.consolelog&&"false"===t.consolelog&&(this._debug=!1),console.log("[VED] version","r1.0.1127.2024")}connect(){var t="api/v1/vedmgr";if(null==this.config.vedconf)return void console.log("[VED mgr] vedconf undefined");let e;!0===this._debug&&console.log("[VED mgr] API path",t),t=this.config.rootpath+t+"?bgcolorr="+this.config.vedconf.bgcolorr+"&bgcolorg="+this.config.vedconf.bgcolorg+"&bgcolorb="+this.config.vedconf.bgcolorb+"&session="+this.config.session,"http:"==this.config.protocol&&(e="ws://"+this.config.host+t),"https:"==this.config.protocol&&(e="wss://"+this.config.host+t),!0===this._debug&&console.log("[VED mgr] connect to url ",e),this.ws=new Ze(this.config),this.ws.connect(e)}createWindows(t,e){this.ws.createWindows(t,e)}moveWindows(t,e){this.ws.moveWindows(t,e)}showWindows(t){this.ws.showWindows(t)}hideWindows(t){this.ws.hideWindows(t)}disconnect(){!0===this._debug&&console.log("[VED ply] disconnect"),this.ws.disconnect(),this.ws=null}}class ti{constructor(t){this.wsSocket=null,this.keepaliveTimerId=null,this.reconnectTimerId=null,this.lastTimeDataRecvived=null,this.totalDataRecvived=BigInt(0),this._nSpeed=1,this.eventEmitter=null,this._debug=!0,this.config=t,null!=t.consolelog&&"false"===t.consolelog&&(this._debug=!1),this.bDisConnected=!1,this.bNeedReconnect=!1}setupWebSocket(t){!0===this._debug&&console.log("[VED ply] start connect to:",t),this.wsSocket=new WebSocket(t),this.wsSocket.binaryType="arraybuffer",this.wsSocket.onopen=this.handleOpen.bind(this),this.wsSocket.onmessage=this.handleMessage.bind(this),this.wsSocket.onclose=this.handleClose.bind(this),this.wsSocket.onerror=this.handleError.bind(this)}connect(t){this._url=t,this.setupWebSocket(t),this.reconnectTimerId=setInterval(this.ReconnectFunction.bind(this),3e3)}start(){try{this.sendMessage({cmd:"H5_START"})}catch(t){!0===this._debug&&console.log(t)}}pause(){try{this.sendMessage({cmd:"H5_PAUSE"})}catch(t){!0===this._debug&&console.log(t)}}resume(){try{this.sendMessage({cmd:"H5_RESUME"})}catch(t){!0===this._debug&&console.log(t)}}seek(t){try{this.sendMessage({cmd:"H5_SEEK",nSeekTime:t})}catch(t){!0===this._debug&&console.log(t)}}moveto(t){try{this.sendMessage({cmd:"H5_MOVETO",strMovetoTime:t})}catch(t){!0===this._debug&&console.log(t)}}speed(t){try{this._nSpeed=t,this.sendMessage({cmd:"H5_SPEED",nSpeed:t})}catch(t){!0===this._debug&&console.log(t)}}handleMessage(t){if(t.data instanceof ArrayBuffer)new Uint8Array(t.data),t.data,this.totalDataRecvived=this.totalDataRecvived+BigInt(t.data.byteLength);else{if("string"==typeof t.data)return void(null!=this.config.pbconf&&null!=this.config.pbconf.callback&&this.config.pbconf.callback(t.data,this.config.pbconf.userdata));!0===this._debug&&console.log("[VED ply] Unexpected data type:",t.data)}}sendMessage(t){this.wsSocket&&this.wsSocket.readyState===WebSocket.OPEN?this.wsSocket.send(JSON.stringify(t)):!0===this._debug&&console.log("[VED ply] WebSocket is not open. Cannot send message:",t)}disconnect(){this.bDisConnected=!0,clearInterval(this.reconnectTimerId),null!=this.wsSocket&&(this.wsSocket.close(),this.wsSocket=null),this.cleanupKeepalive()}handleOpen(t){null!=this.config.pbconf&&"true"===this.config.pbconf.autoplay&&this.start(),this.setupKeepalive()}handleClose(t){this.cleanupKeepalive(),!0===this._debug&&console.log("[VED ply] wsSocket.onclose"),!0===this.bDisConnected?!0===this._debug&&console.log("[VED ply] wsSocket.onclose disconnect"):this.bNeedReconnect=!0}handleError(t){}setupKeepalive(){this.keepaliveTimerId=setInterval(this.keepaliveTimer.bind(this),5e3)}keepaliveTimer(){null!=this.lastTimeDataRecvived&&(this.totalDataRecvived,this.lastTimeDataRecvived),this.lastTimeDataRecvived=this.totalDataRecvived;try{this.sendMessage({cmd:"H5_KEEPALIVE"})}catch(t){!0===this._debug&&console.log(t)}}ReconnectFunction(){!0===this.bNeedReconnect&&(!0===this._debug&&console.log("[VED ply] Reconnect..."),this.lastTimeDataRecvived=null,this.totalDataRecvived=BigInt(0),this.setupWebSocket(this._url),this.bNeedReconnect=!1)}cleanupKeepalive(){null!==this.keepaliveTimerId&&(clearInterval(this.keepaliveTimerId),this.keepaliveTimerId=null)}}class ei{constructor(t){this.config=t,this._debug=!0,void 0!==this.config.consolelog&&"false"===this.config.consolelog&&(this._debug=!1)}connect(){var t="api/v1/vedplayer";!0===this._debug&&console.log("[VED ply] API path",t);var e="main";void 0===this.config.streamprofile||(e=this.config.streamprofile);var i="true";if(void 0===this.config.pbconf)t=this.config.rootpath+t+"?token="+this.config.token+"&dispsesssion="+this.config.dispsesssion+"&dispwindow="+this.config.dispwindow+"&serverip="+this.config.serverip+"&serverport="+this.config.serverport+"&serversession="+this.config.serversession+"&serverhttps="+this.config.serverhttps+"&hevc="+i+"&profile="+e+"&session="+this.config.session;else if(void 0!==this.config.pbconf){var n="false",s="fake";void 0===this.config.pbconf.serverpb||(n=this.config.pbconf.serverpb),void 0===this.config.pbconf.filename||(s=this.config.pbconf.filename);var r=this.config.pbconf.begintime;void 0===this.config.pbconf.moveto||(r=this.config.pbconf.moveto),t=this.config.rootpath+t+"?token="+this.config.token+"&playback=true&dispsesssion="+this.config.dispsesssion+"&dispwindow="+this.config.dispwindow+"&serverip="+this.config.serverip+"&serverport="+this.config.serverport+"&serversession="+this.config.serversession+"&serverhttps="+this.config.serverhttps+"&hevc="+i+"&profile="+e+"&serverpb="+n+"&begintime="+encodeURIComponent(this.config.pbconf.begintime)+"&endtime="+encodeURIComponent(this.config.pbconf.endtime)+"&moveto="+encodeURIComponent(r)+"&filename="+s+"&session="+this.config.session}let o;"http:"==this.config.protocol&&(o="ws://"+this.config.host+t),"https:"==this.config.protocol&&(o="wss://"+this.config.host+t),!0===this._debug&&console.log("[VED ply] connect to url ",o),this.webSocketManager=new ti(this.config),this.webSocketManager.connect(o)}disconnect(){!0===this._debug&&console.log("[VED ply] disconnect"),this.webSocketManager.disconnect(),this.webSocketManager=null}start(){this.webSocketManager.start()}pause(){this.webSocketManager.pause()}resume(){this.webSocketManager.resume()}seek(t){this.webSocketManager.seek(t)}moveto(t){this.webSocketManager.moveto(t)}speed(t){this.webSocketManager.speed(t)}}!function(t){t[t.CODEC_PCMU=0]="CODEC_PCMU",t[t.CODEC_PCMA=8]="CODEC_PCMA",t[t.CODEC_G711A=19]="CODEC_G711A",t[t.CODEC_G711U=20]="CODEC_G711U",t[t.CODEC_H264=96]="CODEC_H264",t[t.CODEC_H265=98]="CODEC_H265",t[t.CODEC_MPEG4=97]="CODEC_MPEG4",t[t.CODEC_VP9=99]="CODEC_VP9",t[t.CODEC_AV1=101]="CODEC_AV1",t[t.CODEC_MJPEG=26]="CODEC_MJPEG",t[t.CODEC_AAC=100]="CODEC_AAC",t[t.CODEC_PS=200]="CODEC_PS",t[t.CODEC_G722=201]="CODEC_G722",t[t.CODEC_G726=202]="CODEC_G726",t[t.CODEC_OPUS=203]="CODEC_OPUS",t[t.CODEC_ARAW=204]="CODEC_ARAW",t[t.CODEC_NONE=254]="CODEC_NONE",t[t.CODEC_LAST=1e3]="CODEC_LAST"}(We||(We={})),function(t){t[t.VIDEO_STREAM_VIDEO=1]="VIDEO_STREAM_VIDEO",t[t.VIDEO_STREAM_AUDIO=2]="VIDEO_STREAM_AUDIO",t[t.VIDEO_STREAM_INFO=3]="VIDEO_STREAM_INFO",t[t.VIDEO_STREAM_TEXT=4]="VIDEO_STREAM_TEXT",t[t.VIDEO_STREAM_SDP=5]="VIDEO_STREAM_SDP",t[t.VIDEO_STREAM_PBEVENT=6]="VIDEO_STREAM_PBEVENT",t[t.VIDEO_STREAM_MUXED=7]="VIDEO_STREAM_MUXED",t[t.VIDEO_STREAM_META_DATA=8]="VIDEO_STREAM_META_DATA",t[t.VIDEO_STREAM_END=9]="VIDEO_STREAM_END",t[t.VIDEO_STREAM_LAST=10]="VIDEO_STREAM_LAST"}(Ne||(Ne={})),function(t){t[t.VIDEO_FRM_NONE=0]="VIDEO_FRM_NONE",t[t.VIDEO_FRM_I=1]="VIDEO_FRM_I",t[t.VIDEO_FRM_P=2]="VIDEO_FRM_P",t[t.VIDEO_FRM_B=3]="VIDEO_FRM_B",t[t.VIDEO_FRM_INFO=4]="VIDEO_FRM_INFO",t[t.VIDEO_FRM_AUDIO=5]="VIDEO_FRM_AUDIO",t[t.VIDEO_FRM_PBTIME=6]="VIDEO_FRM_PBTIME",t[t.VIDEO_FRM_PBPOS=7]="VIDEO_FRM_PBPOS",t[t.VIDEO_FRM_PBEND=8]="VIDEO_FRM_PBEND",t[t.VIDEO_FRM_MUXED=9]="VIDEO_FRM_MUXED",t[t.VIDEO_FRM_TRANS_INFO=10]="VIDEO_FRM_TRANS_INFO",t[t.VIDEO_FRM_PBSPEED=11]="VIDEO_FRM_PBSPEED",t[t.VIDEO_FRM_PBSEEKED=12]="VIDEO_FRM_PBSEEKED",t[t.VIDEO_FRM_PB_PAUSED=13]="VIDEO_FRM_PB_PAUSED",t[t.VIDEO_FRM_LAST=14]="VIDEO_FRM_LAST"}(Be||(Be={}));class ii{constructor(t){if(this.videoElement=null,this.videoCodec=null,this.firstTimestamp=null,this.isDecoderConfigured=!1,this.videoTrackGenerator=null,this.audioDecoderConfigured=!1,this.audioDecoder=null,this.audioTrackGenerator=null,this.audioCodec=null,this.audioWriter=null,this.videoElement=t,t){console.log("videoElement",t),this.videoTrackGenerator=new MediaStreamTrackGenerator({kind:"video"}),this.audioTrackGenerator=new MediaStreamTrackGenerator({kind:"audio"}),console.log("videoTrackGenerator",this.videoTrackGenerator);const e=new MediaStream;e.addTrack(this.videoTrackGenerator),e.addTrack(this.audioTrackGenerator),t.srcObject=e}this.initDecoder()}initDecoder(){"VideoDecoder"in window?this.videoDecoder=new VideoDecoder({output:this.handleVideoFrame.bind(this),error:t=>console.error("Video decoder error:",t)}):console.error("VideoDecoder API is not supported."),this.audioDecoder=new AudioDecoder({output:this.handleAudioFrame.bind(this),error:t=>console.error("Audio decoder error:",t)}),console.log("init decoder!!!!!! ")}handleVideoFrame(t){this.videoTrackGenerator?.write(t),t.close()}handleAudioFrame(t){this.audioTrackGenerator?.write(t),t.close()}start(t){console.log("start"),this.ws=new WebSocket(t),this.ws.binaryType="arraybuffer",this.ws.onmessage=t=>{const e=new Uint8Array(t.data);this.handleVideoData(e)}}handleVideoData(t){const e=new DataView(t.buffer),i={StreamType:e.getUint32(0,!1),FrameType:e.getUint32(4,!1),Seq:e.getUint32(8,!1),Secs:e.getBigUint64(12,!1),Msecs:e.getUint32(20,!1),DataLen:e.getUint32(24,!1),Ptsdiff:e.getUint32(28,!1)};null===this.firstTimestamp&&(this.firstTimestamp=1000n*i.Secs+BigInt(i.Msecs));const n=1000n*i.Secs+BigInt(i.Msecs)-this.firstTimestamp;if(i.StreamType===Ne.VIDEO_STREAM_INFO&&i.FrameType===Be.VIDEO_FRM_INFO){const i=4096,n={Video:e.getUint32(32,!1),Width:e.getUint32(36,!1),Height:e.getUint32(40,!1),Fps:e.getUint32(44,!1),vExtra:new Uint8Array(t.slice(48,48+i)),vExtraLen:e.getUint32(48+i,!1),Audio:e.getUint32(52+i,!1),aSampleRate:e.getUint32(56+i,!1),aSampleBit:e.getUint32(60+i,!1),aChannels:e.getUint32(64+i,!1),aExtra:new Uint8Array(t.slice(68+i,68+2*i)),aExtraLen:e.getUint32(68+2*i,!1)};return console.log("INFO DATA",n),this.aSampleRate=n.aSampleRate,this.aChannels=n.aChannels,this.audioCodec=this.getCodecString(n.Audio),this.videoCodec=this.getCodecString(n.Video),void this.audioDecoder.configure({codec:this.audioCodec,sampleRate:this.aSampleRate,numberOfChannels:this.aChannels})}if(i.StreamType===Ne.VIDEO_STREAM_AUDIO&&i.FrameType===Be.VIDEO_FRM_AUDIO){const e=new EncodedAudioChunk({type:this.getFrameType(i.FrameType),timestamp:Number(n),data:t});this.audioDecoder&&this.audioDecoder.decode(e)}if(this.videoCodec&&(i.FrameType===Be.VIDEO_FRM_I||i.FrameType===Be.VIDEO_FRM_P||i.FrameType===Be.VIDEO_FRM_B)&&this.isDecoderConfigured){const e=32,s=t.slice(e),r=new EncodedVideoChunk({type:this.getFrameType(i.FrameType),timestamp:Number(n),data:s});this.videoDecoder.decode(r)}}getCodecString(t){switch(t){case We.CODEC_PCMU:return"audio/PCMU";case We.CODEC_PCMA:case We.CODEC_G711A:case We.CODEC_G711U:return"audio/PCMA";case We.CODEC_H264:return"avc1.42001E";case We.CODEC_H265:return"hev1.1.6.L93.B0";case We.CODEC_MPEG4:return"video/mp4; codecs=mp4v.20.8";case We.CODEC_VP9:return"video/vp9; codecs=vp09.00.10.08";case We.CODEC_AV1:return"video/av1; codecs=av01";case We.CODEC_MJPEG:return"video/jpeg; codecs=mjpa";case We.CODEC_AAC:return"mp4a.40.2";case We.CODEC_G722:return"audio/G722";case We.CODEC_G726:return"audio/G726";case We.CODEC_OPUS:return"audio/opus";case We.CODEC_ARAW:return"audio/pcm; codecs=1";default:throw new Error("Unknown codec type")}}getFrameType(t){switch(console.log("frameType",t),t){case Be.VIDEO_FRM_I:return"key";case Be.VIDEO_FRM_P:case Be.VIDEO_FRM_B:default:return"delta"}}toHex(t){return Array.from(t).map(t=>t.toString(16).padStart(2,"0")).join(" ")}}const ni=t=>t.match(/([^])\1{1,127}|(?:([^])(?!\2)){1,128}/g).map(t=>t[0]===t[1]?String.fromCharCode(257-t.length)+t[0]:String.fromCharCode(t.length-1)+t).join("");function si(t){let e="",i=0;for(;i<t.length;){let n=t.charCodeAt(i++);e+=n>128?t[i++].repeat(257-n):n<128?t.slice(i,i+=n+1):""}return e}})(),n})());function r(t){return new RTCSessionDescription(t)}console.log("[h5s]","h5splayer r18.0.0823.2024");var o=!1,a=!1;function l(t){this.sourceBuffer,this.buffer=[],this.t,this.video,this.s,this.i,this.o,this.h=0,this.l=0,this.u=0,this.S=!1,this.v=!1,this.C=!1,this.p,this.H=1,this.P=!0,void 0!==t.consolelog&&"false"===t.consolelog&&(this.P=!1),this.m=t,!0===this.P&&console.log("[WS] Websocket Conf:",t),this.R=t.videoid,this.k=t.pbconf,this.W=t.token,void 0===this.R?(this.T=t.videodom,!0===this.P&&console.log("[WS] use dom directly",t.token)):(this.T=document.getElementById(this.R),!0===this.P&&console.log("[WS] use videoid",t.token)),null!=this.T.I&&(!0===this.P&&console.log("[WS] set latencyHint to 0"),this.T.I=0),this.video=this.T,this.A,null!=this.k&&"false"==this.k.showposter?(this.A=this.m.protocol+"//"+this.m.host+this.m.rootpath+"api/v1/GetLoadingImage?session="+this.m.session+"&refresh="+Math.floor(1e6*Math.random()),!0===this.P&&console.log("[WS] connect src",t.token),this.T.setAttribute("poster",this.A)):(this.A=this.m.protocol+"//"+this.m.host+this.m.rootpath+"api/v1/GetImage?token="+this.W+"&session="+this.m.session+"&refresh="+Math.floor(1e6*Math.random()),!0===this.P&&console.log("[WS] connect src",t.token),this.T.setAttribute("poster",this.A))}function h(t){this.s,this.o,this.S=!1,this.v=!1,this.P=!0,void 0!==t.consolelog&&"false"===t.consolelog&&(this.P=!1),this.m=t,this.R=t.videoid,this.k=t.pbconf,this.W=t.token,this.H=1,void 0===this.R?(this.T=t.videodom,!0===this.P&&console.log("[RTC] use dom directly",t.token)):(this.T=document.getElementById(this.R),!0===this.P&&console.log("[RTC] use videoid",t.token)),this.video=this.T,this.g=null,this.M={optional:[{DtlsSrtpKeyAgreement:!0}]},this.U={mandatory:{offerToReceiveAudio:!0,offerToReceiveVideo:!0}},this.O={iceServers:[]},this.N=[],this.A,null!=this.k&&"false"==this.k.showposter?(this.A=this.m.protocol+"//"+this.m.host+this.m.rootpath+"api/v1/GetLoadingImage?session="+this.m.session+"&refresh="+Math.floor(1e6*Math.random()),!0===this.P&&console.log("[WS] connect src",t.token),this.T.setAttribute("poster",this.A)):(this.A=this.m.protocol+"//"+this.m.host+this.m.rootpath+"api/v1/GetImage?token="+this.W+"&session="+this.m.session+"&refresh="+Math.floor(1e6*Math.random()),!0===this.P&&console.log("[WS] connect src",t.token),this.T.setAttribute("poster",this.A)),this.F=new MediaStream}function c(t){this.s,this.o,this.m=t,this.R=t.videoid,this.W=t.token,this.J,this._=t.hlsver,this.P=!0,void 0!==t.consolelog&&"false"===t.consolelog&&(this.P=!1),void 0===this.R?(this.T=t.videodom,!0===this.P&&console.log("[HLS] use dom directly",t.token)):(this.T=document.getElementById(this.R),!0===this.P&&console.log("[HLS] use videoid",t.token)),this.D=this.T,this.D.type="application/x-mpegURL",this.L=0,this.B=0;var e=this.m.protocol+"//"+window.location.host+"/api/v1/GetImage?token="+this.W+"&session="+this.m.session;this.T.setAttribute("poster",e)}function d(t){this.buffer=[],this.s,this.S=!1,this.v=!1,this.m=t,this.K=0,this.G=48e3,this.Z=!1,this.P=!0,void 0!==t.consolelog&&"false"===t.consolelog&&(this.P=!1),!0===this.P&&console.log("[AUDBACK] Aduio Back Conf:",t),this.W=t.token,this.V=new AudioContext,!0===this.P&&console.log("[AUDBACK] sampleRate",this.V.sampleRate),this.X()}function u(t){this.s,this.o,this.S=!1,this.v=!1,this.Y=!1,this.j,this.q,this.$=!1,this.tt=!1,this.et,this.st,this.it=[],this.ot=[],this.P=!0,void 0!==t.consolelog&&"false"===t.consolelog&&(this.P=!1),void 0!==t.nt&&"true"===t.nt&&(this.$=!0),void 0!==t.ht&&"true"===t.ht&&(this.tt=!0),this.m=t,void 0===t.localvideoid?(this.ct=t.localvideodom,!0===this.P&&console.log(t.token,"[CFE] local use dom directly")):(this.ct=document.getElementById(t.localvideoid),!0===this.P&&console.log(t.token,"[CFE] local use videoid")),void 0===t.remotevideoid?(this.rt=t.remotevideodom,!0===this.P&&console.log(t.token,"[CFE] remote use dom directly")):(this.rt=document.getElementById(t.remotevideoid),!0===this.P&&console.log(t.token,"[CFE] remote use videoid")),this.g=null,this.M={optional:[{DtlsSrtpKeyAgreement:!0}]},this.U={mandatory:{offerToReceiveAudio:!0,offerToReceiveVideo:!0,at:!1}},this.O={iceServers:[]},this.N=[]}function g(t,e,i){const n=new Blob(t,{type:"video/webm"}),s=window.URL.createObjectURL(n),r=document.createElement("a");r.style.display="none",r.href=s;const o=new Date;var a=e+"_"+o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()+"-"+o.getHours()+"-"+o.getMinutes()+"-"+o.getSeconds()+i;r.download=a,document.body.appendChild(r),r.click(),setTimeout(()=>{document.body.removeChild(r),window.URL.revokeObjectURL(s)},100)}function f(t){this.s,this.o,this.S=!1,this.v=!1,this.P=!0,void 0!==t.consolelog&&"false"===t.consolelog&&(this.P=!1),this.m=t,this.R=t.localvideoid,this.lt=t.user,this.H=1,void 0===this.R?(this.dt=t.localvideodom,!0===this.P&&console.log("[PUSH] use dom directly",t.user)):(this.dt=document.getElementById(this.R),!0===this.P&&console.log("[PUSH] use videoid",t.user)),this.video=this.dt,this.g=null,this.M={optional:[{DtlsSrtpKeyAgreement:!0}]},this.U={mandatory:{offerToReceiveAudio:!1,offerToReceiveVideo:!1}},this.O={iceServers:[]},this.N=[]}function p(t,i){var n={},s=[],r=[],o=[],a=[];if(navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then(function(t){t&&t.getTracks().forEach(t=>{t.stop()})}).catch(function(t){var e="[PUSH] getUserMedia failed: "+t.name+" "+t.message;alert(e)}),window.RTCRtpTransceiver&&"setCodecPreferences"in window.RTCRtpTransceiver.prototype){const t=window.RTCRtpSender.getCapabilities("video").codecs;var l=!1,h=!1;for(let e=0;e!==t.length;++e){const i=t[e];["video/red","video/ulpfec","video/rtx"].includes(i.mimeType)||(["video/VP9"].includes(i.mimeType)?l=!0:["video/H264"].includes(i.mimeType)&&(h=!0))}1==l&&s.push("VP9"),1==h&&s.push("H264")}else s.push("Default");navigator.mediaDevices.enumerateDevices().then(function(e){for(let t=0;t!==e.length;++t){const n=e[t];var i={};i.id=n.deviceId,i.name=n.label,"audioinput"===n.kind?r.push(i):"audiooutput"===n.kind?o.push(i):"videoinput"===n.kind&&a.push(i)}n.videocodec=s,n.videoin=a,n.audioin=r,n.audioout=o,t(n)}).catch(function(t){alert("[PUSH] enumerateDevices failed",e)})}function m(){var t,e='video/mp4; codecs="avc1.42E01E, mp4a.40.2"';return"MediaSource"in window&&MediaSource.isTypeSupported(e)&&(t="H264"),e='video/mp4; codecs="hev1.1.6.L93.B0, mp4a.40.2"',"MediaSource"in window&&MediaSource.isTypeSupported(e)&&(t+=" H265"),t}function v(){var t;return t="H264",1==o&&(t+=" H265"),t}function y(){return a}function S(t,e){return null==t||null==e?NaN:t<e?-1:t>e?1:t>=e?0:NaN}function w(t,e){return null==t||null==e?NaN:e<t?-1:e>t?1:e>=t?0:NaN}function E(t){let e,i,n;function s(t,n,s=0,r=t.length){if(s<r){if(0!==e(n,n))return r;do{const e=s+r>>>1;i(t[e],n)<0?s=e+1:r=e}while(s<r)}return s}return 2!==t.length?(e=S,i=(e,i)=>S(t(e),i),n=(e,i)=>t(e)-i):(e=t===S||t===w?t:_,i=t,n=t),{left:s,center:function(t,e,i=0,r=t.length){const o=s(t,e,i,r-1);return o>i&&n(t[o-1],e)>-n(t[o],e)?o-1:o},right:function(t,n,s=0,r=t.length){if(s<r){if(0!==e(n,n))return r;do{const e=s+r>>>1;i(t[e],n)<=0?s=e+1:r=e}while(s<r)}return s}}}function _(){return 0}(async function(){try{const t="v=0\r\no=- 4855078920460860878 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=group:BUNDLE 0\r\na=extmap-allow-mixed\r\na=msid-semantic: WMS 83ff--35video_label\r\nm=video 9 UDP/TLS/RTP/SAVPF 125 124 100 101 127\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-ufrag:PgLG\r\na=ice-pwd:O99ZdgQQ+94aOP0UYaMs1dWK\r\na=ice-options:trickle\r\na=fingerprint:sha-256 0A:3F:64:EA:CE:3C:B9:43:08:4B:8B:4C:85:7F:6C:DC:73:30:94:7E:1F:A4:9C:1F:63:69:74:07:25:AB:14:3A\r\na=setup:actpass\r\na=mid:0\r\na=extmap:1 urn:ietf:params:rtp-hdrext:toffset\r\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\r\na=extmap:3 urn:3gpp:video-orientation\r\na=extmap:4 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=extmap:5 http://www.webrtc.org/experiments/rtp-hdrext/playout-delay\r\na=extmap:6 http://www.webrtc.org/experiments/rtp-hdrext/video-content-type\r\na=extmap:7 http://www.webrtc.org/experiments/rtp-hdrext/video-timing\r\na=extmap:8 http://www.webrtc.org/experiments/rtp-hdrext/color-space\r\na=extmap:9 urn:ietf:params:rtp-hdrext:sdes:mid\r\na=extmap:10 urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id\r\na=extmap:11 urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id\r\na=sendonly\r\na=msid:83ff--35video_label video_label\r\na=rtcp-mux\r\na=rtcp-rsize\r\na=rtpmap:125 H265/90000\r\na=rtcp-fb:125 goog-remb\r\na=rtcp-fb:125 transport-cc\r\na=rtcp-fb:125 ccm fir\r\na=rtcp-fb:125 nack\r\na=rtcp-fb:125 nack pli\r\na=rtpmap:124 rtx/90000\r\na=fmtp:124 apt=125\r\na=rtpmap:100 red/90000\r\na=rtpmap:101 rtx/90000\r\na=fmtp:101 apt=100\r\na=rtpmap:127 ulpfec/90000\r\na=ssrc-group:FID 891420707 251370098\r\na=ssrc:891420707 cname:Z7P5xn6vR3vHWXgv\r\na=ssrc:891420707 msid:83ff--35video_label video_label\r\na=ssrc:251370098 cname:Z7P5xn6vR3vHWXgv\r\na=ssrc:251370098 msid:83ff--35video_label video_label\r\n",e=new RTCPeerConnection({iceServers:[]});await e.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:t}));const i=await e.createAnswer();return JSON.stringify(i).search("H265")>=0}catch(t){return!1}})().then(t=>{o=t,a=!0,console.log("[RTC] RTC init finished")}),l.prototype.ut=function(){if(!0===this.S){!0===this.P&&console.log("[WS] Reconnect...");var t=this.A+"&update="+this.H;this.T.setAttribute("poster",t),!0===this.P&&console.log("[WS] Reconnect image",t),this.H++,this.ft(this.W),this.S=!1}},l.prototype.St=function(t){var e;!0===this.P&&console.log("[WS] H5SWebSocketClient");try{"http:"==this.m.protocol&&(e="undefined"!=typeof MozWebSocket?new MozWebSocket("ws://"+this.m.host+t):new WebSocket("ws://"+this.m.host+t)),"https:"==this.m.protocol&&(!0===this.P&&console.log(this.m.host),e="undefined"!=typeof MozWebSocket?new MozWebSocket("wss://"+this.m.host+t):new WebSocket("wss://"+this.m.host+t)),!0===this.P&&console.log(this.m.host)}catch(t){return void alert("WebSocketClient error")}return e},l.prototype.vt=function(){if(null!==this.sourceBuffer&&void 0!==this.sourceBuffer){if(0!==this.buffer.length&&!this.sourceBuffer.updating)try{var t=this.buffer.shift(),e=new Uint8Array(t);this.sourceBuffer.appendBuffer(e)}catch(t){!0===this.P&&console.log(t),this.s.close()}}else!0===this.P&&console.log("[WS] is null or undefined",this.sourceBuffer)},l.prototype.Ct=function(){try{var t={cmd:"H5_KEEPALIVE"};this.s.send(JSON.stringify({cmd:"H5_KEEPALIVE"}))}catch(t){!0===this.P&&console.log(t)}},l.prototype.pt=function(t){return t.data,"string"==typeof t.data?(!0===this.P&&console.log("[WS] string"),void(null!=this.k&&null!=this.k.callback&&this.k.callback(t.data,this.k.userdata))):!0!==this.v?!1===this.C?(this.p=String.fromCharCode.apply(null,new Uint8Array(t.data)),this.Ht(this),void(this.C=!0)):(this.buffer.push(t.data),void this.vt()):void 0},l.prototype.Ht=function(t){try{window.MediaSource=window.MediaSource||window.WebKitMediaSource,window.MediaSource||!0===t.P&&console.log("[WS] MediaSource API is not available");var e='video/mp4; codecs="avc1.42E01E, mp4a.40.2"';"MediaSource"in window&&MediaSource.isTypeSupported(e)?!0===t.P&&console.log("[WS] MIME type or codec: ",e):!0===t.P&&console.log("[WS] Unsupported MIME type or codec: ",e),t.t=new window.MediaSource,t.video.autoplay=!0,!0===t.P&&console.log(t.R),t.video.src=window.URL.createObjectURL(t.t),t.t.addEventListener("sourceopen",t.yt.bind(t),!1)}catch(e){!0===t.P&&console.log(e)}},l.prototype.yt=function(){!0===this.P&&console.log("[WS] Add SourceBuffer"),this.sourceBuffer=this.t.addSourceBuffer(this.p),this.t.duration=1/0,this.t.removeEventListener("sourceopen",this.yt,!1),this.sourceBuffer.addEventListener("updateend",this.vt.bind(this),!1)},l.prototype.ft=function(t){if(this.video.autoplay=!0,window.MediaSource=window.MediaSource||window.WebKitMediaSource,window.MediaSource){var e="false",i='video/mp4; codecs="hev1.1.6.L93.B0, mp4a.40.2"';"MediaSource"in window&&MediaSource.isTypeSupported(i)?(!0===this.P&&console.log("[WS] MIME type or codec: ",i),e="true"):(!0===this.P&&console.log("[WS] Unsupported MIME type or codec: ",i),e="false");var n="api/v1/h5swsapi",s="main";if(void 0===this.m.streamprofile||(s=this.m.streamprofile),void 0===this.k)n=this.m.rootpath+n+"?token="+t+"&hevc="+e+"&profile="+s+"&session="+this.m.session;else{var r="false",o="fake";void 0===this.k.serverpb||(r=this.k.serverpb),void 0===this.k.filename||(o=this.k.filename);var a=this.k.begintime;void 0===this.k.moveto||(a=this.k.moveto),n=this.m.rootpath+n+"?token="+t+"&hevc="+e+"&playback=true&profile="+s+"&serverpb="+r+"&begintime="+encodeURIComponent(this.k.begintime)+"&endtime="+encodeURIComponent(this.k.endtime)+"&moveto="+encodeURIComponent(a)+"&filename="+o+"&session="+this.m.session}!0===this.P&&console.log(n),this.s=this.St(n),!0===this.P&&console.log("[WS] setupWebSocket",this.s),this.s.binaryType="arraybuffer",this.s.Pt=this,this.s.onmessage=this.pt.bind(this),this.s.onopen=function(){!0===this.Pt.P&&console.log("[WS] wsSocket.onopen",this.Pt),this.Pt.i=setInterval(this.Pt.wt.bind(this.Pt),1e4),this.Pt.o=setInterval(this.Pt.Ct.bind(this.Pt),1e3),null!=this.Pt.k&&"true"===this.Pt.k.autoplay&&this.Pt.start()},this.s.onclose=function(){!0===this.Pt.P&&console.log("[WS] wsSocket.onclose",this.Pt),!0===this.Pt.v?!0===this.Pt.P&&console.log("[WS] wsSocket.onclose disconnect"):this.Pt.S=!0;try{this.Pt.Rt(this.Pt)}catch(t){}this.Pt.kt(this.Pt),this.Pt.p="",this.Pt.C=!1}}else!0===this.P&&console.log("[WS] MediaSource API is not available")},l.prototype.Rt=function(t){!0===t.P&&console.log("[WS] Cleanup Source Buffer",t);try{Array.from(t.t.sourceBuffers).includes(t.sourceBuffer)&&!t.sourceBuffer.updating&&(t.sourceBuffer.removeEventListener("updateend",t.vt,!1),t.sourceBuffer.abort(),document.documentMode||/Edge/.test(navigator.userAgent)||t.t.removeSourceBuffer(t.sourceBuffer)),t.video.src="",t.video.load(),t.sourceBuffer=null,t.t=null,t.buffer=[]}catch(e){!0===t.P&&console.log(e)}},l.prototype.kt=function(t){!0===t.P&&console.log("[WS] CleanupWebSocket",t),clearInterval(t.o),clearInterval(t.i),t.h=0,t.l=0,t.u=0},l.prototype.wt=function(){if(void 0===this.k){if(void 0===this.m.Wt);else if("false"==this.m.Wt)return void(!0===this.P&&console.log("[WS] Stream check has been disabled ",this));!0===this.v&&(!0===this.P&&console.log("[WS] CheckSourceBuffer has been disconnect",this),clearInterval(this.o),clearInterval(this.i),clearInterval(this.Et));try{if(!0===this.P&&console.log("[WS] CheckSourceBuffer",this),this.sourceBuffer.buffered.length<=0){if(this.h++,this.h>8)return!0===this.P&&console.log("[WS] CheckSourceBuffer Close 1"),clearInterval(this.o),void this.s.close()}else{this.h=0,this.sourceBuffer.buffered.start(0);var t=this.sourceBuffer.buffered.end(0),e=t-this.video.currentTime;if(e>5)return!0===this.P&&console.log("[WS] CheckSourceBuffer Close 2",e),clearInterval(this.o),void this.s.close();if(t==this.l){if(this.u++,this.u>3)return!0===this.P&&console.log("[WS] CheckSourceBuffer Close 3"),clearInterval(this.o),void this.s.close()}else this.u=0;this.l=t}}catch(t){!0===this.P&&console.log(t),clearInterval(this.o),this.s.close()}}},l.prototype.connect=function(){this.ft(this.W),this.Et=setInterval(this.ut.bind(this),800)},l.prototype.disconnect=function(){!0===this.P&&console.log("[WS] disconnect",this),this.v=!0,clearInterval(this.Et);try{null!=this.s&&(this.video.src="",this.s.close(),this.s=null)}catch(t){}!0===this.P&&console.log("[WS] disconnect",this)},l.prototype.start=function(){try{var t={cmd:"H5_START"};this.s.send(JSON.stringify({cmd:"H5_START"}))}catch(t){!0===this.P&&console.log(t)}},l.prototype.pause=function(){try{var t={cmd:"H5_PAUSE"};this.s.send(JSON.stringify({cmd:"H5_PAUSE"}))}catch(t){!0===this.P&&console.log(t)}},l.prototype.resume=function(){try{var t={cmd:"H5_RESUME"};this.s.send(JSON.stringify({cmd:"H5_RESUME"}))}catch(t){!0===this.P&&console.log(t)}},l.prototype.seek=function(t){try{var e={cmd:"H5_SEEK"};e.nSeekTime=t,this.s.send(JSON.stringify(e))}catch(t){!0===this.P&&console.log(t)}},l.prototype.moveto=function(t){try{var e={cmd:"H5_MOVETO"};e.strMovetoTime=t,this.s.send(JSON.stringify(e))}catch(t){!0===this.P&&console.log(t)}},l.prototype.speed=function(t){try{var e={cmd:"H5_SPEED"};e.nSpeed=t,this.s.send(JSON.stringify(e))}catch(t){!0===this.P&&console.log(t)}},h.prototype.ut=function(){if(!0===this.S){!0===this.P&&console.log("[RTC] Reconnect...");var t=this.A+"&update="+this.H;this.T.setAttribute("poster",t),!0===this.P&&console.log("[RTC] Reconnect image",t),this.H++,this.ft(this.W),this.S=!1}},h.prototype.St=function(t){var e;!0===this.P&&console.log("[RTC] H5SWebSocketClient");try{"http:"==this.m.protocol&&(e="undefined"!=typeof MozWebSocket?new MozWebSocket("ws://"+this.m.host+t):new WebSocket("ws://"+this.m.host+t)),"https:"==this.m.protocol&&(!0===this.P&&console.log(this.m.host),e="undefined"!=typeof MozWebSocket?new MozWebSocket("wss://"+this.m.host+t):new WebSocket("wss://"+this.m.host+t)),!0===this.P&&console.log(this.m.host)}catch(t){return void alert("WebSocketClient error")}return e},h.prototype.Ct=function(){try{var t={type:"keepalive"};this.s.send(JSON.stringify({type:"keepalive"}))}catch(t){!0===this.P&&console.log(t)}},h.prototype.Tt=function(t){if(t.candidate){var e;!0===this.P&&console.log("[RTC] onIceCandidate currentice",t.candidate),e=t.candidate,!0===this.P&&console.log("[RTC] onIceCandidate currentice",JSON.stringify(e));var i=JSON.parse(JSON.stringify(e));i.type="remoteice",!0===this.P&&console.log("[RTC] onIceCandidate currentice new",JSON.stringify(i)),this.s.send(JSON.stringify(i))}else!0===this.P&&console.log("End of candidates.")},h.prototype.It=function(t){if(!0===this.P&&console.log("[RTC] Remote track added:"+JSON.stringify(t.track.kind)),this.F.addTrack(t.track),"audio"!=t.track.kind){var e=this.T;e.srcObject=this.F,e.play()}},h.prototype.bt=function(){!0===this.P&&console.log("[RTC] createPeerConnection  config: "+JSON.stringify(this.O)+" option:"+JSON.stringify(this.M));var t=new RTCPeerConnection(this.O,this.M),e=this;return t.onicecandidate=function(t){e.Tt.call(e,t)},t.ontrack=function(t){e.It.call(e,t)},t.oniceconnectionstatechange=function(i){!0===e.P&&console.log("[RTC] oniceconnectionstatechange  state: "+t.iceConnectionState)},!0===this.P&&console.log("[RTC] Created RTCPeerConnnection with config: "+JSON.stringify(this.O)+"option:"+JSON.stringify(this.M)),t},h.prototype.At=function(t){!0===this.P&&console.log("[RTC] ProcessRTCOffer",t);try{this.g=this.bt(),this.N.length=0;var e=this;!0===this.P&&console.log("[RTC] createRTCSessionDescription "),this.g.setRemoteDescription(r(t)),this.g.createAnswer(this.U).then(function(t){!0===e.P&&console.log("[RTC] Create answer:"+JSON.stringify(t)),e.g.setLocalDescription(t,function(){!0===e.P&&console.log("[RTC] ProcessRTCOffer createAnswer",t),e.s.send(JSON.stringify(t))},function(){})},function(t){alert("[RTC] Create awnser error:"+JSON.stringify(t))})}catch(t){this.disconnect(),alert("[RTC] connect error: "+t)}},h.prototype.gt=function(t){!0===this.P&&console.log("[RTC] ProcessRemoteIce",t);try{var e=new RTCIceCandidate({sdpMLineIndex:t.sdpMLineIndex,candidate:t.candidate});!0===this.P&&console.log("[RTC] ProcessRemoteIce",e),!0===this.P&&console.log("[RTC] Adding ICE candidate :"+JSON.stringify(e)),this.g.addIceCandidate(e,function(){},function(t){console.log("[RTC] addIceCandidate error:"+JSON.stringify(t))})}catch(t){alert("connect ProcessRemoteIce error: "+t)}},h.prototype.pt=function(t){t.data,t.data,!0===this.P&&console.log("[RTC] RTC received ",t.data);var e=JSON.parse(t.data);return!0===this.P&&console.log("[RTC] Get Message type ",e.type),"offer"===e.type?(!0===this.P&&console.log("[RTC] Process Message type ",e.type),void this.At(e)):"iceserver"===e.type?(!0===this.P&&console.log("[RTC] Process Message type ",e.type),this.O.iceServers=e.iceServers,this.O.iceTransportPolicy=e.iceTransportPolicy,void(!0===this.P&&console.log("[RTC] Iceserver:",this.O))):"remoteice"===e.type?(!0===this.P&&console.log("[RTC] Process Message type ",e.type),void this.gt(e)):void(null!=this.k&&null!=this.k.callback&&this.k.callback(t.data,this.k.userdata))},h.prototype.ft=function(t){this.video.autoplay=!0;var e="api/v1/h5srtcapi";void 0===this.m.rtcengine||"v2"===this.m.rtcengine&&(e="api/v1/h5srtcapi2"),!0===this.P&&console.log("[RTC] API path",e);var i="main";void 0===this.m.streamprofile||(i=this.m.streamprofile);var n="false",s='video/mp4; codecs="hev1.1.6.L93.B0, mp4a.40.2"';if("MediaSource"in window&&MediaSource.isTypeSupported(s)?1==o&&(n="true"):(!0===this.P&&console.log("[RTC] Unsupported MIME type or codec: ",s),n="false"),void 0===this.k)e=this.m.rootpath+e+"?token="+t+"&hevc="+n+"&profile="+i+"&session="+this.m.session;else{var r="false",a="fake";void 0===this.k.serverpb||(r=this.k.serverpb),void 0===this.k.filename||(a=this.k.filename);var l=this.k.begintime;void 0===this.k.moveto||(l=this.k.moveto),e=this.m.rootpath+e+"?token="+t+"&playback=true&hevc="+n+"&profile="+i+"&serverpb="+r+"&begintime="+encodeURIComponent(this.k.begintime)+"&endtime="+encodeURIComponent(this.k.endtime)+"&moveto="+encodeURIComponent(l)+"&filename="+a+"&session="+this.m.session}!0===this.P&&console.log(e),this.s=this.St(e),!0===this.P&&console.log("[RTC] setupWebSocket",this.s),this.s.binaryType="arraybuffer",this.s.Pt=this,this.s.onmessage=this.pt.bind(this),this.s.onopen=function(){!0===this.Pt.P&&console.log("[RTC] wsSocket.onopen",this.Pt);this.Pt.s.send(JSON.stringify({type:"open"})),this.Pt.o=setInterval(this.Pt.Ct.bind(this.Pt),1e3),null!=this.Pt.k&&"true"===this.Pt.k.autoplay&&this.Pt.start()},this.s.onclose=function(){!0===this.P&&console.log("[RTC] wsSocket.onclose",this.Pt),!0===this.Pt.v?!0===this.Pt.P&&console.log("[RTC] wsSocket.onclose disconnect"):this.Pt.S=!0,this.Pt.kt(this.Pt)}},h.prototype.kt=function(t){!0===t.P&&console.log("[RTC] CleanupWebSocket",t),clearInterval(t.o)},h.prototype.connect=function(){this.ft(this.W),this.Et=setInterval(this.ut.bind(this),3e3)},h.prototype.disconnect=function(){if(!0===this.P&&console.log("[RTC] disconnect",this),this.v=!0,clearInterval(this.Et),null!=this.s&&(this.s.close(),this.s=null),this.T&&(this.T.src=""),this.g){try{this.g.close()}catch(t){!0===this.P&&console.log("[RTC] close peer connection failed:"+t)}this.g=null}!0===this.P&&console.log("[RTC] disconnect",this)},h.prototype.start=function(){try{var t={cmd:"H5_START"};this.s.send(JSON.stringify({cmd:"H5_START"}))}catch(t){!0===this.P&&console.log(t)}},h.prototype.pause=function(){try{var t={cmd:"H5_PAUSE"};this.s.send(JSON.stringify({cmd:"H5_PAUSE"}))}catch(t){!0===this.P&&console.log(t)}},h.prototype.resume=function(){try{var t={cmd:"H5_RESUME"};this.s.send(JSON.stringify({cmd:"H5_RESUME"}))}catch(t){!0===this.P&&console.log(t)}},h.prototype.seek=function(t){try{var e={cmd:"H5_SEEK"};e.nSeekTime=t,this.s.send(JSON.stringify(e))}catch(t){!0===this.P&&console.log(t)}},h.prototype.moveto=function(t){try{var e={cmd:"H5_MOVETO"};e.strMovetoTime=t,this.s.send(JSON.stringify(e))}catch(t){!0===this.P&&console.log(t)}},h.prototype.speed=function(t){try{var e={cmd:"H5_SPEED"};e.nSpeed=t,this.s.send(JSON.stringify(e))}catch(t){!0===this.P&&console.log(t)}},c.prototype.St=function(t){var e;!0===this.P&&console.log("[HLS] H5SWebSocketClient");try{"http:"==this.m.protocol&&(e="undefined"!=typeof MozWebSocket?new MozWebSocket("ws://"+this.m.host+t):new WebSocket("ws://"+this.m.host+t)),"https:"==this.m.protocol&&(!0===this.P&&console.log("[HLS] ",this.m.host),e="undefined"!=typeof MozWebSocket?new MozWebSocket("wss://"+this.m.host+t):new WebSocket("wss://"+this.m.host+t)),!0===this.P&&console.log(this.m.host)}catch(t){return void alert("WebSocketClient error")}return e},c.prototype.Ct=function(){try{var t={type:"keepalive"};this.s.send(JSON.stringify({type:"keepalive"}))}catch(t){!0===this.P&&console.log(t)}},c.prototype.pt=function(t){!0===this.P&&console.log("[HLS] HLS received ",t.data)},c.prototype.ft=function(t){var e="api/v1/h5swscmnapi";e=this.m.rootpath+e+"?token="+t+"&session="+this.m.session,!0===this.P&&console.log(e),this.s=this.St(e),!0===this.P&&console.log("[HLS] setupWebSocket",this.s),this.s.binaryType="arraybuffer",this.s.Pt=this,this.s.onmessage=this.pt.bind(this),this.s.onopen=function(){!0===this.Pt.P&&console.log("[HLS] wsSocket.onopen",this.Pt),this.Pt.o=setInterval(this.Pt.Ct.bind(this.Pt),1e3)},this.s.onclose=function(){!0===this.Pt.P&&console.log("[HLS] wsSocket.onclose",this.Pt),this.Pt.kt(this.Pt)}},c.prototype.kt=function(t){!0===t.P&&console.log("[HLS] H5sPlayerHls CleanupWebSocket",t),clearInterval(t.o)},c.prototype.Mt=function(){!0===this.P&&console.log("[HLS]  video.ended",this.D.ended),!0===this.P&&console.log("[HLS] video.currentTime",this.D.currentTime);var t=this.D.currentTime,e=t-this.L;!0===this.P&&console.log("[HLS]  diff",e),0===e&&this.B++,this.L=t,this.B>3&&(null!=this.s&&(this.s.close(),this.s=null),this.ft(this.W),!0===this.P&&console.log("[HLS] reconnect"),this.D.src="",this.L=0,this.B=0,this.D.src=this.m.protocol+"//"+this.m.host+this.m.rootpath+"hls/"+this._+"/"+this.W+"/hls.m3u8",this.D.play())},c.prototype.connect=function(){this.ft(this.W),this.L=0,this.B=0,this.D.onended=function(t){!0===this.P&&console.log("[HLS] The End")},this.D.onpause=function(t){!0===this.P&&console.log("[HLS] Pause")},this.D.onplaying=function(t){!0===this.P&&console.log("[HLS] Playing")},this.D.onseeking=function(t){!0===this.P&&console.log("[HLS] seeking")},this.D.onvolumechange=function(t){!0===this.P&&console.log("[HLS] volumechange")},this.D.src=this.m.protocol+"//"+this.m.host+this.m.rootpath+"hls/"+this._+"/"+this.W+"/hls.m3u8",this.D.play(),this.J=setInterval(this.Mt.bind(this),3e3)},c.prototype.disconnect=function(){clearInterval(this.J),this.L=0,this.B=0,null!=this.s&&(this.s.close(),this.s=null),!0===this.P&&console.log("[HLS] disconnect",this)},d.prototype.St=function(t){var e;!0===this.P&&console.log("[AUDBACK] H5SWebSocketClient");try{"http:"==this.m.protocol&&(e="undefined"!=typeof MozWebSocket?new MozWebSocket("ws://"+this.m.host+t):new WebSocket("ws://"+this.m.host+t)),"https:"==this.m.protocol&&(!0===this.P&&console.log(this.m.host),e="undefined"!=typeof MozWebSocket?new MozWebSocket("wss://"+this.m.host+t):new WebSocket("wss://"+this.m.host+t)),!0===this.P&&console.log(this.m.host)}catch(t){return void alert("WebSocketClient error")}return e},d.prototype.Ct=function(){try{this.s.send("keepalive")}catch(t){!0===this.P&&console.log(t)}},d.prototype.pt=function(t){},d.prototype.kt=function(t){!0===this.P&&console.log("[AUDBACK] CleanupWebSocket",t),clearInterval(t.o)},d.prototype.X=function(){!0===this.P&&console.log("[AUDBACK] sampleRate",this.V.sampleRate),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.Ut;try{navigator.getUserMedia({video:!1,audio:!0},this.Ot.bind(this))}catch(e){var t="[AUDBACK] Audio back getUserMedia failed: "+e.name+" "+e.message;return void alert(t)}},d.prototype.Nt=function(){this.Z=!0},d.prototype.ft=function(t){var e="api/v1/h5saudbackapi";e=this.m.rootpath+e+"?token="+t+"&samplerate="+this.G+"&session="+this.m.session,!0===this.P&&console.log(e),this.s=this.St(e),!0===this.P&&console.log("[AUDBACK] setupWebSocket for audio back",this.s),this.s.binaryType="arraybuffer",this.s.Pt=this,this.s.onmessage=this.pt.bind(this),this.s.onopen=this.Nt.bind(this),this.s.onclose=function(){!0===this.P&&console.log("[AUDBACK] wsSocket.onclose",this.Pt),this.Pt.kt(this.Pt)}},d.prototype.Ft=function(t){var e=function(t){for(var e=t.length,i=new Int16Array(e);e--;)i[e]=32767*Math.min(1,t[e]);return i}(t.inputBuffer.getChannelData(0));!0===this.Z&&this.s&&this.s.send(e)},d.prototype.Ot=function(t){try{var e=this.V.createMediaStreamSource(t),i=this.V.createScriptProcessor(1024,1,1);e.connect(i),i.connect(this.V.destination),i.onaudioprocess=this.Ft.bind(this)}catch(t){return void alert("Audio intecomm error",t)}},d.prototype.connect=function(){this.ft(this.W)},d.prototype.disconnect=function(){!0===this.P&&console.log("[AUDBACK] disconnect",this),null!=this.s&&(this.s.close(),this.s=null),!0===this.P&&console.log("[AUDBACK] disconnect",this)},u.prototype.ut=function(){!0===this.S&&(!0===this.P&&console.log("Reconnect..."),this.ft(this.W),this.S=!1)},u.prototype.St=function(t){var e;!0===this.P&&console.log("[CFE] H5SWebSocketClient");try{"http:"==this.m.protocol&&(e="undefined"!=typeof MozWebSocket?new MozWebSocket("ws://"+this.m.host+t):new WebSocket("ws://"+this.m.host+t)),"https:"==this.m.protocol&&(!0===this.P&&console.log(this.m.host),e="undefined"!=typeof MozWebSocket?new MozWebSocket("wss://"+this.m.host+t):new WebSocket("wss://"+this.m.host+t)),!0===this.P&&console.log(this.m.host)}catch(t){return void alert("WebSocketClient error")}return e},u.prototype.Ct=function(){try{var t={type:"CFE_CMD_KEEPALIVE"},e={};e.strId=this.j,t.keepalive=e,this.s.send(JSON.stringify(t))}catch(t){!0===this.P&&console.log(t)}},u.prototype.Tt=function(t){if(t.candidate){var e;!0===this.P&&console.log("[CFE] onIceCandidate currentice",t.candidate),e=t.candidate,!0===this.P&&console.log("[CFE] onIceCandidate currentice",JSON.stringify(e));var i={type:"CFE_CMD_REMOTE_ICE"},n={};console.log("[CFE] remote Ice to",this.q),n.strTo=this.q,n.msg=e,i.remoteIce=n,this.s.send(JSON.stringify(i))}else!0===this.P&&console.log("[CFE] End of candidates.")},u.prototype.Jt=function(t){!0===this.P&&console.log("[CFE] ondataavailableLocal",t.data),this.it.push(t.data),"inactive"==this.et.state&&g(this.it,"local",".webm")},u.prototype._t=function(t){!0===this.P&&console.log("[CFE] ondataavailableRemote",t.data),this.ot.push(t.data),"inactive"==this.st.state&&g(this.ot,"remote",".webm")},u.prototype.It=function(t){var e;!0===this.P&&console.log("[CFE] Remote track added:"+JSON.stringify(t)),e=t.Dt?t.Dt[0]:t.stream;var i=this.rt;if(i.srcObject!==e){i.srcObject=e,i.play();try{1==this.$&&(!0===this.P&&console.log("[CFE] Start local record..."),this.et=new MediaRecorder(this.xt),this.et.ondataavailable=this.Jt.bind(this),this.et.start()),1==this.tt&&(!0===this.P&&console.log("[CFE] Start remote record..."),this.st=new MediaRecorder(e),this.st.ondataavailable=this._t.bind(this),this.st.start())}catch(t){alert("start record error: "+t)}}},u.prototype.bt=function(){!0===this.P&&console.log("[CFE] createPeerConnection  config: "+JSON.stringify(this.O)+" option:"+JSON.stringify(this.M));var t=new RTCPeerConnection(this.O,this.M),e=this;return t.onicecandidate=function(t){e.Tt.call(e,t)},void 0!==t.ontrack?t.ontrack=function(t){e.It.call(e,t)}:t.onaddstream=function(t){e.It.call(e,t)},t.oniceconnectionstatechange=function(e){!0===this.P&&console.log("[CFE] oniceconnectionstatechange  state: "+t.iceConnectionState)},!0===this.P&&console.log("[CFE] Created RTCPeerConnnection with config: "+JSON.stringify(this.O)+"option:"+JSON.stringify(this.M)),t},u.prototype.Lt=function(t){!0===this.P&&console.log("[CFE] ProcessOffer",t);try{this.g=this.bt(),this.N.length=0;var e=this;const i=this.xt.getVideoTracks(),n=this.xt.getAudioTracks();i.length>0&&console.log("[CFE] Using video device:",i[0].label),n.length>0&&console.log("[CFE] Using audio device:",n[0].label),this.xt.getTracks().forEach(t=>this.g.addTrack(t,this.xt)),!0===this.P&&console.log("[CFE] createRTCSessionDescription "),this.g.setRemoteDescription(r(t)),this.g.createAnswer(this.U).then(function(t){!0===e.P&&console.log("[CFE] Create answer:"+JSON.stringify(t)),e.g.setLocalDescription(t,function(){!0===e.P&&console.log("[CFE] ProcessOffer createAnswer",t);var i={type:"CFE_CMD_CALL_ANSWER"},n={};console.log("[CFE] createAnswer to",e.q),n.strTo=e.q,n.msg=t,i.answer=n,e.s.send(JSON.stringify(i))},function(){})},function(t){alert("[CFE ]Create awnser error:"+JSON.stringify(t))})}catch(t){this.disconnect(),alert("connect error: "+t)}},u.prototype.Bt=function(t){!0===this.P&&console.log("[CFE] ProcessAnswer",t);try{this.g.setRemoteDescription(r(t))}catch(t){this.disconnect(),alert("connect error: "+t)}},u.prototype.zt=function(){!0===this.P&&console.log("[CFE] CreateOffer");try{this.g=this.bt(),this.N.length=0;var t=this;const e=this.xt.getVideoTracks(),i=this.xt.getAudioTracks();return e.length>0&&console.log("[CFE] Using video device:",e[0].label),i.length>0&&console.log("[CFE] Using audio device:",i[0].label),this.xt.getTracks().forEach(t=>this.g.addTrack(t,this.xt)),void this.g.createOffer(this.U).then(function(e){!0===t.P&&console.log("[CFE] Create answer:"+JSON.stringify(e)),t.g.setLocalDescription(e,function(){!0===t.P&&console.log("[CFE] ProcessOffer createAnswer",e);var i=e;!0===t.P&&console.log("[CFE] createOffer ",JSON.stringify(i));var n={type:"CFE_CMD_CALL_OFFER"},s={};!0===t.P&&console.log("[CFE] createOffer to",t.q),s.strTo=t.q,s.msg=i,n.offer=s,t.s.send(JSON.stringify(n))},function(){})},function(t){alert("[CFE ]Create offer error:"+JSON.stringify(t))})}catch(t){this.disconnect(),alert("connect error: "+t)}},u.prototype.gt=function(t){!0===this.P&&console.log("[CFE] ProcessRemoteIce",t);try{var e=new RTCIceCandidate({sdpMLineIndex:t.sdpMLineIndex,candidate:t.candidate});!0===this.P&&console.log("[CFE] ProcessRemoteIce",e),!0===this.P&&console.log("[CFE] Adding ICE candidate :"+JSON.stringify(e)),this.g.addIceCandidate(e,function(){},function(t){console.log("[CFE] addIceCandidate error:"+JSON.stringify(t))})}catch(t){alert("connect ProcessRemoteIce error: "+t)}},u.prototype.pt=function(t){!0===this.P&&console.log("[CFE] received ",t.data);var e=JSON.parse(t.data);if(!0===this.P&&console.log("[CFE] Get Message type ",e.type),"CFE_CMD_INVITE_REQ"!==e.type){if("CFE_CMD_INVITE_RESP"===e.type)return this.q=e.inviteResp.strFrom,void this.zt();if("CFE_CMD_CALL_OFFER"!==e.type)if("CFE_CMD_CALL_ANSWER"!==e.type)if("CFE_CMD_REMOTE_ICE"!==e.type){if("CFE_EVENT_ID_ASSIGN"===e.type){this.j=e.idAssign.strId,1==e.idAssign.bEnableRelay&&(this.O.iceServers=e.idAssign.iceServers,this.O.iceTransportPolicy=e.idAssign.iceTransportPolicy,!0===this.P&&console.log("[CFE] Iceserver:",this.O));var i={type:"CFE_EVENT_ID_ASSIGN",idAssign:{}};return i.idAssign.strId=e.idAssign.strId,void(null!=this.m.callback&&this.m.callback(JSON.stringify(i),this.m.userdata))}null!=this.m.callback&&this.m.callback(t.data,this.m.userdata)}else this.gt(e.remoteIce.msg);else this.Bt(e.answer.msg);else this.Lt(e.offer.msg)}},u.prototype.ft=function(t){this.ct.autoplay=!0,this.rt.autoplay=!0;var e="api/v1/h5sconference";e=void 0===this.j?this.m.rootpath+e+"?name="+this.m.user+"&session="+this.m.session:this.m.rootpath+e+"?name="+this.m.user+"?id="+this.j+"&session="+this.m.session,!0===this.P&&console.log(e),this.s=this.St(e),!0===this.P&&console.log("[CFE] setupWebSocket",this.s),this.s.binaryType="arraybuffer",this.s.Pt=this,this.s.onmessage=this.pt.bind(this),this.s.onopen=function(){!0===this.Pt.P&&console.log("[CFE] wsSocket.onopen",this.Pt),this.Pt.o=setInterval(this.Pt.Ct.bind(this.Pt),1e3),null!=this.Pt.k&&"true"===this.Pt.k.autoplay&&this.Pt.start()},this.s.onclose=function(){!0===this.Pt.P&&console.log("[CFE] wsSocket.onclose",this.Pt),!0===this.Pt.v?!0===this.Pt.P&&console.log("[CFE] wsSocket.onclose disconnect"):this.Pt.S=!0,this.Pt.kt(this.Pt)}},u.prototype.kt=function(t){!0===t.P&&console.log("[CFE] CleanupWebSocket",t),clearInterval(t.o)},u.prototype.connect=function(){this.ft(this.W),this.Et=setInterval(this.ut.bind(this),3e3)},u.prototype.call=function(t,e,i,n,s){if(1!=this.Y){this.Vt=i,this.Kt=s,this.Gt=n;var r=1280,o=720;"QVGA"==n?(r=320,o=240):"VGA"==n?(r=640,o=480):"D1"==n?(r=720,o=576):"720P"==n?(r=1280,o=720):"1080P"==n?(r=1920,o=1080):"4K"==n?(r=4096,o=2160):"8K"==n&&(r=7680,o=4320);try{try{var a;a=0!=t&&{deviceId:{exact:i},width:{exact:r},height:{exact:o}};var l=this;navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:s}},video:a}).then(function(i){1==t&&(l.ct.srcObject=i),l.xt=i;var n={type:"CFE_CMD_INVITE_REQ"},s={};s.strFrom=l.j,s.strTo=e,n.inviteReq=s,l.s.send(JSON.stringify(n))}).catch(function(t){var e="[CFE] getUserMedia failed: "+t.name+" "+t.message;alert(e)})}catch(t){var h="[CFE] getUserMedia failed: "+err.name+" "+err.message;alert(h)}}catch(t){!0===this.P&&console.log(t)}this.Y=!0}},u.prototype.answer=function(t,e,i,n,s){if(1!=this.Y){this.Vt=i,this.Kt=s,this.Gt=n;var r=1280,o=720;"QVGA"==n?(r=320,o=240):"VGA"==n?(r=640,o=480):"D1"==n?(r=720,o=576):"720P"==n?(r=1280,o=720):"1080P"==n?(r=1920,o=1080):"4K"==n?(r=4096,o=2160):"8K"==n&&(r=7680,o=4320);try{try{var a;a=0!=t&&{deviceId:{exact:i},width:{exact:r},height:{exact:o}};var l=this;navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:s}},video:a}).then(function(i){1==t&&(l.ct.srcObject=i),l.xt=i;var n={type:"CFE_CMD_INVITE_RESP"},s={};s.strFrom=l.j,s.strTo=e,l.q=e,n.inviteResp=s,l.s.send(JSON.stringify(n))}).catch(function(t){var e="[CFE] getUserMedia failed: "+t.name+" "+t.message;alert(e)})}catch(t){var h="[CFE] getUserMedia failed: "+err.name+" "+err.message;alert(h)}}catch(t){!0===this.P&&console.log(t)}this.Y=!0}},u.prototype.hangup=function(){if(0!=this.Y){try{1==this.$&&this.et.stop(),1==this.tt&&this.st.stop()}catch(t){alert("stop record error: "+t)}try{var t={cmd:"H5_PAUSE"};this.s.send(JSON.stringify({cmd:"H5_PAUSE"}))}catch(t){!0===this.P&&console.log(t)}if(this.ct&&(this.ct.src=""),this.rt&&(this.rt.src=""),this.xt&&(this.xt=null),this.g){try{this.g.close()}catch(t){!0===this.P&&console.log("[CFE] close peer connection failed:"+t)}this.g=null}this.Y=!1}},u.prototype.disconnect=function(){!0===this.P&&console.log("[CFE] disconnect",this),this.v=!0,clearInterval(this.Et),this.hangup(),null!=this.s&&(this.s.close(),this.s=null),!0===this.P&&console.log("[CFE] disconnect",this)},f.prototype.ut=function(){!0===this.S&&(!0===this.P&&console.log("[PUSH] Reconnect..."),this.ft(this.lt),this.S=!1)},f.prototype.St=function(t){var e;!0===this.P&&console.log("[PUSH] H5SWebSocketClient");try{"http:"==this.m.protocol&&(e="undefined"!=typeof MozWebSocket?new MozWebSocket("ws://"+this.m.host+t):new WebSocket("ws://"+this.m.host+t)),"https:"==this.m.protocol&&(!0===this.P&&console.log(this.m.host),e="undefined"!=typeof MozWebSocket?new MozWebSocket("wss://"+this.m.host+t):new WebSocket("wss://"+this.m.host+t)),!0===this.P&&console.log(this.m.host)}catch(t){return void alert("WebSocketClient error")}return e},f.prototype.Ct=function(){try{var t={type:"keepalive"};this.s.send(JSON.stringify({type:"keepalive"}))}catch(t){!0===this.P&&console.log(t)}},f.prototype.Tt=function(t){if(t.candidate){var e;!0===this.P&&console.log("[PUSH] onIceCandidate currentice",t.candidate),e=t.candidate,!0===this.P&&console.log("[PUSH] onIceCandidate currentice",JSON.stringify(e));var i=JSON.parse(JSON.stringify(e));i.type="remoteice",!0===this.P&&console.log("[PUSH] onIceCandidate currentice new",JSON.stringify(i)),this.s.send(JSON.stringify(i))}else!0===this.P&&console.log("End of candidates.")},f.prototype.It=function(t){!0===this.P&&console.log("[PUSH] Remote track added:"+JSON.stringify(t)),t.Dt?t.Dt[0]:t.stream},f.prototype.bt=function(){!0===this.P&&console.log("[PUSH] createPeerConnection  config: "+JSON.stringify(this.O)+" option:"+JSON.stringify(this.M));var t=new RTCPeerConnection(this.O,this.M),e=this;return t.onicecandidate=function(t){e.Tt.call(e,t)},void 0!==t.ontrack?t.ontrack=function(t){e.It.call(e,t)}:t.onaddstream=function(t){e.It.call(e,t)},t.oniceconnectionstatechange=function(i){!0===e.P&&console.log("[PUSH] oniceconnectionstatechange  state: "+t.iceConnectionState)},!0===this.P&&console.log("[PUSH] Created RTCPeerConnnection with config: "+JSON.stringify(this.O)+"option:"+JSON.stringify(this.M)),t},f.prototype.Qt=function(t,e){if(("chrome"===adapter.browserDetails.browser||"safari"===adapter.browserDetails.browser||"firefox"===adapter.browserDetails.browser&&adapter.browserDetails.version>=64)&&"RTCRtpSender"in window&&"setParameters"in window.RTCRtpSender.prototype){const i=t.getSenders();for(let t=0;t!==i.length;++t){const n=i[t];if("video"==n.track.kind){const t=n.getParameters();t.encodings||(t.encodings=[{}]),t.encodings[0].maxBitrate=1e3*e,n.setParameters(t).then(()=>{}).catch(t=>console.error(t))}}}},f.prototype.zt=function(){!0===this.P&&console.log("[PUSH] CreateOffer");try{this.g=this.bt(),this.N.length=0;var t=this;const n=this.xt.getVideoTracks(),s=this.xt.getAudioTracks();if(n.length>0&&console.log("[PUSH] Using video device:",n[0].label),s.length>0&&console.log("[PUSH] Using audio device:",s[0].label),this.xt.getTracks().forEach(t=>this.g.addTrack(t,this.xt)),window.RTCRtpTransceiver&&"setCodecPreferences"in window.RTCRtpTransceiver.prototype){var e="video/H264";"VP9"==this.Zt?e="video/VP9":"H264"==this.Zt&&(e="video/H264");const n=window.RTCRtpSender.getCapabilities("video").codecs;var i=[];for(let t=0;t!==n.length;++t){const s=n[t];[e].includes(s.mimeType)&&i.push(s)}!0===t.P&&console.log("[PUSH] Select codec:",i),this.g.getTransceivers().find(t=>t.sender&&t.sender.track===this.xt.getVideoTracks()[0]).setCodecPreferences(i)}return void this.g.createOffer(this.U).then(function(e){!0===t.P&&console.log("[PUSH] Create offer:"+JSON.stringify(e)),t.g.setLocalDescription(e,function(){var i=e;t.s.send(JSON.stringify(i))},function(){})},function(t){alert("[PUSH ]Create offer error:"+JSON.stringify(t))})}catch(t){this.disconnect(),alert("connect error: "+t)}},f.prototype.Bt=function(t){!0===this.P&&console.log("[PUSH] ProcessAnswer",t);try{this.g.setRemoteDescription(r(t))}catch(t){this.disconnect(),alert("connect error: "+t)}this.Qt(this.g,this.Xt)},f.prototype.gt=function(t){!0===this.P&&console.log("[PUSH] ProcessRemoteIce",t);try{var e=new RTCIceCandidate({sdpMid:t.sdpMid,sdpMLineIndex:t.sdpMLineIndex,candidate:t.candidate});!0===this.P&&console.log("[PUSH] ProcessRemoteIce",e),!0===this.P&&console.log("[PUSH] Adding ICE candidate :"+JSON.stringify(e)),this.g.addIceCandidate(e,function(){},function(t){console.log("[PUSH] addIceCandidate error:"+JSON.stringify(t)),console.log(t)})}catch(t){alert("connect ProcessRemoteIce error: "+t)}},f.prototype.pt=function(t){t.data,t.data,!0===this.P&&console.log("[PUSH] RTC received ",t.data);var e=JSON.parse(t.data);return!0===this.P&&console.log("[PUSH] Get Message type ",e.type),"iceserver"===e.type?(!0===this.P&&console.log("[PUSH] Process Message type ",e.type),this.O.iceServers=e.iceServers,!0===this.P&&console.log("[PUSH] Iceserver:",this.O),void this.zt()):"answer"===e.type?(!0===this.P&&console.log("[PUSH] Process Message type ",e.type),void this.Bt(e)):"remoteice"===e.type?(!0===this.P&&console.log("[PUSH] Process Message type ",e.type),void this.gt(e)):void(null!=this.m.callback&&this.m.callback(t.data,this.m.userdata))},f.prototype.ft=function(t){this.video.autoplay=!0;var e="api/v1/h5srtcpushapi";e=this.m.rootpath+e+"?token="+t+"&type="+this.m.type+"&audio="+this.m.audio+"&session="+this.m.session,!0===this.P&&console.log(e),this.s=this.St(e),!0===this.P&&console.log("[PUSH] setupWebSocket",this.s),this.s.binaryType="arraybuffer",this.s.Pt=this,this.s.onmessage=this.pt.bind(this),this.s.onopen=function(){!0===this.Pt.P&&console.log("[PUSH] wsSocket.onopen",this.Pt);this.Pt.s.send(JSON.stringify({type:"open"})),this.Pt.o=setInterval(this.Pt.Ct.bind(this.Pt),1e3),null!=this.Pt.k&&"true"===this.Pt.k.autoplay&&this.Pt.start()},this.s.onclose=function(){!0===this.P&&console.log("[PUSH] wsSocket.onclose",this.Pt),!0===this.Pt.v?!0===this.Pt.P&&console.log("[PUSH] wsSocket.onclose disconnect"):this.Pt.S=!0,this.Pt.kt(this.Pt)}},f.prototype.kt=function(t){!0===t.P&&console.log("[PUSH] CleanupWebSocket",t),clearInterval(t.o)},f.prototype.connect=function(t,e,i,n,s,r){this.Vt=t,this.Zt=e,this.Xt=i,this.Gt=n,this.Kt=s,!0===this.P&&console.log("[PUSH] videoin:",t,"codec:",e,"bitrate:",i,"resolution:",n,"audioin:",s);var o,a=1280,l=720;"QVGA"==n?(a=320,l=240):"VGA"==n?(a=640,l=480):"D1"==n?(a=720,l=576):"720P"==n?(a=1280,l=720):"1080P"==n?(a=1920,l=1080):"4K"==n?(a=4096,l=2160):"8K"==n&&(a=7680,l=4320);var h="",c=!1;void 0!==this.m.facingmode&&(h=this.m.facingmode,!0===this.P&&console.log("[PUSH] facing mode:",h),c=!0),o="true"==this.m.audio&&{deviceId:{exact:s}};try{const e={audio:o,video:c?{facingMode:{exact:h},width:{exact:a},height:{exact:l}}:{deviceId:{exact:t},width:{exact:a},height:{exact:l}}};try{var d=this;0==r?navigator.mediaDevices.getUserMedia(e).then(function(t){d.dt.srcObject=t,d.xt=t,d.ft(d.lt)}).catch(function(t){var e="[PUSH] getUserMedia failed: "+t.name+" "+t.message;alert(e)}):navigator.mediaDevices.getDisplayMedia({video:!0}).then(function(t){d.dt.srcObject=t,d.xt=t,d.ft(d.lt)}).catch(function(t){alert("[PUSH] getUserMedia failed:",t.name+": "+t.message)})}catch(t){var u="[PUSH] getUserMedia failed: "+err.name+" "+err.message;return void alert(u)}}catch(t){return void(!0===this.P&&console.log(t))}},f.prototype.send=function(t,e){var i={type:"message"};i.user=this.lt,i.token=t,i.msg=e,this.s.send(JSON.stringify(i))},f.prototype.disconnect=function(){if(!0===this.P&&console.log("[PUSH] disconnect",this),this.v=!0,clearInterval(this.Et),null!=this.s&&(this.s.close(),this.s=null),this.dt&&(this.dt.src=""),this.g){try{this.g.close()}catch(t){!0===this.P&&console.log("[PUSH] close peer connection failed:"+t)}this.g=null}!0===this.P&&console.log("[PUSH] disconnect",this)};const C=E(S).right;E(function(t){return null===t?NaN:+t}).center;const D=Math.sqrt(50),T=Math.sqrt(10),b=Math.sqrt(2);function M(t,e,i){const n=(e-t)/Math.max(0,i),s=Math.floor(Math.log10(n)),r=n/Math.pow(10,s),o=r>=D?10:r>=T?5:r>=b?2:1;let a,l,h;return s<0?(h=Math.pow(10,-s)/o,a=Math.round(t*h),l=Math.round(e*h),a/h<t&&++a,l/h>e&&--l,h=-h):(h=Math.pow(10,s)*o,a=Math.round(t/h),l=Math.round(e/h),a*h<t&&++a,l*h>e&&--l),l<a&&.5<=i&&i<2?M(t,e,2*i):[a,l,h]}function P(t,e,i){return M(t=+t,e=+e,i=+i)[2]}function k(t,e,i){i=+i;const n=(e=+e)<(t=+t),s=n?P(e,t,i):P(t,e,i);return(n?-1:1)*(s<0?1/-s:s)}function O(t){return t}var x=1e-6;function A(t){return"translate("+t+",0)"}function I(t){return e=>+t(e)}function R(t,e){return e=Math.max(0,t.bandwidth()-2*e)/2,t.round()&&(e=Math.round(e)),i=>+t(i)+e}function V(){return!this.__axis}function U(t,e){var i=[],n=null,s=null,r=6,o=6,a=3,l="undefined"!=typeof window&&window.devicePixelRatio>1?0:.5,h="y",c=A;function d(t){var d=null==n?e.ticks?e.ticks.apply(e,i):e.domain():n,u=null==s?e.tickFormat?e.tickFormat.apply(e,i):O:s,g=Math.max(r,0)+a,f=e.range(),p=+f[0]+l,m=+f[f.length-1]+l,v=(e.bandwidth?R:I)(e.copy(),l),y=t.selection?t.selection():t,S=y.selectAll(".domain").data([null]),w=y.selectAll(".tick").data(d,e).order(),E=w.exit(),_=w.enter().append("g").attr("class","tick"),C=w.select("line"),D=w.select("text");S=S.merge(S.enter().insert("path",".tick").attr("class","domain").attr("stroke","currentColor")),w=w.merge(_),C=C.merge(_.append("line").attr("stroke","currentColor").attr("y2",1*r)),D=D.merge(_.append("text").attr("fill","currentColor").attr(h,1*g).attr("dy","0.71em")),t!==y&&(S=S.transition(t),w=w.transition(t),C=C.transition(t),D=D.transition(t),E=E.transition(t).attr("opacity",x).attr("transform",function(t){return isFinite(t=v(t))?c(t+l):this.getAttribute("transform")}),_.attr("opacity",x).attr("transform",function(t){var e=this.parentNode.__axis;return c((e&&isFinite(e=e(t))?e:v(t))+l)})),E.remove(),S.attr("d",o?"M"+p+","+1*o+"V"+l+"H"+m+"V"+1*o:"M"+p+","+l+"H"+m),w.attr("opacity",1).attr("transform",function(t){return c(v(t)+l)}),C.attr("y2",1*r),D.attr(h,1*g).text(u),y.filter(V).attr("fill","none").attr("font-size",10).attr("font-family","sans-serif").attr("text-anchor","middle"),y.each(function(){this.__axis=v})}return d.scale=function(t){return arguments.length?(e=t,d):e},d.ticks=function(){return i=Array.from(arguments),d},d.tickArguments=function(t){return arguments.length?(i=null==t?[]:Array.from(t),d):i.slice()},d.tickValues=function(t){return arguments.length?(n=null==t?null:Array.from(t),d):n&&n.slice()},d.tickFormat=function(t){return arguments.length?(s=t,d):s},d.tickSize=function(t){return arguments.length?(r=o=+t,d):r},d.tickSizeInner=function(t){return arguments.length?(r=+t,d):r},d.tickSizeOuter=function(t){return arguments.length?(o=+t,d):o},d.tickPadding=function(t){return arguments.length?(a=+t,d):a},d.offset=function(t){return arguments.length?(l=+t,d):l},d}function F(t){return U(0,t)}var L={value:()=>{}};function W(){for(var t,e=0,i=arguments.length,n={};e<i;++e){if(!(t=arguments[e]+"")||t in n||/[\s.]/.test(t))throw new Error("illegal type: "+t);n[t]=[]}return new N(n)}function N(t){this._=t}function B(t,e){for(var i,n=0,s=t.length;n<s;++n)if((i=t[n]).name===e)return i.value}function H(t,e,i){for(var n=0,s=t.length;n<s;++n)if(t[n].name===e){t[n]=L,t=t.slice(0,n).concat(t.slice(n+1));break}return null!=i&&t.push({name:e,value:i}),t}N.prototype=W.prototype={constructor:N,on:function(t,e){var i,n,s=this._,r=(n=s,(t+"").trim().split(/^|\s+/).map(function(t){var e="",i=t.indexOf(".");if(i>=0&&(e=t.slice(i+1),t=t.slice(0,i)),t&&!n.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:e}})),o=-1,a=r.length;if(!(arguments.length<2)){if(null!=e&&"function"!=typeof e)throw new Error("invalid callback: "+e);for(;++o<a;)if(i=(t=r[o]).type)s[i]=H(s[i],t.name,e);else if(null==e)for(i in s)s[i]=H(s[i],t.name,null);return this}for(;++o<a;)if((i=(t=r[o]).type)&&(i=B(s[i],t.name)))return i},copy:function(){var t={},e=this._;for(var i in e)t[i]=e[i].slice();return new N(t)},call:function(t,e){if((i=arguments.length-2)>0)for(var i,n,s=new Array(i),r=0;r<i;++r)s[r]=arguments[r+2];if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(r=0,i=(n=this._[t]).length;r<i;++r)n[r].value.apply(e,s)},apply:function(t,e,i){if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(var n=this._[t],s=0,r=n.length;s<r;++s)n[s].value.apply(e,i)}};var z="http://www.w3.org/1999/xhtml",G={svg:"http://www.w3.org/2000/svg",xhtml:z,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function K(t){var e=t+="",i=e.indexOf(":");return i>=0&&"xmlns"!==(e=t.slice(0,i))&&(t=t.slice(i+1)),G.hasOwnProperty(e)?{space:G[e],local:t}:t}function J(t){return function(){var e=this.ownerDocument,i=this.namespaceURI;return i===z&&e.documentElement.namespaceURI===z?e.createElement(t):e.createElementNS(i,t)}}function $(t){return function(){return this.ownerDocument.createElementNS(t.space,t.local)}}function Y(t){var e=K(t);return(e.local?$:J)(e)}function j(){}function X(t){return null==t?j:function(){return this.querySelector(t)}}function q(){return[]}function Z(t){return null==t?q:function(){return this.querySelectorAll(t)}}function Q(t){return function(){return null==(e=t.apply(this,arguments))?[]:Array.isArray(e)?e:Array.from(e);var e}}function tt(t){return function(){return this.matches(t)}}function et(t){return function(e){return e.matches(t)}}var it=Array.prototype.find;function nt(){return this.firstElementChild}var st=Array.prototype.filter;function rt(){return Array.from(this.children)}function ot(t){return new Array(t.length)}function at(t,e){this.ownerDocument=t.ownerDocument,this.namespaceURI=t.namespaceURI,this._next=null,this._parent=t,this.__data__=e}function lt(t,e,i,n,s,r){for(var o,a=0,l=e.length,h=r.length;a<h;++a)(o=e[a])?(o.__data__=r[a],n[a]=o):i[a]=new at(t,r[a]);for(;a<l;++a)(o=e[a])&&(s[a]=o)}function ht(t,e,i,n,s,r,o){var a,l,h,c=new Map,d=e.length,u=r.length,g=new Array(d);for(a=0;a<d;++a)(l=e[a])&&(g[a]=h=o.call(l,l.__data__,a,e)+"",c.has(h)?s[a]=l:c.set(h,l));for(a=0;a<u;++a)h=o.call(t,r[a],a,r)+"",(l=c.get(h))?(n[a]=l,l.__data__=r[a],c.delete(h)):i[a]=new at(t,r[a]);for(a=0;a<d;++a)(l=e[a])&&c.get(g[a])===l&&(s[a]=l)}function ct(t){return t.__data__}function dt(t){return"object"==typeof t&&"length"in t?t:Array.from(t)}function ut(t,e){return t<e?-1:t>e?1:t>=e?0:NaN}function gt(t){return function(){this.removeAttribute(t)}}function ft(t){return function(){this.removeAttributeNS(t.space,t.local)}}function pt(t,e){return function(){this.setAttribute(t,e)}}function mt(t,e){return function(){this.setAttributeNS(t.space,t.local,e)}}function vt(t,e){return function(){var i=e.apply(this,arguments);null==i?this.removeAttribute(t):this.setAttribute(t,i)}}function yt(t,e){return function(){var i=e.apply(this,arguments);null==i?this.removeAttributeNS(t.space,t.local):this.setAttributeNS(t.space,t.local,i)}}function St(t){return t.ownerDocument&&t.ownerDocument.defaultView||t.document&&t||t.defaultView}function wt(t){return function(){this.style.removeProperty(t)}}function Et(t,e,i){return function(){this.style.setProperty(t,e,i)}}function _t(t,e,i){return function(){var n=e.apply(this,arguments);null==n?this.style.removeProperty(t):this.style.setProperty(t,n,i)}}function Ct(t,e){return t.style.getPropertyValue(e)||St(t).getComputedStyle(t,null).getPropertyValue(e)}function Dt(t){return function(){delete this[t]}}function Tt(t,e){return function(){this[t]=e}}function bt(t,e){return function(){var i=e.apply(this,arguments);null==i?delete this[t]:this[t]=i}}function Mt(t){return t.trim().split(/^|\s+/)}function Pt(t){return t.classList||new kt(t)}function kt(t){this._node=t,this._names=Mt(t.getAttribute("class")||"")}function Ot(t,e){for(var i=Pt(t),n=-1,s=e.length;++n<s;)i.add(e[n])}function xt(t,e){for(var i=Pt(t),n=-1,s=e.length;++n<s;)i.remove(e[n])}function At(t){return function(){Ot(this,t)}}function It(t){return function(){xt(this,t)}}function Rt(t,e){return function(){(e.apply(this,arguments)?Ot:xt)(this,t)}}function Vt(){this.textContent=""}function Ut(t){return function(){this.textContent=t}}function Ft(t){return function(){var e=t.apply(this,arguments);this.textContent=null==e?"":e}}function Lt(){this.innerHTML=""}function Wt(t){return function(){this.innerHTML=t}}function Nt(t){return function(){var e=t.apply(this,arguments);this.innerHTML=null==e?"":e}}function Bt(){this.nextSibling&&this.parentNode.appendChild(this)}function Ht(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function zt(){return null}function Gt(){var t=this.parentNode;t&&t.removeChild(this)}function Kt(){var t=this.cloneNode(!1),e=this.parentNode;return e?e.insertBefore(t,this.nextSibling):t}function Jt(){var t=this.cloneNode(!0),e=this.parentNode;return e?e.insertBefore(t,this.nextSibling):t}function $t(t){return function(){var e=this.__on;if(e){for(var i,n=0,s=-1,r=e.length;n<r;++n)i=e[n],t.type&&i.type!==t.type||i.name!==t.name?e[++s]=i:this.removeEventListener(i.type,i.listener,i.options);++s?e.length=s:delete this.__on}}}function Yt(t,e,i){return function(){var n,s=this.__on,r=function(t){return function(e){t.call(this,e,this.__data__)}}(e);if(s)for(var o=0,a=s.length;o<a;++o)if((n=s[o]).type===t.type&&n.name===t.name)return this.removeEventListener(n.type,n.listener,n.options),this.addEventListener(n.type,n.listener=r,n.options=i),void(n.value=e);this.addEventListener(t.type,r,i),n={type:t.type,name:t.name,value:e,listener:r,options:i},s?s.push(n):this.__on=[n]}}function jt(t,e,i){var n=St(t),s=n.CustomEvent;"function"==typeof s?s=new s(e,i):(s=n.document.createEvent("Event"),i?(s.initEvent(e,i.bubbles,i.cancelable),s.detail=i.detail):s.initEvent(e,!1,!1)),t.dispatchEvent(s)}function Xt(t,e){return function(){return jt(this,t,e)}}function qt(t,e){return function(){return jt(this,t,e.apply(this,arguments))}}at.prototype={constructor:at,appendChild:function(t){return this._parent.insertBefore(t,this._next)},insertBefore:function(t,e){return this._parent.insertBefore(t,e)},querySelector:function(t){return this._parent.querySelector(t)},querySelectorAll:function(t){return this._parent.querySelectorAll(t)}},kt.prototype={add:function(t){this._names.indexOf(t)<0&&(this._names.push(t),this._node.setAttribute("class",this._names.join(" ")))},remove:function(t){var e=this._names.indexOf(t);e>=0&&(this._names.splice(e,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(t){return this._names.indexOf(t)>=0}};var Zt=[null];function Qt(t,e){this._groups=t,this._parents=e}function te(){return new Qt([[document.documentElement]],Zt)}function ee(t){return"string"==typeof t?new Qt([[document.querySelector(t)]],[document.documentElement]):new Qt([[t]],Zt)}function ie(t,e){if(t=function(t){let e;for(;e=t.sourceEvent;)t=e;return t}(t),void 0===e&&(e=t.currentTarget),e){var i=e.ownerSVGElement||e;if(i.createSVGPoint){var n=i.createSVGPoint();return n.x=t.clientX,n.y=t.clientY,[(n=n.matrixTransform(e.getScreenCTM().inverse())).x,n.y]}if(e.getBoundingClientRect){var s=e.getBoundingClientRect();return[t.clientX-s.left-e.clientLeft,t.clientY-s.top-e.clientTop]}}return[t.pageX,t.pageY]}Qt.prototype=te.prototype={constructor:Qt,select:function(t){"function"!=typeof t&&(t=X(t));for(var e=this._groups,i=e.length,n=new Array(i),s=0;s<i;++s)for(var r,o,a=e[s],l=a.length,h=n[s]=new Array(l),c=0;c<l;++c)(r=a[c])&&(o=t.call(r,r.__data__,c,a))&&("__data__"in r&&(o.__data__=r.__data__),h[c]=o);return new Qt(n,this._parents)},selectAll:function(t){t="function"==typeof t?Q(t):Z(t);for(var e=this._groups,i=e.length,n=[],s=[],r=0;r<i;++r)for(var o,a=e[r],l=a.length,h=0;h<l;++h)(o=a[h])&&(n.push(t.call(o,o.__data__,h,a)),s.push(o));return new Qt(n,s)},selectChild:function(t){return this.select(null==t?nt:function(t){return function(){return it.call(this.children,t)}}("function"==typeof t?t:et(t)))},selectChildren:function(t){return this.selectAll(null==t?rt:function(t){return function(){return st.call(this.children,t)}}("function"==typeof t?t:et(t)))},filter:function(t){"function"!=typeof t&&(t=tt(t));for(var e=this._groups,i=e.length,n=new Array(i),s=0;s<i;++s)for(var r,o=e[s],a=o.length,l=n[s]=[],h=0;h<a;++h)(r=o[h])&&t.call(r,r.__data__,h,o)&&l.push(r);return new Qt(n,this._parents)},data:function(t,e){if(!arguments.length)return Array.from(this,ct);var i,n=e?ht:lt,s=this._parents,r=this._groups;"function"!=typeof t&&(i=t,t=function(){return i});for(var o=r.length,a=new Array(o),l=new Array(o),h=new Array(o),c=0;c<o;++c){var d=s[c],u=r[c],g=u.length,f=dt(t.call(d,d&&d.__data__,c,s)),p=f.length,m=l[c]=new Array(p),v=a[c]=new Array(p);n(d,u,m,v,h[c]=new Array(g),f,e);for(var y,S,w=0,E=0;w<p;++w)if(y=m[w]){for(w>=E&&(E=w+1);!(S=v[E])&&++E<p;);y._next=S||null}}return(a=new Qt(a,s))._enter=l,a._exit=h,a},enter:function(){return new Qt(this._enter||this._groups.map(ot),this._parents)},exit:function(){return new Qt(this._exit||this._groups.map(ot),this._parents)},join:function(t,e,i){var n=this.enter(),s=this,r=this.exit();return"function"==typeof t?(n=t(n))&&(n=n.selection()):n=n.append(t+""),null!=e&&(s=e(s))&&(s=s.selection()),null==i?r.remove():i(r),n&&s?n.merge(s).order():s},merge:function(t){for(var e=t.selection?t.selection():t,i=this._groups,n=e._groups,s=i.length,r=n.length,o=Math.min(s,r),a=new Array(s),l=0;l<o;++l)for(var h,c=i[l],d=n[l],u=c.length,g=a[l]=new Array(u),f=0;f<u;++f)(h=c[f]||d[f])&&(g[f]=h);for(;l<s;++l)a[l]=i[l];return new Qt(a,this._parents)},selection:function(){return this},order:function(){for(var t=this._groups,e=-1,i=t.length;++e<i;)for(var n,s=t[e],r=s.length-1,o=s[r];--r>=0;)(n=s[r])&&(o&&4^n.compareDocumentPosition(o)&&o.parentNode.insertBefore(n,o),o=n);return this},sort:function(t){function e(e,i){return e&&i?t(e.__data__,i.__data__):!e-!i}t||(t=ut);for(var i=this._groups,n=i.length,s=new Array(n),r=0;r<n;++r){for(var o,a=i[r],l=a.length,h=s[r]=new Array(l),c=0;c<l;++c)(o=a[c])&&(h[c]=o);h.sort(e)}return new Qt(s,this._parents).order()},call:function(){var t=arguments[0];return arguments[0]=this,t.apply(null,arguments),this},nodes:function(){return Array.from(this)},node:function(){for(var t=this._groups,e=0,i=t.length;e<i;++e)for(var n=t[e],s=0,r=n.length;s<r;++s){var o=n[s];if(o)return o}return null},size:function(){let t=0;for(const e of this)++t;return t},empty:function(){return!this.node()},each:function(t){for(var e=this._groups,i=0,n=e.length;i<n;++i)for(var s,r=e[i],o=0,a=r.length;o<a;++o)(s=r[o])&&t.call(s,s.__data__,o,r);return this},attr:function(t,e){var i=K(t);if(arguments.length<2){var n=this.node();return i.local?n.getAttributeNS(i.space,i.local):n.getAttribute(i)}return this.each((null==e?i.local?ft:gt:"function"==typeof e?i.local?yt:vt:i.local?mt:pt)(i,e))},style:function(t,e,i){return arguments.length>1?this.each((null==e?wt:"function"==typeof e?_t:Et)(t,e,null==i?"":i)):Ct(this.node(),t)},property:function(t,e){return arguments.length>1?this.each((null==e?Dt:"function"==typeof e?bt:Tt)(t,e)):this.node()[t]},classed:function(t,e){var i=Mt(t+"");if(arguments.length<2){for(var n=Pt(this.node()),s=-1,r=i.length;++s<r;)if(!n.contains(i[s]))return!1;return!0}return this.each(("function"==typeof e?Rt:e?At:It)(i,e))},text:function(t){return arguments.length?this.each(null==t?Vt:("function"==typeof t?Ft:Ut)(t)):this.node().textContent},html:function(t){return arguments.length?this.each(null==t?Lt:("function"==typeof t?Nt:Wt)(t)):this.node().innerHTML},raise:function(){return this.each(Bt)},lower:function(){return this.each(Ht)},append:function(t){var e="function"==typeof t?t:Y(t);return this.select(function(){return this.appendChild(e.apply(this,arguments))})},insert:function(t,e){var i="function"==typeof t?t:Y(t),n=null==e?zt:"function"==typeof e?e:X(e);return this.select(function(){return this.insertBefore(i.apply(this,arguments),n.apply(this,arguments)||null)})},remove:function(){return this.each(Gt)},clone:function(t){return this.select(t?Jt:Kt)},datum:function(t){return arguments.length?this.property("__data__",t):this.node().__data__},on:function(t,e,i){var n,s,r=function(t){return t.trim().split(/^|\s+/).map(function(t){var e="",i=t.indexOf(".");return i>=0&&(e=t.slice(i+1),t=t.slice(0,i)),{type:t,name:e}})}(t+""),o=r.length;if(!(arguments.length<2)){for(a=e?Yt:$t,n=0;n<o;++n)this.each(a(r[n],e,i));return this}var a=this.node().__on;if(a)for(var l,h=0,c=a.length;h<c;++h)for(n=0,l=a[h];n<o;++n)if((s=r[n]).type===l.type&&s.name===l.name)return l.value},dispatch:function(t,e){return this.each(("function"==typeof e?qt:Xt)(t,e))},[Symbol.iterator]:function*(){for(var t=this._groups,e=0,i=t.length;e<i;++e)for(var n,s=t[e],r=0,o=s.length;r<o;++r)(n=s[r])&&(yield n)}};const ne={passive:!1},se={capture:!0,passive:!1};function re(t){t.stopImmediatePropagation()}function oe(t){t.preventDefault(),t.stopImmediatePropagation()}var ae=t=>()=>t;function le(t,{sourceEvent:e,subject:i,target:n,identifier:s,active:r,x:o,y:a,dx:l,dy:h,dispatch:c}){Object.defineProperties(this,{type:{value:t,enumerable:!0,configurable:!0},sourceEvent:{value:e,enumerable:!0,configurable:!0},subject:{value:i,enumerable:!0,configurable:!0},target:{value:n,enumerable:!0,configurable:!0},identifier:{value:s,enumerable:!0,configurable:!0},active:{value:r,enumerable:!0,configurable:!0},x:{value:o,enumerable:!0,configurable:!0},y:{value:a,enumerable:!0,configurable:!0},dx:{value:l,enumerable:!0,configurable:!0},dy:{value:h,enumerable:!0,configurable:!0},_:{value:c}})}function he(t){return!t.ctrlKey&&!t.button}function ce(){return this.parentNode}function de(t,e){return null==e?{x:t.x,y:t.y}:e}function ue(){return navigator.maxTouchPoints||"ontouchstart"in this}function ge(){var t,e,i,n,s=he,r=ce,o=de,a=ue,l={},h=W("start","drag","end"),c=0,d=0;function u(t){t.on("mousedown.drag",g).filter(a).on("touchstart.drag",m).on("touchmove.drag",v,ne).on("touchend.drag touchcancel.drag",y).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function g(o,a){if(!n&&s.call(this,o,a)){var l=S(this,r.call(this,o,a),o,a,"mouse");l&&(ee(o.view).on("mousemove.drag",f,se).on("mouseup.drag",p,se),function(t){var e=t.document.documentElement,i=ee(t).on("dragstart.drag",oe,se);"onselectstart"in e?i.on("selectstart.drag",oe,se):(e.__noselect=e.style.MozUserSelect,e.style.MozUserSelect="none")}(o.view),re(o),i=!1,t=o.clientX,e=o.clientY,l("start",o))}}function f(n){if(oe(n),!i){var s=n.clientX-t,r=n.clientY-e;i=s*s+r*r>d}l.mouse("drag",n)}function p(t){ee(t.view).on("mousemove.drag mouseup.drag",null),function(t,e){var i=t.document.documentElement,n=ee(t).on("dragstart.drag",null);e&&(n.on("click.drag",oe,se),setTimeout(function(){n.on("click.drag",null)},0)),"onselectstart"in i?n.on("selectstart.drag",null):(i.style.MozUserSelect=i.__noselect,delete i.__noselect)}(t.view,i),oe(t),l.mouse("end",t)}function m(t,e){if(s.call(this,t,e)){var i,n,o=t.changedTouches,a=r.call(this,t,e),l=o.length;for(i=0;i<l;++i)(n=S(this,a,t,e,o[i].identifier,o[i]))&&(re(t),n("start",t,o[i]))}}function v(t){var e,i,n=t.changedTouches,s=n.length;for(e=0;e<s;++e)(i=l[n[e].identifier])&&(oe(t),i("drag",t,n[e]))}function y(t){var e,i,s=t.changedTouches,r=s.length;for(n&&clearTimeout(n),n=setTimeout(function(){n=null},500),e=0;e<r;++e)(i=l[s[e].identifier])&&(re(t),i("end",t,s[e]))}function S(t,e,i,n,s,r){var a,d,g,f=h.copy(),p=ie(r||i,e);if(null!=(g=o.call(t,new le("beforestart",{sourceEvent:i,target:u,identifier:s,active:c,x:p[0],y:p[1],dx:0,dy:0,dispatch:f}),n)))return a=g.x-p[0]||0,d=g.y-p[1]||0,function i(r,o,h){var m,v=p;switch(r){case"start":l[s]=i,m=c++;break;case"end":delete l[s],--c;case"drag":p=ie(h||o,e),m=c}f.call(r,t,new le(r,{sourceEvent:o,subject:g,target:u,identifier:s,active:m,x:p[0]+a,y:p[1]+d,dx:p[0]-v[0],dy:p[1]-v[1],dispatch:f}),n)}}return u.filter=function(t){return arguments.length?(s="function"==typeof t?t:ae(!!t),u):s},u.container=function(t){return arguments.length?(r="function"==typeof t?t:ae(t),u):r},u.subject=function(t){return arguments.length?(o="function"==typeof t?t:ae(t),u):o},u.touchable=function(t){return arguments.length?(a="function"==typeof t?t:ae(!!t),u):a},u.on=function(){var t=h.on.apply(h,arguments);return t===h?u:t},u.clickDistance=function(t){return arguments.length?(d=(t=+t)*t,u):Math.sqrt(d)},u}function fe(t,e,i){t.prototype=e.prototype=i,i.constructor=t}function pe(t,e){var i=Object.create(t.prototype);for(var n in e)i[n]=e[n];return i}function me(){}le.prototype.on=function(){var t=this._.on.apply(this._,arguments);return t===this._?this:t};var ve=.7,ye=1/ve,Se="\\s*([+-]?\\d+)\\s*",we="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",Ee="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",_e=/^#([0-9a-f]{3,8})$/,Ce=new RegExp(`^rgb\\(${Se},${Se},${Se}\\)$`),De=new RegExp(`^rgb\\(${Ee},${Ee},${Ee}\\)$`),Te=new RegExp(`^rgba\\(${Se},${Se},${Se},${we}\\)$`),be=new RegExp(`^rgba\\(${Ee},${Ee},${Ee},${we}\\)$`),Me=new RegExp(`^hsl\\(${we},${Ee},${Ee}\\)$`),Pe=new RegExp(`^hsla\\(${we},${Ee},${Ee},${we}\\)$`),ke={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};function Oe(){return this.rgb().formatHex()}function xe(){return this.rgb().formatRgb()}function Ae(t){var e,i;return t=(t+"").trim().toLowerCase(),(e=_e.exec(t))?(i=e[1].length,e=parseInt(e[1],16),6===i?Ie(e):3===i?new Ue(e>>8&15|e>>4&240,e>>4&15|240&e,(15&e)<<4|15&e,1):8===i?Re(e>>24&255,e>>16&255,e>>8&255,(255&e)/255):4===i?Re(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|240&e,((15&e)<<4|15&e)/255):null):(e=Ce.exec(t))?new Ue(e[1],e[2],e[3],1):(e=De.exec(t))?new Ue(255*e[1]/100,255*e[2]/100,255*e[3]/100,1):(e=Te.exec(t))?Re(e[1],e[2],e[3],e[4]):(e=be.exec(t))?Re(255*e[1]/100,255*e[2]/100,255*e[3]/100,e[4]):(e=Me.exec(t))?He(e[1],e[2]/100,e[3]/100,1):(e=Pe.exec(t))?He(e[1],e[2]/100,e[3]/100,e[4]):ke.hasOwnProperty(t)?Ie(ke[t]):"transparent"===t?new Ue(NaN,NaN,NaN,0):null}function Ie(t){return new Ue(t>>16&255,t>>8&255,255&t,1)}function Re(t,e,i,n){return n<=0&&(t=e=i=NaN),new Ue(t,e,i,n)}function Ve(t,e,i,n){return 1===arguments.length?((s=t)instanceof me||(s=Ae(s)),s?new Ue((s=s.rgb()).r,s.g,s.b,s.opacity):new Ue):new Ue(t,e,i,null==n?1:n);var s}function Ue(t,e,i,n){this.r=+t,this.g=+e,this.b=+i,this.opacity=+n}function Fe(){return`#${Be(this.r)}${Be(this.g)}${Be(this.b)}`}function Le(){const t=We(this.opacity);return`${1===t?"rgb(":"rgba("}${Ne(this.r)}, ${Ne(this.g)}, ${Ne(this.b)}${1===t?")":`, ${t})`}`}function We(t){return isNaN(t)?1:Math.max(0,Math.min(1,t))}function Ne(t){return Math.max(0,Math.min(255,Math.round(t)||0))}function Be(t){return((t=Ne(t))<16?"0":"")+t.toString(16)}function He(t,e,i,n){return n<=0?t=e=i=NaN:i<=0||i>=1?t=e=NaN:e<=0&&(t=NaN),new Ge(t,e,i,n)}function ze(t){if(t instanceof Ge)return new Ge(t.h,t.s,t.l,t.opacity);if(t instanceof me||(t=Ae(t)),!t)return new Ge;if(t instanceof Ge)return t;var e=(t=t.rgb()).r/255,i=t.g/255,n=t.b/255,s=Math.min(e,i,n),r=Math.max(e,i,n),o=NaN,a=r-s,l=(r+s)/2;return a?(o=e===r?(i-n)/a+6*(i<n):i===r?(n-e)/a+2:(e-i)/a+4,a/=l<.5?r+s:2-r-s,o*=60):a=l>0&&l<1?0:o,new Ge(o,a,l,t.opacity)}function Ge(t,e,i,n){this.h=+t,this.s=+e,this.l=+i,this.opacity=+n}function Ke(t){return(t=(t||0)%360)<0?t+360:t}function Je(t){return Math.max(0,Math.min(1,t||0))}function $e(t,e,i){return 255*(t<60?e+(i-e)*t/60:t<180?i:t<240?e+(i-e)*(240-t)/60:e)}fe(me,Ae,{copy(t){return Object.assign(new this.constructor,this,t)},displayable(){return this.rgb().displayable()},hex:Oe,formatHex:Oe,formatHex8:function(){return this.rgb().formatHex8()},formatHsl:function(){return ze(this).formatHsl()},formatRgb:xe,toString:xe}),fe(Ue,Ve,pe(me,{brighter(t){return t=null==t?ye:Math.pow(ye,t),new Ue(this.r*t,this.g*t,this.b*t,this.opacity)},darker(t){return t=null==t?ve:Math.pow(ve,t),new Ue(this.r*t,this.g*t,this.b*t,this.opacity)},rgb(){return this},clamp(){return new Ue(Ne(this.r),Ne(this.g),Ne(this.b),We(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:Fe,formatHex:Fe,formatHex8:function(){return`#${Be(this.r)}${Be(this.g)}${Be(this.b)}${Be(255*(isNaN(this.opacity)?1:this.opacity))}`},formatRgb:Le,toString:Le})),fe(Ge,function(t,e,i,n){return 1===arguments.length?ze(t):new Ge(t,e,i,null==n?1:n)},pe(me,{brighter(t){return t=null==t?ye:Math.pow(ye,t),new Ge(this.h,this.s,this.l*t,this.opacity)},darker(t){return t=null==t?ve:Math.pow(ve,t),new Ge(this.h,this.s,this.l*t,this.opacity)},rgb(){var t=this.h%360+360*(this.h<0),e=isNaN(t)||isNaN(this.s)?0:this.s,i=this.l,n=i+(i<.5?i:1-i)*e,s=2*i-n;return new Ue($e(t>=240?t-240:t+120,s,n),$e(t,s,n),$e(t<120?t+240:t-120,s,n),this.opacity)},clamp(){return new Ge(Ke(this.h),Je(this.s),Je(this.l),We(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const t=We(this.opacity);return`${1===t?"hsl(":"hsla("}${Ke(this.h)}, ${100*Je(this.s)}%, ${100*Je(this.l)}%${1===t?")":`, ${t})`}`}}));var Ye=t=>()=>t;function je(t){return 1===(t=+t)?Xe:function(e,i){return i-e?function(t,e,i){return t=Math.pow(t,i),e=Math.pow(e,i)-t,i=1/i,function(n){return Math.pow(t+n*e,i)}}(e,i,t):Ye(isNaN(e)?i:e)}}function Xe(t,e){var i=e-t;return i?function(t,e){return function(i){return t+i*e}}(t,i):Ye(isNaN(t)?e:t)}var qe=function t(e){var i=je(e);function n(t,e){var n=i((t=Ve(t)).r,(e=Ve(e)).r),s=i(t.g,e.g),r=i(t.b,e.b),o=Xe(t.opacity,e.opacity);return function(e){return t.r=n(e),t.g=s(e),t.b=r(e),t.opacity=o(e),t+""}}return n.gamma=t,n}(1);function Ze(t,e){e||(e=[]);var i,n=t?Math.min(e.length,t.length):0,s=e.slice();return function(r){for(i=0;i<n;++i)s[i]=t[i]*(1-r)+e[i]*r;return s}}function Qe(t,e){var i,n=e?e.length:0,s=t?Math.min(n,t.length):0,r=new Array(s),o=new Array(n);for(i=0;i<s;++i)r[i]=oi(t[i],e[i]);for(;i<n;++i)o[i]=e[i];return function(t){for(i=0;i<s;++i)o[i]=r[i](t);return o}}function ti(t,e){var i=new Date;return t=+t,e=+e,function(n){return i.setTime(t*(1-n)+e*n),i}}function ei(t,e){return t=+t,e=+e,function(i){return t*(1-i)+e*i}}function ii(t,e){var i,n={},s={};for(i in null!==t&&"object"==typeof t||(t={}),null!==e&&"object"==typeof e||(e={}),e)i in t?n[i]=oi(t[i],e[i]):s[i]=e[i];return function(t){for(i in n)s[i]=n[i](t);return s}}var ni=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,si=new RegExp(ni.source,"g");function ri(t,e){var i,n,s,r=ni.lastIndex=si.lastIndex=0,o=-1,a=[],l=[];for(t+="",e+="";(i=ni.exec(t))&&(n=si.exec(e));)(s=n.index)>r&&(s=e.slice(r,s),a[o]?a[o]+=s:a[++o]=s),(i=i[0])===(n=n[0])?a[o]?a[o]+=n:a[++o]=n:(a[++o]=null,l.push({i:o,x:ei(i,n)})),r=si.lastIndex;return r<e.length&&(s=e.slice(r),a[o]?a[o]+=s:a[++o]=s),a.length<2?l[0]?function(t){return function(e){return t(e)+""}}(l[0].x):function(t){return function(){return t}}(e):(e=l.length,function(t){for(var i,n=0;n<e;++n)a[(i=l[n]).i]=i.x(t);return a.join("")})}function oi(t,e){var i,n,s=typeof e;return null==e||"boolean"===s?Ye(e):("number"===s?ei:"string"===s?(i=Ae(e))?(e=i,qe):ri:e instanceof Ae?qe:e instanceof Date?ti:(n=e,!ArrayBuffer.isView(n)||n instanceof DataView?Array.isArray(e)?Qe:"function"!=typeof e.valueOf&&"function"!=typeof e.toString||isNaN(e)?ii:ei:Ze))(t,e)}function ai(t,e){return t=+t,e=+e,function(i){return Math.round(t*(1-i)+e*i)}}var li,hi=180/Math.PI,ci={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function di(t,e,i,n,s,r){var o,a,l;return(o=Math.sqrt(t*t+e*e))&&(t/=o,e/=o),(l=t*i+e*n)&&(i-=t*l,n-=e*l),(a=Math.sqrt(i*i+n*n))&&(i/=a,n/=a,l/=a),t*n<e*i&&(t=-t,e=-e,l=-l,o=-o),{translateX:s,translateY:r,rotate:Math.atan2(e,t)*hi,skewX:Math.atan(l)*hi,scaleX:o,scaleY:a}}function ui(t,e,i,n){function s(t){return t.length?t.pop()+" ":""}return function(r,o){var a=[],l=[];return r=t(r),o=t(o),function(t,n,s,r,o,a){if(t!==s||n!==r){var l=o.push("translate(",null,e,null,i);a.push({i:l-4,x:ei(t,s)},{i:l-2,x:ei(n,r)})}else(s||r)&&o.push("translate("+s+e+r+i)}(r.translateX,r.translateY,o.translateX,o.translateY,a,l),function(t,e,i,r){t!==e?(t-e>180?e+=360:e-t>180&&(t+=360),r.push({i:i.push(s(i)+"rotate(",null,n)-2,x:ei(t,e)})):e&&i.push(s(i)+"rotate("+e+n)}(r.rotate,o.rotate,a,l),function(t,e,i,r){t!==e?r.push({i:i.push(s(i)+"skewX(",null,n)-2,x:ei(t,e)}):e&&i.push(s(i)+"skewX("+e+n)}(r.skewX,o.skewX,a,l),function(t,e,i,n,r,o){if(t!==i||e!==n){var a=r.push(s(r)+"scale(",null,",",null,")");o.push({i:a-4,x:ei(t,i)},{i:a-2,x:ei(e,n)})}else 1===i&&1===n||r.push(s(r)+"scale("+i+","+n+")")}(r.scaleX,r.scaleY,o.scaleX,o.scaleY,a,l),r=o=null,function(t){for(var e,i=-1,n=l.length;++i<n;)a[(e=l[i]).i]=e.x(t);return a.join("")}}}var gi,fi,pi=ui(function(t){const e=new("function"==typeof DOMMatrix?DOMMatrix:WebKitCSSMatrix)(t+"");return e.isIdentity?ci:di(e.a,e.b,e.c,e.d,e.e,e.f)},"px, ","px)","deg)"),mi=ui(function(t){return null==t?ci:(li||(li=document.createElementNS("http://www.w3.org/2000/svg","g")),li.setAttribute("transform",t),(t=li.transform.baseVal.consolidate())?di((t=t.matrix).a,t.b,t.c,t.d,t.e,t.f):ci)},", ",")",")"),vi=0,yi=0,Si=0,wi=0,Ei=0,_i=0,Ci="object"==typeof performance&&performance.now?performance:Date,Di="object"==typeof window&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(t){setTimeout(t,17)};function Ti(){return Ei||(Di(bi),Ei=Ci.now()+_i)}function bi(){Ei=0}function Mi(){this._call=this._time=this._next=null}function Pi(t,e,i){var n=new Mi;return n.restart(t,e,i),n}function ki(){Ei=(wi=Ci.now())+_i,vi=yi=0;try{!function(){Ti(),++vi;for(var t,e=gi;e;)(t=Ei-e._time)>=0&&e._call.call(void 0,t),e=e._next;--vi}()}finally{vi=0,function(){var t,e,i=gi,n=1/0;for(;i;)i._call?(n>i._time&&(n=i._time),t=i,i=i._next):(e=i._next,i._next=null,i=t?t._next=e:gi=e);fi=t,xi(n)}(),Ei=0}}function Oi(){var t=Ci.now(),e=t-wi;e>1e3&&(_i-=e,wi=t)}function xi(t){vi||(yi&&(yi=clearTimeout(yi)),t-Ei>24?(t<1/0&&(yi=setTimeout(ki,t-Ci.now()-_i)),Si&&(Si=clearInterval(Si))):(Si||(wi=Ci.now(),Si=setInterval(Oi,1e3)),vi=1,Di(ki)))}function Ai(t,e,i){var n=new Mi;return e=null==e?0:+e,n.restart(i=>{n.stop(),t(i+e)},e,i),n}Mi.prototype=Pi.prototype={constructor:Mi,restart:function(t,e,i){if("function"!=typeof t)throw new TypeError("callback is not a function");i=(null==i?Ti():+i)+(null==e?0:+e),this._next||fi===this||(fi?fi._next=this:gi=this,fi=this),this._call=t,this._time=i,xi()},stop:function(){this._call&&(this._call=null,this._time=1/0,xi())}};var Ii=W("start","end","cancel","interrupt"),Ri=[];function Vi(t,e,i,n,s,r){var o=t.__transition;if(o){if(i in o)return}else t.__transition={};!function(t,e,i){var n,s=t.__transition;function r(t){i.state=1,i.timer.restart(o,i.delay,i.time),i.delay<=t&&o(t-i.delay)}function o(r){var h,c,d,u;if(1!==i.state)return l();for(h in s)if((u=s[h]).name===i.name){if(3===u.state)return Ai(o);4===u.state?(u.state=6,u.timer.stop(),u.on.call("interrupt",t,t.__data__,u.index,u.group),delete s[h]):+h<e&&(u.state=6,u.timer.stop(),u.on.call("cancel",t,t.__data__,u.index,u.group),delete s[h])}if(Ai(function(){3===i.state&&(i.state=4,i.timer.restart(a,i.delay,i.time),a(r))}),i.state=2,i.on.call("start",t,t.__data__,i.index,i.group),2===i.state){for(i.state=3,n=new Array(d=i.tween.length),h=0,c=-1;h<d;++h)(u=i.tween[h].value.call(t,t.__data__,i.index,i.group))&&(n[++c]=u);n.length=c+1}}function a(e){for(var s=e<i.duration?i.ease.call(null,e/i.duration):(i.timer.restart(l),i.state=5,1),r=-1,o=n.length;++r<o;)n[r].call(t,s);5===i.state&&(i.on.call("end",t,t.__data__,i.index,i.group),l())}function l(){for(var n in i.state=6,i.timer.stop(),delete s[e],s)return;delete t.__transition}s[e]=i,i.timer=Pi(r,0,i.time)}(t,i,{name:e,index:n,group:s,on:Ii,tween:Ri,time:r.time,delay:r.delay,duration:r.duration,ease:r.ease,timer:null,state:0})}function Ui(t,e){var i=Li(t,e);if(i.state>0)throw new Error("too late; already scheduled");return i}function Fi(t,e){var i=Li(t,e);if(i.state>3)throw new Error("too late; already running");return i}function Li(t,e){var i=t.__transition;if(!i||!(i=i[e]))throw new Error("transition not found");return i}function Wi(t,e){var i,n;return function(){var s=Fi(this,t),r=s.tween;if(r!==i)for(var o=0,a=(n=i=r).length;o<a;++o)if(n[o].name===e){(n=n.slice()).splice(o,1);break}s.tween=n}}function Ni(t,e,i){var n,s;if("function"!=typeof i)throw new Error;return function(){var r=Fi(this,t),o=r.tween;if(o!==n){s=(n=o).slice();for(var a={name:e,value:i},l=0,h=s.length;l<h;++l)if(s[l].name===e){s[l]=a;break}l===h&&s.push(a)}r.tween=s}}function Bi(t,e,i){var n=t._id;return t.each(function(){var t=Fi(this,n);(t.value||(t.value={}))[e]=i.apply(this,arguments)}),function(t){return Li(t,n).value[e]}}function Hi(t,e){var i;return("number"==typeof e?ei:e instanceof Ae?qe:(i=Ae(e))?(e=i,qe):ri)(t,e)}function zi(t){return function(){this.removeAttribute(t)}}function Gi(t){return function(){this.removeAttributeNS(t.space,t.local)}}function Ki(t,e,i){var n,s,r=i+"";return function(){var o=this.getAttribute(t);return o===r?null:o===n?s:s=e(n=o,i)}}function Ji(t,e,i){var n,s,r=i+"";return function(){var o=this.getAttributeNS(t.space,t.local);return o===r?null:o===n?s:s=e(n=o,i)}}function $i(t,e,i){var n,s,r;return function(){var o,a,l=i(this);if(null!=l)return(o=this.getAttribute(t))===(a=l+"")?null:o===n&&a===s?r:(s=a,r=e(n=o,l));this.removeAttribute(t)}}function Yi(t,e,i){var n,s,r;return function(){var o,a,l=i(this);if(null!=l)return(o=this.getAttributeNS(t.space,t.local))===(a=l+"")?null:o===n&&a===s?r:(s=a,r=e(n=o,l));this.removeAttributeNS(t.space,t.local)}}function ji(t,e){var i,n;function s(){var s=e.apply(this,arguments);return s!==n&&(i=(n=s)&&function(t,e){return function(i){this.setAttributeNS(t.space,t.local,e.call(this,i))}}(t,s)),i}return s._value=e,s}function Xi(t,e){var i,n;function s(){var s=e.apply(this,arguments);return s!==n&&(i=(n=s)&&function(t,e){return function(i){this.setAttribute(t,e.call(this,i))}}(t,s)),i}return s._value=e,s}function qi(t,e){return function(){Ui(this,t).delay=+e.apply(this,arguments)}}function Zi(t,e){return e=+e,function(){Ui(this,t).delay=e}}function Qi(t,e){return function(){Fi(this,t).duration=+e.apply(this,arguments)}}function tn(t,e){return e=+e,function(){Fi(this,t).duration=e}}var en=te.prototype.constructor;function nn(t){return function(){this.style.removeProperty(t)}}var sn=0;function rn(t,e,i,n){this._groups=t,this._parents=e,this._name=i,this._id=n}function on(){return++sn}var an=te.prototype;rn.prototype={constructor:rn,select:function(t){var e=this._name,i=this._id;"function"!=typeof t&&(t=X(t));for(var n=this._groups,s=n.length,r=new Array(s),o=0;o<s;++o)for(var a,l,h=n[o],c=h.length,d=r[o]=new Array(c),u=0;u<c;++u)(a=h[u])&&(l=t.call(a,a.__data__,u,h))&&("__data__"in a&&(l.__data__=a.__data__),d[u]=l,Vi(d[u],e,i,u,d,Li(a,i)));return new rn(r,this._parents,e,i)},selectAll:function(t){var e=this._name,i=this._id;"function"!=typeof t&&(t=Z(t));for(var n=this._groups,s=n.length,r=[],o=[],a=0;a<s;++a)for(var l,h=n[a],c=h.length,d=0;d<c;++d)if(l=h[d]){for(var u,g=t.call(l,l.__data__,d,h),f=Li(l,i),p=0,m=g.length;p<m;++p)(u=g[p])&&Vi(u,e,i,p,g,f);r.push(g),o.push(l)}return new rn(r,o,e,i)},selectChild:an.selectChild,selectChildren:an.selectChildren,filter:function(t){"function"!=typeof t&&(t=tt(t));for(var e=this._groups,i=e.length,n=new Array(i),s=0;s<i;++s)for(var r,o=e[s],a=o.length,l=n[s]=[],h=0;h<a;++h)(r=o[h])&&t.call(r,r.__data__,h,o)&&l.push(r);return new rn(n,this._parents,this._name,this._id)},merge:function(t){if(t._id!==this._id)throw new Error;for(var e=this._groups,i=t._groups,n=e.length,s=i.length,r=Math.min(n,s),o=new Array(n),a=0;a<r;++a)for(var l,h=e[a],c=i[a],d=h.length,u=o[a]=new Array(d),g=0;g<d;++g)(l=h[g]||c[g])&&(u[g]=l);for(;a<n;++a)o[a]=e[a];return new rn(o,this._parents,this._name,this._id)},selection:function(){return new en(this._groups,this._parents)},transition:function(){for(var t=this._name,e=this._id,i=on(),n=this._groups,s=n.length,r=0;r<s;++r)for(var o,a=n[r],l=a.length,h=0;h<l;++h)if(o=a[h]){var c=Li(o,e);Vi(o,t,i,h,a,{time:c.time+c.delay+c.duration,delay:0,duration:c.duration,ease:c.ease})}return new rn(n,this._parents,t,i)},call:an.call,nodes:an.nodes,node:an.node,size:an.size,empty:an.empty,each:an.each,on:function(t,e){var i=this._id;return arguments.length<2?Li(this.node(),i).on.on(t):this.each(function(t,e,i){var n,s,r=function(t){return(t+"").trim().split(/^|\s+/).every(function(t){var e=t.indexOf(".");return e>=0&&(t=t.slice(0,e)),!t||"start"===t})}(e)?Ui:Fi;return function(){var o=r(this,t),a=o.on;a!==n&&(s=(n=a).copy()).on(e,i),o.on=s}}(i,t,e))},attr:function(t,e){var i=K(t),n="transform"===i?mi:Hi;return this.attrTween(t,"function"==typeof e?(i.local?Yi:$i)(i,n,Bi(this,"attr."+t,e)):null==e?(i.local?Gi:zi)(i):(i.local?Ji:Ki)(i,n,e))},attrTween:function(t,e){var i="attr."+t;if(arguments.length<2)return(i=this.tween(i))&&i._value;if(null==e)return this.tween(i,null);if("function"!=typeof e)throw new Error;var n=K(t);return this.tween(i,(n.local?ji:Xi)(n,e))},style:function(t,e,i){var n="transform"==(t+="")?pi:Hi;return null==e?this.styleTween(t,function(t,e){var i,n,s;return function(){var r=Ct(this,t),o=(this.style.removeProperty(t),Ct(this,t));return r===o?null:r===i&&o===n?s:s=e(i=r,n=o)}}(t,n)).on("end.style."+t,nn(t)):"function"==typeof e?this.styleTween(t,function(t,e,i){var n,s,r;return function(){var o=Ct(this,t),a=i(this),l=a+"";return null==a&&(this.style.removeProperty(t),l=a=Ct(this,t)),o===l?null:o===n&&l===s?r:(s=l,r=e(n=o,a))}}(t,n,Bi(this,"style."+t,e))).each(function(t,e){var i,n,s,r,o="style."+e,a="end."+o;return function(){var l=Fi(this,t),h=l.on,c=null==l.value[o]?r||(r=nn(e)):void 0;h===i&&s===c||(n=(i=h).copy()).on(a,s=c),l.on=n}}(this._id,t)):this.styleTween(t,function(t,e,i){var n,s,r=i+"";return function(){var o=Ct(this,t);return o===r?null:o===n?s:s=e(n=o,i)}}(t,n,e),i).on("end.style."+t,null)},styleTween:function(t,e,i){var n="style."+(t+="");if(arguments.length<2)return(n=this.tween(n))&&n._value;if(null==e)return this.tween(n,null);if("function"!=typeof e)throw new Error;return this.tween(n,function(t,e,i){var n,s;function r(){var r=e.apply(this,arguments);return r!==s&&(n=(s=r)&&function(t,e,i){return function(n){this.style.setProperty(t,e.call(this,n),i)}}(t,r,i)),n}return r._value=e,r}(t,e,null==i?"":i))},text:function(t){return this.tween("text","function"==typeof t?function(t){return function(){var e=t(this);this.textContent=null==e?"":e}}(Bi(this,"text",t)):function(t){return function(){this.textContent=t}}(null==t?"":t+""))},textTween:function(t){var e="text";if(arguments.length<1)return(e=this.tween(e))&&e._value;if(null==t)return this.tween(e,null);if("function"!=typeof t)throw new Error;return this.tween(e,function(t){var e,i;function n(){var n=t.apply(this,arguments);return n!==i&&(e=(i=n)&&function(t){return function(e){this.textContent=t.call(this,e)}}(n)),e}return n._value=t,n}(t))},remove:function(){return this.on("end.remove",function(t){return function(){var e=this.parentNode;for(var i in this.__transition)if(+i!==t)return;e&&e.removeChild(this)}}(this._id))},tween:function(t,e){var i=this._id;if(t+="",arguments.length<2){for(var n,s=Li(this.node(),i).tween,r=0,o=s.length;r<o;++r)if((n=s[r]).name===t)return n.value;return null}return this.each((null==e?Wi:Ni)(i,t,e))},delay:function(t){var e=this._id;return arguments.length?this.each(("function"==typeof t?qi:Zi)(e,t)):Li(this.node(),e).delay},duration:function(t){var e=this._id;return arguments.length?this.each(("function"==typeof t?Qi:tn)(e,t)):Li(this.node(),e).duration},ease:function(t){var e=this._id;return arguments.length?this.each(function(t,e){if("function"!=typeof e)throw new Error;return function(){Fi(this,t).ease=e}}(e,t)):Li(this.node(),e).ease},easeVarying:function(t){if("function"!=typeof t)throw new Error;return this.each(function(t,e){return function(){var i=e.apply(this,arguments);if("function"!=typeof i)throw new Error;Fi(this,t).ease=i}}(this._id,t))},end:function(){var t,e,i=this,n=i._id,s=i.size();return new Promise(function(r,o){var a={value:o},l={value:function(){0===--s&&r()}};i.each(function(){var i=Fi(this,n),s=i.on;s!==t&&((e=(t=s).copy())._.cancel.push(a),e._.interrupt.push(a),e._.end.push(l)),i.on=e}),0===s&&r()})},[Symbol.iterator]:an[Symbol.iterator]};var ln={time:null,delay:0,duration:250,ease:function(t){return((t*=2)<=1?t*t*t:(t-=2)*t*t+2)/2}};function hn(t,e){for(var i;!(i=t.__transition)||!(i=i[e]);)if(!(t=t.parentNode))throw new Error(`transition ${e} not found`);return i}function cn(t,e){switch(arguments.length){case 0:break;case 1:this.range(t);break;default:this.range(e).domain(t)}return this}function dn(t){return+t}te.prototype.interrupt=function(t){return this.each(function(){!function(t,e){var i,n,s,r=t.__transition,o=!0;if(r){for(s in e=null==e?null:e+"",r)(i=r[s]).name===e?(n=i.state>2&&i.state<5,i.state=6,i.timer.stop(),i.on.call(n?"interrupt":"cancel",t,t.__data__,i.index,i.group),delete r[s]):o=!1;o&&delete t.__transition}}(this,t)})},te.prototype.transition=function(t){var e,i;t instanceof rn?(e=t._id,t=t._name):(e=on(),(i=ln).time=Ti(),t=null==t?null:t+"");for(var n=this._groups,s=n.length,r=0;r<s;++r)for(var o,a=n[r],l=a.length,h=0;h<l;++h)(o=a[h])&&Vi(o,t,e,h,a,i||hn(o,e));return new rn(n,this._parents,t,e)};var un=[0,1];function gn(t){return t}function fn(t,e){return(e-=t=+t)?function(i){return(i-t)/e}:(i=isNaN(e)?NaN:.5,function(){return i});var i}function pn(t,e,i){var n=t[0],s=t[1],r=e[0],o=e[1];return s<n?(n=fn(s,n),r=i(o,r)):(n=fn(n,s),r=i(r,o)),function(t){return r(n(t))}}function mn(t,e,i){var n=Math.min(t.length,e.length)-1,s=new Array(n),r=new Array(n),o=-1;for(t[n]<t[0]&&(t=t.slice().reverse(),e=e.slice().reverse());++o<n;)s[o]=fn(t[o],t[o+1]),r[o]=i(e[o],e[o+1]);return function(e){var i=C(t,e,1,n)-1;return r[i](s[i](e))}}function vn(){var t,e,i,n,s,r,o=un,a=un,l=oi,h=gn;function c(){var t,e,i,l=Math.min(o.length,a.length);return h!==gn&&(t=o[0],e=o[l-1],t>e&&(i=t,t=e,e=i),h=function(i){return Math.max(t,Math.min(e,i))}),n=l>2?mn:pn,s=r=null,d}function d(e){return null==e||isNaN(e=+e)?i:(s||(s=n(o.map(t),a,l)))(t(h(e)))}return d.invert=function(i){return h(e((r||(r=n(a,o.map(t),ei)))(i)))},d.domain=function(t){return arguments.length?(o=Array.from(t,dn),c()):o.slice()},d.range=function(t){return arguments.length?(a=Array.from(t),c()):a.slice()},d.rangeRound=function(t){return a=Array.from(t),l=ai,c()},d.clamp=function(t){return arguments.length?(h=!!t||gn,c()):h!==gn},d.interpolate=function(t){return arguments.length?(l=t,c()):l},d.unknown=function(t){return arguments.length?(i=t,d):i},function(i,n){return t=i,e=n,c()}}const yn=new Date,Sn=new Date;function wn(t,e,i,n){function s(e){return t(e=0===arguments.length?new Date:new Date(+e)),e}return s.floor=e=>(t(e=new Date(+e)),e),s.ceil=i=>(t(i=new Date(i-1)),e(i,1),t(i),i),s.round=t=>{const e=s(t),i=s.ceil(t);return t-e<i-t?e:i},s.offset=(t,i)=>(e(t=new Date(+t),null==i?1:Math.floor(i)),t),s.range=(i,n,r)=>{const o=[];if(i=s.ceil(i),r=null==r?1:Math.floor(r),!(i<n&&r>0))return o;let a;do{o.push(a=new Date(+i)),e(i,r),t(i)}while(a<i&&i<n);return o},s.filter=i=>wn(e=>{if(e>=e)for(;t(e),!i(e);)e.setTime(e-1)},(t,n)=>{if(t>=t)if(n<0)for(;++n<=0;)for(;e(t,-1),!i(t););else for(;--n>=0;)for(;e(t,1),!i(t););}),i&&(s.count=(e,n)=>(yn.setTime(+e),Sn.setTime(+n),t(yn),t(Sn),Math.floor(i(yn,Sn))),s.every=t=>(t=Math.floor(t),isFinite(t)&&t>0?t>1?s.filter(n?e=>n(e)%t===0:e=>s.count(0,e)%t===0):s:null)),s}const En=wn(()=>{},(t,e)=>{t.setTime(+t+e)},(t,e)=>e-t);En.every=t=>(t=Math.floor(t),isFinite(t)&&t>0?t>1?wn(e=>{e.setTime(Math.floor(e/t)*t)},(e,i)=>{e.setTime(+e+i*t)},(e,i)=>(i-e)/t):En:null),En.range;const _n=1e3,Cn=6e4,Dn=36e5,Tn=864e5,bn=6048e5,Mn=2592e6,Pn=31536e6,kn=wn(t=>{t.setTime(t-t.getMilliseconds())},(t,e)=>{t.setTime(+t+e*_n)},(t,e)=>(e-t)/_n,t=>t.getUTCSeconds());kn.range;const On=wn(t=>{t.setTime(t-t.getMilliseconds()-t.getSeconds()*_n)},(t,e)=>{t.setTime(+t+e*Cn)},(t,e)=>(e-t)/Cn,t=>t.getMinutes());On.range;const xn=wn(t=>{t.setUTCSeconds(0,0)},(t,e)=>{t.setTime(+t+e*Cn)},(t,e)=>(e-t)/Cn,t=>t.getUTCMinutes());xn.range;const An=wn(t=>{t.setTime(t-t.getMilliseconds()-t.getSeconds()*_n-t.getMinutes()*Cn)},(t,e)=>{t.setTime(+t+e*Dn)},(t,e)=>(e-t)/Dn,t=>t.getHours());An.range;const In=wn(t=>{t.setUTCMinutes(0,0,0)},(t,e)=>{t.setTime(+t+e*Dn)},(t,e)=>(e-t)/Dn,t=>t.getUTCHours());In.range;const Rn=wn(t=>t.setHours(0,0,0,0),(t,e)=>t.setDate(t.getDate()+e),(t,e)=>(e-t-(e.getTimezoneOffset()-t.getTimezoneOffset())*Cn)/Tn,t=>t.getDate()-1);Rn.range;const Vn=wn(t=>{t.setUTCHours(0,0,0,0)},(t,e)=>{t.setUTCDate(t.getUTCDate()+e)},(t,e)=>(e-t)/Tn,t=>t.getUTCDate()-1);Vn.range;const Un=wn(t=>{t.setUTCHours(0,0,0,0)},(t,e)=>{t.setUTCDate(t.getUTCDate()+e)},(t,e)=>(e-t)/Tn,t=>Math.floor(t/Tn));function Fn(t){return wn(e=>{e.setDate(e.getDate()-(e.getDay()+7-t)%7),e.setHours(0,0,0,0)},(t,e)=>{t.setDate(t.getDate()+7*e)},(t,e)=>(e-t-(e.getTimezoneOffset()-t.getTimezoneOffset())*Cn)/bn)}Un.range;const Ln=Fn(0),Wn=Fn(1),Nn=Fn(2),Bn=Fn(3),Hn=Fn(4),zn=Fn(5),Gn=Fn(6);function Kn(t){return wn(e=>{e.setUTCDate(e.getUTCDate()-(e.getUTCDay()+7-t)%7),e.setUTCHours(0,0,0,0)},(t,e)=>{t.setUTCDate(t.getUTCDate()+7*e)},(t,e)=>(e-t)/bn)}Ln.range,Wn.range,Nn.range,Bn.range,Hn.range,zn.range,Gn.range;const Jn=Kn(0),$n=Kn(1),Yn=Kn(2),jn=Kn(3),Xn=Kn(4),qn=Kn(5),Zn=Kn(6);Jn.range,$n.range,Yn.range,jn.range,Xn.range,qn.range,Zn.range;const Qn=wn(t=>{t.setDate(1),t.setHours(0,0,0,0)},(t,e)=>{t.setMonth(t.getMonth()+e)},(t,e)=>e.getMonth()-t.getMonth()+12*(e.getFullYear()-t.getFullYear()),t=>t.getMonth());Qn.range;const ts=wn(t=>{t.setUTCDate(1),t.setUTCHours(0,0,0,0)},(t,e)=>{t.setUTCMonth(t.getUTCMonth()+e)},(t,e)=>e.getUTCMonth()-t.getUTCMonth()+12*(e.getUTCFullYear()-t.getUTCFullYear()),t=>t.getUTCMonth());ts.range;const es=wn(t=>{t.setMonth(0,1),t.setHours(0,0,0,0)},(t,e)=>{t.setFullYear(t.getFullYear()+e)},(t,e)=>e.getFullYear()-t.getFullYear(),t=>t.getFullYear());es.every=t=>isFinite(t=Math.floor(t))&&t>0?wn(e=>{e.setFullYear(Math.floor(e.getFullYear()/t)*t),e.setMonth(0,1),e.setHours(0,0,0,0)},(e,i)=>{e.setFullYear(e.getFullYear()+i*t)}):null,es.range;const is=wn(t=>{t.setUTCMonth(0,1),t.setUTCHours(0,0,0,0)},(t,e)=>{t.setUTCFullYear(t.getUTCFullYear()+e)},(t,e)=>e.getUTCFullYear()-t.getUTCFullYear(),t=>t.getUTCFullYear());is.every=t=>isFinite(t=Math.floor(t))&&t>0?wn(e=>{e.setUTCFullYear(Math.floor(e.getUTCFullYear()/t)*t),e.setUTCMonth(0,1),e.setUTCHours(0,0,0,0)},(e,i)=>{e.setUTCFullYear(e.getUTCFullYear()+i*t)}):null,is.range;const[ns,ss]=function(t,e,i,n,s,r){const o=[[kn,1,_n],[kn,5,5e3],[kn,15,15e3],[kn,30,3e4],[r,1,Cn],[r,5,3e5],[r,15,9e5],[r,30,18e5],[s,1,Dn],[s,3,108e5],[s,6,216e5],[s,12,432e5],[n,1,Tn],[n,2,1728e5],[i,1,bn],[e,1,Mn],[e,3,7776e6],[t,1,Pn]];function a(e,i,n){const s=Math.abs(i-e)/n,r=E(([,,t])=>t).right(o,s);if(r===o.length)return t.every(k(e/Pn,i/Pn,n));if(0===r)return En.every(Math.max(k(e,i,n),1));const[a,l]=o[s/o[r-1][2]<o[r][2]/s?r-1:r];return a.every(l)}return[function(t,e,i){const n=e<t;n&&([t,e]=[e,t]);const s=i&&"function"==typeof i.range?i:a(t,e,i),r=s?s.range(t,+e+1):[];return n?r.reverse():r},a]}(es,Qn,Ln,Rn,An,On);function rs(t){if(0<=t.y&&t.y<100){var e=new Date(-1,t.m,t.d,t.H,t.M,t.S,t.L);return e.setFullYear(t.y),e}return new Date(t.y,t.m,t.d,t.H,t.M,t.S,t.L)}function os(t){if(0<=t.y&&t.y<100){var e=new Date(Date.UTC(-1,t.m,t.d,t.H,t.M,t.S,t.L));return e.setUTCFullYear(t.y),e}return new Date(Date.UTC(t.y,t.m,t.d,t.H,t.M,t.S,t.L))}function as(t,e,i){return{y:t,m:e,d:i,H:0,M:0,S:0,L:0}}var ls,hs,cs={"-":"",_:" ",0:"0"},ds=/^\s*\d+/,us=/^%/,gs=/[\\^$*+?|[\]().{}]/g;function fs(t,e,i){var n=t<0?"-":"",s=(n?-t:t)+"",r=s.length;return n+(r<i?new Array(i-r+1).join(e)+s:s)}function ps(t){return t.replace(gs,"\\$&")}function ms(t){return new RegExp("^(?:"+t.map(ps).join("|")+")","i")}function vs(t){return new Map(t.map((t,e)=>[t.toLowerCase(),e]))}function ys(t,e,i){var n=ds.exec(e.slice(i,i+1));return n?(t.w=+n[0],i+n[0].length):-1}function Ss(t,e,i){var n=ds.exec(e.slice(i,i+1));return n?(t.u=+n[0],i+n[0].length):-1}function ws(t,e,i){var n=ds.exec(e.slice(i,i+2));return n?(t.U=+n[0],i+n[0].length):-1}function Es(t,e,i){var n=ds.exec(e.slice(i,i+2));return n?(t.V=+n[0],i+n[0].length):-1}function _s(t,e,i){var n=ds.exec(e.slice(i,i+2));return n?(t.W=+n[0],i+n[0].length):-1}function Cs(t,e,i){var n=ds.exec(e.slice(i,i+4));return n?(t.y=+n[0],i+n[0].length):-1}function Ds(t,e,i){var n=ds.exec(e.slice(i,i+2));return n?(t.y=+n[0]+(+n[0]>68?1900:2e3),i+n[0].length):-1}function Ts(t,e,i){var n=/^(Z)|([+-]\d\d)(?::?(\d\d))?/.exec(e.slice(i,i+6));return n?(t.Z=n[1]?0:-(n[2]+(n[3]||"00")),i+n[0].length):-1}function bs(t,e,i){var n=ds.exec(e.slice(i,i+1));return n?(t.q=3*n[0]-3,i+n[0].length):-1}function Ms(t,e,i){var n=ds.exec(e.slice(i,i+2));return n?(t.m=n[0]-1,i+n[0].length):-1}function Ps(t,e,i){var n=ds.exec(e.slice(i,i+2));return n?(t.d=+n[0],i+n[0].length):-1}function ks(t,e,i){var n=ds.exec(e.slice(i,i+3));return n?(t.m=0,t.d=+n[0],i+n[0].length):-1}function Os(t,e,i){var n=ds.exec(e.slice(i,i+2));return n?(t.H=+n[0],i+n[0].length):-1}function xs(t,e,i){var n=ds.exec(e.slice(i,i+2));return n?(t.M=+n[0],i+n[0].length):-1}function As(t,e,i){var n=ds.exec(e.slice(i,i+2));return n?(t.S=+n[0],i+n[0].length):-1}function Is(t,e,i){var n=ds.exec(e.slice(i,i+3));return n?(t.L=+n[0],i+n[0].length):-1}function Rs(t,e,i){var n=ds.exec(e.slice(i,i+6));return n?(t.L=Math.floor(n[0]/1e3),i+n[0].length):-1}function Vs(t,e,i){var n=us.exec(e.slice(i,i+1));return n?i+n[0].length:-1}function Us(t,e,i){var n=ds.exec(e.slice(i));return n?(t.Q=+n[0],i+n[0].length):-1}function Fs(t,e,i){var n=ds.exec(e.slice(i));return n?(t.s=+n[0],i+n[0].length):-1}function Ls(t,e){return fs(t.getDate(),e,2)}function Ws(t,e){return fs(t.getHours(),e,2)}function Ns(t,e){return fs(t.getHours()%12||12,e,2)}function Bs(t,e){return fs(1+Rn.count(es(t),t),e,3)}function Hs(t,e){return fs(t.getMilliseconds(),e,3)}function zs(t,e){return Hs(t,e)+"000"}function Gs(t,e){return fs(t.getMonth()+1,e,2)}function Ks(t,e){return fs(t.getMinutes(),e,2)}function Js(t,e){return fs(t.getSeconds(),e,2)}function $s(t){var e=t.getDay();return 0===e?7:e}function Ys(t,e){return fs(Ln.count(es(t)-1,t),e,2)}function js(t){var e=t.getDay();return e>=4||0===e?Hn(t):Hn.ceil(t)}function Xs(t,e){return t=js(t),fs(Hn.count(es(t),t)+(4===es(t).getDay()),e,2)}function qs(t){return t.getDay()}function Zs(t,e){return fs(Wn.count(es(t)-1,t),e,2)}function Qs(t,e){return fs(t.getFullYear()%100,e,2)}function tr(t,e){return fs((t=js(t)).getFullYear()%100,e,2)}function er(t,e){return fs(t.getFullYear()%1e4,e,4)}function ir(t,e){var i=t.getDay();return fs((t=i>=4||0===i?Hn(t):Hn.ceil(t)).getFullYear()%1e4,e,4)}function nr(t){var e=t.getTimezoneOffset();return(e>0?"-":(e*=-1,"+"))+fs(e/60|0,"0",2)+fs(e%60,"0",2)}function sr(t,e){return fs(t.getUTCDate(),e,2)}function rr(t,e){return fs(t.getUTCHours(),e,2)}function or(t,e){return fs(t.getUTCHours()%12||12,e,2)}function ar(t,e){return fs(1+Vn.count(is(t),t),e,3)}function lr(t,e){return fs(t.getUTCMilliseconds(),e,3)}function hr(t,e){return lr(t,e)+"000"}function cr(t,e){return fs(t.getUTCMonth()+1,e,2)}function dr(t,e){return fs(t.getUTCMinutes(),e,2)}function ur(t,e){return fs(t.getUTCSeconds(),e,2)}function gr(t){var e=t.getUTCDay();return 0===e?7:e}function fr(t,e){return fs(Jn.count(is(t)-1,t),e,2)}function pr(t){var e=t.getUTCDay();return e>=4||0===e?Xn(t):Xn.ceil(t)}function mr(t,e){return t=pr(t),fs(Xn.count(is(t),t)+(4===is(t).getUTCDay()),e,2)}function vr(t){return t.getUTCDay()}function yr(t,e){return fs($n.count(is(t)-1,t),e,2)}function Sr(t,e){return fs(t.getUTCFullYear()%100,e,2)}function wr(t,e){return fs((t=pr(t)).getUTCFullYear()%100,e,2)}function Er(t,e){return fs(t.getUTCFullYear()%1e4,e,4)}function _r(t,e){var i=t.getUTCDay();return fs((t=i>=4||0===i?Xn(t):Xn.ceil(t)).getUTCFullYear()%1e4,e,4)}function Cr(){return"+0000"}function Dr(){return"%"}function Tr(t){return+t}function br(t){return Math.floor(+t/1e3)}function Mr(t){return new Date(t)}function Pr(t){return t instanceof Date?+t:+new Date(+t)}function kr(t,e,i,n,s,r,o,a,l,h){var c=vn()(gn,gn),d=c.invert,u=c.domain,g=h(".%L"),f=h(":%S"),p=h("%I:%M"),m=h("%I %p"),v=h("%a %d"),y=h("%b %d"),S=h("%B"),w=h("%Y");function E(t){return(l(t)<t?g:a(t)<t?f:o(t)<t?p:r(t)<t?m:n(t)<t?s(t)<t?v:y:i(t)<t?S:w)(t)}return c.invert=function(t){return new Date(d(t))},c.domain=function(t){return arguments.length?u(Array.from(t,Pr)):u().map(Mr)},c.ticks=function(e){var i=u();return t(i[0],i[i.length-1],null==e?10:e)},c.tickFormat=function(t,e){return null==e?E:h(e)},c.nice=function(t){var i=u();return t&&"function"==typeof t.range||(t=e(i[0],i[i.length-1],null==t?10:t)),t?u(function(t,e){var i,n=0,s=(t=t.slice()).length-1,r=t[n],o=t[s];return o<r&&(i=n,n=s,s=i,i=r,r=o,o=i),t[n]=e.floor(r),t[s]=e.ceil(o),t}(i,t)):c},c.copy=function(){return d=c,kr(t,e,i,n,s,r,o,a,l,h).domain(d.domain()).range(d.range()).interpolate(d.interpolate()).clamp(d.clamp()).unknown(d.unknown());var d},c}function Or(t,e,i){this.k=t,this.x=e,this.y=i}ls=function(t){var e=t.dateTime,i=t.date,n=t.time,s=t.periods,r=t.days,o=t.shortDays,a=t.months,l=t.shortMonths,h=ms(s),c=vs(s),d=ms(r),u=vs(r),g=ms(o),f=vs(o),p=ms(a),m=vs(a),v=ms(l),y=vs(l),S={a:function(t){return o[t.getDay()]},A:function(t){return r[t.getDay()]},b:function(t){return l[t.getMonth()]},B:function(t){return a[t.getMonth()]},c:null,d:Ls,e:Ls,f:zs,g:tr,G:ir,H:Ws,I:Ns,j:Bs,L:Hs,m:Gs,M:Ks,p:function(t){return s[+(t.getHours()>=12)]},q:function(t){return 1+~~(t.getMonth()/3)},Q:Tr,s:br,S:Js,u:$s,U:Ys,V:Xs,w:qs,W:Zs,x:null,X:null,y:Qs,Y:er,Z:nr,"%":Dr},w={a:function(t){return o[t.getUTCDay()]},A:function(t){return r[t.getUTCDay()]},b:function(t){return l[t.getUTCMonth()]},B:function(t){return a[t.getUTCMonth()]},c:null,d:sr,e:sr,f:hr,g:wr,G:_r,H:rr,I:or,j:ar,L:lr,m:cr,M:dr,p:function(t){return s[+(t.getUTCHours()>=12)]},q:function(t){return 1+~~(t.getUTCMonth()/3)},Q:Tr,s:br,S:ur,u:gr,U:fr,V:mr,w:vr,W:yr,x:null,X:null,y:Sr,Y:Er,Z:Cr,"%":Dr},E={a:function(t,e,i){var n=g.exec(e.slice(i));return n?(t.w=f.get(n[0].toLowerCase()),i+n[0].length):-1},A:function(t,e,i){var n=d.exec(e.slice(i));return n?(t.w=u.get(n[0].toLowerCase()),i+n[0].length):-1},b:function(t,e,i){var n=v.exec(e.slice(i));return n?(t.m=y.get(n[0].toLowerCase()),i+n[0].length):-1},B:function(t,e,i){var n=p.exec(e.slice(i));return n?(t.m=m.get(n[0].toLowerCase()),i+n[0].length):-1},c:function(t,i,n){return D(t,e,i,n)},d:Ps,e:Ps,f:Rs,g:Ds,G:Cs,H:Os,I:Os,j:ks,L:Is,m:Ms,M:xs,p:function(t,e,i){var n=h.exec(e.slice(i));return n?(t.p=c.get(n[0].toLowerCase()),i+n[0].length):-1},q:bs,Q:Us,s:Fs,S:As,u:Ss,U:ws,V:Es,w:ys,W:_s,x:function(t,e,n){return D(t,i,e,n)},X:function(t,e,i){return D(t,n,e,i)},y:Ds,Y:Cs,Z:Ts,"%":Vs};function _(t,e){return function(i){var n,s,r,o=[],a=-1,l=0,h=t.length;for(i instanceof Date||(i=new Date(+i));++a<h;)37===t.charCodeAt(a)&&(o.push(t.slice(l,a)),null!=(s=cs[n=t.charAt(++a)])?n=t.charAt(++a):s="e"===n?" ":"0",(r=e[n])&&(n=r(i,s)),o.push(n),l=a+1);return o.push(t.slice(l,a)),o.join("")}}function C(t,e){return function(i){var n,s,r=as(1900,void 0,1);if(D(r,t,i+="",0)!=i.length)return null;if("Q"in r)return new Date(r.Q);if("s"in r)return new Date(1e3*r.s+("L"in r?r.L:0));if(e&&!("Z"in r)&&(r.Z=0),"p"in r&&(r.H=r.H%12+12*r.p),void 0===r.m&&(r.m="q"in r?r.q:0),"V"in r){if(r.V<1||r.V>53)return null;"w"in r||(r.w=1),"Z"in r?(s=(n=os(as(r.y,0,1))).getUTCDay(),n=s>4||0===s?$n.ceil(n):$n(n),n=Vn.offset(n,7*(r.V-1)),r.y=n.getUTCFullYear(),r.m=n.getUTCMonth(),r.d=n.getUTCDate()+(r.w+6)%7):(s=(n=rs(as(r.y,0,1))).getDay(),n=s>4||0===s?Wn.ceil(n):Wn(n),n=Rn.offset(n,7*(r.V-1)),r.y=n.getFullYear(),r.m=n.getMonth(),r.d=n.getDate()+(r.w+6)%7)}else("W"in r||"U"in r)&&("w"in r||(r.w="u"in r?r.u%7:"W"in r?1:0),s="Z"in r?os(as(r.y,0,1)).getUTCDay():rs(as(r.y,0,1)).getDay(),r.m=0,r.d="W"in r?(r.w+6)%7+7*r.W-(s+5)%7:r.w+7*r.U-(s+6)%7);return"Z"in r?(r.H+=r.Z/100|0,r.M+=r.Z%100,os(r)):rs(r)}}function D(t,e,i,n){for(var s,r,o=0,a=e.length,l=i.length;o<a;){if(n>=l)return-1;if(37===(s=e.charCodeAt(o++))){if(s=e.charAt(o++),!(r=E[s in cs?e.charAt(o++):s])||(n=r(t,i,n))<0)return-1}else if(s!=i.charCodeAt(n++))return-1}return n}return S.x=_(i,S),S.X=_(n,S),S.c=_(e,S),w.x=_(i,w),w.X=_(n,w),w.c=_(e,w),{format:function(t){var e=_(t+="",S);return e.toString=function(){return t},e},parse:function(t){var e=C(t+="",!1);return e.toString=function(){return t},e},utcFormat:function(t){var e=_(t+="",w);return e.toString=function(){return t},e},utcParse:function(t){var e=C(t+="",!0);return e.toString=function(){return t},e}}}({dateTime:"%x, %X",date:"%-m/%-d/%Y",time:"%-I:%M:%S %p",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]}),hs=ls.format,ls.parse,ls.utcFormat,ls.utcParse,Or.prototype={constructor:Or,scale:function(t){return 1===t?this:new Or(this.k*t,this.x,this.y)},translate:function(t,e){return 0===t&0===e?this:new Or(this.k,this.x+this.k*t,this.y+this.k*e)},apply:function(t){return[t[0]*this.k+this.x,t[1]*this.k+this.y]},applyX:function(t){return t*this.k+this.x},applyY:function(t){return t*this.k+this.y},invert:function(t){return[(t[0]-this.x)/this.k,(t[1]-this.y)/this.k]},invertX:function(t){return(t-this.x)/this.k},invertY:function(t){return(t-this.y)/this.k},rescaleX:function(t){return t.copy().domain(t.range().map(this.invertX,this).map(t.invert,t))},rescaleY:function(t){return t.copy().domain(t.range().map(this.invertY,this).map(t.invert,t))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}},Or.prototype;class xr extends EventTarget{constructor(t,e){super();const i={name:"",width:1280,height:80,marginTop:17,baseMinutes:600,minZoom:2,maxZoom:26,initialTime:new Date,motionEvents:[],motionEventsAll:[],timeFormat:"%Y-%m-%d %H:%M:%S.%L",axisTimeFormat:"%H:%M:%S",backgroundColor:"#343434"};this.options={...i,...e},this.currentTime=new Date(this.options.initialTime),this.zoom=12,this.mainStep=5,this.minorStep=1,this.isPlaying=!1,this.isDragging=!1,this.draging=!1,this.dragStartX=0,this.dragStartTime=0,this.initialDistance=null,this.lastTouchTime=0,this.motionBars=[],this.motionBarsAll=[],this.timer=null,this._initSVG(t),this._initTimelineComponents("minorUseMinute"),this._createMotionBars(),this._setupEventListeners(),this.updateTimelineView()}_initSVG(t){const e=t.slice(1),i=document.getElementById(e).parentElement;this.options.width=i.offsetWidth,this.options.height=i.offsetHeight,this.svg=ee(t).attr("width","100%").attr("height",this.options.height).style("user-select","none")}_initTimelineComponents(t){this.svg.selectAll("*").remove(),this.timelineGroup=this.svg.append("g").attr("transform",`translate(0, ${this.options.marginTop})`),this.timelineGroup.append("rect").attr("x",0).attr("y",0).attr("width","100%").attr("height",this.options.height-this.options.marginTop).attr("fill",this.options.backgroundColor),this.x=function(){return cn.apply(kr(ns,ss,es,Qn,Ln,Rn,An,On,kn,hs).domain([new Date(2e3,0,1),new Date(2e3,0,2)]),arguments)}().range([0,this.options.width]),this.xAxis="minorUseHour"===t?F(this.x).ticks(An.every(this.mainStep)).tickSize(12).tickPadding(4).tickFormat(hs(this.options.axisTimeFormat)):F(this.x).ticks(On.every(this.mainStep)).tickSize(12).tickPadding(4).tickFormat(hs(this.options.axisTimeFormat)),this.xAxisMinor="minorUseMinute"===t||"minorUseHour"===t?F(this.x).ticks(On.every(this.minorStep)).tickSize(6).tickFormat(""):F(this.x).ticks(kn.every(this.minorStep)).tickSize(6).tickFormat(""),this.timelineGroup.append("g").attr("class","x axis").style("path","display: none"),this.timelineGroup.append("g").attr("class","x axis minor").style("path","display: none"),this.motionBarsContainer=this.timelineGroup.append("g").attr("class","motion-bars-container"),this.centerX=this.options.width/2,this.centerPointer=this.svg.append("g").attr("class","center-pointer"),this.centerPointer.append("line").attr("x1",this.centerX).attr("x2",this.centerX).attr("y1",0).attr("y2",this.options.height-this.options.marginTop).attr("transform",`translate(0, ${this.options.marginTop})`),this._initEventBarName(),this._initTimeLabel()}_initTimeLabel(){this.timeLabel=this.svg.append("g").attr("class","label"),this.timeLabel.append("rect").attr("x",this.centerX-85).attr("y",this.options.marginTop-17).attr("width",170).attr("height",17).attr("fill","transparent"),this.labelText=this.timeLabel.append("text").attr("x",this.centerX).attr("y",this.options.marginTop-5).attr("text-anchor","middle").attr("dominant-baseline","middle").attr("fill","#fff")}_initEventBarName(){this.svg.selectAll("g.bar-name").remove(),this.EventBarName=this.svg.append("g").attr("class","bar-name"),this.options.singleEvent?(this.EventBarName.append("rect").attr("x",10).attr("y",77).attr("height",10),this.EventBarText=this.EventBarName.append("text").attr("x",10).attr("y",77).attr("text-anchor","small").attr("fill","#fff")):(this.EventBarName.append("rect").attr("x",10).attr("y",59).attr("height",10),this.EventBarText=this.EventBarName.append("text").attr("x",10).attr("y",59).attr("text-anchor","small").attr("fill","#fff")),this.EventBarText.text(this.options.name),this.options.singleEvent||(this.AllEventBarName=this.svg.append("g").attr("class","bar-name"),this.AllEventBarName.append("rect").attr("x",10).attr("y",77).attr("height",10),this.AllEventBarText=this.AllEventBarName.append("text").attr("x",10).attr("y",77).attr("text-anchor","small").attr("fill","#fff"),""==this.options.name?this.EventBarText.text(""):this.AllEventBarText.text("All"))}_createMotionBars(){this.motionBarsContainer.selectAll("*").remove(),this.motionBars=[],this.motionBarsAll=[],this.options.motionEvents.forEach((t,e)=>{if(t.type&&Array.isArray(t.type)&&t.type.length>0){const e=["H5_STOR_REC_ALERT","H5_STOR_REC_A_MOTION","H5_STOR_REC_A_OBJECT","H5_STOR_REC_N_MANUAL","H5_STOR_REC_N_SCHED"];switch(t.type.find(t=>e.includes(t))){case"H5_STOR_REC_ALERT":case"H5_STOR_REC_A_MOTION":case"H5_STOR_REC_A_OBJECT":t.color="#ee1011";break;case"H5_STOR_REC_N_MANUAL":t.color="#3cc43c";break;case"H5_STOR_REC_N_SCHED":t.color="#2188E2"}}const i=this.motionBarsContainer.append("g").attr("class","motion-event-group");let n;n=this.options.singleEvent?i.append("rect").attr("class",t.className||"").attr("y",50).attr("height",12).attr("fill",t.color||"#2188E2"):i.append("rect").attr("class",t.className||"").attr("y",32).attr("height",12).attr("fill",t.color||"#2188E2"),this.motionBars.push({element:n,group:i,start:t.start,end:t.end})}),this.options.singleEvent||this.options.motionEventsAll.forEach(t=>{const e=this.motionBarsContainer.append("g").attr("class","motion-event-group-all"),i=e.append("rect").attr("class",t.className||"").attr("y",50).attr("height",12).attr("fill",t.color||"#2188E2");this.motionBarsAll.push({element:i,group:e,start:t.start,end:t.end})})}updateTimelineView(t){try{t&&(this.currentTime=t),this.currentTime instanceof Date&&!isNaN(this.currentTime.getTime())||(this.currentTime=new Date,console.warn("重置无效的currentTime"));const e=60*this.options.baseMinutes*1e3/Math.max(1,this.zoom)/2,i=new Date(this.currentTime.getTime()-e),n=new Date(this.currentTime.getTime()+e);this.x.domain([i,n]),this.timelineGroup.select(".x.axis").call(this.xAxis),this.timelineGroup.select(".x.axis.minor").call(this.xAxisMinor),this.motionBars.forEach((t,e)=>{try{const i=t.start,n=t.end;if(isNaN(i.getTime())||isNaN(n.getTime()))return console.error("无效的事件时间:",t),void t.element.attr("width",0);let s=this.x(i),r=this.x(n);if(e>0){const t=this.motionBars[e-1];i.getTime()-t.end.getTime()<=1e3&&(s=this.x(new Date(t.end))-1)}const o=Math.max(0,r-s);t.element.attr("x",isNaN(s)?0:s).attr("width",isNaN(o)?0:o)}catch(e){console.error("更新运动事件条出错:",e),t.element.attr("width",0)}}),this.options.singleEvent||this.motionBarsAll.forEach((t,e)=>{try{const i=t.start,n=t.end;if(isNaN(i.getTime())||isNaN(n.getTime()))return console.error("无效运动时间",t),void t.element.attr("width",0);let s=this.x(i),r=this.x(n);if(e>0){const t=this.motionBarsAll[e-1];i.getTime()-t.end.getTime()<=1e3&&(s=this.x(new Date(t.end))-1)}const o=Math.max(0,r-s);t.element.attr("x",isNaN(s)?0:s).attr("width",isNaN(o)?0:o)}catch(e){console.error("更新所有回放运动事件条出错",e),t.element.attr("width",0)}}),this.labelText.text(hs(this.options.timeFormat)(this.currentTime))}catch(t){console.error("更新时间轴视图出错:",t)}}updateBackgroundColor(t){this.options.backgroundColor=t,this.timelineGroup.select("rect").attr("fill",t)}clearMotionBars(){this.options.motionEvents=[],this.options.motionEventsAll=[],this.motionBarsContainer.selectAll("*").remove(),this.svg.selectAll("g.bar-name").remove(),this.motionBars=[],this.motionBarsAll=[],this.destroyTimer()}_startDrag(t){this.isDragging=!0,this.dragStartX=t,this.dragStartTime=this.currentTime.getTime(),this.svg.style("cursor","grabbing"),this.dispatchEvent(new CustomEvent("pause",{})),this.draging=!0}_handleDrag(t){if(!this.isDragging)return;const e=t-this.dragStartX,i=60*this.options.baseMinutes*1e3/this.zoom/this.options.width;this.currentTime=new Date(this.dragStartTime-e*i),this.updateTimelineView(),this.dispatchEvent(new CustomEvent("change",{detail:this.currentTime}))}_endDrag(){this.isDragging=!1,this.svg.style("cursor","grab"),this.draging&&(this.dispatchEvent(new CustomEvent("resume",{detail:this.currentTime})),this.draging=!1)}_handleZoom(t){t>1.02?this.zoom=Math.min(this.options.maxZoom,this.zoom+.05):t<.98&&(this.zoom=Math.max(this.options.minZoom,this.zoom-.05)),this.updateTimelineView()}_handleWheel(t){let e;if(e=t<0?this.zoom+1:this.zoom-1,!(e>this.options.maxZoom||e<this.options.minZoom)){if(this.zoom=e,this.zoom>=16)this.options.baseMinutes=160,this.mainStep=1,this.minorStep=10,this._initTimelineComponents();else if(this.zoom>=12)this.options.baseMinutes=600,this.mainStep=5,this.minorStep=1,this._initTimelineComponents("minorUseMinute");else if(this.zoom>=8)this.options.baseMinutes=1e3,this.mainStep=10,this.minorStep=2,this._initTimelineComponents("minorUseMinute");else if(this.zoom>=6)this.options.baseMinutes=2e3,this.mainStep=30,this.minorStep=6,this._initTimelineComponents("minorUseMinute");else if(this.zoom>=4)this.options.baseMinutes=2400,this.mainStep=60,this.minorStep=10,this._initTimelineComponents("minorUseMinute");else{if(!(this.zoom>=2))return;this.options.baseMinutes=2900,this.mainStep=2,this.minorStep=20,this._initTimelineComponents("minorUseHour")}this._createMotionBars(),this.updateTimelineView()}}_setupEventListeners(){this.svg.on("mousedown",t=>{Date.now()-this.lastTouchTime<300||this._startDrag(ie(t)[0])}),this.svg.on("mousemove",t=>{this._handleDrag(ie(t)[0])}),this.svg.on("mouseup",()=>this._endDrag()),this.svg.on("mouseleave",()=>this._endDrag()),this.svg.on("wheel",t=>{t.preventDefault(),this._handleWheel(t.deltaY)}),this.svg.on("dblclick",t=>{t.preventDefault(),this.zoom=1,this.updateTimelineView()})}setCurrentTime(t){this.isDragging||(this.currentTime=new Date(t),this.updateTimelineView())}updateMotionEvents(t,e){t&&(this.options.motionEvents=t.map(t=>({...t,start:new Date(t.strStartTime),end:new Date(t.strEndTime)}))),e&&e.length>0&&(this.options.motionEventsAll=e.map(t=>({...t,start:new Date(t.strStartTime),end:new Date(t.strEndTime)}))),this._createMotionBars(),this.updateTimelineView()}_initTimer(){console.log("[Timeline] Init Timer"),this.timer=setInterval(()=>{this.dispatchEvent(new CustomEvent("updateEventBar",{detail:this.currentTime}))},1e4)}destroyTimer(){console.log("[Timeline] Destory Timer"),clearInterval(this.timer),this.timer=null}}class Ar extends EventTarget{constructor(t,e){super();this.containerId=t,this.container=document.getElementById(t),this.conf={videoid:"",protocol:"http:",host:"127.0.0.1:8085",token:"",name:"",session:"",accessToken:"",hlsver:"v1",rootpath:"/",streamprofile:"main",consolelog:"false",buffersize:300,h264cpumode:"false",liveVideoType:"WS",onPlaybackModeChange:function(){},onError:function(){},...e},this.isLivePlayer=!0,this.currentPosition=-1,this.player=null,this.segmentPlayer=null,this.livePlayer=null,this.playing=!1,this.liveVideo=null,this.playbackDom=null,this.conf.updateMainVideo=this.updateMainVideo.bind(this),this.conf.updateTimeline=this.updateTimeline.bind(this),this.conf.updateMetadata=this.updateMetadata.bind(this),this.conf.setPlaying=this.setPlaying.bind(this),this.initPlayers()}updateTimeline(t){this.currentPosition=t,this.dispatchEvent(new CustomEvent("updateTimeline",{detail:{time:t,containerId:this.containerId,livePlayer:!1}}))}updateMetadata(t){this.dispatchEvent(new CustomEvent("updateMetadata",{detail:{data:t}}))}initPlayers(){this.createVideoElement(),this.createPlaybackElement(),this.showLivePlayer()}initLivePlayer(){switch(console.log("this.livePlayer",this.livePlayer),this.livePlayer&&(this.livePlayer.disconnect(),this.livePlayer=null),this.conf.liveVideoType){case"RTC":this.livePlayer=new h(this.conf);break;case"WS2":this.livePlayer=new s.H5sPlayerWS2(this.conf);break;default:this.livePlayer=new l(this.conf)}}liveTimeupdate(){this.livePlayer&&this.dispatchEvent(new CustomEvent("updateTimeline",{detail:{time:(new Date).getTime(),containerId:this.containerId,livePlayer:!0}}))}createVideoElement(){const t=document.createElement("video");t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.top="0",t.style.left="0",t.style.display="block",t.id=this.conf.videoid,t.controls=!1,t.muted=!0,t.autoplay=!0,this.container.appendChild(t),this.liveVideo=t,this.liveVideo.addEventListener("timeupdate",this.liveTimeupdate.bind(this))}createPlaybackElement(){const t=document.createElement("div");t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.top="0",t.style.left="0",t.style.display="block",t.id="playback"+this.conf.videoid,this.container.appendChild(t),this.playbackDom=t}showLivePlayer(){this.segmentPlayer&&(this.playbackDom.style.display="none",this.segmentPlayer.close(),this.segmentPlayer.destroy(),this.segmentPlayer=null),this.liveVideo&&(this.liveVideo.style.display="block"),this.isLivePlayer=!0,this.initLivePlayer(),this.conf.onPlaybackModeChange("live")}showPlaybackPlayer(){this.livePlayer&&(this.livePlayer.disconnect(),this.livePlayer=null),this.playbackDom.style.display="block",this.segmentPlayer=new t(this.playbackDom,this.conf),this.segmentPlayer.setMainVideo(this.mainVideo),this.isLivePlayer=!1,this.liveVideo&&(this.liveVideo.style.display="none"),this.conf.onPlaybackModeChange("playback")}async setPosition(t){const e="number"==typeof t?t:new Date(t).getTime();e>=Date.now()-5e3?this.isLivePlayer||this.showLivePlayer():(this.isLivePlayer&&this.showPlaybackPlayer(),this.segmentPlayer&&(await this.segmentPlayer.setPosition(t),this.currentPosition=e))}getPosition(){return this.isLivePlayer?Date.now():this.segmentPlayer.getCurrentTime()}play(){this.isLivePlayer?this.livePlayer&&!this.playing&&(setTimeout(()=>{this.livePlayer.connect(),this.currentPosition=(new Date).getTime()},500),this.playing=!0):this.segmentPlayer&&(this.segmentPlayer.play(),this.playing=!0)}pause(){this.isLivePlayer||this.segmentPlayer&&(this.playing=!1,this.segmentPlayer.pause())}getPlaying(){return this.segmentPlayer.playing}setPlaying(t){this.playing=t}setPlaybackRate(t){!this.isLivePlayer&&this.segmentPlayer&&this.segmentPlayer.setPlaybackRate(t)}setTimelineCurrentTime(t){this.segmentPlayer.setTimelineCurrentTime(t)}destroy(){this.playing=!1,this.livePlayer&&(this.livePlayer.disconnect(),this.livePlayer=null),this.segmentPlayer&&this.segmentPlayer.destroy();const t=document.getElementById(this.conf.videoid);t&&t.remove();const e=document.getElementById("playback"+this.conf.videoid);e&&e.remove(),this.player=null,this.segmentPlayer=null,this.liveVideo=null,this.playbackDom=null,console.log("PlayerSDK destroyed")}getPlaybackMode(){return this.isLivePlayer?"live":"playback"}getContainerId(){return this.containerId}updateMainVideo(){this.dispatchEvent(new CustomEvent("updateMainVideo",{detail:{containerId:this.containerId}}))}setMainVideo(t){this.isLivePlayer?this.mainVideo=t:this.segmentPlayer.setMainVideo(t)}getMainVideo(){return this.segmentPlayer.getMainVideo()}async getRecordTimeBar(t,e){const i=this.conf.protocol+"//"+this.conf.host+`/api/v1/SearchStorRecordByTime?token=${this.conf.token}&start=${t}&end=${e}&maxlen=900&session=${this.conf.session}`;let n=await fetch(i);const s=await n.json();return s.bFinished?s.record:[]}}class Ir extends EventTarget{constructor(t,e){super(),this.containerElement=t,this.options=e,this.playing=!1,this.UPlayerSDKList=[],this.timeline=null,this.actionUPlayerSDK=null,this.mainSDK=null,this.motionEvents=[],this.initTimeline(),this._positionTaskId=0,this._lastSetPosition=null}async addPlayer(t){if(this.updateTimelineHandler=t=>this.updateTimeline(t.detail),this.updateMainVideoHandler=t=>this.updateMainVideo(t.detail),t.addEventListener("updateTimeline",this.updateTimelineHandler),t.addEventListener("updateMainVideo",this.updateMainVideoHandler),this.UPlayerSDKList.push(t),this.actionUPlayerSDK||(this.actionUPlayerSDK=this.UPlayerSDKList[0],this.actionUPlayerSDK.setMainVideo(!0)),this.mainSDK||this.changeMainSDK(this.UPlayerSDKList[0].conf.videoid),console.log("UPlayerSDKList =>",this.UPlayerSDKList),this.UPlayerSDKList.length>1&&null!=this.timeline.currentTime){const e=Date.now()/1e3,i=this.timeline.currentTime.getTime()/1e3;console.log("addPlayer  timeline  currentTime =>",this.timeline.currentTime,i),Math.abs(e-i)<=5?console.log("在5s范围内"):(console.log("超出5s范围"),t.setPosition(this.timeline.currentTime))}}changeMainSDK(t){const e=this.UPlayerSDKList.find(e=>e.conf.videoid===t);e&&(this.mainSDK=e,this.timeline.options.name=this.mainSDK.conf.name,this.timeline._initEventBarName(),this.getEventBar(this.timeline.currentTime))}delMainSDK(){this.mainSDK=null}getPlayer(t){return this.UPlayerSDKList[t]||null}getOutPlayer(t){const e=this.UPlayerSDKList.find(e=>e.conf.videoid==t);if(e){if(e.removeEventListener("updateTimeline",this.updateTimelineHandler),e.removeEventListener("updateMainVideo",this.updateMainVideoHandler),this.UPlayerSDKList=this.UPlayerSDKList.filter(e=>e.conf.videoid!==t),0==this.UPlayerSDKList.length)return this.actionUPlayerSDK=null,this.delMainSDK(),void this.timeline.clearMotionBars();this.actionUPlayerSDK=this.UPlayerSDKList[0],t===this.mainSDK.conf.videoid&&this.changeMainSDK(this.UPlayerSDKList[0].conf.videoid)}}removePlayer(t){if(this.UPlayerSDKList.forEach(e=>{e.conf.videoid===t&&e.destroy()}),this.UPlayerSDKList=this.UPlayerSDKList.filter(e=>e.conf.videoid!==t),0==this.UPlayerSDKList.length)return this.actionUPlayerSDK=null,this.delMainSDK(),void this.timeline.clearMotionBars();this.actionUPlayerSDK=this.UPlayerSDKList[0],t===this.mainSDK.conf.videoid&&this.changeMainSDK(this.UPlayerSDKList[0].conf.videoid)}destroyAll(){this.UPlayerSDKList.forEach(t=>t.destroy()),this.UPlayerSDKList=[],this.actionUPlayerSDK=null,this.delMainSDK(),this.timeline.clearMotionBars()}playAll(t=new Date){this.playing=!0,this.UPlayerSDKList.forEach(t=>t.play());("number"==typeof t?t:new Date(t).getTime())>=Date.now()-12e5?(this.timeline.destroyTimer(),this.timeline._initTimer(),this.getEventBar(t)):this.getEventBar(t)}pauseAll(){this.playing=!1,this.UPlayerSDKList.forEach(t=>t.pause())}setTimelineCurrentTime(t){for(let e of this.UPlayerSDKList)e.setTimelineCurrentTime(t);this.timeline.currentTime=t}async setAllPosition(t){const e=++this._positionTaskId,i=this.UPlayerSDKList.map(async e=>{const i=e.setPosition(t);return Promise.race([i,new Promise((t,e)=>setTimeout(()=>e(new Error("Timeout")),6e3))]).catch(t=>(console.warn("setPosition failed:",t),!1))}),n=Promise.all(i).then(t=>e===this._positionTaskId&&t.some(t=>!0===t));return this._lastSetPosition=n,n}async waitLastSetPosition(){if(this._lastSetPosition)try{await this._lastSetPosition;return!0}catch(t){return console.warn("waitLastSetPosition error:",t),!0}return!1}setAllPlaybackRate(t){this.UPlayerSDKList.forEach(e=>e.setPlaybackRate(t))}getPlaybackModes(){return this.UPlayerSDKList.map(t=>t.getPlaybackMode())}initTimeline(){const t={};this.options&&this.options.timelineBackgroundColor&&(t.backgroundColor=this.options.timelineBackgroundColor),this.timeline=new xr(this.containerElement,t),this.timeline.addEventListener("change",t=>{this.setAllPosition(t.detail)}),this.timeline.addEventListener("rate",t=>{this.setAllPlaybackRate(t.detail)}),this.timeline.addEventListener("resume",async t=>{try{await this.waitLastSetPosition(),console.log("最后一次 setAllPosition 已完成，开始播放"),this.playAll(t.detail)}catch(t){console.error("恢复播放失败:",t)}}),this.timeline.addEventListener("pause",()=>{this.pauseAll(),this.timeline.destroyTimer()}),this.timeline.addEventListener("timelineCurrentTime",t=>{console.log("timelineCurrentTime =>",t.detail)}),this.timeline.addEventListener("updateEventBar",t=>{console.log(t.detail),this.getEventBar(t.detail)})}updateTimeline(t){this.playing&&(t.livePlayer?this.actionUPlayerSDK&&this.actionUPlayerSDK.getContainerId()==t.containerId&&this.timeline.setCurrentTime(t.time):this.actionUPlayerSDK&&this.actionUPlayerSDK.getContainerId()==t.containerId&&(this.setTimelineCurrentTime(t.time),this.timeline.setCurrentTime(t.time)))}updateMainVideo(t){this.actionUPlayerSDK&&!this.actionUPlayerSDK.getPlaying()&&(this.actionUPlayerSDK=this.UPlayerSDKList.find(t=>t.getPlaying())),this.actionUPlayerSDK?this.actionUPlayerSDK.setMainVideo(!0):this.setActionUPlayerSDK()}async getEventBar(t=new Date){const e=this.getStartAndEndTime(t),i=[];for(const t of this.UPlayerSDKList){const n=await t.getRecordTimeBar(e.startTime,e.endTime);i.push(...n)}if(this.mainSDK){const t=await this.mainSDK.getRecordTimeBar(e.startTime,e.endTime);this.timeline.updateMotionEvents(t,i)}else this.timeline.updateMotionEvents(null,i)}getStartAndEndTime(t){const e=new Date(t),i=new Date(e);i.setHours(i.getHours()-16);const n=new Date(e);n.setHours(n.getHours()+16);const s=t=>{const e=t=>String(t).padStart(2,"0"),i=t.getFullYear(),n=e(t.getMonth()+1),s=e(t.getDate()),r=e(t.getHours()),o=e(t.getMinutes()),a=e(t.getSeconds()),l=-t.getTimezoneOffset();return`${i}-${n}-${s}T${r}:${o}:${a}+${e(Math.floor(Math.abs(l)/60))}:${e(Math.abs(l)%60)}`};return{startTime:s(i),endTime:s(n)}}setActionUPlayerSDK(){const t=this.UPlayerSDKList.reduce((t,e)=>new Date(e.segmentPlayer.currentTime)<new Date(t.segmentPlayer.currentTime)?e:t);t.setMainVideo(!0),t.play(),this.actionUPlayerSDK=t}debounce(t,e=200){let i=null,n=0;return function(...s){const r=Date.now(),o=this;if(clearTimeout(i),r-n>=e)t.apply(o,s),n=r;else{i=setTimeout(()=>{t.apply(o,s),n=Date.now()},e-(r-n))}}}}class Rr extends EventTarget{constructor(t,e={}){super(),this.padding=e.padding||20,this.aspectRatio=e.aspectRatio||[16,9],this.animationDuration=e.animationDuration||500,this.createIcons=e.createIcons||{},this.enableCache=!1!==e.enableCache,this.cacheKey=e.cacheKey||"grid-layout-cache",this.autoSave=!1!==e.autoSave,this.autoSaveDelay=e.autoSaveDelay||1e3,this.autoSaveTimer=null,this.container=ee(t),this.element=this.container.node(),this.lineSvg=this.container.append("svg").attr("class","line-matrix").style("width","100%").style("height","100%"),this.cellContainer=this.container.append("div").attr("class","cell-matrix"),this.highlighterSvg=this.container.append("svg").attr("class","cell-highlighter").style("width","100%").style("height","100%"),this.gridState={container:this.cellContainer,columnsInsertedSinceRender:0,rowsInsertedSinceRender:0,cellWidth:0,cellHeight:0,offsetLeft:0,offsetTop:0,cells:[[{rowSpan:1,columnSpan:1,initialValues:{},forceLbm:!1,dewarpMode:void 0}]]},this.lineState={container:this.lineSvg,containerSize:{width:0,height:0},firstColumnIndex:1e3,firstRowIndex:1e3,previousValues:{uninitialized:!0,cellWidth:0,cellHeight:0,offsetLeft:0,offsetTop:0},horizontal:{group:this.lineSvg.append("g").attr("orientation","horizontal"),lines:[]},vertical:{group:this.lineSvg.append("g").attr("orientation","vertical"),lines:[]}},this.playModeShow=!1,this.isResizing=!1,this.isAddingCell=!1,this.isFullScreen=!1,this.persistTimeout=null,this.eventListeners=new Map,this.initialize()}initialize(){this.enableCache&&this.loadFromCache(),this.renderGrid(),this.setupEventListeners()}saveToCache(){if(this.enableCache)try{const t=this.extractLayoutData(this.gridState.cells);localStorage.setItem(this.cacheKey,JSON.stringify(t)),console.log("布局已保存到本地缓存")}catch(t){console.error("保存布局到缓存失败:",t)}}extractLayoutData(t){return Array.isArray(t)?t.map(t=>t.map(t=>(console.log(t),t&&0!==Object.keys(t).length&&null!=t.camera?{row:t.row,column:t.column,rowSpan:t.rowSpan||1,columnSpan:t.columnSpan||1,forceLbm:t.forceLbm||!1,claimed:t.claimed||!1,camera:t.camera?{token:t.camera.token,session:t.camera.session}:null,id:t.id||null}:{}))):t}loadFromCache(){if(!this.enableCache)return!1;try{const t=localStorage.getItem(this.cacheKey);if(!t)return!1;const e=JSON.parse(t);return this.applyLayoutFromCache(e),console.log("布局已从本地缓存加载"),!0}catch(t){return console.error("从缓存加载布局失败:",t),!1}}applyLayoutFromCache(t){t&&0!=t.length&&(this.gridState.cells.forEach(t=>{t.forEach(t=>{t.claimed&&t.element&&this.closeSingleCell(t)})}),this.gridState.cells=t,this.dispatchEvent(new CustomEvent("layoutLoadedFromCache",{detail:t})))}triggerAutoSave(){this.autoSave&&this.enableCache&&(this.autoSaveTimer&&clearTimeout(this.autoSaveTimer),this.autoSaveTimer=setTimeout(()=>{this.saveToCache()},this.autoSaveDelay))}setupEventListeners(){const t=()=>{this.isResizing=!0,this.renderGrid(),this.isResizing=!1,this.broadcastResize()};window.addEventListener("resize",t),this.eventListeners.set("resize",t);const e=new ResizeObserver(()=>{this.isResizing=!0,this.renderGrid(),this.isResizing=!1,this.broadcastResize()});e.observe(this.lineSvg.node()),this.eventListeners.set("resizeObserver",e)}renderGrid(){this.lineState.containerSize={width:this.element.clientWidth,height:this.element.clientHeight};const t=this.gridState.cells[0].length,e=this.calculateCellDimensions(this.gridState.cells.length,t);this.gridState.cellWidth=e.cellWidth,this.gridState.cellHeight=e.cellHeight,this.gridState.offsetLeft=e.offsetLeft,this.gridState.offsetTop=e.offsetTop,this.gridState.cells.forEach((t,e)=>{t.forEach((t,i)=>{this.updateCell(t,e,i)})}),!0===this.lineState.previousValues.uninitialized&&(this.lineState.previousValues.uninitialized=!1,this.lineState.previousValues={cellWidth:this.gridState.cellWidth,cellHeight:this.gridState.cellHeight,offsetLeft:this.gridState.offsetLeft,offsetTop:this.gridState.offsetTop}),this.gridState.cellWidth>0&&this.gridState.cellHeight>0&&(this.updateHorizontalLines(),this.updateVerticalLines()),this.lineState.previousValues.cellWidth=this.gridState.cellWidth,this.lineState.previousValues.cellHeight=this.gridState.cellHeight,this.lineState.previousValues.offsetLeft=this.gridState.offsetLeft,this.lineState.previousValues.offsetTop=this.gridState.offsetTop,this.isResizing||setTimeout(()=>{this.hideGridLines(),this.broadcastResize()},220),this.gridState.columnsInsertedSinceRender=0,this.gridState.rowsInsertedSinceRender=0}calculateCellDimensions(t,e){const i=this.lineState.containerSize.width-2*this.padding-3*(e-1),n=this.lineState.containerSize.height-2*this.padding-3*(t-1);let s=i/e,r=n/t,o=0,a=0;return s/this.aspectRatio[0]>r/this.aspectRatio[1]?(s=r/this.aspectRatio[1]*this.aspectRatio[0],o=(i-s*e)/2):(r=s/this.aspectRatio[0]*this.aspectRatio[1],a=(n-r*t)/2),{cellWidth:s,cellHeight:r,offsetLeft:o,offsetTop:a}}updateCell(t,e,i){t.previousRow=t.row,t.previousColumn=t.column,t.row=e,t.column=i,t.left=i*this.gridState.cellWidth+3*i+this.padding+this.gridState.offsetLeft,t.top=e*this.gridState.cellHeight+3*e+this.padding+this.gridState.offsetTop,t.width=0,t.height=0,!0!==t.spannedUpon&&!0===t.claimed&&(t.width=t.columnSpan?t.columnSpan*this.gridState.cellWidth+3*(t.columnSpan-1):this.gridState.cellWidth,t.height=t.rowSpan?t.rowSpan*this.gridState.cellHeight+3*(t.rowSpan-1):this.gridState.cellHeight),this.ensureCellElement(t),!0===t.claimed&&t.initialValues&&this.applyInitialValues(t),this.applyCellStyles(t),t.element.data([{x:t.left,y:t.top}])}applyInitialValues(t){void 0!==t.initialValues.left&&t.element.style("left",t.initialValues.left+"px"),void 0!==t.initialValues.top&&t.element.style("top",t.initialValues.top+"px"),void 0!==t.initialValues.width&&t.element.style("width",t.initialValues.width+"px"),void 0!==t.initialValues.height&&t.element.style("height",t.initialValues.height+"px"),delete t.initialValues}applyCellStyles(t){const e=t.fullScreen?t.element.node().parentNode.parentNode.offsetWidth:t.width,i=t.fullScreen?t.element.node().parentNode.parentNode.offsetHeight:t.height,n=t.fullScreen?0:t.left,s=t.fullScreen?0:t.top;(this.isResizing?t.element:t.element.transition().duration(this.animationDuration)).style("width",e+"px").style("height",i+"px").style("left",n+"px").style("top",s+"px")}ensureCellElement(t){console.log("cell.element======================>",t.element),t.element||(t.element=this.gridState.container.append("div").attr("id",t.id).attr("class",t.id?"grid_cell red_border":"grid_cell").style("width",t.width+"px").style("height",t.height+"px").style("background-color","#272727").on("click",function(){if(console.log("点击容器 mousedown",t.id),!t.id)return;const e=ee(this);e.classed("active")?e.classed("active",!1):(ee(this.parentNode).selectAll(".grid_cell.active").classed("active",!1),e.classed("active",!0))}).on("mousedown",e=>{this.dispatchEvent(new CustomEvent("cellClick",{detail:t.id}))}),this.createInnerStructure(t),this.setupDragBehavior(t))}changePlayModeText(t){this.createIcons.playModeText=t,this.container.selectAll(".playMode").text(t)}createInnerStructure(t){const e=t.element.append("div").attr("class","float-layer").on("mousedown",t=>{t.preventDefault(),t.stopPropagation()}).on("mousedown",t=>{t.preventDefault(),t.stopPropagation()}).on("click",t=>{t.preventDefault(),t.stopPropagation()});t.element.append("i").attr("class","cell-i").text("⇲"),this.createIcons.playModeIcon&&(e.append("i").attr("class",this.playModeShow?"iconfont icon-shouqi":"iconfont icon-zhankai").on("click",t=>{this.playModeShow=!this.playModeShow,console.log("点击收起播放模式",this.playModeShow);ee(t.currentTarget).attr("class",this.playModeShow?"iconfont icon-shouqi":"iconfont icon-zhankai"),e.select(".playMode").style("display",this.playModeShow?null:"none")}),e.append("span").attr("class","playMode").style("display",this.playModeShow?null:"none").text(this.createIcons.playModeText)),this.createIcons.informationIcon&&e.append("i").attr("class","iconfont icon-yibiao").on("click",e=>{console.log("点击仪表"),this.dispatchEvent(new CustomEvent("Information",{detail:{id:t.id}}))}),this.createIcons.shouwhearIcon&&e.append("i").attr("class","iconfont icon-yuyinguan").on("click",e=>{console.log("点击语音"),this.dispatchEvent(new CustomEvent("Shoutwheat",{detail:{id:t.id,audio:t.audio}}))}),this.createIcons.snapshotIcon&&e.append("i").attr("class","iconfont icon-zhuapai").on("click",e=>{console.log("点击抓拍"),this.dispatchEvent(new CustomEvent("Snapshot",{detail:{id:t.id}}))}),this.createIcons.recEnableIcon&&e.append("i").attr("class",t.recEnable?"iconfont icon-fuwuluxiangzhong":"iconfont icon-fuwuluxiang").style("color",t.recEnable?"#FF0000":"").on("click",e=>{console.log("点击服务录像"),this.dispatchEvent(new CustomEvent("recEnableClick",{detail:{id:t.id,recEnable:t.recEnable}}))}),this.createIcons.ptzcontrolIcon&&e.append("i").attr("class","iconfont icon-yuntai").on("click",e=>{console.log("点击云台"),this.dispatchEvent(new CustomEvent("PtzControlShow",{detail:{id:t.id}}))}),e.append("i").attr("class","iconfont icon-fangda").on("click",e=>{console.log("点击全屏");const i=ee(e.currentTarget);this.toggleFullScreen(t),this.isFullScreen?i.classed("icon-fangda",!1).classed("icon-suoxiao",!0):i.classed("icon-suoxiao",!1).classed("icon-fangda",!0)}),e.append("i").attr("class","iconfont icon-guanbi").on("click",e=>{this.closeSingleCell(t)})}changeIcons(t){this.createIcons=t}changeRecEnable(t,e){const i=ee("#"+t).select(".float-layer").select(".icon-fuwuluxiangzhong, .icon-fuwuluxiang");e?i.classed("icon-fuwuluxiang",!1).classed("icon-fuwuluxiangzhong",!0).style("color","#FF0000"):i.classed("icon-fuwuluxiangzhong",!1).classed("icon-fuwuluxiang",!0).style("color",null),this.gridState.cells.forEach(i=>{i.forEach(i=>{i.id===t&&(console.log("changeRecEnable gridState cell => ",i),i.recEnable=e)})})}changeAudio(t,e){const i=ee("#"+t).select(".float-layer").select(".icon-yuyinkai, .icon-yuyinguan");e?i.classed("icon-yuyinguan",!1).classed("icon-yuyinkai",!0):i.classed("icon-yuyinkai",!1).classed("icon-yuyinguan",!0),this.gridState.cells.forEach(i=>{i.forEach(i=>{i.id===t&&(i.audio=e)})})}closeSingleCell(t){if(!t||!0!==t.claimed)return!1;t.fullScreen,t.element&&(t.element.remove(),t.element=null),this.releaseCellArea(t),t.claimed=!1,t.forceLbm=!1,t.dewarpMode=void 0,delete t.camera,this.dispatchEvent(new CustomEvent("closeCell",{detail:t.id})),delete t.id,t.rowSpan=1,t.columnSpan=1,t.width=this.gridState.cellWidth,t.height=this.gridState.cellHeight,this.cleanupDragState(t),this.cleanupEmptyEdges(),this.renderGrid(),setTimeout(()=>{this.broadcastResize()},this.animationDuration),this.broadcastEvent("cellClosed",{cell:t}),this.triggerAutoSave(),console.log("Cell closed successfully")}setupDragBehavior(t){if(!t.element)return;const e=ge().on("start",e=>this.handleDragStart(e,t)).on("drag",e=>this.handleDrag(e,t)).on("end",e=>this.handleDragEnd(e,t));t.element.on("click",t=>{t.target.closest("i")||t&&t.preventDefault()}).call(e)}handleDragStart(t,e){return t.sourceEvent.target.closest(".cell-close")?(t.on("drag",null),void t.on("end",null)):(e.canDrag=!this.findAncestor(t.sourceEvent.target,t=>t.classList.contains("undraggable")),(!e.canDrag||!0===e.claimed)&&(this.broadcastEvent("stageInteract"),void(e.dragState={dragged:!1,action:null,initX:null,initY:null,resizeOffsetX:null,resizeOffsetY:null,resizeDirection:null,rowOffset:0,columnOffset:0,originalWidth:null,originalHeight:null,desiredSpan:null,highlightColor:"green",movePosition:null,dragResizing:!1,dragMoving:!1,x:null,y:null})))}handleDrag(t,e){if(!0!==e.claimed)return!1;if(void 0===t.sourceEvent.clientX&&window.TouchEvent&&t.sourceEvent instanceof window.TouchEvent&&(t.sourceEvent.clientX=t.sourceEvent.changedTouches[0].clientX,t.sourceEvent.clientY=t.sourceEvent.changedTouches[0].clientY),!e.fullScreen){if(!e.dragState.dragged){if(!e.dragState.initX)return e.dragState.initX=t.sourceEvent.clientX,void(e.dragState.initY=t.sourceEvent.clientY);if(Math.abs(e.dragState.initX-t.sourceEvent.clientX)>1||Math.abs(e.dragState.initY-t.sourceEvent.clientY)>1){const i=this.element.getBoundingClientRect(),n=e.dragState.initX-e.left-i.left,s=e.dragState.initY-e.top-i.top;n>=e.width-21&&s>=e.height-21||t.sourceEvent.target.classList.contains("resize-se")?(e.dragState.resizeOffsetX=e.width-n,e.dragState.resizeOffsetY=e.height-s,e.dragState.action="resize",e.dragState.resizeDirection="se"):n>=e.width-21&&Math.abs(e.height/2-s)<16||t.sourceEvent.target.classList.contains("resize-e")?(e.dragState.resizeOffsetX=e.width-n,e.dragState.action="resize",e.dragState.resizeDirection="e"):s>=e.height-21&&Math.abs(e.width/2-n)<16||t.sourceEvent.target.classList.contains("resize-s")?(e.dragState.resizeOffsetY=e.height-s,e.dragState.action="resize",e.dragState.resizeDirection="s"):t.sourceEvent.touches&&1!==t.sourceEvent.touches.length||(e.dragState.rowOffset=e.rowSpan?Math.max(1,Math.ceil(s/(this.gridState.cellHeight+3)))-1:0,e.dragState.columnOffset=e.columnSpan?Math.max(1,Math.ceil(n/(this.gridState.cellWidth+3)))-1:0,e.dragState.action="move"),e.dragState.action&&(e.element.style("opacity",.5),this.showGridLines(),e.dragState.dragged=!0)}}"resize"===e.dragState.action?this.handleResizeDrag(t,e):"move"===e.dragState.action&&this.handleMoveDrag(t,e)}}handleResizeDrag(t,e){e.dragState.dragResizing=!0,e.dragState.originalWidth||(e.dragState.originalWidth=e.width,e.dragState.originalHeight=e.height);let i=e.dragState.originalWidth,n=e.dragState.originalHeight;const s=this.element.getBoundingClientRect();e.dragState.resizeDirection.indexOf("e")>-1&&(i=t.sourceEvent.clientX-e.left-s.left+e.dragState.resizeOffsetX),e.dragState.resizeDirection.indexOf("s")>-1&&(n=t.sourceEvent.clientY-e.top-s.top+e.dragState.resizeOffsetY),i=Math.max(100,i),n=Math.max(100,n);const r=this.findGridOrigin(),o=this.findGridPositionByCoordinates(e.left+3+s.left,e.top+3+s.top),a=this.findGridPositionByCoordinates(e.left+i+s.left,e.top+n+s.top,!0);let l=[e.columnSpan,e.rowSpan],h="green";if(a&&o&&a[0]-o[0]+1>0&&a[1]-o[1]+1>0){const t=a[0]-o[0]+1,i=a[1]-o[1]+1,n=[];let s=!0;for(let a=0;a<i;a++)for(let i=0;i<t;i++){const t=this.getDimensionsForGridPosition(i+o[0],a+o[1]);n.push(t);const l=a+o[1]-r[1],c=i+o[0]-r[0];if(this.gridState.cells[l]&&this.gridState.cells[l][c]){const t=this.gridState.cells[l][c];t.claimed&&t!==e&&t.spannedUponBy!==e&&(s=!1,h="red")}}s&&(l=[t,i]),this.highlightCells(n,h)}e.dragState.desiredSpan=l,e.element.classed("resizing",!0).style("z-index",45).style("outline","2px solid #0399FE").style("width",i+"px").style("height",n+"px"),e.dragState.currentWidth=i,e.dragState.currentHeight=n}handleMoveDrag(t,e){e.dragState.dragMoving=!0,e.dragState.highlightColor="green",e.dragState.movePosition=void 0;const i=this.getCellByCoordinates(t.sourceEvent.clientX,t.sourceEvent.clientY,e),n=[];let s;if(i)n.push({x:i.left,y:i.top,width:i.width,height:i.height});else{const i=this.element.getBoundingClientRect(),r=this.findGridPositionByCoordinates(t.sourceEvent.clientX,t.sourceEvent.clientY);if(!1!==r){const t={x:i.left,y:i.top},o={x:this.lineState.vertical.lines[0].value-this.gridState.cellWidth+t.x,y:this.lineState.horizontal.lines[0].value-this.gridState.cellHeight+t.y},a={},l={};e.rowSpan?(a.from=r[1]-e.dragState.rowOffset,a.to=r[1]-e.dragState.rowOffset+e.rowSpan-1):(a.from=r[1],a.to=r[1]),e.columnSpan?(l.from=r[0]-e.dragState.columnOffset,l.to=r[0]-e.dragState.columnOffset+e.columnSpan-1):(l.from=r[0],l.to=r[0]);const h=this.findGridOrigin();let c=!0;for(let i=a.from;i<=a.to;i++)for(let s=l.from;s<=l.to;s++){const r=this.getDimensionsForGridPosition(s,i,t,o);n.push(r);const a=i-h[1],l=s-h[0];if(this.gridState.cells[a]&&this.gridState.cells[a][l]){const t=this.gridState.cells[a][l];t.claimed&&t!==e&&t.spannedUponBy!==e&&(c=!1,e.dragState.highlightColor="red")}}c&&(s=[r[0]-h[0]-e.dragState.columnOffset,r[1]-h[1]-e.dragState.rowOffset])}}e.dragState.movePosition=s,this.highlightCells(n,e.dragState.highlightColor),e.dragState.dragged=!0,e.dragState.x=t.x,e.dragState.y=t.y,e.element.classed("dragging",!0).style("z-index",45).style("outline","2px solid #0399FE").style("top",e.dragState.y+"px").style("left",e.dragState.x+"px")}handleDragEnd(t,e){if(!0!==e.claimed||!e.dragState)return!1;void 0===t.sourceEvent.clientX&&window.TouchEvent&&t.sourceEvent instanceof window.TouchEvent&&(t.sourceEvent.clientX=t.sourceEvent.changedTouches[0].clientX,t.sourceEvent.clientY=t.sourceEvent.changedTouches[0].changedTouches[0].clientY),e.dragState.dragged&&("resize"===e.dragState.action?(this.handleResizeDragEnd(t,e),e.dragState.dragResizing=!1):"move"===e.dragState.action&&(this.handleMoveDragEnd(t,e),e.dragState.dragMoving=!1)),this.highlighterSvg.style("display",""),this.cleanupDragState(e)}handleResizeDragEnd(t,e){!e.dragState.desiredSpan||e.dragState.desiredSpan[0]===e.columnSpan&&e.dragState.desiredSpan[1]===e.rowSpan?e.element.style("opacity","").style("outline",0).transition().duration(this.animationDuration).style("width",e.width+"px").style("height",e.height+"px").style("top",e.top+"px").style("left",e.left+"px").on("end",()=>{e.element.style("z-index",""),this.broadcastResize()}):(this.releaseCellArea(e),e.columnSpan=e.dragState.desiredSpan[0],e.rowSpan=e.dragState.desiredSpan[1],this.ensureGridCapacity([e.column,e.row],e.columnSpan,e.rowSpan),this.claimCellArea(e),this.cleanupEmptyEdges(),this.renderGrid(),setTimeout(()=>{this.broadcastResize()},this.animationDuration),e.element.style("opacity","").style("outline",0).style("z-index","")),setTimeout(()=>{this.hideGridLines(),e.element.node().classList.remove("resizing")},this.animationDuration),this.triggerAutoSave()}handleMoveDragEnd(t,e){console.log(e),"green"===e.dragState.highlightColor&&e.dragState.moveTarget?this.swapCellsWithTarget(e,e.dragState.moveTarget):"green"!==e.dragState.highlightColor||!Array.isArray(e.dragState.movePosition)||e.column===e.dragState.movePosition[0]&&e.row===e.dragState.movePosition[1]?this.restoreCellPosition(e):this.moveCellToNewPosition(e,e.dragState.movePosition),e.element.node().classList.remove("dragging"),this.triggerAutoSave()}swapCellsWithTarget(t,e){(t.rowSpan||t.columnSpan)&&this.releaseCellArea(t),(e.rowSpan||e.columnSpan)&&this.releaseCellArea(e);const i={row:t.row,column:t.column,rowSpan:t.rowSpan,columnSpan:t.columnSpan};this.gridState.cells[e.row][e.column]=t,this.gridState.cells[t.row][t.column]=e,t.row=e.row,t.column=e.column,e.row=i.row,e.column=i.column,t.rowSpan=e.rowSpan,t.columnSpan=e.columnSpan,e.rowSpan=i.rowSpan,e.columnSpan=i.columnSpan,t.top=t.dragState.y,t.left=t.dragState.x,t.element.style("z-index",47).style("opacity",1),e.element.style("z-index",45),(t.rowSpan||t.columnSpan)&&this.claimCellArea(t),(e.rowSpan||e.columnSpan)&&this.claimCellArea(e),this.cleanupEmptyEdges(),this.renderGrid(),setTimeout(()=>{t.element.style("outline",0).style("z-index",""),e.element.style("z-index",""),this.broadcastResize()},this.animationDuration)}moveCellToNewPosition(t,e){const i=t;this.gridState.cells[i.row][i.column]={rowSpan:1,columnSpan:1,initialValues:{},forceLbm:!1,dewarpMode:void 0},this.gridState.cells[i.row][i.column].initialValues={left:t.left,top:t.top,width:this.gridState.cellWidth,height:this.gridState.cellHeight},this.releaseCellArea(t);const n=this.ensureGridCapacity(e,t.columnSpan,t.rowSpan);t.column=e[0]+n[0],t.row=e[1]+n[1];const s=e[1]+n[1],r=e[0]+n[0];this.gridState.cells[s]&&this.gridState.cells[s][r]&&this.gridState.cells[s][r].element&&this.gridState.cells[s][r].element.remove(),this.gridState.cells[s][r]=t,t.element.style("z-index",47).style("opacity",1),this.claimCellArea(t),this.cleanupEmptyEdges(),this.renderGrid(),setTimeout(()=>{t.element.style("outline",0).style("z-index",""),this.broadcastResize()},this.animationDuration)}restoreCellPosition(t){t.element.style("opacity","").transition().duration(100).style("width",t.width+"px").style("height",t.height+"px").style("top",t.top+"px").style("left",t.left+"px").on("end",()=>{t.element.style("z-index","").style("outline",0),this.broadcastResize()}),this.lineState.horizontal.group.style("opacity",1).transition().duration(this.animationDuration).style("opacity",0).on("end",()=>{this.hideGridLines(),this.lineState.horizontal.group.style("opacity",1)}),this.lineState.vertical.group.style("opacity",1).transition().duration(this.animationDuration).style("opacity",0).on("end",()=>{this.hideGridLines(),this.lineState.vertical.group.style("opacity",1)}),t.dragState.x=t.left,t.dragState.y=t.top}cleanupDragState(t){t.dragState&&(delete t.dragState.action,delete t.dragState.dragged,delete t.dragState.initX,delete t.dragState.initY,delete t.dragState.resizeOffsetX,delete t.dragState.resizeOffsetY,delete t.dragState.rowSpanAnchor,delete t.dragState.columnSpanAnchor,delete t.dragState.moveTarget,delete t.dragState.rowOffset,delete t.dragState.columnOffset,delete t.dragState.highlightColor,delete t.dragState.w,delete t.dragState.h,delete t.dragState.canDrag,delete t.dragState.desiredSpan,delete t.dragState.movePosition,delete t.dragState.dragResizing,delete t.dragState.dragMoving,delete t.dragState.x,delete t.dragState.y,delete t.dragState.originalWidth,delete t.dragState.originalHeight,delete t.dragState.resizeDirection)}updateHorizontalLines(){const t=[],{cellHeight:e,offsetTop:i}=this.gridState,n=this.lineState.containerSize.width;let s=0;for(let n=i+this.padding-e-3;n>0;n-=e+3){const e=n-1.5,i=this.lineState.firstRowIndex-1-s,r=0===this.lineState.horizontal.lines.length?e:this.lineState.horizontal.lines[0].value+(i-this.lineState.horizontal.lines[0].index)*(this.lineState.previousValues.cellHeight+3);t.unshift({index:i,value:e,initialValue:r}),s+=1}s=0;for(let n=i+this.padding;n<this.lineState.containerSize.height;n+=e+3){const e=n-1.5,i=this.lineState.firstRowIndex+s,r=0===this.lineState.horizontal.lines.length?e:this.lineState.previousValues.offsetTop+this.padding-1.5+(i-this.lineState.firstRowIndex-this.gridState.rowsInsertedSinceRender)*(this.lineState.previousValues.cellHeight+3);t.push({index:i,value:e,initialValue:r}),s+=1}this.lineState.horizontal.lines=t,this.updateLineGroup(this.lineState.horizontal.group,t,"horizontal",n)}updateVerticalLines(){const t=[],{cellWidth:e,offsetLeft:i}=this.gridState,n=this.lineState.containerSize.height;let s=0;for(let n=i+this.padding-e-3;n>0;n-=e+3){const e=n-1.5,i=this.lineState.firstColumnIndex-1-s,r=0===this.lineState.vertical.lines.length?e:this.lineState.vertical.lines[0].value+(i-this.lineState.vertical.lines[0].index)*(this.lineState.previousValues.cellWidth+3);t.unshift({index:i,value:e,initialValue:r}),s+=1}s=0;for(let n=i+this.padding;n<this.lineState.containerSize.width;n+=e+3){const e=n-1.5,i=this.lineState.firstColumnIndex+s,r=0===this.lineState.vertical.lines.length?e:this.lineState.previousValues.offsetLeft+this.padding-1.5+(i-this.lineState.firstColumnIndex-this.gridState.columnsInsertedSinceRender)*(this.lineState.previousValues.cellWidth+3);t.push({index:i,value:e,initialValue:r}),s+=1}this.lineState.vertical.lines=t,this.updateLineGroup(this.lineState.vertical.group,t,"vertical",n)}updateLineGroup(t,e,i,n){const s="horizontal"===i?"y":"x",r="horizontal"===i?"x":"y",o=t.selectAll("line").data(e,t=>t.index);o.attr("index",t=>t.index).transition().duration(this.isResizing?0:this.animationDuration).style("stroke-width",3).attr(s+"1",t=>t.value).attr(s+"2",t=>t.value).attr(r+"1",0).attr(r+"2",n),o.enter().append("line").attr("index-orig",t=>t.index).attr("index",t=>t.index).style("stroke-width",3).attr(s+"1",t=>t.initialValue).attr(s+"2",t=>t.initialValue).transition().duration(this.isResizing?0:this.animationDuration).attr(s+"1",t=>t.value).attr(s+"2",t=>t.value).attr(r+"1",0).attr(r+"2",n),o.exit().remove()}showGridLines(){"inline"!==this.lineState.horizontal.group.style("display")&&this.lineState.horizontal.group.style("opacity","0").style("display","inline").transition().duration(this.animationDuration).style("opacity","1").on("end",()=>{this.lineState.horizontal.group.style("opacity","")}),"inline"!==this.lineState.vertical.group.style("display")&&this.lineState.vertical.group.style("opacity","0").style("display","inline").transition().duration(this.animationDuration).style("opacity","1").on("end",()=>{this.lineState.vertical.group.style("opacity","")})}hideGridLines(){"none"!==this.lineState.horizontal.group.style("display")&&this.lineState.horizontal.group.style("opacity","1").transition().duration(this.animationDuration).style("opacity","0").on("end",()=>{this.lineState.horizontal.group.style("display","none").style("opacity","")}),"none"!==this.lineState.vertical.group.style("display")&&this.lineState.vertical.group.style("opacity","1").transition().duration(this.animationDuration).style("opacity","0").on("end",()=>{this.lineState.vertical.group.style("display","none").style("opacity","")})}insertRowAtTop(){this.lineState.firstRowIndex-=1,this.gridState.rowsInsertedSinceRender+=1;const t=[],e=-this.gridState.rowsInsertedSinceRender;for(let i=0;i<this.gridState.cells[0].length;i++){const n=i-this.gridState.columnsInsertedSinceRender,s={rowSpan:1,columnSpan:1,initialValues:{},forceLbm:!1,dewarpMode:void 0};s.initialValues.left=n*this.gridState.cellWidth+3*n+this.padding+this.gridState.offsetLeft,s.initialValues.top=e*this.gridState.cellHeight+3*e+this.padding+this.gridState.offsetTop,s.initialValues.width=this.gridState.cellWidth,s.initialValues.height=this.gridState.cellHeight,t.push(s)}this.gridState.cells.unshift(t)}insertColumnAtLeft(){this.lineState.firstColumnIndex-=1,this.gridState.columnsInsertedSinceRender+=1;const t=-this.gridState.columnsInsertedSinceRender;for(let e=0;e<this.gridState.cells.length;e++){const i=e-this.gridState.rowsInsertedSinceRender,n={rowSpan:1,columnSpan:1,initialValues:{},forceLbm:!1,dewarpMode:void 0};n.initialValues.left=t*this.gridState.cellWidth+3*t+this.padding+this.gridState.offsetLeft,n.initialValues.top=i*this.gridState.cellHeight+3*i+this.padding+this.gridState.offsetTop,n.initialValues.width=this.gridState.cellWidth,n.initialValues.height=this.gridState.cellHeight,this.gridState.cells[e].unshift(n)}}insertRowAtBottom(){const t=[],e=this.gridState.cells.length;for(let i=0;i<this.gridState.cells[0].length;i++){const n={rowSpan:1,columnSpan:1,initialValues:{},forceLbm:!1,dewarpMode:void 0};n.initialValues.left=i*this.gridState.cellWidth+3*i+this.padding+this.gridState.offsetLeft,n.initialValues.top=e*this.gridState.cellHeight+3*e+this.padding+this.gridState.offsetTop,n.initialValues.width=this.gridState.cellWidth,n.initialValues.height=this.gridState.cellHeight,t.push(n)}this.gridState.cells.push(t)}insertColumnAtRight(){const t=this.gridState.cells[0].length;for(let e=0;e<this.gridState.cells.length;e++){const i={rowSpan:1,columnSpan:1,initialValues:{},forceLbm:!1,dewarpMode:void 0};i.initialValues.left=t*this.gridState.cellWidth+3*t+this.padding+this.gridState.offsetLeft,i.initialValues.top=e*this.gridState.cellHeight+3*e+this.padding+this.gridState.offsetTop,i.initialValues.width=this.gridState.cellWidth,i.initialValues.height=this.gridState.cellHeight,this.gridState.cells[e].push(i)}}removeTopRow(){this.gridState.cells.length>1&&(this.lineState.firstRowIndex+=1,this.gridState.rowsInsertedSinceRender-=1,this.gridState.cells[0].forEach(t=>{t.element&&t.element.remove()}),this.gridState.cells.shift())}removeLeftColumn(){if(this.gridState.cells[0].length>1){this.gridState.columnsInsertedSinceRender-=1,this.lineState.firstColumnIndex+=1;for(let t=0;t<this.gridState.cells.length;t++){const e=this.gridState.cells[t][0];e.element&&e.element.remove(),this.gridState.cells[t].shift()}}}removeBottomRow(){if(this.gridState.cells.length>1){this.gridState.cells[this.gridState.cells.length-1].forEach(t=>{t.element&&t.element.remove()}),this.gridState.cells.pop()}}removeRightColumn(){if(this.gridState.cells[0].length>1)for(let t=0;t<this.gridState.cells.length;t++){const e=this.gridState.cells[t][this.gridState.cells[t].length-1];e.element&&e.element.remove(),this.gridState.cells[t].pop()}}cleanupEmptyEdges(){let t=!1;for(;this.gridState.cells.length>1&&this.isRowEmpty(0);)this.removeTopRow(),t=!0;for(;this.gridState.cells.length>1&&this.isRowEmpty(this.gridState.cells.length-1);)this.removeBottomRow(),t=!0;for(;this.gridState.cells[0].length>1&&this.isColumnEmpty(0);)this.removeLeftColumn(),t=!0;for(;this.gridState.cells[0].length>1&&this.isColumnEmpty(this.gridState.cells[0].length-1);)this.removeRightColumn(),t=!0;return t}isRowEmpty(t){for(let e=0;e<this.gridState.cells[t].length;e++){const i=this.gridState.cells[t][e];if(!0===i.claimed||!0===i.spannedUpon)return!1}return!0}isColumnEmpty(t){for(let e=0;e<this.gridState.cells.length;e++){const i=this.gridState.cells[e][t];if(!0===i.claimed||!0===i.spannedUpon)return!1}return!0}highlightCells(t,e){const i=this.highlighterSvg.selectAll("rect").data(t);i.attr("x",t=>t.x+"px").attr("y",t=>t.y+"px").attr("width",t=>t.width+"px").attr("height",t=>t.height+"px").style("fill",e),i.exit().remove(),i.enter().append("rect").attr("x",t=>t.x+"px").attr("y",t=>t.y+"px").attr("width",t=>t.width+"px").attr("height",t=>t.height+"px").style("fill",e).style("opacity",0).transition().duration(this.animationDuration).style("opacity",.5),this.highlighterSvg.style("display",0===t.length?"":"block")}showLines(){this.showGridLines()}hideLines(){this.hideGridLines()}getCellByCoordinates(t,e){const i=this.element.getBoundingClientRect(),n=t-i.left,s=e-i.top;let r=!1;return this.gridState.cells.some(t=>t.some(t=>{if(t.left<=n&&t.left+t.width>=n&&t.top<=s&&t.top+t.height>=s)return r=t,!0})),r}deleteCellByCoordinates(t,e){const i=this.element.getBoundingClientRect(),n=t-i.left,s=e-i.top;let r=!1;return this.gridState.cells=this.gridState.cells.map(t=>t.filter(t=>{const e=!(t.left<=n&&t.left+t.width>=n&&t.top<=s&&t.top+t.height>=s);return e||(t.element&&t.element.remove(),this.cleanupCell(t),r=!0),e})).filter(t=>t.length>0),r}findGridPositionByCoordinates(t,e,i){const n=this.element.getBoundingClientRect(),s=n.left,r=n.top,o=this.lineState.vertical.lines[0].value-this.gridState.cellWidth+s-1.5,a=this.lineState.horizontal.lines[0].value-this.gridState.cellHeight+r-1.5,l=this.lineState.vertical.lines[this.lineState.vertical.lines.length-1].value+s+1.5,h=this.lineState.horizontal.lines[this.lineState.horizontal.lines.length-1].value+r+1.5;if(!i&&(t<o||e<a||t>l||e>h))return[Math.floor((t-o)/(this.gridState.cellWidth+3)),Math.floor((e-a)/(this.gridState.cellHeight+3))];let c=0;for(let i=a;i<=this.element.clientHeight+this.gridState.cellHeight;i+=this.gridState.cellHeight+3){let n=0;for(let s=o;s<=this.element.clientWidth+this.gridState.cellWidth;s+=this.gridState.cellWidth+3){if(s<=t&&s+this.gridState.cellWidth>=t&&i<=e&&i+this.gridState.cellHeight>=e)return[n,c];n+=1}c+=1}return!1}getDimensionsForGridPosition(t,e,i,n){const s=this.element.getBoundingClientRect();return void 0===i&&(i={x:s.left,y:s.top}),void 0===n&&(n={x:this.lineState.vertical.lines[0].value-this.gridState.cellWidth+i.x,y:this.lineState.horizontal.lines[0].value-this.gridState.cellHeight+i.y}),{x:t*(this.gridState.cellWidth+3)+n.x-i.x-1.5,y:e*(this.gridState.cellHeight+3)+n.y-i.y-1.5,width:this.gridState.cellWidth,height:this.gridState.cellHeight}}getCellByElement(t){let e;return this.gridState.cells.some(i=>i.some(i=>{if(i.element&&i.element[0][0]===t)return e=i,!0})),e}findGridOrigin(){const t=this.container.node().getBoundingClientRect();return this.findGridPositionByCoordinates(this.gridState.cells[0][0].left+t.left+3,this.gridState.cells[0][0].top+t.top+3)}claimCellByCoordinates(t){let e=this.getCellByCoordinates(t.pageX,t.pageY);if(e&&e.id&&(console.log("覆盖已有id单元格：",e.id),this.dispatchEvent(new CustomEvent("closeCell",{detail:e.id}))),!e){const i=this.findGridPositionByCoordinates(t.pageX,t.pageY);if(!1!==i){const t=this.findGridOrigin()||[0,0],n=[i[0]-t[0],i[1]-t[1]],s=this.ensureGridCapacity(n,1,1)||[0,0],r=i[1]-t[1]+(s[1]||0),o=i[0]-t[0]+(s[0]||0);this.gridState.cells[r]&&this.gridState.cells[r][o]&&(e=this.gridState.cells[r][o],e.claimed=!0,this.cleanupEmptyEdges())}}if(e.claimed=!0,e.camera=t.camera,e.id=t.id,e.recording=t.recording,e.recEnable=t.recEnable,e.element){e.element.attr("id",e.id);const t=e.element.select(".float-layer").select(".icon-fuwuluxiangzhong, .icon-fuwuluxiang");e.recEnable?t.classed("icon-fuwuluxiang",!1).classed("icon-fuwuluxiangzhong",!0).style("color","#FF0000"):t.classed("icon-fuwuluxiangzhong",!1).classed("icon-fuwuluxiang",!0).style("color",null)}else e.element=null,this.ensureCellElement(e,!0);this.renderGrid(),this.setupDragBehavior(e),this.triggerAutoSave()}releaseCell(t,e){if(t.fullScreen&&(t.fullScreen=!1,this.isFullScreen=!1),t.claimed=!1,t.forceLbm=void 0,t.dewarpMode=void 0,this.releaseCellArea(t),t.rowSpan=1,t.columnSpan=1,!e){this.cleanupEmptyEdges()&&this.gridState.cells.length>1&&this.gridState.cells[0].length>1&&this.showGridLines(),this.renderGrid(),setTimeout(()=>{this.hideGridLines()},this.animationDuration)}}obtainContainer(t){if(this.isAddingCell)return!1;for(let e=0;e<this.gridState.cells.length;e++)for(let i=0;i<this.gridState.cells[0].length;i++){const n=this.gridState.cells[e][i];if(!n.claimed&&!n.spannedUpon)return n.claimed=!0,n.width=this.gridState.cellWidth,n.height=this.gridState.cellHeight,n.rowSpan=1,n.columnSpan=1,n.element&&(n.element.style("width",n.width+"px"),n.element.style("height",n.height+"px")),t(n),!0}this.isAddingCell=!0;const e=this.gridState.cells.length,i=this.gridState.cells[0].length,n=this.calculateCellDimensions(e,i+1),s=this.calculateCellDimensions(e+1,i);if(n.cellWidth*n.cellHeight>s.cellWidth*s.cellHeight){this.insertColumnAtRight();const e=this.gridState.cells[0][this.gridState.cells[0].length-1];e.claimed=!0,this.renderGrid(),t(e)}else{this.insertRowAtBottom();const e=this.gridState.cells[this.gridState.cells.length-1][0];e.claimed=!0,this.renderGrid(),t(e)}return setTimeout(()=>{this.isAddingCell=!1},this.animationDuration),!0}toggleFullScreen(t){return this.isFullScreen?t.fullScreen?(this.isFullScreen=!1,t.fullScreen=!1,this.exitFullScreen(t),this.triggerAutoSave(),!0):void 0:(this.isFullScreen=!0,t.fullScreen=!0,this.enterFullScreen(t),this.triggerAutoSave(),!0)}enterFullScreen(t){const e=t.element.node().parentNode.parentNode.offsetWidth,i=t.element.node().parentNode.parentNode.offsetHeight;t.element.style("z-index",50).transition().style("top","0px").style("left","0px").style("height",i+"px").style("width",e+"px").on("end",()=>{this.broadcastResize()})}exitFullScreen(t){t.element.transition().style("top",t.top+"px").style("left",t.left+"px").style("width",t.width+"px").style("height",t.height+"px").style("outline","").on("end",()=>{t.element.style("z-index",""),this.broadcastResize()})}buildSerializableMatrix(){const t=[];return this.gridState.cells.forEach(e=>{const i=[];e.forEach(t=>{const e={};t.claimed&&(e.columnSpan=t.columnSpan,e.rowSpan=t.rowSpan,"map"===t.type?(e.type="map",e.map=t.map):(e.type="player",e.camera=t.camera,e.forceLbm=t.forceLbm,e.dewarpMode=t.dewarpMode)),i.push(e)}),t.push(i)}),t}traverseCellArea(t,e,i,n){for(let s=t.row;s<t.row+e;s++)for(let e=t.column;e<t.column+i;e++)if((s!==t.row||e!==t.column)&&this.gridState.cells[s]&&this.gridState.cells[s][e]){if(!1===n(this.gridState.cells[s][e]))return!1}return!0}releaseCellArea(t){this.traverseCellArea(t,t.rowSpan,t.columnSpan,t=>{delete t.claimed,delete t.spannedUpon,delete t.spannedUponBy,t.width=this.gridState.cellWidth,t.height=this.gridState.cellHeight,t.initialValues={width:this.gridState.cellWidth,height:this.gridState.cellHeight}})}claimCellArea(t){return this.traverseCellArea(t,t.rowSpan,t.columnSpan,e=>(e.claimed=!0,e.spannedUpon=!0,e.spannedUponBy=t,e.width=0,e.height=0,e.initialValues={width:0,height:0},!0))}ensureGridCapacity(t,e,i){const n=[0,0],[s,r]=t;if(s+e-1>=this.gridState.cells[0].length)for(let t=this.gridState.cells[0].length;t<=s+e-1;t++)this.insertColumnAtRight();if(r+i-1>=this.gridState.cells.length)for(let t=this.gridState.cells.length;t<=r+i-1;t++)this.insertRowAtBottom();if(s<0)for(let t=0;t>s;t--)this.insertColumnAtLeft(),n[0]+=1;if(r<0)for(let t=0;t>r;t--)this.insertRowAtTop(),n[1]+=1;return n}findAncestor(t,e){for(;t;){if(e(t))return t;t=t.parentElement}return null}broadcastEvent(t,e){const i=new CustomEvent(t,{detail:e});this.element.dispatchEvent(i)}broadcastResize(){this.broadcastEvent("resize.stage")}reloadStageConfiguration(t){this.gridState.cells.forEach(t=>t.forEach(t=>{t.element&&t.element.remove()}));this.gridState.cells=[[{rowSpan:1,columnSpan:1,initialValues:{},forceLbm:!1}]],this.gridState.cells.forEach((t,e)=>{t.forEach((t,i)=>{t.row=e,t.column=i})});const e=[];this.gridState.cells.forEach(i=>{i.forEach(i=>{(i.claimed||i.camera||i.map)&&(console.log("reloadStageConfiguration cell =>",i),this.ensureCellElement(i),(i.rowSpan>1||i.columnSpan>1)&&this.claimCellArea(i),e.push(t(i).then(t=>{t||this.releaseCell(i,!0)})))})}),Promise.all(e).then(()=>{this.isResizing=!0,this.renderGrid(),this.isResizing=!1})}cleanupCell(t){t&&(t.element&&(t.element.style("outline",0),t.element.style("z-index","")),t.dewarpMode=void 0,t.forceLbm=!1,delete t.camera)}destroy(){this.eventListeners.forEach((t,e)=>{window.removeEventListener(e,t)}),this.eventListeners.clear(),this.persistTimeout&&clearTimeout(this.persistTimeout),this.container.selectAll("*").remove(),this.autoSaveTimer&&(clearTimeout(this.autoSaveTimer),this.autoSaveTimer=null)}}var Vr=s.AiDraw,Ur=s.H5sPlayerWS2,Fr=s.PackBitsCompress,Lr=s.PackBitsDecompress,Wr=s.TestVideo,Nr=s.VedDispMgr,Br=s.Video;export{Vr as AiDraw,Rr as GridLayoutManager,u as H5sConference,v as H5sGetClientRTCDecoder,y as H5sGetClientRTCInit,m as H5sGetClientWSDecoder,d as H5sPlayerAudBack,c as H5sPlayerHls,h as H5sPlayerRTC,l as H5sPlayerWS,Ur as H5sPlayerWS2,p as H5sRTCGetCapability,f as H5sRTCPush,Fr as PackBitsCompress,Lr as PackBitsDecompress,t as SegmentPlayer,Wr as TestVideo,xr as Timeline,Ir as UPlayerList,Ar as UPlayerSDK,Nr as VedDispMgr,Br as Video};
